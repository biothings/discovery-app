{% extends "main.html" %}
{% block content %}
{% include "header.html" %}
<style>
  .registry-item-background{
    background-size: contain;
    background-position: center;
    background-repeat: no-repeat;
    background-color: #D0D0D0;
    clip-path: polygon(0 0, 56% 0, 100% 100%, 0% 100%);
  }
</style>
<div id="registry" class="jumbotron" style="min-height:80vh;">
  <div v-if=loading class="loader">
    <img src="/static/img/ripple.svg" />
  </div>
  <div class="col-md-10 col-sm-12 m-auto">
    <div class="">
      <h1 class="text-center logoText mb-1 mt-2">Dataset Registry</h1>
      <div>
        <form @submit.prevent="search(query)">
          <div class="row m-1 cBox actions bg-secondary">
            <div class="col-sm-10 p-2">
              <div class="">
                <input class="form-control col-12" id="search_query" type="text" v-model="query" name="query" placeholder="Search...">
              </div>
            </div>
            <div class="col-sm-2 p-2 bg-dark actions d-flex align-items-center justify-content-around">
              <span class="fa-stack fa-1x pointer search unselectable tip" @click.prevent="search(query)">
                <i class="fas fa-circle text-muted fa-stack-2x"></i>
                <i class="fas fa-search fa-stack-1x text-light"></i>
              </span>
              <span class="fa-stack fa-1x pointer reset unselectable" @click.prevent="query='';registry=[]">
                <i class="fas fa-circle fa-stack-2x text-muted"></i>
                <i class="fas fa-undo fa-stack-1x text-light"></i>
              </span>
            </div>
          </div>
        </form>
      </div>
      <div class="resultsTab mt-3 p-1 bg-secondary text-light" v-text="registryTotal.value+' Results'">
      </div>
      <ul class="list-group context" style="border-top:solid 3px var(--main)" id="regTippyParent">
        <li class="list-group-item d-flex justify-content-center align-items-center text-muted p-1" style="background:#d0d0d0;">
          <small v-if="registry.length && query" v-text="'results for '+query">
          </small>
        </li>
        <template v-if="registry.length" v-for="(item,index) in registryResults">
          <registry-item :item='item' :key="index"></registry-item>
        </template>
        <li v-if="!registry.length" class="text-center text-muted list-group-item">
          <div class="jumbotron">
            <h4>Search for existing datasets</h4>
          </div>
        </li>
      </ul>
      <div class="bg-light">
        <div class="row">
          <nav class="m-auto ">
            <ul class="pagination m-2 flex-wrap p-2">
              <li class="page-item" :class="{ 'disabled': page <= 1 }">
                <a class="page-link" @click.prevent="prevPage()"><i class="fas fa-step-backward"></i></a>
              </li>
              <li class="page-item" :class="{ 'active': page == n, 'bg-primary': page == n, 'white-text': page == n  }" v-for="n in pages">
                <a href="#" class="page-link" @click.prevent="page = n" v-text="n"></a>
              </li>
              <li class="page-item" :class="{ 'disabled': page >= pages }">
                <a class="page-link" @click.prevent="nextPage()"><i class="fas fa-step-forward"></i></a>
              </li>
            </ul>
          </nav>
          <div class="col-sm-12 right-align form-group">
            <select class="perPage form-control form-control-sm w-50 m-auto" v-model="perPage" @change="calculatePages" id="perPage">
              <option value="" disabled selected>Shown Per Page</option>
              <option value="20">20 per page</option>
              <option value="50">50 per page</option>
              <option value="100">100 per page</option>
            </select>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
{% block extra_scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.4.2/vue.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.18.0/axios.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.es6.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js"></script>
<script src="/static/js/lodash.js"></script>
<script src="https://unpkg.com/tippy.js@3/dist/tippy.all.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@7.28.11/dist/sweetalert2.all.min.js"></script>
<script>
  Vue.component('registry-item', {
    data: function() {
      return {
        options: false
      }
    },
    props: ['item'],
    methods: {
      getSubclass(parents) {
        if (parents) {
          let sub = parents[0].split(', ');
          return sub[sub.length - 1]
        } else {
          return 'This class has no subclass'
        }
      },
      getPropTotal() {
        if (this.item.hasOwnProperty('properties')) {
          return this.item.properties.length
        } else {
          return '0'
        }
      },
      goTo(item) {
        var self = this;
        if (item) {
          window.location.href = '/dataset/' + item._id;
        } else {
          Swal.fire(
            'Oops!',
            'Action not available for this item',
          );
        }
      },
    },
    computed: {
      text: function() {
        if (this.item.description.length > 150) {
          return this.item.description.substring(0, 150) + "..."
        } else {
          return this.item.description
        }
      },
      imgIcon: function(){
        if (this.item.hasOwnProperty("@type") && this.item['@type'].includes('n3c')) {
          return '/static/img/N3Co.png'
        }
        else if (this.item.hasOwnProperty("@type") && this.item['@type'].includes('outbreak')) {
          return '/static/img/outbreak.png'
        }
        else if (this.item.hasOwnProperty("@type") && this.item['@type'].includes('niaid')) {
          return '/static/img/niaid/icon.svg'
        }
        else{
          return '/static/img/dde-logo-o.svg'
        }
      },
      detailLink: function(){
        return '/dataset/'+this.item._id
      }
    },
    template: `<li class="list-group-item list-group-item-action p-0 pointer">
                <div class="row m-0">
                  <div class="col-sm-1 registry-item-background" :style="{backgroundImage: 'url(' + imgIcon + ')' }"></div>
                  <div class="col-sm-11" @click="goTo(item)">
                    <h5 class="mb-1 mainTextDark d-inline" v-text="item.name"></h5>
                    <p v-if="item && item.description" class="text-muted">
                      <small v-html="text"></small>
                    </p>
                  </div>
                </div>
              </li>`
  });

  //<small v-if="item && item._meta.username" class="text-muted" v-text="item._meta.username"></small>

  var app = new Vue({
    el: '#registry',
    data: function() {
      return {
        alphabet: ['ALL', 'A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 'N', 'O', 'P', 'Q', 'R', 'S', 'T', 'U', 'V', 'W', 'X', 'Y', 'Z'],
        input: '',
        linkPrefix: './',
        data: null,
        user: {},
        testURL: '',
        registry: [],
        registryTotal: '0',
        sort: 'Search Relevance',
        query: '',
        page: 1,
        pages: 1,
        perPage: 20,
        loading: false,
      }
    },
    methods: {

      searchByUser(username) {
        var self = this;

        $('#searching').show();

        var context = document.querySelector(".context");
        var instance = new Mark(context);
        instance.unmark();

        axios.get('/api/query?q=_meta.username:' + username + '&size=100').then(function(response) {
          self.registry = response.data.hits;
          self.registryTotal = response.data.total;
          $(document).ready(function() {
            self.mark(username);
          });
          if (self.registryTotal) {
            self.calculatePages();
          }
          $('#searching').hide();
        });
      },
      mark(kw) {
        var context = document.querySelector(".context");
        var instance = new Mark(context);
        instance.mark(kw);
      },
      getQueryFilters() {
        var filters = [];
        var authorFilters = [];
        var finalFilters = {};
        this.tags.forEach(function(item) {
          if (item.active)
            filters.push(item.name);
        });
        if (filters.length > 0) {
          finalFilters['tags.name.raw'] = filters;
        }

        this.authors.forEach(function(item) {
          if (item.active) {
            authorFilters.push(item.name);
          }
        });
        if (authorFilters.length) {
          finalFilters['info.contact.name.raw'] = authorFilters;
        }

        return finalFilters;
      },
      search(query) {
        var self = this;

        query = query || "__all__";

        if (query) {
          var params = {
            "params": {
              "q": query,
            }
          };
        }
        self.loading = true;
        var context = document.querySelector(".context");
        var instance = new Mark(context);
        instance.unmark();
        self.registry = [];
        axios.get('/api/dataset/query?size=1000', params).then(function(response) {
          self.registry = response.data.hits;
          self.registryTotal = response.data.total;
          $(document).ready(function() {
            self.mark(self.query);
          });
          if (self.registryTotal) {
            self.calculatePages();
          }
          self.checkforQuery();
          self.loading = false;
        });
      },
      calculatePages() {
        var self = this;
        self.pages = Math.ceil(self.registry && self.registry.length / self.perPage);
      },
      prevPage() {
        var self = this;
        if (self.page > 1)
          self.page -= 1
      },
      nextPage() {
        var self = this;
        if (self.page < self.pages)
          self.page += 1
      },
      sortResults(e) {
        this.sort = e.target.value;
      },
      checkLoggedUser() {
        var self = this;
        axios.get('./user').then(res => {
          if (res.data.login) {
            self.user = res.data;
          }
        }).catch(err => {
          throw err;
        });
      },
      checkforQuery(){
            let self = this;
            let url_string = window.location.href
            let url = new URL(url_string);

            let q = url.searchParams.get("q");
            if (q) {
              this.query = q;
            }

            let guides = url.searchParams.get("guide");
            let guide_paths =[]

            if (guides) {
              if (guides.includes(',')) {
                guides = guides.split(',')
              }else {
                guides = [guides]
              }
              console.log(guides)
              for (var i = 0; i < guides.length; i++) {
                let guide_url = self.getLocation(guides[i])
                guide_paths.push(guide_url.pathname)
              }
              if (guide_paths.length) {
                self.handleGuideFilter(guide_paths)
              }
            }
          },
          handleGuideFilter(guide_paths){
            let self = this;
            self.registry = _.filter(self.registry, function(item) {
              if (item.hasOwnProperty('_meta') && item['_meta']['guide']) {
                let item_path = self.getLocation(item['_meta']['guide'])
                item_path = item_path.pathname
                if (guide_paths.includes(item_path)) {
                  return item
                }
              }
            });
            self.registryTotal = {'value':self.registry.length}
            self.calculatePages()
          },
          getLocation(href) {
              var l = document.createElement("a");
              l.href = href;
              return l;
          },
    },
    mounted: function() {
      var self = this;
      self.checkLoggedUser();
      self.search(self.query);
      tippy('.search', {
        maxWidth: '200px',
        placement: 'top',
        content: '<div class="text-muted m-0" style="border-radius:none">Search</div>',
        animation: 'fade',
        theme: 'light'
      });
      tippy('.reset', {
        maxWidth: '200px',
        placement: 'top',
        content: '<div class="text-muted m-0" style="border-radius:none">Reset</div>',
        animation: 'fade',
        theme: 'light'
      });
      tippy('#regTippyParent', {
        target: '.tip',
        placement: 'top',
        maxWidth: '200px',
        content: 'loading',
        animation: 'fade',
        theme: 'light',
        onShow(instance) {
          let info = instance.reference.dataset.tippyInfo;
          instance.setContent("<div class='text-muted m-0 text-center wraptext'>" + info + "</div>")
        }
      });
    },
    computed: {
      registryResults: function() {
        var start = (this.page - 1) * this.perPage,
          end = start + this.perPage;
        return this.registry && this.registry.slice(start, end);
      }
    },
  })

  // Smooth Scroll-To

  $('a[href*="#"]')
    .not('[href="#"]')
    .not('[href="#0"]')
    .click(function(event) {
      if (
        location.pathname.replace(/^\//, '') == this.pathname.replace(/^\//, '') &&
        location.hostname == this.hostname
      ) {
        var target = $(this.hash);
        target = target.length ? target : $('[name=' + this.hash.slice(1) + ']');
        if (target.length) {
          event.preventDefault();
          $('html, body').animate({
            scrollTop: target.offset().top
          }, 1000, function() {
            var $target = $(target);
            $target.focus();
            if ($target.is(":focus")) {
              return false;
            } else {
              $target.attr('tabindex', '-1');
              $target.focus();
            };
          });
        }
      }
    });
</script>

{% include "footer.html" %}
{% endblock %}
