{% extends "main.html" %}
{% block content %}
{% include "header.html" %}
<style>
  .drag-el{
    color: white;
    transition: all .3s;
    background-image: url("/static/img/cube.svg");
    background-position: left;
    background-repeat: no-repeat;
    outline: none !important;
    padding: 10px 10px 10px 40px !important;
  }
  .drag-el:hover{
    cursor: grab;
  }
  .v-container{
    position: relative;
    transform-style: preserve-3d;
  }
  .drop-zone {
    background-color: honeydew;
    border: grey dotted 2px;
    max-height: 200px;
    overflow: scroll;
  }
  .drop-zone[drop-active=true] {
    background-color: #d2ff8f;
    border: #caff37 dotted 2px;
  }
</style>
<link rel="stylesheet" href="/static/css/codemirror.css">
<section id="editor" class="container-fluid m-auto col-sm-12 col-md-10 col-lg-10 col-xl-8" style="min-height: 80vh;padding-top:60px;">
  <audio id="dropsound" src="/static/img/tinybutton.wav"></audio>
  <div>
    <div class="jumbotron bg-light text-center m-1 pt-4">
      <h1 class="logoText">Schema Editor</h1>
      <small class="text-muted">Extend an existing schema to create your own.</small>
    </div>
    <div v-if="loading" class="loader">
      <img src="/static/img/ripple.svg"/>
    </div>
    <div id="widget">
      <ul class="nav nav-tabs bg-secondary">
        <li class="nav-item" v-if="userInfo && userInfo.login">
          <span class="nav-link text-light" :class="{ 'disabled': userInfo }"><small>
            <i class="fas fa-user-check text-success"></i> Logged in as <span v-text="userInfo.login"></span></small>
          </span>
        </li>
        <li class='nav-item' v-if="userInfo && !userInfo.login">
          <a class='nav-link bg-light rounded-0' :href='"/login?next="+window.location.pathname'>
            <small><i class="fas fa-sign-in-alt"></i> Login</small>
          </a>
        </li>
        <template v-if='newClassAdded'>
          <li class='nav-item' v-show="prefix">
            <a class='nav-link rounded-0' :class="{ 'disabled text-muted notallowed text-light': !prefix, 'mainBackDark text-light pointer': prefix }" data-tippy="Look at your work so far" @click='getPreview()'>
              <small>
                <i class="fas fa-code"></i> Preview
              </small>
            </a>
          </li>
          <li class='nav-item'>
            <a class='nav-link rounded-0' :class="{ 'disabled text-muted notallowed text-light': !prefix, 'bg-info text-light pointer': prefix }" data-tippy="Edit Validation" @click='editValidation()'>
              <small>
                <i class="fas fa-pen-square"></i> Validation
              </small>
            </a>
          </li>
          <li class='nav-item' v-show="prefix">
            <a class='nav-link rounded-0' :class="{ 'disabled text-muted notallowed text-light': !prefix, 'bg-primary text-light pointer': prefix }" data-tippy="Download your schema" @click='downnloadSchema()'>
              <small>
                <i class="fas fa-file-download"></i> Download
              </small>
            </a>
          </li>
          <li class='nav-item' v-show="prefix">
            <a class='nav-link rounded-0' :class="{ 'disabled text-muted notallowed text-light': !prefix, 'bg-success text-light pointer': prefix }" data-tippy="Requires Gihub Login" @click.prevent="githubOptions()">
              <small >
                <i class="fab fa-github"></i> Save to GitHub
              </small>
            </a>
          </li>
        </template>
        <li class='nav-item'>
          <a class='nav-link rounded-0 text-light pointer' data-tippy="Learn about this editor" @click.prevent="showHelp()">
            <small >
              <i class="fas fa-question-circle"></i> Help
            </small>
          </a>
        </li>
      </ul>
      <!-- Validation -->
      <div v-if="validationView" class="v-container p-0 bg-dark justify-content-center d-flex align-items-center">
        
        <div class="w-100 row m-0">
          <div class="bg-info p-1 col-sm-12">
            <p class="text-center text-light m-0">
              <small class="text-light"><i class="fas fa-info-circle text-light"></i> Define how the input for each property should be validated, drag and drop common rules or create your own.</small>
            </p>
          </div>
          <div class="col-sm-12 col-md-6 bg-secondary border-right" style="max-height: 800px; overflow-y: scroll;">
            <h5 class="text-light text-center m-0 text-dark pt-2">Your Validation</h5>
            <template v-for="(val,propname) in validation_props">
              <validation-dropzone :propname="propname" :key="propname" :validation_options="validation_options" :val="val"></validation-dropzone>
            </template>
          </div>
          <div class="col-sm-12 col-md-6 bg-dark border-left">
            <h5 class="text-light text-center m-0 text-muted pt-2">Common Validation Options</h5>
            <small class="text-info text-center d-block">Drag & drop to merge validation</small>
            <div class="border rounded p-2 bg-light mb-2">
              <template v-for='item in validation_options'>
                <div class='badge drag-el m-1' :data-tippy-info="JSON.stringify(item.validation,null,2)" :style="{ 'background-color': item.color }" :key='item.title' draggable @dragstart='startDrag($event, item)'>
                  <span v-text="item.title"></span>
                  <span data-tippy-info="EDIT" class="badge badge-light pointer" @click="editValidationOption(item)"><i class="fas fa-pen-square"></i></span>
                </div>
              </template>
              <div @click="addValidationOption()" data-tippy="ADD NEW" class="badge m-1 badge-secondary text-light pointer"><i class="fas fa-plus"></i></div>
            </div>
            <div class="bg-dark p-1" v-if="item">
              <editor></editor>
            </div>
          </div>
          
        </div>
      </div>
      <!-- LOGGED IN DASHBOARD -->
      <template v-if="userInfo && userInfo.login">
        <!-- NAMESPACE -->
        <div class="jumbotron alert-secondary" v-if='!prefix'>
          <p class="text-center text-muted">
            <small>Extending: <span class="text-dark" v-text="startingPoint"></span></small>  <small class="bold" :class="{'text-success':availableNamespace, 'text-danger': !availableNamespace}"><i class="fas fa-chevron-right"></i> Choose a namespace</small>
          </p>
          <h4 class="text-info text-center">Choose a short name used to identify new definitions</h4>
          <p class="text-center text-muted">
            <small class="text-muted"><i class="fas fa-info-circle text-info"></i> For example: <b>myname</b>:ClassName </small>
          </p>
          <div class="d-flex justify-content-center align-items-center flex-wrap">
            <form @submit.prevent="savePrefix" class="text-center">
              <div class="input-group">
                <input type="text" v-model='inputNamespace' class="form-control m-auto text-center" :class="{'text-success':availableNamespace, 'text-danger': !availableNamespace}" placeholder="">
                <div>
                  <button :disabled="!availableNamespace" class="btn text-light" :class="{'btn-success':availableNamespace, 'btn-danger': !availableNamespace}" type="submit">Continue</button>
                </div>
              </div>
              <small class="text-muted">Choose a short namespace (a-z) 3 chars minimum recommended.</small>
            </form>
          </div>
        </div>

        <!-- Custom Class -->
        <div class="jumbotron alert-secondary text-center text-muted" v-if='prefix && !newClassAdded'>
          <p class="text-center text-muted">
            <small>Extending schema: <span class="text-info" v-text="startingPoint"></span></small>
            <small class="text-muted"><i class="fas fa-chevron-right"></i> namespace: <span class="text-info" v-text="prefix"></span></small>
            <small class="text-muted bold"><i class="fas fa-chevron-right"></i> Create a new class</small>
          </p>
          <hr />
          <form class="m-auto col-sm-12 col-md-9 py-2 bg-light rounded fade-in text-left" @submit.prevent='addClass()'>
            <h4 class="text-info">Create a new class</h4>
            <small>
              <p><i class="fas fa-info-circle text-info"></i> You are extending <span class="text-info" v-text="startingPoint"></span>, consider naming your class something more specific or relevant to the class' hierarchy.</p>
              <p>Description can be a short paragraph about how this class is more specific from the class you are extending, need to extend this hierarchy, or use case.</p>
            </small>
            <div class="form-group">
              <h5 for="exampleInputEmail1" class="text-dark"><i class="fas fa-asterisk text-danger"></i> Name of the new extended class:</h5>
              <input type="text" ref="clsName" class="form-control" id="exampleInputEmail1" placeholder="Name should be PascalCased eg. MyClass">
            </div>
            <div class="form-group">
              <h5 for="exampleInputPassword1" class="text-dark"><i class="fas fa-asterisk text-danger"></i> Brief description about this class:</h5>
              <textarea type="password" minlength="20" rows="6" ref="clsDesc" class="form-control" placeholder="Enter your Class description here"></textarea>
            </div>
            <div>
              <button type="submit" class="btn btn-success">Continue</button>
            </div>
          </form>
        </div>

        <!-- PARENT CLASSES -->
        <div class="jumbotron alert-secondary" v-if="newClassAdded && !validationView" id="editorTippy">
          <div>
            <h4 class="text-info text-left">Select and create properties for your schema</h4>
            <p class="text-center text-muted">
              <small class="text-muted">Reuse properties from parents</small>
              <i class="fas fa-arrow-circle-right mx-1"></i>
              <small class="text-muted">Add new properties</small>
              <i class="fas fa-arrow-circle-right mx-1"></i>
              <small class="text-muted">Add validation</small>
              <i class="fas fa-arrow-circle-right mx-1"></i>
              <small class="text-muted">Save schema</small>
              </ol>
            </p>
          </div>
          <!-- <ngx-graph></ngx-graph> -->
          <div class="mt-2">
            <input type="checkbox" class="slider mr-2" id="customControlInline" @click="toggleDesc()">
            <label for="customControlInline"><small class="text-muted">Show Descriptions</small></label>
          </div>
          <template  v-for="(item,index) in classesAvailable">
            <c-box :item="item" :key="index"></c-box>
          </template>
        </div>

      </template>
      <template v-else>
        <div class="alert alert-light text-danger text-center p-5">
          <h5>You must be logged in to proceed</h5>
        </div>
      </template>

    </div>
  </div>
  <div class="alert alert-secondary" v-if="newClassAdded">
    <p class="m-0">
      Done editing? Easy! <i class="fas fa-arrow-right text-success"></i> Click <b>Download</b> <i class="fas fa-arrow-right text-success"></i> Host your schema file<span class="text-danger">*</span>. Eg. on <a target="_blank" rel="noreferrer" href="https://github.com/">GitHub</a>
    </p>
    <p class="m-0">
      Done with that too? <i class="fas fa-arrow-right text-success"></i> Visualize, Register and share your schema here: <a href="/schema-playground">Schema Playground</a>
    </p>
  </div>
  <div id="ghOptions" class="modal" style="z-index:1000;">
    <!-- Modal content -->
    <div class="modal-content bg-light">
      <div>
        <span id="closeBtn" class="close">&times;</span>
      </div>
      <github-option></github-option>
    </div>
  </div>
</section>
{% endblock %}
{% block extra_scripts %}
<script src="https://unpkg.com/vuex"></script>
<script src="/static/js/lodash.js"></script>
<script src="/static/js/notify.min.js"></script>
<script src="/static/js/codemirror.js"></script>
<script src="https://d3js.org/d3.v3.js"></script>
<script src="/static/js/networkx.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.18.0/axios.min.js"></script>
<script src="https://unpkg.com/tippy.js@3/dist/tippy.all.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@7.28.11/dist/sweetalert2.all.min.js"></script>
<script>

$.notify.addStyle('success', {
    html: "<div><span data-notify-text/></div>",
    classes: {
      base: {
        "white-space": "nowrap",
        "background-color": "#28a745",
        "padding": "5px",
        "color":'white',
      }
    }
  });
  $.notify.addStyle('danger', {
    html: "<div class='bg-danger text-light p-1'><span data-notify-text/></div>",
    classes: {
      base: {
        "white-space": "nowrap",
        "background-color": "#dc3545",
        "padding": "5px",
        "color":'white',
      }
    }
  });
  $.notify.addStyle('warning', {
    html: "<div class='bg-danger text-light p-1'><span data-notify-text/></div>",
    classes: {
      base: {
        "white-space": "nowrap",
        "background-color": "#ffc107",
        "padding": "5px",
        "color":'white',
      }
    }
  });
  $.notify.addStyle('info', {
    html: "<div class='bg-danger text-light p-1'><span data-notify-text/></div>",
    classes: {
      base: {
        "white-space": "nowrap",
        "background-color": "#17a2b8",
        "padding": "5px",
        "color":'white',
      }
    }
  });
  $.notify.addStyle('trophy', {
    html: `<div class="bg-dark p-1 text-light">
        <i class="fas fa-thumbs-up text-success"></i> <span data-notify-text/>
      </div>`,
      classes: {
        base: {
          "white-space": "nowrap",
          "background-color": "#343a40",
          "padding": "5px",
          "color":'white',
          "border-radius":"5px"
        }
      }
  });

const store = new Vuex.Store({
  state: {
    'schema':[],
    'startingPoint':'',
    'prefix':'',
    'finalschema':
    {
      '@context':{
        "schema": "http://schema.org/",
        "rdf": "http://www.w3.org/1999/02/22-rdf-syntax-ns#",
        "rdfs": "http://www.w3.org/2000/01/rdf-schema#",
      },
      '@graph':[]
    },
    'validation':{
      "$schema": "http://json-schema.org/draft-07/schema#",
      "type": "object",
      "properties": {},
      'required':[]
    },
    'showDescriptions':false,
    'editThis':null,
    'previousPreviewProps': {},
    'validation_options': [
            {
              id: 0,
              title: 'string',
              color: '#0263fd',
              validation:{
                "type": "string"
              }
            },
            {
              id: 01,
              title: 'string(s)',
              color: '#2717a1',
              validation:{
                "oneOf": [
                  {
                    "type": "string"
                  },
                  {
                    "type": "array",
                    "items": {
                      "type": "string"
                    }
                  }
                ]
              }
            },
            {
              id: 1,
              title: 'boolean',
              color: '#d62979',
              validation:{
                "type": "boolean"
              }
            },
            {
              id: 3,
              title: 'integer',
              color: '#6e3ac5',
              validation:{
                "type": "integer"
              }
            },
            {
              id: 4,
              title: 'url',
              color: '#fc6903',
              validation:{
                "type": "string",
                "format": "uri"
              }
            },
            {
              id: 5,
              title: 'keywords',
              color: '#28908c',
              validation:{
                "oneOf": [
                  {
                    "type": "string"
                  },
                  {
                    "type": "array",
                    "items": {
                      "type": "string"
                    }
                  }
                ]
              }
            },
            {
              id: 6,
              title: 'date',
              color: '#9bbf06',
              validation:{
                "format": "date",
                "type": "string"
              }
            },
            {
              id: 7,
              title: 'enumeration',
              color: '#5a71a5',
              validation:{
                "oneOf": [
                  {
                    "type": "string",
                    "enum": ["option1", "option2", "option3"]
                  },
                  {
                    "type": "array",
                    "items": {
                      "type": "string",
                      "enum": ["option1", "option2", "option3"]
                    }
                  }
                ]
              }
            },
            {
              id: 8,
              title: 'constant',
              color: '#d8272a',
              validation:{
                "const": "Edit const value"
              }
            },
            {
              id: 9,
              title: 'object|Person',
              color: '#49414b',
              validation:{
                "@type": "Person",
                "type": "object",
                "properties": {
                  "name":      { "type": "string" },
                  "url": { "type": "string", "format": "uri" },
                },
                "required": [
                  "name"
                ]
              }
            },
            {
              id: 10,
              title: 'ontology',
              color: '#a37d00',
              validation:{
                "@type": "CreativeWork",
                "type": "string",
                "vocabulary": {
                "ontology": [
                  "[For example:]",
                  "ncbitaxon"
                  ],
                "children_of": [
                  "[For example:]",
                  "http://purl.obolibrary.org/obo/NCBITaxon_10239"
                ]
                },
                "strict": false
              },
            }
          ],
    'val_test': {
            'name':{},
            'contains_phi':{},
            'description':{},
            'size':{},
            'author':{}
          }
    
  },
  strict: true,
  mutations: {
    toggleDesc(state){
      state.showDescriptions = !state.showDescriptions
    },
    saveSchema(state,payload){
      state.schema.push(payload['schema']);
      state.startingPoint=payload['start'];
      // console.log('🍕🍕🍕 saved schema..🍕🍕🍕',state.schema);
    },
    setValidation(state,payload){
      // console.log(state.finalschema)
      let item = payload['validation']
      let name = payload['name']
      let newval = Object.assign({}, state.finalschema['@graph'][0]['$validation']['properties'][name], item['validation'])
      // console.log('merged', newval)
      Vue.set(state.finalschema['@graph'][0]['$validation']['properties'], name, newval)

      // let item = payload['validation']
      // let name = payload['name']
      // Vue.set(state['val_test'], name, item['validation'])
    },
    updateValidationOptions(state,payload){
      let v = payload['validation']
      Vue.set(state, 'validation_options', v)
      // console.log('validation updated from localStorage')
    },
    resetValidationFor(state,payload){
      let name = payload['name']
      let obj = {}
      try {
        obj.description = state.finalschema['@graph'][0]['$validation']['properties'][name]['description']
      } catch (error) {
        obj = {}
      }
      Vue.set(state.finalschema['@graph'][0]['$validation']['properties'], name, obj)
      Swal.fire({type:'success',
                toast:true,
                title: 'Validation Cleared',
                showConfirmButton:false,
                timer:1000})
      // Vue.set(state['val_test'], name, {})
    },
    addValidationOption(state,payload){
      let item = payload['validation']
      state.validation_options.push(item)
      localStorage.setItem('custom_validation', JSON.stringify(state.validation_options) );

      Swal.fire({type:'success',
                toast:true,
                title: 'Option Added',
                showConfirmButton:false,
                timer:1000})
    },
    editValidationItem(state,payload){
      let itemID = payload['item']['id']
      let newitem = payload['item']
      for (let i = 0; i < state.validation_options.length; i++) {
        let item = state.validation_options[i];
        if (item.id == itemID) {
          Vue.set(state.validation_options, i, newitem)
          state.editThis = null
          Swal.fire({type:'success',
                toast:true,
                title: 'Edits Saved',
                showConfirmButton:false,
                timer:1000})
        }
      }
      localStorage.setItem('custom_validation', JSON.stringify(state.validation_options) );
    },
    editThis (state,payload){
      let item = payload['item']
      state.editThis = item;
    },
    savePrefix(state,payload){
      state.prefix = payload['prefix'];
      Vue.set(state.finalschema['@context'],state.prefix,'http://discovery.biothings.io/view/')
    },
    saveParent(state,payload){
      let parent = payload['parent']
      // sort props alphabetically
      if (parent.hasOwnProperty('properties')) {
        parent.properties = _.orderBy(parent.properties, ['label'], ['asc']);
      }
      state.schema.push(parent)
    },
    addClass(state,payload){
      let newClass = {};
      newClass['special'] = true
      newClass['label'] = payload['name']
      newClass['description'] = payload['description']
      newClass['name'] = state.prefix+":"+payload['name']
      newClass['prefix'] = state.prefix
      newClass['parent_classes'] = [state.schema[0].name]

      state.schema.unshift(newClass)
    },
    addProperty(state,payload){
      let newProp = {};
      newProp['label'] = payload['name']
      newProp['description'] = payload['description']
      newProp['name'] = state.prefix+":"+payload['name']
      newProp['range'] = payload['range']
      newProp['domain'] = state.prefix+":"+payload['domain']
      // if new prop added it should appear in validation by default
      newProp['selected'] = payload['special']

      for (var i = 0; i < state.schema.length; i++) {
        if (state.schema[i].special) {
          if (state.schema[i].hasOwnProperty('properties')) {
            state.schema[i].properties.push(newProp)
          }else if (!state.schema[i].hasOwnProperty('properties')) {
            Vue.set(state.schema[i],'properties',[])
            state.schema[i].properties.push(newProp)
          }

        }
      }
    },
    selectProp(state,payload){
      let label = payload['label']
      for (var i = 0; i < state.schema.length; i++) {
        if (state.schema[i].hasOwnProperty('properties')) {
          for (var x = 0; x < state.schema[i]['properties'].length; x++) {
            if (state.schema[i]['properties'][x].hasOwnProperty('label') && state.schema[i]['properties'][x].label === label) {
              if (state.schema[i]['properties'][x].hasOwnProperty('selected')) {
                Vue.set(state.schema[i]['properties'][x],'selected',!state.schema[i]['properties'][x]['selected'])
                //If unselected also mark as not required
                if (!state.schema[i]['properties'][x]['selected']) {
                  Vue.set(state.schema[i]['properties'][x],'isRequired',false)
                }
              }else{
                Vue.set(state.schema[i]['properties'][x],'selected',true)
              }
            }
          }
        }
      }
    },
    requireProp(state,payload){
      let label = payload['label']
      for (var i = 0; i < state.schema.length; i++) {
        if (state.schema[i].hasOwnProperty('properties')) {
          for (var x = 0; x < state.schema[i]['properties'].length; x++) {
            if (state.schema[i]['properties'][x].hasOwnProperty('label') && state.schema[i]['properties'][x].label === label) {
              if (state.schema[i]['properties'][x].hasOwnProperty('isRequired')) {
                Vue.set(state.schema[i]['properties'][x],'isRequired',!state.schema[i]['properties'][x]['isRequired'])
              }else{
                Vue.set(state.schema[i]['properties'][x],'isRequired',true)
              }
            }
          }
        }
      }
    },
    removeProperty(state,payload){
      let label = payload['label']
      for (var i = 0; i < state.schema.length; i++) {
        if (state.schema[i].special) {
          for (var x = 0; x < state.schema[i].properties.length; x++) {
            if (state.schema[i].properties[x].label === label) {
              state.schema[i].properties.pop(x)
              $.notify(label+" deleted",{ globalPosition: 'right',style:'info', showDuration: 200, });
            }
          }
        }
      }
    },
    formPreview(state){
      try {
        state.previousPreviewProps = state.finalschema['@graph'][0]['$validation']['properties'];
      } catch (error) {
        console.log('NO previousPreviewProps', state.previousPreviewProps)
      }
      if (_.size(state.previousPreviewProps)) {
        console.log('previousPreviewProps found', state.previousPreviewProps)
      }
      Vue.set(state.finalschema,'@graph',[]);
      Vue.set(state.validation,'properties',{});
      Vue.set(state.validation,'required',[]);

      for (var i = 0; i < state.schema.length; i++) {
        if (state.schema[i].special) {
          //Add Main Class to Graph
          let mainClass={};
          Vue.set(mainClass,'@id',state.schema[i]['name'])
          Vue.set(mainClass,'@type','rdfs:Class')
          Vue.set(mainClass,'rdfs:comment',state.schema[i]['description'])
          Vue.set(mainClass,'rdfs:label',state.schema[i]['label'])
          Vue.set(mainClass,'rdfs:subClassOf',{"@id": state.startingPoint})
          Vue.set(mainClass,'$validation',state.startingPoint)
          //Add New Class
          state.finalschema['@graph'].push(mainClass)
          //Handle main Class Properties
          if (state.schema[i].properties) {
            for (var x = 0; x < state.schema[i].properties.length; x++) {

              let mainProp = {};
              Vue.set(mainProp,'@id',state.schema[i].properties[x]['name'])
              Vue.set(mainProp,'@type','rdfs:Property')
              Vue.set(mainProp,'rdfs:comment',state.schema[i].properties[x]['description'])
              Vue.set(mainProp,'rdfs:label',state.schema[i].properties[x]['label'])
              Vue.set(mainProp,'schema:domainIncludes',{'@id':state.schema[i]['name']})
              //Ranges of Property
              if (state.schema[i].properties[x]['range']) {
                let ranges= state.schema[i].properties[x]['range'].split(',');
                Vue.set(mainProp,'schema:rangeIncludes',[])
                for (var rangeIndex = 0; rangeIndex < ranges.length; rangeIndex++) {
                  mainProp['schema:rangeIncludes'].push({'@id':ranges[rangeIndex]})
                }
              }
              if (state.schema[i].properties[x].selected) {
                let propValue={};

                if (state.previousPreviewProps.hasOwnProperty(state.schema[i].properties[x].label)) {
                  // keep existing validation if any
                  propValue = Object.assign({}, state.previousPreviewProps[state.schema[i].properties[x].label])
                }else{
                  //for first time add description
                  Vue.set(propValue,'description',state.schema[i].properties[x].description)
                }
                Vue.set(state.validation['properties'],state.schema[i].properties[x].label,propValue)
              }
              if (state.schema[i].properties[x].isRequired) {
                let p = state.schema[i].properties[x].label;
                if (!state.validation['required'].includes(p)) {
                  state.validation['required'].push(p)
                }
              }
              //Add New Prop
              state.finalschema['@graph'].push(mainProp)
            }
          }
        }else{
          //Handle Parent Classes
          if (state.schema[i].hasOwnProperty('properties')) {
            let myLabel = "";
            for (let y = 0; y < state.schema[i].properties.length; y++){
              if (state.schema[i].properties[y].selected) {
                let propValue={};
                let prop_label = state.schema[i].properties[y]['label'];
                if (state.previousPreviewProps.hasOwnProperty(prop_label)) {
                  // keep existing validation if any
                  propValue = Object.assign({}, state.previousPreviewProps[prop_label])
                }else{
                  //for first time add description
                  Vue.set(propValue,'description',state.schema[i].properties[y].description)
                }
                myLabel = state.schema[i].properties[y].label;
                Vue.set(state.validation['properties'],myLabel,propValue)
              }
              if (state.schema[i].properties[y].isRequired) {
                if (!state.validation['required'].includes(myLabel)) {
                  state.validation['required'].push(myLabel)
                }
              }
              //Once done add temp validation to finalschema
              if (state.finalschema['@graph'].length) {
                Vue.set(state.finalschema['@graph'][0],'$validation',state.validation)
              }
            }
          }
        }
      }
    }
  },
  getters:{
    getSchema:state=>{
      return state.schema
    },
    getEditItem:state=>{
      return state.editThis
    },
    getValidationProps:state=>{
      return state.validation['properties']
      // return state.val_test
    },
    getValidationOptions:state=>{
      return state.validation_options
    },
    getStartingPoint:state=>{
      return state.startingPoint
    },
    getPrefix:state=>{
      return state.prefix
    },
    getFinalSchema:state=>{
      return state.finalschema
    },
    getShowDesc:state=>{
      return state.showDescriptions
    },
    isDuplicateProp: (state) => (name) =>{
      for (var i = 0; i < state.schema.length; i++) {
        if (state.schema[i] && state.schema[i].hasOwnProperty('properties')) {
          let props = state.schema[i]['properties']
          for (var x = 0; x < props.length; x++) {
            if (props[x]['label'] === name) {
              return true
            }
          }
        }
      }
      return false
    },
    isDuplicateClass: (state) => (name) =>{
      for (var i = 0; i < state.schema.length; i++) {
        if (state.schema[i] && state.schema[i].hasOwnProperty('label')) {
          if (state.schema[i]['label'] === name) {
            return true
          }
        }
      }
      return false
    }
  },
  actions:{
    getParents ({commit,state}) {
      let list =[];
      for (var i = 0; i < state.schema[0].parent_classes.length; i++) {
        list = list.concat(state.schema[0].parent_classes[i].split(", ").reverse())
      }
      let uniqueParents = new Set(list)
      let pList = [...uniqueParents]
      // console.log('pList',pList)
      for (var i = 0; i < pList.length; i++) {
        state.loading = true;
        let url = "api/registry/"+state.schema[0].namespace+"/"+pList[i]
        axios.get(url).then(res=>{
          if (res.data) {
            commit('saveParent',{'parent':res.data})
          }
        }).catch(err=>{
          console.warn("Failed query for class info "+url)
          throw err;
        })
      }
    }
  }
});

Vue.component('ngx-graph', {
    data: function(){
      return{
        nxG: null, 
        edgeGraph:[],
      }
    },
    computed:{
      classesAvailable:function(){
        return store.getters.getSchema
      },
    },
    methods:{
      makeGraph(){
        var self = this;

        self.nxG = new jsnx.DiGraph();

        self.classesAvailable.forEach( cls => {
          self.addNode(cls.name);
          if (cls.hasOwnProperty('parent_classes')) {
            let parents = cls.parent_classes[0].split(',');
            self.addEdge(cls.name, parents[parents.length - 1]);
          }
        });

        self.drawGraph();
      },
      addEdge(class1,class2){
        // console.log('%c addEdge','color:hotpink')
        // console.log(class1,class2)
        this.nxG.addEdge(class1,class2);
      },
      addNode(className){
        console.log('%c add Node','color:limegreen')
        console.log(className)
        this.nxG.addNode(className,{'label':className});
      },
      drawGraph(){
        var self = this;
        console.log('draw', self.nxG)
        jsnx.draw(self.nxG, {
            element: '#classGraph',
            weighted: true,
            edgeStyle: {
                'stroke-width': 10,
                'fill': '#b4b4b4'
            },
            layoutAttr: {
                charge: -800,
                linkDistance: 100
            },
            height:200,
            labelStyle: {fill: '#5C3069'},
            withLabels: true,
            nodeLabels: 'label',
            nodeStyle: {
                'stroke': '#8feddc',
                'fill': '#84dcdf',
                'cursor': 'pointer',
                'nodeShape':'s'
            }
        });
      },
    },
    watch: {
      
    },
    mounted: function(){
      this.makeGraph()
    },
    template:`<div id="classGraph" class="border border-secondary rounded"></div>`
  });

Vue.component('editor', {
    data: function(){
      return{
        editor : null
      }
    },
    computed:{
      item(){
        return store.getters.getEditItem
      }
    },
    methods:{
      SaveDefinition(){
        let self = this;
        let value = self.editor.getValue();
        let copy = Object.assign({}, self.item);
        copy.validation = JSON.parse(value)
          let payload = {
            'item': copy
          }
        store.commit('editValidationItem', payload)
      }
    },
    watch: {
      item: function(v){
        let self = this;
        if (v) {
          self.editor.setValue(JSON.stringify(self.item.validation,null,2));
        }
      }
    },
    mounted: function(){
      let self = this;
      self.editor = CodeMirror.fromTextArea(document.getElementById("code"), {
          mode: "json",
          lineNumbers: true,
      });
    },
    template:`<div>
                <textarea id="code" name="code"></textarea>
                <div>
                  <button type="button" class="btn btn-success w-100" @click="SaveDefinition()">Save</button>
                </div>
              </div>`
  });

Vue.component('validation-dropzone', {
    props: ['propname', 'val', 'validation_options'],
    data: function(){
      return{
        matches : []
      }
    },
    methods:{
      allowDrop(ev) {
        $(ev.target).attr("drop-active", true);
        ev.preventDefault();
      },
      startDrag: (evt, item) => {
        let img = new Image(); 
        img.src = '/static/img/cubeplus.svg'; 
        evt.dataTransfer.setDragImage(img, 10, 10);

        evt.dataTransfer.dropEffect = 'move'
        evt.dataTransfer.effectAllowed = 'move'
        evt.dataTransfer.setData('itemID', item.id)
      },
      onDrop (evt, name) {
        let self = this;
        self.matches = [];
        const itemID = evt.dataTransfer.getData('itemID')
        const item = this.validation_options.find(item => item.id == itemID)
        self.matches.push(item)
        let payload = {
          'validation':item,
          'name':name
          }
        let audio = document.getElementById("dropsound");
        audio.play();
        store.commit('setValidation', payload);
      },
      allowDrop(ev) {
        $(ev.target).attr("drop-active", true);
        ev.preventDefault();
      },
      leaveDrag(ev) {
        $(ev.target).removeAttr("drop-active");
        ev.preventDefault();
      },
      resetValidation(){
        let self = this;
        let payload = {
          'name': self.propname
        }
        self.matches = [];
        store.commit('resetValidationFor', payload);
      }
    },
    watch:{
    },
    template:
      `<div class="row m-0 valBox bg-dark m-1">
        <div class="col-sm-12 col-md-5">
          <small class="text-light" v-text="propname"></small>
          <i class="far fa-times-circle pointer text-warning" @click="resetValidation()" data-tippy-info="Clear Validation"></i>
        </div>
        <div class="col-sm-12 col-md-7 p-1 text-success drop-zone" @drop='onDrop($event, propname)' @dragleave="leaveDrag($event)" @dragover="allowDrop($event);" @dragenter.prevent>
          <template v-for='item in matches'>
            <div v-if="val.type === item.validation.type" :data-tippy-info="JSON.stringify(item.validation,null,2)" :style="{ 'background-color': item.color }" class='badge drag-el m-1' :key='item.title' draggable @dragstart='startDrag($event, item)' v-text="item.title"></div>
          </template>
          <small>
          <pre v-text="JSON.stringify(val,null,2)"></pre>
          </small>
        </div>
      </div>`
  });

Vue.component('github-option', {
  data: function(){
    return{
      repoName: '',
      repos: [],
      loading: false,
      repo_selected: '',
      name_selected: '',
      comment: '',
      accepts: false,
      repo_saved: false,
      repo_link: '',
      existing_file: true,
      files_available: [],
      file_selected: '',
      slug: '',
      number: 0,
      input: '',
      data: [],
    }
  },
  props: [],
  methods:{
    resetFields(){
      let self = this;
      self.loading = true;
      setTimeout(function(){
        self.repo_selected = '';
        self.name_selected = '';
        self.comment = '';
        self.repo_saved = false;
        self.repo_link = '';
        self.files_available = [];
        self.file_selected = '';
      }, 1000);
      self.loading = false;
    },
    checkRepo(){
      let self = this;
      self.loading = true;
      axios.get("/api/gh/"+self.repoName).then(res=>{
        self.loading = false;
        if (res.data.success) {
          return "https://github.com/"+res.data.msg
        }else{
          Swal.fire({
            type: 'error',
            title: 'Unsuccesful...',
            text: JSON.stringify(res.data, null, 2),
          })
        }
      }).catch(err=>{
        self.loading = false;
        Swal.fire({
          type: 'error',
          title: 'Oops...Something went really wrong!',
          text: err,
        })
        throw err;
      });
    },
    getRepos(){
      var self = this;
      self.loading = true;
      axios.get("/api/gh").then(res=>{
        self.loading = false;
        if (res.data.success) {
          self.repos = res.data.msg
        }else{
          Swal.fire({
            type: 'error',
            title: 'Problems getting your repos, try again later.',
            text: JSON.stringify(res.data, null, 2),
          })
        }
      }).catch(err=>{
        self.loading = false;
        Swal.fire({
          type: 'error',
          title: 'Oops...Something went really wrong!',
          text: err,
        })
        throw err;
      });
    },
    updateFile(){
      let self = this;

      data ={
        'name': self.repo_selected,
        'file': self.name_selected,
        'data': store.getters.getFinalSchema,
        'existing': true,
        'comment': self.comment,
        'existing_file': true
      }

      let config = {
         headers: {
           'content-type': 'application/json'
         }
       }

      self.loading = true;

      return axios.put("/api/gh", data, config).then(res=>{
        self.loading = false;
        if (res.data.success) {
          self.repo_saved = true;
          self.repo_link = "https://github.com/"+res.data.msg
        }else{
          self.repo_saved = false;
          Swal.fire({
            type: 'error',
            title: 'Problems updating your file, please try again later.',
            text: JSON.stringify(res.data, null, 2),
          })
        }
      }).catch(err=>{
        self.loading = false;
        self.repo_saved = false;
        Swal.fire({
          type: 'error',
          title: 'Oops...Something went wrong!',
          text: err,
        })
        throw err;
      });
    },
    saveWork(){
      let self = this;

      if (self.existing_file === true) {
        console.log("updating file")
        self.updateFile()
      }else{
        data ={
          'name': self.repo_selected,
          'file': self.name_selected+'.jsonld',
          'data': store.getters.getFinalSchema,
          'existing': true,
          'comment': self.comment,
        }

        let config = {
           headers: {
             'content-type': 'application/json'
           }
         }

        self.loading = true;

        return axios.post("/api/gh", data, config).then(res=>{
          self.loading = false;
          if (res.data.success) {
            self.repo_saved = true;
            self.repo_link = "https://github.com/"+res.data.msg
          }else{
            self.repo_saved = false;
            Swal.fire({
              type: 'error',
              title: 'Problems saving to GitHub, please try again later.',
              text: JSON.stringify(res.data, null, 2),
            })
          }
        }).catch(err=>{
          self.loading = false;
          self.repo_saved = false;
          Swal.fire({
            type: 'error',
            title: 'Oops...Something went wrong!',
            text: err,
          })
          throw err;
        });
      }
    },
    assignTempName(hits){
      let self = this;
      if (hits.length) {
        if (hits[0].hasOwnProperty('namespace')) {
          self.slug = hits[0]['namespace'];
        }else if (hits[0].hasOwnProperty('name')) {
          self.slug = hits[0]['name'].split(':')[0];
        }
        else{
          self.slug = 'temp'
        }
        var modal = document.getElementById("ghOptions");
        modal.style.display = "none";
        self.makeURLandRedirect();
      }else{
        Swal(
          'Error parsing schema',
          "No classes found",
          'error'
        );
      }
    },
    sendRequest(){
      let self = this;
      self.loading = true;
      axios.get("/api/view?url="+self.input).then(res=>{
        console.log(res.data)
        self.data = res.data;
        self.loading = false;
        localStorage.setItem('user-schema-classes',JSON.stringify(self.data));
        localStorage.setItem('user-schema-url',self.input);
        self.assignTempName(res.data.hits);
      }).catch(err=>{
        self.loading = false;
        self.loading = false;
        // console.log('err',err.response.data)
        let culprit = "<h6>"+err.response.data.error+"</h6>"
        if (err.response.data && err.response.data.path) {
          culprit += "<h5>Culprit <i class='fas fa-arrow-right'></i> <b class='text-danger'>"+err.response.data.path+"</b></h5>"
        }
        if (err.response.data.parent && err.response.data.parent.path){
          if (true) {
            culprit += "<h5>Under <i class='fas fa-arrow-right'6</i> <b class='text-danger'>"+err.response.data.parent.path+"</b></h5>"
          }
          if (err.response.data.parent && err.response.data.parent.reason) {
            culprit += "<div class='alert alert-warning'><small>"+err.response.data.parent.reason+"</small></div>"
          }
        }
        if (err.response.data.hasOwnProperty('validator_value') && err.response.data.validator_value.length){
          culprit += "<div class='alert alert-info'><small> Hint: "+err.response.data.validator_value+"</small></div>"
        }
        Swal.fire({
          type: 'error',
          position: 'top center',
          title: 'Failed because: ',
          html: culprit,
        });
        throw err;
      })
    },
    makeURLandRedirect(){

      this.setLastViewed();

      Swal.fire({
        title: 'Visualization Ready',
        text: "Do you want to see it now?",
        icon: 'success',
        showCancelButton: true,
        confirmButtonText: "Let's see it!"
      }).then((result) => {
        if (result.isConfirmed) {
          window.open(
            "./view/"+this.slug+this.number+"/",
            '_blank'
          );
        }
      });
    },
    setLastViewed(){
      this.number = Math.floor(Math.random()*90000) + 10000;
      let temp = this.slug+this.number;
      sessionStorage.clear();
      sessionStorage.setItem(temp,localStorage.getItem('user-schema-classes'));
      sessionStorage.setItem(temp+'-url',localStorage.getItem('user-schema-url'));
    },
    copyToInput(value){
      let self = this;
      if (value.includes('blob') || value.includes('github.com')) {
        let suggestedURL = value.replace('blob/', '')
        .replace('github.com', 'raw.githubusercontent.com')
        .replace('www.github.com', 'raw.githubusercontent.com');;

        Swal({
          title: 'Link Converted',
          imageAlt: 'Warning',
          animation:false,
          customClass:'scale-in-center',
          html:
            '<p>We will need the direct link tot he raw data and have changed your url.</p> ' +
            '<p><a target="_blank" href="'+suggestedURL+'">'+suggestedURL+'</a></p>' +
            '<p>Proceed with this link?</p>',
          showCancelButton: true,
          confirmButtonColor:"{{color_main}}",
          cancelButtonColor:"{{color_sec}}",
          confirmButtonText: 'Yes, use this link!'
        }).then((result) => {
          if (result.value) {
            self.input = suggestedURL
          }else{
            self.input = value
          }
        });
      }
    }
  },
  computed: {
    code:function(){
      return store.getters.getFinalSchema
    },
    readyLink: function(){
      let self = this;
      if (self.existing_file) {
        return self.repo_link+"/blob/main/"+self.name_selected
      }else {
        return self.repo_link+"/blob/main/"+self.name_selected+".jsonld"
      }
    }
  },
  watch:{
    repo_selected:function(name,oldname){
      let self = this;
      self.loading = true;
      return axios.get("/api/gh/"+name).then(res=>{
        self.loading = false;
        if (res.data.success) {
          self.files_available = res.data.msg
        }else{
          Swal.fire({
            type: 'error',
            title: 'Problems saving to GitHub, please try again later.',
            text: JSON.stringify(res.data, null, 2),
          })
        }
      }).catch(err=>{
        self.loading = false;
        Swal.fire({
          type: 'error',
          title: 'Oops...Something went wrong!',
          text: err,
        })
        throw err;
      });
    },
  },
  template:
  `<div class="bg-light" style="position: relative;">
    <h4 class="logoText text-center m-2"><i class="fab fa-github-alt"></i> Save your work to GitHub</h4>
    <p class="text-dark w-50 m-auto mb-2">
      <small><i class="fas fa-exclamation-circle text-info"></i> By continuing with this process you are giving us permission to access your GitHub account to create/edit <b>public</b> repos/files.
      If you DO NOT accept this please close this window and choose the <b>Download</b> option to save manually.</small>
    </p>
    <div v-if="!accepts">
      <h3 class="pointer text-center text-success m-4" @click="accepts = true">Continue</h3>
    </div>
    <div v-else class="row m-0 slit-in-vertical">
      <div class="text-center col-sm-12 m-auto" v-if="loading" style="position: absolute; top:45%; z-index:2000;">
        <i class="fab fa-github-alt fa-spin fa-5x p-2 text-info"></i>
      </div>
      <div class="col-sm-12 col-md-4 border p-1" :class="[repo_selected?'alert-success':'alert-light']">
        <h6 class="logoText">1. Choose a repository</h6>
        <small class="text-muted">Choose an existing repository to save your work to.</small>
        <button type="button" class="btn themeButton text-light btn-sm" @click="getRepos()"><i class="fab fa-github-alt"></i> Get Repos</button>
        <template v-if="repos.length">
        <h6 class="text-muted">1. Choose one:</h6>
        <select class="custom-select w-100" v-model="repo_selected">
          <option selected>Choose...</option>
          <template v-for="repo in repos">
            <option :value="repo" v-text="repo"></option>
          </template>
        </select>
        </template>
        <template v-else>
          <p>
            <small class="text-muted">No results yet</small>
          </p>
        </template>
      </div>
      <div class="col-sm-12 col-md-4 border p-1" :class="[name_selected?'alert-success':'alert-light']">
        <h6 class="logoText">2. Choose file</h6>
        <small class="text-muted">Create or update an existing file.</small>
        <div v-if="repo_selected">
          <small class="text-info d-block" v-if="!existing_file">Do not include the file extension. It will be <code>.jsonld</code>.</small>
          <h6 class="text-muted">Create/Update File</h6>
          <input @change="name_selected=''" v-model="existing_file" class="form-control text-light tip m-auto slider" type="checkbox" checked/>
        </div>
        <template v-if="repo_selected && !existing_file">
          <small class="text-info bold">A. New File: Name your file (without extension)</small>
          <div class="form-group row">
            <div class="col-sm-10">
              <input :disabled="!repo_selected" :class="{disabled:!repo_selected}" v-model="name_selected" type="text" class="form-control form-control-sm" placeholder="enter your file name here">
            </div>
          </div>
        </template>
        <template v-if="repo_selected && existing_file">
          <small class="text-info bold">A. Update File: Select one</small>
          <select :disabled="!repo_selected" class="custom-select w-100" v-model="name_selected">
            <option selected>Choose...</option>
            <template v-for="file in files_available">
              <option :value="file" v-text="file"></option>
            </template>
          </select>
        </template>
        <template v-if="repo_selected">
          <small class="text-muted d-block"><span class="text-info">B. (Optional)</span> Write a comment about this addition.</small>
          <div class="form-group row">
            <div class="col-sm-10">
              <input :disabled="!repo_selected" :class="{disabled:!repo_selected}" v-model="comment" type="text" class="form-control form-control-sm" placeholder="write a comment here">
            </div>
          </div>
        </template>
        <div>
<pre>
<code v-text="code" style="font-size:.5em; max-height:300px;"></code>
</pre>
        </div>
      </div>
      <div class="col-sm-12 col-md-4 border p-1" :class="[repo_saved?'alert-success':'alert-light']">
        <h6 class="logoText">3. Save to GitHub</h6>
        <small v-if="!existing_file" class="text-muted">A new file will be saved to this repository.</small>
        <small v-else class="text-muted">The file chosen will be updated with your work.</small>
        <div class="text-muted text-center">
          <template v-if="name_selected && repo_selected">
            <h5 class="my-3"><span class="text-info" v-text="existing_file?'Update':'Create'"></span>: <b v-text="repo_selected"></b>/<code v-text="name_selected"></code>?</h5>
            <button type="button" class="btn btn-success text-light btn-sm" @click="saveWork()"><i class="fab fa-github-alt"></i> <span v-text="existing_file?'Update':'Save'"></span></button>
          </template>
          <template v-else>
            <small class="d-block"><i class="fab fa-github-alt fa-2x"></i></small>
          </template>
        </div>
        <div v-if="repo_saved && repo_link" class="text-center mt-3">
          <h6><i class="fas fa-check"></i> Work <span v-text="existing_file?'Updated':'Saved'"></span>!</h6>
          <small>
            <a :href="repo_link" target="_blank" rel="nonreferrer"><b v-text="repo_link"></b> <i class="fas fa-external-link-alt"></i></a>
          </small>
        </div>
      </div>
      <div class="col-sm-12 grad border border-success p-2 text-center" v-if="repo_link">
        <p class="text-light mt-2 text-center">
          <template v-if="readyLink">
            <img src="/static/img/visualize-01.png" width="100px" alt="Visualize"/>
            <h5>Visualize and register your work</h5>
            <small  @click="copyToInput(readyLink)" class="pointer d-block">CLICK HERE to copy to input</small>
            <code v-text="readyLink"></code>
            <h5><i class="fas fa-arrow-down"></i></h5>
            <form id="linkForm" class="col-sm-6 m-auto">
              <div v-if="!loading" class="input-group mb-3 shadow rounded">
                <input type="text" class="form-control" v-model="input" id="urlform" autocomplete="" required ref="my_input" aria-label="Paste your link here"  placeholder="Paste your link here" aria-describedby="button-addon2">
                <div class="input-group-append">
                  <button :disabled="!input.length" :class="{heartbeat:input.length}" @click.prevent="sendRequest()" id="button-addon2" class="btn btn-info" type="submit">Go</button>
                </div>
              </div>
              <div v-else>
                <h3 class="text-light"><i class="fas fa-cog fa-spin"></i> Please Wait...</h3>
              </div>
            </form>
          </template>
        </p>
      </div>
      <div class="col-sm-12 alert-secondary border p-1 text-center">
        <small>New changes or want to reset? <b @click="resetFields()" class="pointer text-danger">click here</b></small>
      </div>
    </div>
  </div>`
});

Vue.component('c-box', {
  props: ['item'],
  data: function(){
    return{
      expand: false,
      addPropMode: false,
      newPropName:'',
      propExists: false,
      newPropDescription:'',
      newPropDomain:'',
      newPropRange:[],
      rangeOptions: [],
      query:'',
      filtered: [],
      // pagination
      perPage: 20,
      page: 1,
      pages: 1,
      startCap:0,
      endCap:20,
      groupPages: false,
      pageLimit: 20,
      startCapLimitReached: true,
      endCapLimitReached: false,
      // prop totals
      totals:{}
    }
  },
  computed:{
    showDesc:function(){
      return store.getters.getShowDesc
    },
    addNewPropReady: function(){
      return this.newPropName && this.newPropDescription ? this.newPropDomain && this.newPropRange.length ? true : false : false;
    },
    paginatedResults: function () {
        var start = (this.page - 1) * this.perPage,
            end = start + this.perPage;
        return this.item.properties && this.item.properties.slice(start, end);
    },
  },
  watch:{
    newPropName: function(v){
      this.propExists = store.getters.isDuplicateProp(v);
    },
    query: function(q){
      if (q) {
        this.filtered = this.item.properties.filter( prop => prop['label'].includes(q))
      }else{
        this.filtered = []
      }
    }
  },
  mounted:function(){

    if (this.item.special) {
      this.getRangeOptions();
      this.expand = true;
    }else{
      this.calculatePages();
    }

    this.updateTotals();

    tippy( '#editorTippy', {
        target:'.cTip',
        interactive:'true',
        content: 'Loading...',
        placement:'right',
        animation: 'fade',
        trigger:'click',
        theme:'light',
        onShow(instance) {
          let desc = instance.reference.dataset.tippyDescription;
          instance.setContent("<div class='text-muted m-0 text-left wraptext'>"+desc+"</div>")
        }
      });
      tippy( '.expand', {
        maxWidth:'200px',
        placement:'top',
        content: '<div class="text-muted m-0" style="border-radius:none">Show/Hide Properties</div>',
        animation: 'fade',
        theme:'light'});

        tippy( '.addprop', {
          maxWidth:'200px',
          placement:'top',
          content: '<div class="text-muted m-0" style="border-radius:none">Add New Property</div>',
          animation: 'fade',
          theme:'light'});

      tippy( '.required', {
        maxWidth:'200px',
        placement:'top',
        content: '<div class="text-danger m-0" style="border-radius:none">Mark As Required</div>',
        animation: 'fade',
        theme:'light'});

      tippy( '.select', {
        maxWidth:'200px',
        placement:'top',
        content: '<div class="text-muted m-0" style="border-radius:none">Re-Use This Property</div>',
        animation: 'fade',
        theme:'light'});

        tippy( '.remove', {
          maxWidth:'200px',
          placement:'top',
          content: '<div class="text-danger m-0" style="border-radius:none">Delete Property</div>',
          animation: 'fade',
          theme:'light'});
  },
  template: `<div class="row m-1 cBox actions" :class="{'alert-info mb-3':item.special,'alert-light':!item.special}">
              <div class="col-sm-10 p-2">
                <div>
                  <i v-if="item.special" class="fas fa-star text-warning"></i>
                  <template v-if="item.parent_classes.length" v-for="tree in item.parent_classes">
                    <template v-for="(name,i) in getSubclass(tree)">
                      <small v-text="name"></small>
                      <small><i class="fas fa-chevron-right"></i></small>
                    </template>
                  </template>
                  <small class="bold"><span v-text="item.label"></span> <i class="fas fa-info-circle text-info cTip pointer" :data-tippy-description="item.description" :data-tippy-label="item.label"></i></small class="bold">
                  <!-- 🌈 prop totals 🌈 -->
                  <div v-if="totals" class="float-right">
                    <table>
                    <tr>
                      <td v-for="(val, name) in totals" class="px-1"> 
                        <small>
                          <i v-if="name == 'required'" class="fas fa-asterisk text-danger"></i>
                          <i v-else-if="name == 'selected'" class="fas fa-check-circle text-success"></i> 
                          <i v-else v-text="name"></i> : <b v-text="val" :class="[val?'text-primary':'text-muted']"></b> 
                        </small>
                      </td>
                    </tr>
                    </table>
                  </div>
                  <small v-if="item.special && !item.properties" class="text-muted float-right">Add properties here <i class="fas fa-arrow-right text-danger"></i></small>
                  <template v-if="showDesc">
                    <small class="d-block text-muted" v-html="item.description || 'No description provided'"></small>
                  </template>
                </div>

                <!-- 🌈 selected list 🌈 -->
                <div v-if="!item.special" class="">
                  <template v-if="item && item.properties" v-for="prop in item.properties">
                    <small v-if="prop.selected" class="badge badge-success m-1">
                      <i v-if="prop && prop.isRequired" class="fas fa-asterisk text-danger"></i> <span v-text="prop.label"></span>
                    </small>
                  </template>
                </div>

                <div v-show='expand' class="mt-1">
                  <div class="p-1 bg-secondary" v-if="!item.special && item.properties.length > perPage">
                    <!-- 🌈 filter by name 🌈 -->
                    <div>
                      <input type="text" class="form-control form-control-sm col-sm-6" placeholder="search properties" v-model="query">
                    </div>

                    <!-- 🌈 filtered 🌈 -->
                    <template v-for="prop in filtered">
                      <div class="row m-1 alert-secondary pBox actions">
                        <div class="col-sm-9">
                          <small class="text-dark">
                            <span v-text="prop.label"></span> <i class="fas fa-info-circle cTip pointer text-info" :data-tippy-description="prop.description" :data-tippy-label="prop.label"></i>
                            <template v-if="showDesc">
                              <small class="d-block text-muted" v-html="prop.description || 'No description provided'"></small>
                            </template>
                          </small>
                        </div>
                        <div class="col-sm-3 bg-dark actions d-flex align-items-center justify-content-around">
                          <i v-show="item.special" class="fas fa-minus-circle pointer text-muted unselectable remove" @click="removeProp(prop.label)"></i>
                          <i class="fas fa-check-circle pointer unselectable select" @click="markSelected(prop.label)" :class="{'text-muted':!prop.selected,'text-success':prop.selected}"></i>
                          <i class="fas fa-asterisk required pointer unselectable" @click="markRequired(prop.label)" :class="{'text-muted':!prop.isRequired,'text-danger':prop.isRequired}"></i>
                        </div>
                      </div>
                    </template>
                  </div>

                  <!-- 🌈 results 🌈 -->
                  <template v-for="prop in paginatedResults">
                    <div class="row m-1 alert-secondary pBox actions">
                      <div class="col-sm-9">
                        <small class="mainTextDark">
                          <span v-text="prop.label"></span> <i class="fas fa-info-circle cTip pointer text-info" :data-tippy-description="prop.description" :data-tippy-label="prop.label"></i>
                          <template v-if="showDesc">
                            <small class="d-block text-muted" v-html="prop.description || 'No description provided'"></small>
                          </template>
                        </small>
                      </div>
                      <div class="col-sm-3 bg-dark actions d-flex align-items-center justify-content-around">
                        <i v-show="item.special" class="fas fa-minus-circle pointer text-muted unselectable remove" @click="removeProp(prop.label)"></i>
                        <i class="fas fa-check-circle pointer unselectable select" @click="markSelected(prop.label)" :class="{'text-muted':!prop.selected,'text-success':prop.selected}"></i>
                        <i class="fas fa-asterisk required pointer unselectable" @click="markRequired(prop.label)" :class="{'text-muted':!prop.isRequired,'text-danger':prop.isRequired}"></i>
                      </div>
                    </div>
                  </template>

                  <!-- 🌈 pagination 🌈 -->
                  <template v-if="!item.special && item.properties.length > perPage">
                    <div class="d-flex flex-wrap justify-content-center p-1 mt-2">
                      <div class="page-item rounded-0" :class="{ 'disabled': page <= 1 }">
                        <a class="page-link p-1" @click.prevent="prevPage()"><i class="fas fa-step-backward"></i></a>
                      </div>
                      <template v-if="groupPages">
                        <div class="page-item rounded-0" v-show="!startCapLimitReached">
                          <a href="#" class="page-link p-1" @click.prevent="previousGroup()">Previous 20</a>
                        </div>
                      </template>
                      <template v-for="n in pages">
                        <div v-if="n >= startCap && n <= endCap" class="page-item rounded-0" :class="{ 'active': page == n, 'bg-primary': page == n, 'white-text': page == n  }">
                          <a href="#" class="page-link p-1" @click.prevent="page = n" v-text="n"></a>
                        </div>
                      </template>
                      <template v-if="groupPages">
                        <div class="page-item rounded-0" v-show="!endCapLimitReached">
                          <a href="#" class="page-link p-1" @click.prevent="nextGroup()">Next 20</a>
                        </div>
                      </template>
                      <div class="page-item rounded-0" :class="{ 'disabled': page >= pages }">
                        <a class="page-link p-1" @click.prevent="nextPage()"><i class="fas fa-step-forward"></i></a>
                      </div>
                    </div>
                  </template>


                </div>
              </div>
              <div class="col-sm-2 p-2 bg-dark actions d-flex align-items-center justify-content-around">
                <span v-if="item.special" class="fa-stack fa-1x pointer addprop unselectable tip" @click='addPropMode = !addPropMode; newPropDomain = item.label'>
                  <i class="fas fa-circle fa-stack-2x" :class="[ addPropMode ? 'text-success':'mainTextLight']"></i>
                  <i class="fas fa-stack-1x text-light" :class="[ addPropMode ? 'fa-minus':'fa-plus']"></i>
                </span>
                <span class="fa-stack fa-1x pointer expand unselectable" @click='expand=!expand' v-if="item && item.properties">
                  <i class="fas fa-circle fa-stack-2x" :class="{'text-muted':!expand,'text-success':expand}"></i>
                  <i class="fas fa-stack-1x text-light" :class="[ expand ? 'fa-list-ul':'fa-ellipsis-h']"></i>
                </span>
              </div>
              <div v-if="addPropMode" class="col-sm-12 p-2 bg-dark d-flex align-items-center justify-content-center text-light">
                <div class="col-sm-12 col-md-6">
                  <h3>New Property</h3>
                  <form>
                    <div class="form-group">
                      <label for="name">Name <i class="fas fa-asterisk text-danger"></i></label>
                      <input v-model="newPropName" type="text" class="form-control" id="name" placeholder="name of new property">
                      <small v-if="propExists" class="text-danger">A property with this name already exists</small>
                    </div>
                    <div class="form-group">
                      <label for="desc">Description <i class="fas fa-asterisk text-danger"></i></label>
                      <input v-model="newPropDescription" type="text" class="form-control" id="desc" placeholder="description of new property">
                    </div>
                    <div class="form-group">
                      <label for="domain">Domain <i class="fas fa-asterisk text-danger"></i></label>
                      <input disabled v-model="newPropDomain" type="text" class="form-control bg-dark text-light" id="domain">
                    </div>
                    <div class="form-group">
                      <label for="input">Input Type(s) <i class="fas fa-asterisk text-danger"></i></label>
                      <input disabled v-model="newPropRange" type="text" class="form-control bg-dark text-light" id="input">
                      <button type="button" class="btn btn-sm text-light themeButton m-1" @click.prevent="addInputType()">Search Types & Add</button>
                    </div>
                    <div class="w-100 p-1">
                      <button :disabled="!addNewPropReady && !propExists" :class="[addNewPropReady && !propExists ?'btn-success':'btn-secondary']" type="submit" class="btn btn-lg w-100" @click.prevent="submitNewProp()">Submit</button>
                    </div>
                  </form>
                </div>
              </div>
            </div>`,
  methods: {
    updateTotals(){
      let totals ={
        properties: 0,
        selected: 0,
        required: 0
      }
      if (this.item.hasOwnProperty('properties')) {
        this.item.properties.forEach( prop => {
          totals.properties ++;
          if (prop && prop.selected) {
            totals.selected ++;
          }
          if (prop && prop.isRequired) {
            totals.required ++;
          }
        })
      }
      this.totals = totals
    },
    removeProp(propLabel){
      Swal.fire({
        title: 'Are you sure you want to delete '+propLabel+'?',
        text: "You won't be able to revert this",
        showCancelButton: true,
        confirmButtonColor:"{{color_main}}",
        cancelButtonColor:"{{color_sec}}",
        animation:false,
        customClass:'scale-in-center',
        confirmButtonText: 'Yes, Delete it!'
      }).then((res) => {
        if (res.value) {
          let payload = {}
          payload['label'] = propLabel;
          store.commit('removeProperty',payload);
        }
      })
    },
    sortedList(){
      var self = this;
      try {
        return _.orderBy(self.item.properties, ['label'], ['asc']);
      } catch (e) {
        return self.item.properties
      }
    },
    calculatePages: function () {
      var self= this;
      self.pages = Math.ceil(self.item.properties.length / self.perPage);

      if (self.pages > self.pageLimit) {
        self.groupPages =  true;
      }
    },
    previousGroup: function(){
      var self = this;

      if (!self.startCapLimitReached) {
        if (self.startCap-20 > 0) {
          self.page = self.startCap-20
          self.startCap = self.startCap-20
          self.endCap = self.endCap-20
          self.endCapLimitReached = false;
        }else {
          self.page = 1
          self.startCap = 0
          self.endCap = 20
          self.startCapLimitReached = true;
          self.endCapLimitReached = false;
        }
      }
    },
    nextGroup: function(){
      var self = this;

      if (!self.endCapLimitReached) {
        if (self.endCap+20 < self.pages) {
          self.page = self.startCap+20
          self.startCap = self.startCap+20
          self.endCap = self.endCap+20
          self.startCapLimitReached = false;
        }else {
          self.page = self.startCap+20
          self.startCap = self.startCap+20
          self.endCap = self.pages
          self.endCapLimitReached = true;
          self.startCapLimitReached = false;
        }
      }
    },
    prevPage: function () {
      var self= this;
      if (self.page > 1)
          self.page -= 1
    },
    nextPage: function () {
      var self= this;
      if (self.page < self.pages)
          self.page += 1
    },
    getSubclass(item){
      return item.split(", ")
    },
    markSelected(propLabel){
      var payload = {};
      payload["label"] = propLabel
      store.commit('selectProp',payload);
      this.updateTotals();
    },
    markRequired(propLabel){
      var self = this;
      for (var i = 0; i < self.item.properties.length; i++) {
        if (self.item.properties[i].label === propLabel && self.item.properties[i].selected) {
          var payload = {};
          payload["label"] = propLabel
          store.commit('requireProp',payload);
        }else if (self.item.properties[i].label === propLabel && !self.item.properties[i].selected){
          $.notify("Can't require an unselected property",{ globalPosition: 'right',style:'error', showDuration: 40, });
        }
      }
      this.updateTotals();
    },
    resetAddPropForm(){
      var self = this;
      self.newPropName = '';
      // self.newPropDomain = '';
      self.newPropDescription = '';
      self.newPropRange = [];
      $.notify("New property added",{ globalPosition: 'right',style:'success', showDuration: 200, });
    },
    getRangeOptions(){
      var self = this;
      let options =[]
      axios.get('/api/registry/schema?field=name'). then(res=>{
        if (res.data.hits) {
          for(var i = 0; i < res.data.hits.length; i++){
            options.push(res.data.hits[i].name)
          }
        }
        self.rangeOptions = options;
      }).catch(err=>{
        throw err;
      });
    },
    submitNewProp(){
      var self = this;
      let payload = {}
      payload['name'] = self.newPropName;
      payload['range'] = self.newPropRange.toString();
      payload['description'] = self.newPropDescription;
      payload['domain'] = self.newPropDomain;
      if (self.item.special) {
        payload['special'] = true;
      }else {
        payload['special'] = false;
      }
      store.commit('addProperty',payload);
      self.addPropMode = false;
      self.resetAddPropForm();
    },
    addInputType(){
      var self = this;
      Swal.fire({
            title: "What is this property's expected type(s)?",
            footer:"Start typing to check for existing classes. If none found specify it's context prefix and name. eg. prefix:Name (Multiple separated by commas)",
            html: '<datalist id="myCustomList"></datalist>',
            input: 'text',
            confirmButtonColor:"{{color_main}}",
            cancelButtonColor:"{{color_sec}}",
            confirmButtonText: 'Add',
            animation:false,
            customClass:'scale-in-center',
            inputAttributes: {
              list: 'myCustomList'
            },
            onOpen:function(){
               Swal.isLoading();
               var options = '';
               options += '<option value="schema:Text" />';
               options += '<option value="schema:URL" />';
               options += '<option value="schema:Integer" />';
               options += '<option value="schema:Number" />';
               options += '<option value="schema:Date" />';
               options += '<option value="schema:Float" />';
               options += '<option value="schema:Boolean" />';
               options += '<option value="schema:DateTime" />';
               options += '<option value="schema:Time" />';
               if (self.rangeOptions && self.rangeOptions.length) {
                for (let i = 0; i < self.rangeOptions.length; i++) {
                  let element = self.rangeOptions[i];
                  options += '<option value="'+element+'" />';
                }
               }
               document.getElementById('myCustomList').innerHTML = options;
               Swal.hideLoading();
             }
          }).then((res) => {
            if (res.value) {
              self.newPropRange.push(res.value);
            }
          });
    },
    addProp(domain){
        var self = this;
        Swal.mixin({
        input: 'text',
        confirmButtonText: 'Next &rarr;',
        showCancelButton: true,
        confirmButtonColor:"{{color_main}}",
        cancelButtonColor:"{{color_sec}}",
        animation:false,
        customClass:'scale-in-center',
        progressSteps: ['1', '2','3']
      }).queue([
        {
          title: "Choose a name for your property",
          html: 'input name must be camelCased <b class="text-danger">eg. myProperty </b>',
          inputValidator: (value) => {
            return new Promise((resolve) => {
              if (value.match(/^[a-z]+(?:[A-Z][a-z]+)*$/)) {
                // DUPLICATE CHECK
                if (store.getters.isDuplicateProp(value)) {
                  resolve('Property already exists in parent classes. All properties should be unique or more specific.')
                }else {
                  resolve()
                }
              } else {
                resolve('property names must be camelCased')
              }
            })
          }
        },
        {
          title: "What is this property's expected type(s)?",
          footer:"Start typing to check for existing classes. If none found specify it's context prefix and name. eg. prefix:Name (Multiple separated by commas)",
          html: '<datalist id="myCustomList"></datalist>',
            input: 'text',
            inputAttributes: {
              list: 'myCustomList'
            },
            onOpen:function(){
               var options = '';
               options += '<option value="schema:Text" />';
               options += '<option value="schema:URL" />';
               options += '<option value="schema:Integer" />';
               options += '<option value="schema:Number" />';
               options += '<option value="schema:Date" />';
               options += '<option value="schema:Float" />';
               options += '<option value="schema:Boolean" />';
               options += '<option value="schema:DateTime" />';
               options += '<option value="schema:Time" />';
               Swal.isLoading();
               axios.get('/api/registry/schema?field=name'). then(res=>{
                 Swal.hideLoading();
                 if (res.data.hits) {
                   for(var i = 0; i < res.data.hits.length; i++){
                     options += '<option value="'+res.data.hits[i].name+'" />';
                   }
                   document.getElementById('myCustomList').innerHTML = options;
                 }
               }).catch(err=>{
                 Swal.hideLoading();
                 throw err;
               });
             },
            inputValidator: (value) => {
              return value.length < 10 && 'Property should have at least 1 input type'
            }
        },
        {
          title: "Write a comment about this class",
          html: 'Write a short summary about this class',
          input:'textarea',
          inputValidator: (value) => {
            return value.length < 10 && 'Description is too short! You should write something meaningful.'
          }
        },
      ]).then((result) => {
        if (result.value) {
          Swal.fire({
            title: 'Add Property '+result.value[0]+'?',
            text: result.value[2],
            showCancelButton: true,
            confirmButtonColor:"{{color_main}}",
            cancelButtonColor:"{{color_sec}}",
            confirmButtonText: 'Yes, Add It!',
            animation:false,
            customClass:'scale-in-center',
          }).then((res) => {
            if (res.value) {
              $.notify(result.value[0]+" added",{ globalPosition: 'right',style:'success', showDuration: 200, });
              let payload = {}
              payload['name'] = result.value[0];
              payload['range'] = result.value[1];
              payload['description'] = result.value[2];
              payload['domain'] = domain;
              if (self.item.special) {
                payload['special'] = true;
              }else {
                payload['special'] = false;
              }
              store.commit('addProperty',payload);
              self.expand = true;
            }
          });
        }
      });

    }
  }
});


var app = new Vue({
      el: '#editor',
      store: store,
			data: function(){
				return {
          loading: false,
          inputNamespace:'',
          availableNamespace:false,
          userInfo:null,
          validationView:false,       
				}
			},
      computed:{
        validation_props: function(){
          return store.getters.getValidationProps
        },
        validation_options (){
          return store.getters.getValidationOptions
        },
        startingPoint:function(){
          return store.getters.getStartingPoint
        },
        prefix:function(){
          return store.getters.getPrefix
        },
        classesAvailable:function(){
          return store.getters.getSchema
        },
        newClassAdded:function(){
          for (var i = 0; i < store.state.schema.length; i++) {
            if (store.state.schema[i].special) {
              return true
            }
          }
          return false
        },
        item(){
          return store.getters.getEditItem
        }
      },
      watch:{
        prefix:function(prefix,oldprefix){
          if (prefix) {
            store.dispatch('getParents')
          }
        },
        inputNamespace:function(value,oldvalue){
          let self=this;
          var re = /^[a-z0-9]+$/i;
          if (value.length < 3) {
            self.availableNamespace= false;
          }else{
            if (!re.test(value)) {
              $.notify("["+value+"] cannot contain non-alphanumeric values",{ globalPosition: 'right',style:'error', showDuration: 100, });
              self.availableNamespace= false;
            }else{
              let url = "/api/registry/" + value;
              axios.head(url).then(function (res) {
                self.availableNamespace= false;
                console.log('%c Namespace "'+value+'" is NOT available', 'color:coral')
              }).catch(err=>{
                //last check for reserved names
                if (value === 'metadata' || value === 'dataset') {
                  self.availableNamespace= false;
                }else{
                  self.availableNamespace= true;
                }
                console.log('%c Namespace "'+value+'" is available', 'color:limegreen')
                // throw err;
              });
            }
          }
        },
      },
			methods:{
        editValidation(){
          let self = this;
          self.validationView = !self.validationView ;
          store.commit('formPreview');
        },
        getRandomColor() {
          let self = this;
          var letters = '0123456789ABCDEF';
          var color = '#';
          for (var i = 0; i < 6; i++) {
            color += letters[Math.floor(Math.random() * 16)];
          }
          return color
        },
        editValidationOption(item){
          let copy = Object.assign({}, item);
          let self = this;
          store.commit('editThis',{'item':copy});   
        },
        makeid(length) {
          var result           = '';
          var characters       = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
          var charactersLength = characters.length;
          for ( var i = 0; i < length; i++ ) {
              result += characters.charAt(Math.floor(Math.random() * charactersLength));
          }
          return result;
        },
        async addValidationOption(){
          let self = this;
          const { value: name } = await Swal.fire({
            title: "Name of new validation option",
            input: 'text',
            inputPlaceholder: 'Name this option'
          })

          if (name) {
            let payload = {
                  'validation': {
                    id: self.makeid(4),
                    title: name,
                    color: self.getRandomColor(),
                    list: 2,
                    validation: {'description':'EDIT to define'}
                  }
                }
                store.commit('addValidationOption', payload)
          }         
        },
        startDrag: (evt, item) => {
          let img = new Image(); 
          img.src = '/static/img/cubeplus.svg'; 
          evt.dataTransfer.setDragImage(img, 10, 10);

          evt.dataTransfer.dropEffect = 'move'
          evt.dataTransfer.effectAllowed = 'move'
          evt.dataTransfer.setData('itemID', item.id)
        },
        githubOptions(){
          // show modal
          store.commit('formPreview');
          var modal = document.getElementById("ghOptions");
          modal.style.display = "block";
          var span = document.getElementById("closeBtn");
          span.onclick = function() {
            modal.style.display = "none";
          }
        },
        toggleDesc(){
          store.commit('toggleDesc');
        },
        addClass(){
          let self = this;
          let name = this.$refs.clsName.value;
          let desc = this.$refs.clsDesc.value;

          // if (value.match(/^(?=.*[a-z])[A-Z]+[a-z]*(?:\d*(?:[A-Z]+[a-z]*)?)*$/)) {

          if (name && desc) {
            // DUPLICATE CHECK
            if (store.getters.isDuplicateClass(name)) {
              Swal.fire({type:'error',
                toast:true,
                title: 'Class already exists. Choose a different name',
                showConfirmButton:false,
                timer:1000})
            }else {
                let payload = {}
                payload['name'] = name;
                payload['description'] = desc;
                store.commit('addClass',payload);
            }
          } else {
            Swal.fire({type:'error',
                toast:true,
                title: 'You forgot something!',
                showConfirmButton:false,
                timer:1000})
          }

        },
        getPreview(){
          let self = this;
          if (self.prefix) {
            store.commit('formPreview');
            Swal.fire({
              position: 'center',
              confirmButtonColor:"{{color_main}}",
              cancelButtonColor:"{{color_sec}}",
              animation:false,
              customClass:'scale-in-center',
              html: `<h6 class="text-center mainTextDark">Preview</h6><div class="text-left p-1 previewBox"><small><pre>`+JSON.stringify(store.getters.getFinalSchema,null,2)+`</pre></small></div>`
            });
          }

        },
        checkUser(){
          let self = this;
          self.loading = true;
          $.ajax({url: "/user", success: function(result){
            self.loading = false;
             self.userInfo = result;
          },
          cache: false});
        },
        checkForData(){
          var schema = localStorage.getItem('EditorData');
          var startingPoint = localStorage.getItem('EditorStartingPoint');

          if (schema && startingPoint) {
            var payload = {};
            payload["schema"] = JSON.parse(schema);
            payload["start"] = startingPoint;
            store.commit('saveSchema',payload);
          }else{
            Swal({
              title: 'No Schema Selected',
              imageAlt: 'Warning',
              html:
                '<p>You have not selected a schema to start with.</p> ' +
                '<p>Search the <a href="/registry">Registry</a> for a schema to start from.</p>',
              showCancelButton: false,
              confirmButtonColor:"{{color_main}}",
              cancelButtonColor:"{{color_sec}}",
            });
          }
        },
        handleSubmit(){
          var self = this;
          if (self.url) {
            axios.get(self.url).then(res=>{
              // console.log(res.data)
            }).catch(err=>{
              throw err;
            });
          }
        },
        savePrefix(){
          if (this.availableNamespace) {
            var payload = {};
            payload["prefix"] = this.inputNamespace
            store.commit('savePrefix',payload);
          }
        },
        downnloadSchema(){
          var self = this;
          if (self.prefix) {
            store.commit('formPreview');
            Swal.fire({
              title: 'Name your file',
              input: 'text',
              animation:false,
              customClass:'scale-in-center',
              inputAttributes: {
                autocapitalize: 'off'
              },
              showCancelButton: true,
              confirmButtonText: 'Download JSON-LD',
              allowOutsideClick: () => !Swal.isLoading()
            }).then((result) => {
              if (result.value) {
                self.download(JSON.stringify(store.getters.getFinalSchema,null,2), result.value+'.jsonld', 'text/plain')
              }
            })
          }

        },
        download(content, fileName, contentType) {
          var a = document.createElement("a");
          var file = new Blob([content], {type: contentType});
          a.href = URL.createObjectURL(file);
          a.download = fileName;
          a.click();
        },
        showHelp(){
          Swal.fire({
            title: 'Editor',
            animation:false,
            customClass:'scale-in-center',
            html:`<p>
                    After choosing a namespace and creating your class you will be able to edit the schema you decided to extend. It's really easy and fast! Here's a quick introduction to the layout:
                  </p>
                  <small>
                    <ol class="text-left">
                      <li>
                        Log-in status.
                      </li>
                      <li>
                        Preview your work.
                      </li>
                      <li>
                        Download your work.
                      </li>
                      <li>
                        Save to GitHub directly* Requires GitHub login and permission.
                      </li>
                      <li>
                        Add a new property to your class.
                      </li>
                      <li>
                        The extended Class you created.
                      </li>
                      <li>
                        Parent properties available to choose from.
                      </li>
                      <li>
                        Show/Hide all properties of this class.
                      </li>
                    </ol>
                  </small>`,
            footer:'',
            width:'52em',
            confirmButtonColor:"{{color_main}}",
            cancelButtonColor:"{{color_sec}}",
            confirmButtonText:"Ready!",
            imageUrl: '/static/img/editor.png',
            imageAlt: 'Metadata Editor'
          })
        },
        CreateRepo(){
          var self = this;
          Swal.mixin({
            input: 'text',
            confirmButtonText: 'Next &rarr;',
            showCancelButton: true,
            footer:`<small class="text-danger">Important: You need to have logged in using GitHub and given us permission to access your repositories.</small>`,
            progressSteps: ['<i class="fab fa-github-alt"></i>A', '<i class="fab fa-github-alt"></i>B',]
          }).queue([
            {
              title: 'Name your repository',
              text: 'We will create a public repository with this name'
            },
            {
              title: 'Name your schema file (without extension)',
              text: 'We will create a JSON-LD file with this name'
            },
          ]).then((result) => {
            if (result.value) {
              const answers = result.value
              self.handleGHRequest(answers[0],answers[1]+".jsonld");
            }
          })
        },
        handleGHRequest(repo,file){
          var self = this;
          Swal.fire({
            title: '<h4>Do you give us permission to create a repository and file with these names?</h4>',
            text: repo+"/"+file,
            showCancelButton: true,
            confirmButtonText: `Go Ahead`,
            cancelButtonText: `Never Mind`,
            showLoaderOnConfirm: true,
            preConfirm: () => {

              data ={
                'name': repo,
                'file': file,
                'data': store.getters.getFinalSchema
              }

              console.log(typeof store.getters.getFinalSchema)
              console.log(data)

              let config = {
                 headers: {
                   'content-type': 'application/json'
                 }
               }

              return axios.post("/api/gh", data, config).then(res=>{
                if (res.data.success) {
                  return "https://github.com/"+res.data.msg
                }else{
                  Swal.fire({
                    type: 'error',
                    title: 'Unsuccesful...',
                    text: JSON.stringify(res.data, null, 2),
                  })
                }
              }).catch(err=>{
                Swal.fire({
                  type: 'error',
                  title: 'Oops...Something went wrong!',
                  text: err,
                })
                throw err;
              });
            },
            allowOutsideClick: () => !Swal.isLoading()
          }).then((result) => {
            if (!result.dismiss) {
              Swal.fire({
                type: 'success',
                title: 'Sucess!',
                html: `<h2>Repository created!</h2>
                <p>
                  Click here to see it: <a href="`+result.value+`" target="_blank" rel="nonreferrer">`+result.value+`</a>
                </p>`,
              })
            }
          })
        },
        checkCustomValidation(){
          let v = localStorage.getItem('custom_validation');
          if (v) {
            store.commit('updateValidationOptions', {'validation': JSON.parse(v) });
          }
        },
        clearCustomValidation(){
          
          Swal.fire({
            title: 'Are you sure?',
            text: result.value[1],
            showCancelButton: true,
            confirmButtonColor:"{{color_main}}",
            cancelButtonColor:"{{color_sec}}",
            animation:false,
            customClass:'scale-in-center',
            confirmButtonText: 'Reset it all!'
          }).then((res) => {
            if (res.value) {
              localStorage.removeItem('custom_validation');
              Swal.fire({type:'success',
                toast:true,
                title: 'Validation Reset',
                showConfirmButton:false,
                timer:1000})
            }
          })
        }
			},
			mounted:function(){
        var self = this;
        self.checkUser();
        self.checkForData();
        self.checkCustomValidation();
        tippy( '#editor', {
          target:'*[data-tippy-info]',
          placement:'bottom',
          content: 'loading',
          animation: 'fade',
          theme:'light bg-light',
          onShow(instance) {
            let info = instance.reference.dataset.tippyInfo;
            instance.setContent("<pre class='text-left' style='margin:0px !important;'>"+info+"</pre>")
          }});
			}
		});

</script>
{% include "footer.html" %}
{% endblock %}
