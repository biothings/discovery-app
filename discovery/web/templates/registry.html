{% extends "main.html" %}
{% block content %}
{% include "header.html" %}
<style>

</style>
<div id="registry" class="jumbotron" style="min-height:80vh;">
  <div v-if=loading class="loader">
    <img src="/static/img/ripple.svg"/>
  </div>
  <div class="row">

    <div class="col-sm-12 col-md-10 col-lg-7 m-auto">
      <h1 class="text-center logoText mb-5 mt-5">REGISTRY</h1>
      <div class="message p-1">
        <div class="m-2">
          <small class="bold text-muted">SHORTCUTS</small>
          <div class="d-flex justify-content-start">
            <div class="row m-1 cBox actions mainBackDark">
              <div class="col-sm-8 p-2 text-light text-center d-flex align-items-center">
                <small>Visualize Schema.org</small>
              </div>
              <div class="col-sm-4 p-2 bg-dark actions d-flex align-items-center justify-content-around">
                <span class="fa-stack fa-1x pointer unselectable" data-tippy="Visualize Classes in Schema.org" data-tippy-theme="light" @click.prevent="window.location.href='/schema/'">
                  <i class="fas fa-circle text-muted fa-stack-2x"></i>
                  <i class="fas fa-eye fa-stack-1x text-light"></i>
                </span>
              </div>
            </div>
            <div class="row m-1 cBox actions mainBackDark">
              <div class="col-sm-8 p-2 text-light text-center d-flex align-items-center">
                <small>Visualize BioLink</small>
              </div>
              <div class="col-sm-4 p-2 bg-dark actions d-flex align-items-center justify-content-around">
                <span class="fa-stack fa-1x pointer unselectable" data-tippy="Visualize Classes in BioThings" data-tippy-theme="light" @click.prevent="window.location.href='/bts/'">
                  <i class="fas fa-circle text-muted fa-stack-2x"></i>
                  <i class="fas fa-eye fa-stack-1x text-light"></i>
                </span>
              </div>
            </div>
            <template v-for='item in startingPoints'>
              <preset-box :preset='item'></preset-box>
            </template>
          </div>
        </div>
      </div>
      <div class="mt-4">
        <form @submit.prevent="search(query)">
          <div class="row m-1 cBox actions bg-secondary">
            <div class="col-sm-10 p-2">
              <div class="">
                <input class="form-control col-12" id="search_query" type="text" v-model="query" name="query" placeholder="Search..." >
                <template v-show="registryTotal && registry.length">
                  <small class="text-light" v-text="registryTotal+' Results'"></small>
                </template>
              </div>
            </div>
            <div class="col-sm-2 p-2 bg-dark actions d-flex align-items-center justify-content-around">
              <span class="fa-stack fa-1x pointer search unselectable tip" @click.prevent="search(query)">
                <i class="fas fa-circle text-muted fa-stack-2x"></i>
                <i class="fas fa-search fa-stack-1x text-light"></i>
              </span>
              <span class="fa-stack fa-1x pointer reset unselectable" @click.prevent="query='';registry=[]">
                <i class="fas fa-circle fa-stack-2x text-danger"></i>
                <i class="fas fa-undo fa-stack-1x text-light"></i>
              </span>
            </div>
          </div>
        </form>
      </div>

      <ul class="list-group context" id="regTippyParent">
        <template v-if="registry.length" v-for="(item,index) in registryResults">
          <registry-item :item='item' :key="index"></registry-item>
        </template>
        <li v-if="!registry.length" class="text-center text-muted list-group-item">
          <div class="jumbotron">
            <h4>Search for schema classes</h4>
            <h5>For example:</h5>
            <a href="#" class="text-muted mr-1" @click.prevent='search("Thing")'>Thing <i class="fas fa-chevron-right"></i></a>
            <a href="#" class="text-muted mr-1" @click.prevent='search("CreativeWork")'>CreativeWork <i class="fas fa-chevron-right"></i></a>
            <a href="#" class="text-muted mr-1" @click.prevent='search("Dataset")'>Dataset <i class="fas fa-chevron-right"></i></a>
          </div>
        </li>
      </ul>
      <div class="bg-light">
        <div class="row">
          <nav class="m-auto ">
            <ul class="pagination m-2 flex-wrap p-2">
              <li class="page-item" :class="{ 'disabled': page <= 1 }">
                <a class="page-link" @click.prevent="prevPage()">&lt;</a>
              </li>
              <li class="page-item" :class="{ 'active': page == n, 'bg-primary': page == n, 'white-text': page == n  }" v-for="n in pages">
                <a href="#" class="page-link" @click.prevent="page = n" v-text="n"></a>
              </li>
              <li class="page-item" :class="{ 'disabled': page >= pages }">
                <a class="page-link" @click.prevent="nextPage()">&gt;</a>
              </li>
            </ul>
          </nav>
          <div class="col-sm-12 right-align form-group">
            <select class="perPage form-control form-control-sm w-50 m-auto" v-model="perPage" @change="calculatePages" id="perPage">
                <option value="" disabled selected>Shown Per Page</option>
                <option value="20">20 per page</option>
                <option value="50">50 per page</option>
                <option value="100">100 per page</option>
            </select>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
{% block extra_scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.4.2/vue.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.18.0/axios.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.es6.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js"></script>
<script src="/static/js/lodash.js"></script>
<script src="https://unpkg.com/tippy.js@3/dist/tippy.all.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@7.28.11/dist/sweetalert2.all.min.js"></script>
<script>

Vue.component('preset-box', {
  props: ['preset'],
  template: `<div class="row m-1 cBox actions mainBackLight">
              <div class="col-sm-8 p-2 text-light text-center d-flex align-items-center">
                <small>Extend <span class="bold" v-text="preset.name"></span> schema</small>
              </div>
              <div class="col-sm-4 p-2 bg-dark actions d-flex align-items-center justify-content-around">
                <span class="fa-stack fa-1x pointer unselectable" data-tippy="Create a new schema from this starting point" data-tippy-theme="light" @click.prevent="handleClick()">
                  <i class="fas fa-circle text-muted fa-stack-2x"></i>
                  <i class="fas fa-code-branch fa-stack-1x text-light"></i>
                </span>
              </div>
            </div>`,
  methods: {
    handleClick(){
			var self = this;
			axios.get('/api/registry/'+self.preset.namespace+'/'+self.preset.prefix+':'+self.preset.name).then(res=>{
				let obj = JSON.stringify(res.data)
				localStorage.setItem('EditorData',obj);
				localStorage.setItem('EditorStartingPoint',self.preset.prefix+':'+self.preset.name);
				window.location.href ='/editor'
			}).catch(err=>{
				throw err;
			})
    }
  }
});

Vue.component('registry-item', {
  data: function(){
    return{
      options:false
    }
  },
  props: ['item'],
  methods:{
    saveDataAndRedirect(item,goesToEditor){
      var self = this;
      console.log("ITEM",item)
      if (goesToEditor) {
        console.log("TO EDITOR")
        if (item && item.namespace && item.label && item.prefix) {
          let obj = JSON.stringify(item)
          localStorage.setItem('EditorData',obj);
          localStorage.setItem('EditorStartingPoint',item.prefix+':'+item.label);
          window.location.href = goesToEditor;
        }else{
          Swal.fire(
            'Oops!',
            'Action not available for this item',
          );
        }
      }else{
        console.log("TO VIEWER")
        if (item && item.namespace && item.label) {
          window.location.href = '/'+item.namespace+'/'+item.label;
        }else{
            Swal.fire(
              'Oops!',
              'Action not available for this item',
            );
        }
      }
    },
    getSubclass(parents){
      if (parents) {
        let sub = parents[0].split(', ');
        return sub[sub.length-1]
      }else{
        return 'This class has no subclass'
      }
    },
    getPropTotal(){
      if (this.item.hasOwnProperty('properties')) {
        return this.item.properties.length
      }else{
        return '0'
      }
    }
  },
  watch:{
  },
  mounted: function(){
    tippy('#'+this.item.label, {
      theme:'light',
      content: "<div class='text-left text-muted'>"+JSON.stringify(this.item.description,null,2)+"</div>" || "<div class='m-0'>No Description Available</div>",
    })
  },
  template: `<li class="list-group-item list-group-item-action p-0 pointer" @click.prevent="options=!options">
    <div class="d-flex">
      <div class="flex-grow-1 p-2">
        <div class="d-flex justify-content-between w-100">
          <h5 class="mb-1 mainTextDark">
            <small v-text="item.prefix"></small>:<span v-text="item.label"></span> <small><i :id="item.label" class="fas fa-info-circle text-info"></i></small>
          </h5>
        </div>
        <p class="mb-1">
          <small>
            <span class='badge mainBackLight text-light'><span v-text="getPropTotal()"></span> Properties </span>
          </small>
          <small>Subclass of:</small>
          <span class="mb-1" v-text="getSubclass(item.parent_classes)"></span>
        </p>

      </div>
      <div v-if='options' class="p-1 bg-dark d-flex align-items-center justify-content-around flip-in-ver-left">
        <div>
          <span class="fa-stack fa-1x pointer tip mr-2 ml-2" @click.prevent="saveDataAndRedirect(item)" :data-tippy-info="'Visualize'">
            <i class="fas fa-circle text-muted fa-stack-2x"></i>
            <i class="fas fa-eye fa-stack-1x text-light"></i>
          </span>
        </div>
        <div>
          <span class="fa-stack fa-1x pointer tip mr-2 ml-2" @click.prevent="saveDataAndRedirect(item,'editor')" :data-tippy-info="'Extend'">
            <i class="fas fa-circle text-muted fa-stack-2x"></i>
            <i class="fas fa-code-branch fa-stack-1x text-light"></i>
          </span>
        </div>
      </div>
    </div>
  </li>`
});

var app = new Vue({
      el: '#registry',
			data: function(){
				return {
          alphabet : ['ALL','A','B','C','D','E','F','G','H','I','J','K','L','M','N','O','P','Q','R','S','T','U','V','W','X','Y','Z'],
          input:'',
          linkPrefix:'./',
          data: null,
          user:{},
          testURL:'',
          registry:[],
          registryTotal:'0',
          sort:'Search Relevance',
          query:'',
          page: 1,
          pages: 1,
          perPage: 20,
          loading:false,
          startingPoints:[
						{
              'namespace':'schema',
              'prefix':'schema',
              'name':'Dataset',
              'description':'A body of structured information describing some topic(s) of interest.'
            },
          ]
				}
			},
      methods:{

        searchByUser(username){
          var self = this;

          $('#searching').show();

          var context = document.querySelector(".context");
          var instance = new Mark(context);
          instance.unmark();

          axios.get('/api/query?q=_meta.username:'+username+'&size=100').then(function (response) {
            self.registry = response.data.hits;
            self.registryTotal = response.data.total;
            $( document ).ready(function() {
              self.mark(username);
            });
            if (self.registryTotal) {
              self.calculatePages();
            }
            $('#searching').hide();
          });
        },
        mark: function(kw){
          var context = document.querySelector(".context");
          var instance = new Mark(context);
          instance.mark(kw);
        },
        getQueryFilters: function(){
            var filters = [];
            var authorFilters = [];
            var finalFilters = {};
            this.tags.forEach(function(item){
              if (item.active)
                  filters.push(item.name);
              });
            if (filters.length > 0){
              finalFilters['tags.name.raw'] = filters;
            }

            this.authors.forEach(function(item){
              if (item.active){
                authorFilters.push(item.name);
              }
              });
            if (authorFilters.length){
              finalFilters['info.contact.name.raw'] = authorFilters;
            }

            return finalFilters;
        },
        search(query){
          var self = this;

          query = query || "__all__";

          if (query) {
              var params = {
                  "params": {
                    "q": query,
                    // 'fields': 'info,_meta,paths.path, paths.pathitem.get.summary,paths.pathitem.post.summary,paths.pathitem.delete.summary,paths.pathitem.patch.summary,paths.pathitem.put.summary,paths.pathitem.head.summary,paths.pathitem.put.summary,options.pathitem.head.summary,paths.pathitem.put.summary,paths.pathitem.trace.summary, tags,openapi,swagger,'
                  }
              };
            }
            // var filters = this.getQueryFilters();
            // if (filters)
            //     params["params"]["filters"] = filters;

            self.loading = true;

            var context = document.querySelector(".context");
            var instance = new Mark(context);
            instance.unmark();
            //clear registry to fix mixing results info
            self.registry = [];
            axios.get('/api/query?size=1000', params).then(function (response) {
              // console.log('%c SEARCH..','color:hotpink')
              // console.log(response.data.hits)
              self.registry = response.data.hits;
              self.registryTotal = response.data.total;
              // mark results, doc must be loaded
              $( document ).ready(function() {
                self.mark(self.query);
              });
              if (self.registryTotal) {
                self.calculatePages();
              }
              self.loading = false;
            });
        },
        calculatePages: function () {
          var self= this;
          self.pages = Math.ceil(self.registry && self.registry.length / self.perPage);
        },
        prevPage: function () {
          var self= this;
          if (self.page > 1)
              self.page -= 1
        },
        nextPage: function () {
          var self= this;
          if (self.page < self.pages)
              self.page += 1
        },
        sortResults(e){
          this.sort = e.target.value;
        },
        checkLoggedUser(){
          var self = this;
          axios.get('./user').then(res=>{
            if (res.data.login) {
              self.user = res.data;
            }
          }).catch(err=>{
            throw err;
          });
        },
    },
    mounted:function(){
      var self = this;
      self.checkLoggedUser();
      tippy( '.search', {
        maxWidth:'200px',
        placement:'top',
        content: '<div class="text-muted m-0" style="border-radius:none">Search</div>',
        animation: 'fade',
        theme:'light'});
        tippy( '.reset', {
          maxWidth:'200px',
          placement:'top',
          content: '<div class="text-muted m-0" style="border-radius:none">Reset</div>',
          animation: 'fade',
          theme:'light'});
          tippy( '.reset', {
            maxWidth:'200px',
            placement:'top',
            content: '<div class="text-muted m-0" style="border-radius:none">Reset</div>',
            animation: 'fade',
            theme:'light'});
      tippy( '#regTippyParent', {
        target:'.tip',
        placement:'top',
        maxWidth:'200px',
        content: 'loading',
        animation: 'fade',
        theme:'light',
        onShow(instance) {
          let info = instance.reference.dataset.tippyInfo;
          instance.setContent("<div class='text-muted m-0 text-center wraptext'>"+info+"</div>")
        }});
    },
    computed: {
                registryResults: function () {
                    var start = (this.page - 1) * this.perPage,
                        end = start + this.perPage;
                    return this.registry && this.registry.slice(start, end);
                }
            },
  })

  // Smooth Scroll-To

  $('a[href*="#"]')
    .not('[href="#"]')
    .not('[href="#0"]')
    .click(function(event) {
      if (
        location.pathname.replace(/^\//, '') == this.pathname.replace(/^\//, '')
        &&
        location.hostname == this.hostname
      ) {
        var target = $(this.hash);
        target = target.length ? target : $('[name=' + this.hash.slice(1) + ']');
        if (target.length) {
          event.preventDefault();
          $('html, body').animate({
            scrollTop: target.offset().top
          }, 1000, function() {
            var $target = $(target);
            $target.focus();
            if ($target.is(":focus")) {
              return false;
            } else {
              $target.attr('tabindex','-1');
              $target.focus();
            };
          });
        }
      }
    });
</script>

{% include "footer.html" %}
{% endblock %}
