{% extends "main.html" %}
{% block content %}
{% include "header.html" %}
<style>
  [v-cloak] > * { display:none; }
  [v-cloak]::before { content: "Please wait..."; }
.p-relative{
  position: relative;
}
.checkmark__circle {
  stroke-dasharray: 166;
  stroke-dashoffset: 166;
  stroke-width: 2;
  stroke-miterlimit: 10;
  stroke: #7ac142;
  fill: none;
  animation: stroke 0.6s cubic-bezier(0.65, 0, 0.45, 1) forwards;
}
.checkmark {
  width: 56px;
  height: 56px;
  border-radius: 50%;
  display: block;
  stroke-width: 2;
  stroke: #fff;
  stroke-miterlimit: 10;
  margin: 10% auto;
  box-shadow: inset 0px 0px 0px #7ac142;
  animation: fill .4s ease-in-out .4s forwards, scale .3s ease-in-out .9s both;
}

.checkmark__check {
  transform-origin: 50% 50%;
  stroke-dasharray: 48;
  stroke-dashoffset: 48;
  animation: stroke 0.3s cubic-bezier(0.65, 0, 0.45, 1) 0.8s forwards;
}

.classTab{
  border-top-left-radius: 10px;
  border-top-right-radius: 10px;
}

@keyframes stroke {
  100% {
    stroke-dashoffset: 0;
  }
}
@keyframes scale {
  0%, 100% {
    transform: none;
  }
  50% {
    transform: scale3d(1.1, 1.1, 1);
  }
}
@keyframes fill {
  100% {
    box-shadow: inset 0px 0px 0px 30px #7ac142;
  }
}

/* ----------------------------------------------
 * Generated by Animista on 2020-11-20 9:51:40
 * Licensed under FreeBSD License.
 * See http://animista.net/license for more info. 
 * w: http://animista.net, t: @cssanimista
 * ---------------------------------------------- */

/**
 * ----------------------------------------
 * animation slit-out-horizontal
 * ----------------------------------------
 */
 @-webkit-keyframes slit-out-horizontal {
  0% {
    -webkit-transform: translateZ(0) rotateX(0);
            transform: translateZ(0) rotateX(0);
    opacity: 1;
  }
  54% {
    -webkit-transform: translateZ(-160px) rotateX(87deg);
            transform: translateZ(-160px) rotateX(87deg);
    opacity: 1;
  }
  100% {
    -webkit-transform: translateZ(-800px) rotateX(90deg);
            transform: translateZ(-800px) rotateX(90deg);
    opacity: 0;
  }
}
@keyframes slit-out-horizontal {
  0% {
    -webkit-transform: translateZ(0) rotateX(0);
            transform: translateZ(0) rotateX(0);
    opacity: 1;
    box-shadow: 0px 00px 0px #9e9e9e;
  }
  33% {
    -webkit-transform: translateZ(0) rotateX(0);
            transform: translateZ(0) rotateX(0);
    opacity: 1;
    box-shadow: 0px 10px 30px #929292;
  }
  66% {
    -webkit-transform: translateZ(-160px) rotateX(87deg);
            transform: translateZ(-160px) rotateX(87deg);
    opacity: 1;
    box-shadow: 0px 5px 10px #919191;
  }
  100% {
    -webkit-transform: translateZ(-800px) rotateX(90deg);
            transform: translateZ(-800px) rotateX(90deg);
    opacity: 0;
    box-shadow: 0px 0px 0px #8d8d8d;
  }
}

.slit-out-horizontal {
	-webkit-animation: slit-out-horizontal 0.5s ease-in both;
  animation: slit-out-horizontal 0.5s ease-in both;
  animation-duration: 1.8s;
  animation-iteration-count: 1;
  animation-delay: .4s;
  border-radius: 10px;
}

.arrow-bottom {
    position:relative;
}

.arrow-bottom:after {
    content:'';
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    margin: 0 auto;
    width: 0;
    height: 0;
    border-top: solid 15px #0E627C;
    border-left: solid 15px transparent;
    border-right: solid 15px transparent;
}

#puff {
    position:absolute;
    z-index: 2000;
    pointer-events: none;
    height:32px;
    width:32px;
    display: none;
}

.zoom-2{
  zoom: 2;
}
</style>
<div id="guide" class="container-fluid pt-5 m-auto col-sm-12 col-md-10 col-lg-10 col-xl-8" style="min-height:90vh;" v-cloak>
  <div id="tip-cont">
    <img id="puff" src="/static/img/puff.gif">
    <audio id="pop-sound" src="/static/img/pop.wav"></audio>
    <div v-if=loading class="loader">
      <img src="/static/img/ripple.svg"/>
    </div>
    <div class="p-2 bg-light text-center mt-5">
      <h6 class="logoText">DISCOVERY GUIDE</h5>
      <p class="text-muted">
        Follow best practices to make your dataset metadata more findable
      </p>
      <a :href="'/dataset?guide='+window.location.pathname">Browse other registered dataset metadata using this guide <i class="fas fa-chevron-right"></i></a>
    </div>
    <div id="jsonTable">
      <!-- BULK -->
      <div v-if="jsonItems.length" class="alert grad">
        <small class="text-light">BULK REGISTRATION </small> <small class="text-info" v-text="jsonItems.length+' documents found'"></small>
        <table class="m-0 table table-sm table-dark table-striped">
          <colgroup>
           <col span="1" style="width: 30%;">
           <col span="1" style="width: 60%;">
           <col span="1" style="width: 10%;">
          </colgroup>
          <thead>
            <th>
              <small>Name</small>
            </th>
            <th>
              <small>Result/Details</small>
            </th>
            <th>
              <small>Status</small>
            </th>
          </thead>
        </table>
        <div style="max-height:500px; overflow:scroll;">
          <table class="m-0 table table-sm table-dark">
            <colgroup>
             <col span="1" style="width: 30%;">
             <col span="1" style="width: 60%;">
             <col span="1" style="width: 10%;">
            </colgroup>
            <tbody style="max-height:500px; overflow:scroll;">
              <template v-for="(item,i) in jsonItems">
                <json-item :item="item" :number="i+1"></json-item>
              </template>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    <!-- bulk end -->
    <div id="widget" class="mb-5 grad rounded">
      <div>
        <div class="actions bg-dark p-2 rounded d-flex align-items-center justify-content-start">
          <span class="fa-stack fa-1x pointer tip mr-2" :data-tippy-info="'Logged in as '+userInfo.login" v-if="userInfo && userInfo.login">
            <i class="fas fa-circle text-success fa-stack-2x"></i>
            <i class="fas fa-user-check fa-stack-1x fa-inverse"></i>
          </span>
          <a class='nav-link active text-primary mr-2' :href='"/login?next="+window.location.pathname' v-if="userInfo && !userInfo.login">
            <span class="fa-stack fa-1x pointer tip" data-tippy-info="Click to log in">
              <i class="fas fa-circle text-primary fa-stack-2x"></i>
              <i class="fas fa-sign-in-alt fa-stack-1x fa-inverse"></i>
            </span>
          </a>
          <span class="fa-stack fa-1x pointer tip mr-2" data-tippy-info="Start Over" @click="reset()"  :class="{ 'disabled notallowed': !validation, 'pointer': validation }">
            <i class="fas fa-circle text-success fa-stack-2x"  :class="{ 'text-muted': !validation, 'text-danger': validation }"></i>
            <i class="fas fa-undo fa-stack-1x fa-inverse"></i>
          </span>
          <span class="fa-stack fa-1x pointer tip mr-2" data-tippy-info="Preview Progress" @click="getPreview()"  :class="{ 'disabled notallowed': !validation, 'pointer': validation }">
            <i class="fas fa-circle text-success fa-stack-2x"  :class="{ 'text-muted': !validation, 'mainTextDark': validation }"></i>
            <i class="fas fa-code fa-stack-1x fa-inverse"></i>
          </span>
          <span class="fa-stack fa-1x pointer tip mr-2" data-tippy-info="Import Metadata" @click="loadData()"  v-show="validation">
            <i class="fas fa-circle text-success fa-stack-2x"  :class="{ 'text-muted': !validation, 'mainTextDark': validation }"></i>
            <i class="fas fa-file-import fa-stack-1x fa-inverse"></i>
          </span>
          <span class="fa-stack fa-1x pointer tip mr-2" data-tippy-info="Bulk Registration" @click="handleBulk()"  v-show="validation">
            <i class="fas fa-circle text-success fa-stack-2x"  :class="{ 'text-muted': !validation, 'mainTextDark': validation }"></i>
            <i class="fas fa-registered fa-stack-1x fa-inverse"></i>
          </span>
          <div class="pillType tip pointer" @click="viewErrors()" data-tippy-info="Issues Details" :class="{'shake-horizontal':!valid}" style="outline: none !important;">
            <span class="alert-muted">issues</span>
            <span class="text-light" v-text="errors.length" :class="[valid?'bg-success':'bg-danger']"></span>
          </div>
        </div>
      </div>
  
      <div v-if="userInfo && !userInfo.login" class="widgetContainer bg-light jumbotron text-center m-1">
        <div class="alert text-danger text-center p-5">
          <h5>You must be logged in to proceed</h5>
          <h6><a :href='"/login?next="+window.location.pathname'>click here to log in</a></h6>
        </div>
      </div>
  
      <div v-else class="widgetContainer bg-light text-center">
          <template v-if="step === 1 ">
            <!-- STARTING POINT -->
            <h4 class="logoText">Metadata</h4>
            <p class="text-muted">
              Select the type of metadata you are interested in creating.
            </p>
            <div>
              <template v-for="item in presets">
                <buttom  @click="setStartingPoint(item)" class="btn themeButton text-light mr-2 tip" v-text="item.name" :data-tippy-info="item.description"></buttom>
              </template>
            </div>
          </template>
          <!-- OPTIONAL PORTALS -->
          <template v-if=" step === 2 ">
            <h4 class="logoText">Discovery Portals</h4>
            <p class="text-muted">
              Select the portals you are interested in. Each will add fields required in order to be discovered by that portal.
            </p>
            <form @submit.prevent="getFormValues()">
              <template v-for="item in portals">
                <div class="p-2 text-left w-50 m-auto">
                  <input class="form-check-input slider" type="checkbox" name="portal" :id="item.displayName" :value="item.name" :checked="item.selected" @click="item.selected = !item.selected">
                  <label class="form-check-label" :for="item.displayName">
                    <span v-text="item.displayName"></span>
                    <i class="fas fa-info-circle text-info desc" :data-tippy-info="item.description"></i>
                  </label>
                </div>
              </template>
              <button class="btn themeButton text-light mt-3" type="submit">NEXT <i class="fas fa-chevron-right"></i></button>
            </form>
          </template>
  
          <template v-if=" step === 3 ">
            <propcontainer v-show="validation" :type="'REQUIRED'"></propcontainer>
          </template>
  
          <template v-if=" step === 4 ">
            <propcontainer v-show="validation" :type="'RECOMMENDED'"></propcontainer>
          </template>
  
          <template v-if=" step === 5">
            <template v-if="window.location.pathname == '/guide/n3c/dataset' ">
              <h1 class="logoText">N3C Dataset Request</h1>
              <div class="p-5 text-center m-3">
                <img src="/static/img/N3C.png" width="250px" alt="N3C" class="text-center">
                <p class="text-muted text-center">
                  <b>Are you all done?</b> Click <b>Submit Request</b> to proceed.
                </p>
                <a class='btn btn-lg btn-success text-light' :class="{ 'disabled text-muted notallowed': !isComplete, 'bg-success text-light pointer': isComplete }" @click="handleRegistration()">
                  <small>
                    <i class="fas fa-check"></i> Submit Request
                  </small>
                </a>
              </div>
            </template>
            <template v-else>
              <h1 class="logoText">Registration</h1>
              <div class="p-5 text-center m-3">
                <p class="text-muted text-center">
                  <b>Are you all done?</b> Click <b>Register</b> to proceed. <br />You will leave this page after successfully registering this metadata.
                </p>
                <a class='btn btn-lg btn-success text-light desc' :class="{ 'disabled text-muted notallowed': !isComplete, 'bg-success text-light pointer': isComplete }" @click="handleRegistration()" :data-tippy-info="[!isComplete ? 'Available when all required fields are complete' : 'Click to register your metadata']">
                  <small>
                    <i class="fas fa-check"></i> Register
                  </small>
                </a>
              </div>
            </template>
            <div class="col-sm-12">
              <div class="row">
                <div class="col-sm-12 text-center p-3">
                  <h4 class="bold" :class="{ 'text-info': fieldsleftRegistration !== 0, 'text-success': fieldsleftRegistration !== 0 }">
                    <span v-show="fieldsleftRegistration === 0">Great Job! </span>
                    <span v-text="Math.ceil((totals.complete/totals.total)*100)+'% COMPLETE'" ></span>
                  </h4>
                  <small class="text-info"> (<span v-text='totals.complete'></span>/<span v-text='totals.total'></span>)</small>
                </div>
              </div>
              <div v-if="fieldsleftRegistration !== 0" class="col-sm-12 text-center p-3 rounded alert-light m-2">
                <h4 class="text-muted">Only <span class="text-danger bold" v-text="fieldsleftRegistration"></span> fields left!</h4>
                <button class="btn themeButton text-light" @click="goToStep(4)">Fill Out Now</button>
              </div>
              <div v-else class="col-sm-12 text-center p-3 rounded m-2">
                <button class="btn btn-danger text-light" @click="goToStep(step-1)"><i class="fas fa-chevron-left"></i> BACK</button>
              </div>
              <div class="d-flex justify-content-center flex-wrap">
                <template v-if="categoryTotals" v-for="(subcats,cat) in categoryTotals">
                  <catcontainer class="fade-in" :cat="cat" :subcats="subcats" :key="cat+subcats"></catcontainer>
                </template>
              </div>
            </div>
          </template>
      </div>
    </div>
  </div>
</div>

{% endblock %}
{% block extra_scripts %}
<script src="https://unpkg.com/vuex"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.18.0/axios.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.bundle.min.js" integrity="sha256-xKeoJ50pzbUGkpQxDYHD7o7hxe0LaOGeguUidbq6vis=" crossorigin="anonymous"></script>
<script src="/static/js/lodash.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ajv/6.12.4/ajv.min.js" integrity="sha512-jT80r/QIunAH3Bng0028a3kMjhpr+ApSrAjshiM+0+6s/O01//jwogIby3WnFle7UxDas+/gf3BgI4Rjju17ww==" crossorigin="anonymous"></script>
<script src="/static/js/renderjson.js"></script>
<script src="/static/js/notify.min.js"></script>
<script src="/static/js/moment.js"></script>
<script src="https://gmousse.github.io/dataframe-js/dist/dataframe.min.js"></script>
<script src="/static/js/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@7.28.11/dist/sweetalert2.all.min.js"></script>
<script>
  $.notify.addStyle('success', {
    html: "<div><span data-notify-text/></div>",
    classes: {
      base: {
        "white-space": "nowrap",
        "background-color": "#28a745",
        "padding": "5px",
        "color":'white',
      }
    }
  });
  $.notify.addStyle('danger', {
    html: "<div class='bg-danger text-light p-1'><span data-notify-text/></div>",
    classes: {
      base: {
        "white-space": "nowrap",
        "background-color": "#dc3545",
        "padding": "5px",
        "color":'white',
      }
    }
  });
  $.notify.addStyle('warning', {
    html: "<div class='bg-danger text-light p-1'><span data-notify-text/></div>",
    classes: {
      base: {
        "white-space": "nowrap",
        "background-color": "#ffc107",
        "padding": "5px",
        "color":'white',
      }
    }
  });
  $.notify.addStyle('info', {
    html: "<div class='bg-danger text-light p-1'><span data-notify-text/></div>",
    classes: {
      base: {
        "white-space": "nowrap",
        "background-color": "#17a2b8",
        "padding": "5px",
        "color":'white',
      }
    }
  });
  $.notify.addStyle('trophy', {
    html: `<div class="bg-dark p-1 text-light">
        <i class="fas fa-thumbs-up text-success"></i> <span data-notify-text/>
      </div>`,
      classes: {
        base: {
          "white-space": "nowrap",
          "background-color": "#343a40",
          "padding": "5px",
          "color":'white',
          "border-radius":"5px"
        }
      }
  });

  const store = new Vuex.Store({
    state: {
      schema:Object,
      required:Array,
      validation:null,
      schemaName:'',
      output:{},
      startingPoint: null,
      selectedPortals:[],
      step: Number,
      showDescriptions:true,
      bulkJSONItems:[],
      valid: Boolean,
      errors: [],
      guide_prefilled: {{guide_prefilled}},
      output_default:{}
    },
    strict: true,
    mutations: {
      toggleDesc(state){
        state.showDescriptions = !state.showDescriptions
      },
      saveBulkItems(state,payload){
        state.bulkJSONItems = payload['items'];
      },
      updateJsonItem(state,payload){
        let item = payload['item']
        let change = payload['change']
        let field = payload['field']

        for (var i = 0; i < state.bulkJSONItems.length; i++) {
          if (state.bulkJSONItems[i]['name'] == item['name'] || state.bulkJSONItems[i]['description'] == item['description']) {

            Vue.set(state.bulkJSONItems[i],field,change)

            Swal.fire({type:'success',
              toast:true,
              title: 'Updated',
              showConfirmButton:false,
              timer:1000})
          }
        }
      },
      saveSchema(state,payload){
        state.schema = payload['schema'];
        console.log('form properties',state.schema.validation.properties)
        state.output['@type'] = state.schema.name || state.schema.label
        state.output['@context'] = payload['schema']["@context"]
        let obj = Object.assign({}, state.output)
        Vue.set(state,'output_default',obj)

        // helper func to decide right subcategory
        function getProp(propname){
          let cat={
            'category': state.schema.label || state.schema.name
          }
          if (state.schema.validation.required.includes(propname)) {
            Vue.set(cat,'subcategory','Required')
          }else{
            Vue.set(cat,'subcategory','Recommended')
          }
          return cat
        }

        // Assign initial guide_categories
        for (var prop in state.schema.validation.properties) {
          if (state.schema.validation.properties[prop].hasOwnProperty('categories')) {
            state.schema.validation.properties[prop]['categories'].unshift(getProp(prop))
          }else{
            Vue.set(state.schema.validation.properties[prop],'categories',[])
            state.schema.validation.properties[prop]['categories'].unshift(getProp(prop))
          }
        }
      },
      saveSchemaName(state,payload){
        state.schemaName = payload['name'];
      },
      reset(state){
        state.schema = {};
        state.validation = null;
        state.step = '1';
        state.selectedPortals = []
        state.startingPoint = null
        window.location.reload()
      },
      markSelected(state,payload){
        let selection = payload['select'];
        for (key in state.schema.validation.properties) {
          if (key === selection) {
            Vue.set(state.schema.validation.properties[selection],'selected',true);
          }else{
            Vue.set(state.schema.validation.properties[key],'selected',false);
          }
        }
      },
      selectNext(state){
        for (key in state.schema.validation.properties) {
          if (state.schema.validation.properties[key] && !state.schema.validation.properties[key].value) {
            Vue.set(state.schema.validation.properties[key],'selected',true);
            break;
          }
        }
      },
      highlight(state,payload){
        let cat = payload['category'];
        let subcat = payload['subcategory'];
        for (prop in state.schema.validation.properties) {
          Vue.set(state.schema.validation.properties[prop],'highlighted',false);
        }
        for (prop in state.schema.validation.properties) {
          if (state.schema.validation.properties[prop].hasOwnProperty('categories')) {
            for (var i = 0; i < state.schema.validation.properties[prop]['categories'].length; i++) {
              if (state.schema.validation.properties[prop]['categories'][i]['category'] === cat && state.schema.validation.properties[prop]['categories'][i]['subcategory'] === subcat  ) {
                if (state.schema.validation.properties[prop]['highlighted']) {
                  Vue.set(state.schema.validation.properties[prop],'highlighted',false);
                }else {
                  Vue.set(state.schema.validation.properties[prop],'highlighted',true);
                }
              }
            }
          }
        }
      },
      unhighlight(state){
        for (prop in state.schema.validation.properties) {
          Vue.set(state.schema.validation.properties[prop],'highlighted',false);
        }
      },
      markCompleted(state,payload){
        let selection = payload['completed'];
        if (state.schema.validation.properties.hasOwnProperty(selection.name)) {
          Vue.set(state.schema.validation.properties[selection.name],'value',selection.value);
          //check for duplicate keys or plural names
          if (selection.name+"s" in state.schema.validation.properties && state.schema.validation.properties[selection.name+"s"].hasOwnProperty('duplicate') ) {
            $.notify(selection.name+"s < similar found and filled out",{ globalPosition: 'right',style:"info", showDuration: 40, });
            Vue.set(state.schema.validation.properties[selection.name+"s"],'value',selection.value);
          }
        }
      },
      clearValueOfProp(state,payload){
        let selection = payload['clear'];
        if (state.schema.validation.properties[selection].hasOwnProperty('value')) {
          Vue.delete(state.schema.validation.properties[selection],'value');
          Vue.set(state.schema.validation.properties[selection],'selected',false);
        }else {
          $.notify(selection+": no value detected",{ globalPosition: 'right',style:"danger", showDuration: 40, });
        }
        if (!state.schema.validation.properties[selection].hasOwnProperty('value')) {
          $.notify(selection+" was cleared",{ globalPosition: 'right',style:"success", showDuration: 40, });
        }
      },
      removeArrayItemFrom(state,payload){
        let field = payload['from']; //name of prop
        let item = payload['item']; //full info
        let props = state.schema.validation.properties;
        switch (props[field].value.constructor) {
          case Object:
            if (_.isEqual(props[field].value, item)) {
              Vue.delete(props[field],'value')
            }else{
              $.notify("[OBJ] does not match value",{ globalPosition: 'right',style:"danger", showDuration: 40, });
            }
            break;
          case Array:
            if (props[field] && props[field].value) {
              for (var i = 0; i < props[field].value.length; i++){
                let arr_item = props[field].value[i];
                switch (arr_item.constructor) {
                  case String:
                    if (arr_item === item) {
                      Vue.delete(props[field].value,i);
                      $.notify(item+" removed",{ globalPosition: 'right',style:"success", showDuration: 40, });
                    }
                    break;
                  case Object:
                    if (_.isEqual(arr_item, item)) {
                      Vue.delete(props[field].value,i)
                      $.notify("Item removed",{ globalPosition: 'right',style:"success", showDuration: 40, });
                    }
                    break;
                  default:
                    console.log("not handled")
                }
              }
            }else{
              console.log('NO VALUE',props[field])
            }
            break;
          case String:
            for (var i = 0; i < props[field].value.length; i++) {
              let prop_val = props[field].value[i];
              if (prop_val === item) {
                Vue.delete(props[field].value,i);
                $.notify(item+" removed",{ globalPosition: 'right',style:"success", showDuration: 40, });
              }
            }
            break;
          default:
            console.log("not handled")
        }


        if (props[field].hasOwnProperty('value')) {
          if (props[field].value.constructor === Array && props[field].value.length == 0) {
            Vue.delete(props[field],'value')
          }
        }

      },
      addToArrayFrom(state,payload){
        let field = payload['from'];
        let item = payload['item'];
        //Initialize array
        if (!state.schema.validation.properties[field].value) {
          Vue.set(state.schema.validation.properties[field], 'value', item)
        }else{
          if (state.schema.validation.properties[field]['value'].constructor === Object) {
            state.schema.validation.properties[field]['value'] = [state.schema.validation.properties[field]['value']]
            state.schema.validation.properties[field]['value'].push(item)
          }else if (state.schema.validation.properties[field]['value'].constructor === Array){
            state.schema.validation.properties[field]['value'].push(item)
          }else{
            state.schema.validation.properties[field]['value'] = [state.schema.validation.properties[field]['value']]
            state.schema.validation.properties[field]['value'].push(item)
          }
        }
      },
      formPreview(state){
        let props = state.schema.validation.properties;
        // Add prefilled values from config
        Vue.set(state,'output',Object.assign({}, state.output_default))

        for (var key in state.guide_prefilled) {
          Vue.set(state.output,key,state.guide_prefilled[key])
        }
        for (key in props) {
          if (props[key].hasOwnProperty('value')) {
            if (props[key]['value'] || props[key]['value'] === false) {
              if (_.isArray(props[key]['value']) && props[key]['value'].length === 1) {
                Vue.set(state.output,key,props[key].value[0])
              }else{
                Vue.set(state.output,key,props[key].value)
              }
            }
          }
        }
        // VALIDATION ON COMPLETE
        var ajv = new Ajv({allErrors:true, jsonPointers:true});
        var schema = state.schema.validation
        var data = state.output
        const isValid = ajv.validate(schema, data);

        // ajv.addKeyword('required', {
        //   validate: function validate (schema, data) {
        //     validate.errors = [{keyword: 'required', message: 'This field is required.', params: {keyword: 'required'}}];
        //     return false;
        //   },
        //   errors: true
        // });

        if(! isValid){
          state.valid = false;
          state.errors = ajv.errors;
          for (var key in props) {
            Vue.delete(props[key],'hasIssue')
          }
          let issues = []
          for (var i = 0; i < state.errors.length; i++) {
            if (state.errors[i]['dataPath']) {
              let parts = state.errors[i]['dataPath'].split('/')
              for (var x = 0; x < parts.length; x++) {
                let k = parts[x]
                if (k in props) {
                  if ('hasIssue' in props[k]) {
                    props[k]['hasIssue'].push(state.errors[i]['message'])
                  }else{
                    Vue.set(props[k],'hasIssue',[ state.errors[i]['message'] ])
                  }
                }
              }
            }
            if (state.errors[i]['params'].hasOwnProperty('missingProperty')) {
              let missing = state.errors[i]['params']['missingProperty'];
              if (props.hasOwnProperty(missing)) {
                if ('hasIssue' in props[missing]) {
                  props[missing]['hasIssue'].push(state.errors[i]['message'])
                }else{
                  Vue.set(props[missing],'hasIssue',[ state.errors[i]['message'] ])
                }
              }
            }
          }
        }else {
          state.valid = true;
          state.errors = []
          for (var key in props) {
            Vue.delete(props[key],'hasIssue')
          }
        }
      },
      mergeCategoryProps(state,payload){
        let origin = payload['origin'];
        let catprops = payload['catprops'];
        let catpropsrequired = payload['catpropsrequired'];
        // add requirements to main reqs
        for (var i = 0; i < catpropsrequired.length; i++) {
          if (!state.schema.validation.required.includes(catpropsrequired[i])) {
            state.schema.validation.required.push(catpropsrequired[i])
          }
        }
        // helper func to decide right succategory
        function getProp(propname){
          let cat={
            'category': origin,
          }
          if (catpropsrequired.includes(propname)) {
            Vue.set(cat,'subcategory','Required')
          }else{
            Vue.set(cat,'subcategory','Recommended')
          }
          return cat
        }

        // if matching add cat {name:orgin, subcategory: req/rec}
        // else add new prop with origin = name
        for (prop in catprops) {
          if (prop in state.schema.validation.properties) {
            // check if prop has guide_categories
            // if YES push new
            // if NO set-up and add
            if (state.schema.validation.properties[prop].hasOwnProperty('categories')) {
              state.schema.validation.properties[prop]['categories'].unshift(getProp(prop))
            }else{
              Vue.set(state.schema.validation.properties[prop],'categories',[])
              state.schema.validation.properties[prop]['categories'].unshift(getProp(prop))
            }
          }else if (prop.slice(0, -1)  in state.schema.validation.properties) {
            //plural form exists
            let newProp = catprops[prop]
            Vue.set(newProp,'categories',[])
            // set origin to remove by origin
            Vue.set(newProp,'origin', origin)
            // is a duplicate
            Vue.set(newProp,'duplicate', true)
            newProp['categories'].unshift(getProp(prop))
            Vue.set(state.schema.validation.properties,prop,newProp)
          }else{
            let newProp = catprops[prop]
            Vue.set(newProp,'categories',[])
            // set origin to remove by origin
            Vue.set(newProp,'origin', origin)
            newProp['categories'].unshift(getProp(prop))
            Vue.set(state.schema.validation.properties,prop,newProp)
          }
        }
        $.notify(origin+" added",{ globalPosition: 'right',style:"success", showDuration: 40, });
      },
      removeCategory(state,payload){
        let origin = payload['origin'];
        let catpropsrequired = [];
        $.notify(origin+" removed",{ globalPosition: 'right',style:"info", showDuration: 40, });
        for (var i = 0; i < state.selectedPortals.length; i++) {
          if (state.selectedPortals[i]['label'] === origin) {
            catpropsrequired = state.selectedPortals[i]['validation']['required']
          }
        }
        for (prop in state.schema.validation.properties) {
          // if origin matches remove prop
          if (state.schema.validation.properties[prop].hasOwnProperty('origin') && state.schema.validation.properties[prop]['origin'] === origin ) {
            Vue.delete(state.schema.validation.properties,prop)
          }else {
            // if not check categories and remove mention of origin
            if (state.schema.validation.properties[prop].hasOwnProperty('categories')) {
              for (var i = 0; i < state.schema.validation.properties[prop]['categories'].length; i++) {
                if (state.schema.validation.properties[prop]['categories'][i]['category'] === origin) {
                  state.schema.validation.properties[prop]['categories'].splice(i,1)
                }
              }
            }
          }
        }
      },
      setStartingPoint(state,payload){
        state.startingPoint= payload['startingPoint'];
      },
      addPortalSchema(state,payload){
        let portal = payload['portal']
        state.selectedPortals.push(portal)
      },
      changeStep(state,payload){
        state.step = payload['step']
      },
      addValue(state,payload){
        let name = payload['name'];
        let info = payload['info'];
        let value = payload['value'];
        let props = state.schema.validation.properties;
        for (key in props) {
          if (key === name) {
            if (info.hasOwnProperty('type') && info['type'] == 'object') {
              console.log('OBJECT')
              //SAVE OBJECT
              if (props[name].value) {
                Swal.fire({
                  title: 'Value Already Exists',
                  text: "Do you want to replace the value of: "+name,
                  showCancelButton: true,
                  confirmButtonText: 'Yes'
                }).then((result) => {
                  if (result.value) {
                    Vue.set(props[name],'value',value);
                  }
                })
              }else{
                Vue.set(props[name],'value',value);
              }
            }else if (info.hasOwnProperty('anyOf')) {
              console.log('ANY OF')
              // SAVE OBJECT TO ARRAY IF AVAILABLE
              for (var i = 0; i < info['anyOf'].length; i++) {
                if (info['anyOf'][i].hasOwnProperty('type') && info['anyOf'][i]['type'] == 'array') {
                  // CAN BE ARRAY
                  if (props[name].value) {
                    let val = props[name].value
                    if (_.isPlainObject(val)) {
                      // will replace
                      Swal.fire({
                        title: 'Value Exists',
                        text: "Do you want to replace the value of: "+name,
                        showCancelButton: true,
                        confirmButtonText: 'Yes'
                      }).then((result) => {
                        if (result.value) {
                          Vue.set(props[name],'value',value);
                        }
                      })
                    }
                    else if (_.isArray(val)) {
                      //push to exisiting array
                      props[name]['value'].push(value)
                    }else {
                      //no value yet
                      Vue.set(props[name],'value',value);
                    }
                  }else{
                    //no value yet
                    Vue.set(props[name],'value',value);
                  }
                }else{
                  //no ability to be array
                  console.log('no ability to be array')
                  Vue.set(props[name],'value',value);
                }
              }
            }else if (info.hasOwnProperty('oneOf')) {
              console.log('ONE OF')
              // SAVE OBJECT TO ARRAY IF AVAILABLE
              for (var i = 0; i < info['oneOf'].length; i++) {
                if (info['oneOf'][i].hasOwnProperty('type') && info['oneOf'][i]['type'] == 'array') {
                  // CAN BE ARRAY
                  if (props[name].value) {
                    let val = props[name].value
                    if (_.isPlainObject(val)) {
                      // will replace
                      Swal.fire({
                        title: 'Value Exists',
                        text: "Do you want to replace the value of: "+name,
                        showCancelButton: true,
                        confirmButtonText: 'Yes'
                      }).then((result) => {
                        if (result.value) {
                          Vue.set(props[name],'value',value);
                        }
                      })
                    }
                    else if (_.isArray(val)) {
                      //push to exisiting array
                      props[name]['value'].push(value)
                    }else {
                      //no value yet
                      Vue.set(props[name],'value',value);
                    }
                  }else{
                    //no value yet
                    Vue.set(props[name],'value',value);
                  }
                }else{
                  //no ability to be array
                  console.log('no ability to be array')
                  Vue.set(props[name],'value',value);
                }
              }
            }else{
              Vue.set(props[name],'value',value);
            }
          }
        }
      },
    },
    getters:{
      getBulkJSONItems:state=>{
        return state.bulkJSONItems
      },
      getValidStatus:state=>{
        return state.valid
      },
      getErrors:state=>{
        return state.errors
      },
      getShowDesc:state=>{
        return state.showDescriptions
      },
      getSchema: (state) => {
        return state.schema
      },
      getValidation: (state) => {
        if (state.schema.hasOwnProperty('validation')) {
          return state.schema.validation
        }else{
          return false;
        }
      },
      isRequired: (state) => (propname) =>{
        if (state.schema.validation.required.includes(propname)) {
          return true
        }else{
          return false
        }
      },
      isInputHidden: (state) => (propname) =>{
        if (propname in state.guide_prefilled) {
          return true
        }else{
          return false
        }
      },
      getSchemaName: (state)=>{
        return state.schemaName
      },
      getValueOf: (state) => (propname) =>{
        if (state.schema.validation.properties[propname].hasOwnProperty('value')) {
          return state.schema.validation.properties[propname].value
        }else {
          console.log(state.schema.validation.properties[propname])
          console.log('return null')
          return null
        }
      },
      getTotals:(state) => {
        let completeCount = 0;
        if (state.schema.hasOwnProperty('validation')) {
          let totalprops = Object.keys(state.schema.validation.properties).length
          for (key in state.schema.validation.properties) {
            if (state.schema.validation.properties[key] && state.schema.validation.properties[key].value) {
              completeCount++;
            }
          }
          let left = totalprops - completeCount;
          if (left === 0) {
            state.complete = true
          }
          let res = {'left':left,'complete':completeCount,'total':totalprops}
          return res
        }

      },
      getCategoryTotals: (state)=>{
        let cats = {}
        if (state.schema.hasOwnProperty('validation')) {
          for (key in state.schema.validation.properties) {
            if (state.schema.validation.properties[key].hasOwnProperty('categories')) {
              for (var i = 0; i < state.schema.validation.properties[key]['categories'].length; i++) {
                let c = state.schema.validation.properties[key]['categories'][i]['category']
                if(!cats.hasOwnProperty(c)) {
                  Vue.set(cats,c,{})
                  Vue.set(cats[c],'Required',{'completed':0,'todo':0})
                  Vue.set(cats[c],'Recommended',{'completed':0,'todo':0})

                  switch (state.schema.validation.properties[key]['categories'][i]['subcategory']) {
                    case 'Required':
                      cats[c]['Required']['todo'] += 1
                      break;
                    case 'Recommended':
                      cats[c]['Recommended']['todo'] += 1
                      break;
                    default:
                  }

                }else{
                  switch (state.schema.validation.properties[key]['categories'][i]['subcategory']) {
                    case 'Required':
                      cats[c]['Required']['todo'] += 1
                      break;
                    case 'Recommended':
                      cats[c]['Recommended']['todo'] += 1
                      break;
                    default:
                  }
                }
              }
            }
          }
          // UPDATE TOTALS
          for (key in state.schema.validation.properties) {
            if (state.schema.validation.properties[key] && state.schema.validation.properties[key].value || state.schema.validation.properties[key].value === false) {
              if (state.schema.validation.properties[key].hasOwnProperty('categories')) {
                for (var i = 0; i < state.schema.validation.properties[key]['categories'].length; i++) {

                  let c = state.schema.validation.properties[key]['categories'][i]['category']

                  switch (state.schema.validation.properties[key]['categories'][i]['subcategory']) {
                    case 'Required':
                      cats[c]['Required']['todo'] -= 1
                      cats[c]['Required']['completed'] += 1
                      break;
                    case 'Recommended':
                      cats[c]['Recommended']['todo'] -= 1
                      cats[c]['Recommended']['completed'] += 1
                      break;
                    default:
                  }
                }
              }
            }
          }
        }
        return cats
      },
      getPreview(state){
        return state.output
      },
      isComplete(state){
        let complete = false;
        if (state.schema && state.schema.hasOwnProperty('validation') && state.schema.validation.hasOwnProperty('required')) {
          let required = state.schema.validation['required']
          for (var i = 0; i < required.length; i++) {
            if (state.schema.validation.properties.hasOwnProperty(required[i]) && state.schema.validation.properties[required[i]].value || state.schema.validation.properties[required[i]].value === false) {
              complete = true
            }else{
              complete = false
              break;
            }
          }
        }
        return complete
      },
      getOutput(state){
        return state.output
      },
      getStartingPoint:(state)=>{
        return state.startingPoint
      },
      getSelectedPortals:(state)=>{
        return state.selectedPortals
      },
      getStep:(state)=>{
        return state.step
      },
    },
    actions:{
      reset ({ commit }) {
        commit('reset')
      },
      saveProgress({commit, state}){
        commit('formPreview')
        let obj = state.output
        sessionStorage.setItem('guideProgress',JSON.stringify(obj));
      },
    }
  });

  Vue.component('type-selector', {
    data: function(){
      return{
        options: [],
        parsed_options: {},
        type_selected: '',
        userObject:{}, 
        pulse: false
      }
    },
    props: ['info','main_name', 'isChild', 'childName'],
    methods:{
      parseOptions(){
        var self = this;
        // get options from oneOf or anyOf
        self.info && self.info.oneOf ? self.options = self.info.oneOf : self.info && self.info.anyOf ? self.options = self.info.anyOf : console.warn(`No oneOf/anyOf in ${self.main_name}`)
        // narrow options don't include array of existing options
        if (self.options.length) {
          // ANY OF AND ONE OF TYPE FIELDS
          self.options.forEach(option =>{
            
             if (option && option['@type']) {
               Vue.set(self.parsed_options, option['@type'] , option)
             }
             else if (option && option['items'] && option['items']['@type']) {
               if (!self.parsed_options.hasOwnProperty(option['items']['@type'])) {
                Vue.set(self.parsed_options, option['items']['@type'] , option)
               }
             }
             else if (option && option['enum']) {
               // use main prop name and replace underscore with space
               let name = self.main_name.split('_').join(' ');
               if (!self.parsed_options.hasOwnProperty(name)) {
                Vue.set(self.parsed_options, name , option)
               }
             }else{
              //  console.warn('Option exists in singular form.');
              //  console.warn(`Option: ${JSON.stringify(option, null, 2)}`);
             }
             
          });
        }else if( (self.info.hasOwnProperty('properties') && self.info.hasOwnProperty('@type')) && (self.info.hasOwnProperty('type') && self.info.type == 'object') ){
          // OBJECT TYPE FIELD
          Vue.set(self.parsed_options, self.info['@type'] , self.info)
        }
        // console.log(self.main_name, self.parsed_options)
        // self.checkAutoSelect();
      },
      isRequired(requiredList, name){
        return requiredList.includes(name) ? true : false;
      },
      updateObject(prop, event) {
        var self = this;
        Vue.set(self.userObject , prop, event.target.value);
      },
      updateParent(childValue){
        var self = this;
        if (self.userObject && self.userObject[childValue.subfield]) {
          let existing_val = [ self.userObject[childValue.subfield] ];
          existing_val.push(childValue.value)
          Vue.set(self.userObject , childValue.subfield, existing_val);
        }else{
          Vue.set(self.userObject , childValue.subfield, childValue.value);
        }
      },
      select(name){
        var self = this;
        self.type_selected == name ? self.type_selected = '' : self.type_selected = name;
      },
      getNestedValue(childName){
        var self = this;
        return self.userObject.hasOwnProperty(childName) ? JSON.stringify(self.userObject[childName], null, 2) : "";
      },
      checkAutoSelect(){
        var self = this;
        Object.keys(self.parsed_options).length == 1 ? (self.type_selected = Object.keys(self.parsed_options)[0] ) : console.log('multiple options');
      },
      handleVocab(propName,propInfo){
        let self = this;

        Swal.fire({
          title: propName,
          text: 'Search for an existing term here:',
          input: 'text',
          confirmButtonColor:"{{color_main}}",
          cancelButtonColor:"{{color_sec}}",
          animation:false,
          customClass:'scale-in-center',
          inputAttributes: {
            autocapitalize: 'off'
          },
          showCancelButton: true,
          confirmButtonText: 'Look up',
          showLoaderOnConfirm: true,
          focusConfirm: false,
          preConfirm: (query) => {
            let ontologies = propInfo['vocabulary']['ontology'].toString()
            let children = propInfo['vocabulary']['children_of'].toString()
            let url = `https://www.ebi.ac.uk/ols/api/search?q=${query}`
            +"&ontology="+ontologies
            +"&childrenOf="+children
            +"&type=class&fieldList=id,iri,label,description,obo_id,short_form,ontology_prefix"
            +"&queryFields=label"
            +"&rows=100"

            return fetch(url)
              .then(response => {
                if (!response.ok) {
                  throw new Error(response.statusText)
                }
                return response.json()
              })
              .catch(error => {
                Swal.showValidationMessage(
                  `Request failed: ${error}`
                )
              })
          },
          allowOutsideClick: () => !Swal.isLoading()
        }).then((result) => {
          if (result.value) {
            let html ="<div id='ontology' style='max-height: 500px;overflow: scroll;' class='p-1 text-left'>";
            let docs = result.value.response.docs;
            html += self.getVocabCheckboxHTML(html, docs);
            if (propInfo && !propInfo.strict) {
              html += `<div class="alert alert-info mt-1">
                          <h6>Didn't find what you are looking for? Enter value here:</h6>
                          <input class="form-control" type="text" id="qTerm">
                      </div>`
            }
            html += "</div>";

            Swal.fire({
              title: propName+'(s):',
              html: html,
              confirmButtonColor:"{{color_main}}",
              cancelButtonColor:"{{color_sec}}",
              animation:false,
              customClass:'scale-in-center',
              preConfirm: () => {

                let checked=[]

                  for (var i = 0; i < 100; i++) {
                    let x = document.getElementById("cb"+i)
                    if (x && x.checked) {
                      checked.push(x.value)
                    }
                  }
                  let y = document.getElementById("qTerm")
                  if (y.value) {
                    checked.push(y.value)
                  }
                  return checked
              }
            }).then((result) => {
              if (result.value) {
                for (var i = 0; i < result.value.length; i++) {
                  let res = result.value[i];
                  // let data = {value:res, subfield: self.main_name};
                  // console.log('term lookup res', data)
                  // self.updateParent(data)
                  var payload = {};
                  payload["item"] = res;
                  payload["from"] = self.main_name;
                  store.commit('addToArrayFrom',payload);
                  store.dispatch('saveProgress');
                }

              }
            })
          }
        });
      },
      getVocabCheckboxHTML(html, docs){
        for (var i = 0; i < docs.length; i++) {
          tippy('#cb'+i,{
            content:docs[i]
          });

          let label = docs[i]['label']
          if (label && label.length > 37) {
            label = label.substring(0,37)+"..."
          }
          html += `<div class="form-check">
                      <input class="form-check-input mr-2 slider" type="checkbox" value="`+docs[i]['iri']+`" id="cb`+i+`">
                      <label class="form-check-label" for="cb`+i+`" title="`+docs[i]['label']+`">
                          `+label+`
                          <i class="fa fa-info-circle text-info modaltip" data-tippy-info='`+JSON.stringify(docs[i])+`'></i>
                      </label>
                  </div>`
        }
        return html;
      },
      regularSubmit(ClassType, fieldInfo){
        var self = this;
        let inputIsObject =  fieldInfo.hasOwnProperty('type') && fieldInfo.type == 'object' ? true : false;
        if (ClassType && inputIsObject) {
          self.userObject = Object.assign({"@type":ClassType}, self.userObject)
        }
        let data = Object.assign({}, self.userObject);
        // console.log('submit data', JSON.stringify(data, null, 2))
        if (self.isChild) {
          // CHILD
          self.$emit('update', {value:data, subfield:self.childName})
          self.type_selected = ''
        }else{
          // PARENT
          var payload = {};
          payload["item"] = data;
          payload["from"] = self.main_name;
          store.commit('addToArrayFrom',payload);
          store.dispatch('saveProgress');
          //reset 
          self.userObject = {}
          self.type_selected = ''
        }
      },
      animatedSubmit(ClassType, fieldInfo){
        let self = this;
        const over = document.querySelector('#over-'+self.main_name);
        // hide lower part 
        self.type_selected = ''

        over.classList="bg-success text-center p-5 slit-out-horizontal";
        over.innerHTML= `<svg class="checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
            <circle class="checkmark__circle" cx="26" cy="26" r="25" fill="none"/>
            <path class="checkmark__check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
          </svg>`
        setTimeout(()=>{
          self.regularSubmit(ClassType, fieldInfo);
          over.classList="";
          over.innerHTML="";
        }, 1900);
      },
      handleSubmit(ClassType, fieldInfo){
        let self = this;
        if (self.requirementsFulfilled(fieldInfo)) {
          if (!self.isChild) {
            self.animatedSubmit(ClassType, fieldInfo);
          }else{
            self.regularSubmit(ClassType, fieldInfo);
          }
        }else{
          Swal.fire({type:'error',
                toast:true,
                title: `${ClassType} missing requirements`,
                showConfirmButton:false,
                timer:2000})
        }
      },
      requirementsFulfilled(req){
        let self = this;
        let req_list = req.hasOwnProperty('required') ? req.required : false;
        if (!req_list) return true 
        let check = true;
        req_list.forEach(r => {
          if (!self.userObject.hasOwnProperty(r)) check = false;
        });
        return check;
      },
      handleEnum(propName,propInfo){
        let e = propInfo['enum']
        let html = ''

        for (var eIndex = 0; eIndex < e.length; eIndex++) {
          let name = e[eIndex]
          html += '<div><label><input type="checkbox" class="mr-1 zoom-2" id="cb'+eIndex+'" value="'+name+'"/>'+name+'</label></div>'
        }

        html = `<div class="text-left">
                  <form id=#cbForm">`+html+`</form>
                </div>`

        Swal({
          title: propName,
          inputAttributes: {
            id:'hideThis'
          },
          animation:false,
          confirmButtonColor:"{{color_main}}",
          cancelButtonColor:"{{color_sec}}",
          customClass:'scale-in-center',
          html: html,
          onOpen: ()=>{
            document.getElementById("hideThis").classList.add('d-none');
          },
          preConfirm: () => {

            let checked=[]

              for (var i = 0; i < e.length; i++) {
                let x = document.getElementById("cb"+i)
                if (x && x.checked) {
                  checked.push(x.value)
                }
              }
              console.log(checked)
              return checked
          }
        }).then((result) => {
          if (result.value) {
            for (var i = 0; i < result.value.length; i++) {
              var payload = {};
              payload["item"] = result.value[i];
              payload["from"] = propName;
              store.commit('addToArrayFrom',payload);

              store.dispatch('saveProgress');
            }

          }
        })
      }
    },
    watch:{
      // type_selected: v =>{
      //   console.log('type_selected', v)
      // },
      userObject: {
        handler(val){
          let keys = Object.keys(val).length
          keys >= 1 ? this.pulse = true : this.pulse = false;
        },
        deep: true
      }
    },
    mounted: function(){
      this.parseOptions();
    },
    template:
    `<div class="d-block w-100">
      <div class="row m-0 p-relative">
        <div class="col-sm-12 w-100">
          <div class="d-flex justify-content-center align-items-stretch">
            <!--  TABS -->
            <template v-for="(value, name) in parsed_options">
              <div class="pointer m-1 text-center text-light rounded" @click="select(name)" 
              :class="[type_selected == name?'mainBackLight arrow-bottom':'mainBackDark', isChild ? 'p-1':'p-2']">
                <h6 class="m-0" v-if="!isChild">
                  <i class="fas fa-plus"></i> <span v-text="name"></span>
                </h6>
                <h6 class="m-0" v-else>
                  <i class="fas fa-plus"></i> <span v-text="name"></span>
                </h6>
              </div>
            </template>
          </div>
        <div>
        <!--  Animation -->
        <div style="perspective: 800px; z-index:999;">
          <div :id="'over-'+main_name">
          
          </div>
        </div>
        <!--  TAB SECTIONS -->
        <div class="col-sm-12 w-100 text-dark">
          <form v-if="type_selected == name" class="w-100 fade-in" v-for="(value, name) in parsed_options" @submit.prevent="handleSubmit(name, value)">
            <div class="col-sm-12 py-2">
              <template v-if="!isChild">
                <small class="text-muted m-2"><i class="fas fa-circle text-danger"></i> = required</small>
                <small class="text-muted"><i class="fas fa-circle text-info"></i> = recommended</small>
              </template>
            </div>

            <!--  CLASS TYPE  IF NOT ENUM OR VOCAB-->
            <div class="col-sm-12 mainBackLight text-light p-1 text-center classTab" v-if="value && !value.vocabulary && !value.enum">
              <h5 class="m-0" v-text="name"></h5>
            </div>

            <!--  VOCABULARY TOP LEVEL -->
            <div v-if="value && value.vocabulary" class="bg-light p-4 text-light d-flex justify-content-start align-items-center" :class="[isChild?'col-sm-12':'col-sm-12']">
              <button class="btn btn-danger m-auto" @click.prevent="handleVocab(main_name, value)">
                <i class="fas fa-plus"></i> <span v-text="main_name+'(s)'"></span>
              </button>
            </div>
            <!--  ENUMERATION TOP LEVEL -->
            <div v-else-if="value && value.enum" class="bg-light p-4 text-light d-flex justify-content-start align-items-center" :class="[isChild?'col-sm-12':'col-sm-12']">
              <button class="btn btn-danger m-auto" @click.prevent="handleEnum(main_name, value)">
                <i class="fas fa-plus"></i> <span v-text="main_name"></span>
              </button>
            </div>
            
            <!--  FOR EACH PROP -->

            <div v-for="(propInfo, propName) in value.properties" class="row m-0">
              <!--  INPUT DESCRIPTION -->
              <div class="col-sm-12 p-1" v-if="propInfo && propInfo.description && propName !== '@type'">
                <small v-html="propInfo.description"></small>
              </div>
              <!--  INPUT NAME -->
              <div class="bg-dark p-1 text-light d-flex justify-content-start align-items-center border-bottom" :class="[isChild?'col-sm-12':'col-sm-12 col-md-4']" v-if="propName !== '@type'">
                <small>
                  <b v-if="value && value.required">
                    <i class="fas fa-circle text-info" :class="[isRequired(value.required, propName)?'text-danger':'text-info']"></i>
                    <span v-text="propName"></span>
                  </b>
                  <b v-else class="text-info" v-text="propName"></b>
                </small>
              </div>
              <!--  INPUT TYPES -->
              <div class="p-1 text-dark border-bottom" :class="[isChild?'col-sm-12 alert-secondary':'col-sm-12 col-md-8 bg-light']" v-if="propName !== '@type'">
                <!--  WITH TYPE -->
                <template v-if="propInfo && propInfo.type">
                  <!--  STRING TYPES -->
                  <template v-if="propInfo.type == 'string' ">
                    <!--  VOCABULARY UNDER PROPERTIES -->
                    <template v-if="propInfo && propInfo.vocabulary">
                      <button class="btn btn-danger m-auto" @click.prevent="handleVocab(main_name, value)">
                        <i class="fas fa-plus"></i> <span v-text="main_name+'(s)'"></span>
                      </button>
                    </template>
                    <!--  WITH FORMAT -->
                    <template v-else-if="propInfo && propInfo.format == 'uri' ">
                      <!--  STRING URL -->
                      <div class="input-group">
                        <div class="input-group-prepend">
                          <span class="input-group-text" id="basic-addon1"><i class="fas fa-link"></i></span>
                        </div>
                        <input class="form-control" type="url" @input="updateObject(propName, $event)" :placeholder="'enter '+propName">
                      </div>
                    </template>
                    <template v-else-if="propInfo && propInfo.format == 'date' ">
                      <!--  STRING DATE -->
                      <div class="input-group">
                        <div class="input-group-prepend">
                          <span class="input-group-text" id="basic-addon1"><i class="fas fa-calendar-alt"></i></span>
                        </div>
                        <input class="form-control" type="date" @input="updateObject(propName, $event)">
                      </div>
                    </template>
                    <!--  REGULAR STRING -->
                    <input v-else class="form-control" type="text" @input="updateObject(propName, $event)" :placeholder="'enter '+propName">
                  </template>
                  <!--   INTEGER  -->
                  <template v-else-if="propInfo && propInfo.type == 'integer'">
                    <div class="input-group">
                      <div class="input-group-prepend">
                        <span class="input-group-text" id="basic-addon1"><i class="fas fa-hashtag"></i></span>
                      </div>
                      <input class="form-control" type="number" @input="updateObject(propName, $event)">
                    </div>
                  </template>
                  <!--    BOOLEAN   -->
                  <template v-else-if="propInfo && propInfo.type == 'boolean'">
                    <small>Oops, this hasn't been handled yet..</small>
                  </template>
                  <!--   TYPE OBJECT  -->
                  <template v-else-if="propInfo && propInfo.type == 'object'">
                    <div class="alert-secondary">
                      <pre v-text="getNestedValue(propName)"></pre>
                    </div>
                    <type-selector :info="propInfo" :main_name="main_name" :childName="propName" :isChild="true" @update="updateParent"></type-selector>
                  </template>
                  <!--  LAST RESORT STRING -->
                  <input v-else class="form-control" type="text" @input="updateObject(propName, $event)" :placeholder="'enter '+propName">
                </template>
                <!--   NO TYPE ON TOP LEVEL  -->
                <template v-else>
                  <template v-if="propInfo && propInfo.anyOf">
                    <!--   ANY OF  -->
                    <div class="w-100">
                      <div class="border rounded p-1">
                        <pre v-text="getNestedValue(propName)"></pre>
                      </div>
                      <type-selector :info="propInfo" :main_name="main_name" :childName="propName" :isChild="true" @update="updateParent"></type-selector>
                    </div>
                  </template>
                  <template v-if="propInfo && propInfo.oneOf">
                    <!--   ONE OF  -->
                    <div class="w-100">
                      <div class="alert-secondary">
                        <pre v-text="getNestedValue(propName)"></pre>
                      </div>
                      <type-selector :info="propInfo" :main_name="main_name" :childName="propName" :isChild="true" @update="updateParent"></type-selector>
                    </div>
                  </template>
                  <!--   CONSTANT  -->
                  <template v-else-if="propInfo && propInfo.const">
                    <div class="text-muted">
                      <small v-text="propInfo.const"></small>
                    </div>
                  </template>
                  <!--  LAST RESORT NO TYPE -->
                  <template v-else>
                    <small v-text="propInfo"></small>
                  </template>
                </template>
              </div>
            </div>
            <!--  SUBMIT IF NOT ENUM OR VOCAB-->
            <div class="col-sm-12 p-0 mt-2" v-if="value && !value.vocabulary && !value.enum">
              <button type="submit" class="btn w-100" :class="[isChild?'btn-info btn-sm':'btn-success btn-lg', pulse && isChild ? 'jello':'']">
                Add <span v-text="isChild?childName:name"></span>
              </button>
            </div>
          </form>
        <div>
      </div>
    </div>`
  });

  Vue.component('json-item', {
    data: function(){
      return{
        errMSG:"",
        successMSG:"",
        loading: false,
      }
    },
    props: ['item', 'number'],
    methods:{
      registerJSONItem(isRetry){
        var self = this;

        let schema = store.getters.getSchema

        let config = {
           headers: {
             'content-type': 'application/json'
           }
         }

        axios.post('/api/dataset?schema='+schema['namespace']+'::'+schema['prefix']+':'+schema['label'],self.item,config).then(res=>{
          self.loading = false;
          if (res.data.success) {
            self.successMSG = `<a href="/dataset/`+res.data.id+`" target="_blank" rel="nonreferrer"><small>Registration Successful! Click here to view.</small></a>`;
            self.errMSG = '';
          }
        }).catch(err=>{
          self.loading = false;
          if (isRetry) {
            Swal.fire({type:'error',
              toast:true,
              title: 'Failed',
              showConfirmButton:false,
              timer:1000})
          }
          let culprit = "<small class='d-block text-danger'><b>ERROR: "+err.response.data.error+"</b></small>"
          if (err.response.data && err.response.data.path) {
            culprit += "<small class='mr-2'>Culprit (index/property)<i class='fas fa-arrow-right'></i> <b class='text-danger'>"+err.response.data.path+"</b></small>"
          }
          if (err.response.data.parent && err.response.data.parent.path){
            if (true) {
              culprit += "<small>Under <i class='fas fa-arrow-right'6</i> <b class='text-danger'>"+err.response.data.parent.path+"</b></small>"
            }
            if (err.response.data.parent && err.response.data.parent.reason) {
              culprit += "<div class='text-danger p-1 m-0'><small> "+err.response.data.parent.reason+"</small></div>"
            }
          }
          if (err.response.data.hasOwnProperty('validator_value') && err.response.data.validator_value.length){
            culprit += "<div class='text-info p-1 m-0'><small> Hint: "+err.response.data.validator_value+"</small></div>"
          }
          self.errMSG = culprit;
          throw err;
        })
      },
      edit(isRetry){
        var self = this;
        let list ={}
        let notAllowed=['@context','@type']
        for(key in self.item){
          if (!notAllowed.includes(key)) {
            list[key] = key
          }
        }

        Swal.fire({
          title: `Quick Edit`,
          text:"Which field would you like to edit?",
          input: 'select',
          footer:"<b class='text-danger'>Important:<b>Only existing fields can be edited.</b>",
          inputOptions: list,
          inputPlaceholder: 'Select a field to edit',
          showCancelButton: true,
          confirmButtonColor:"{{color_main}}",
          cancelButtonColor:"{{color_sec}}",
          confirmButtonText: 'Edit',
          inputValidator: (value) => {
            return new Promise((resolve) => {
              if (!value) {
                resolve('You must select something first')
              }else{
                resolve()
              }
            })
          }
        }).then((keyname) => {
          if (keyname.value) {
            let iValue =''

            if (typeof self.item[keyname.value] === 'string' ||  typeof self.item[keyname.value] === 'number' ||  typeof self.item[keyname.value] === 'boolean') {
              iValue = self.item[keyname.value]
            }else{
              iValue = JSON.stringify(self.item[keyname.value],null,2)
            }

            Swal.fire({
              title: "Edit: "+keyname.value,
              input: 'textarea',
              footer:`<small>Make sure to close all: {},[] and quotes</small>`,
              confirmButtonColor:"{{color_main}}",
              cancelButtonColor:"{{color_sec}}",
              animation:false,
              customClass:'scale-in-center',
              inputPlaceholder: self.item[keyname.value],
              inputValue: iValue,
              inputAttributes: {
                'aria-label': keyname.value,
                'rows':15
              },
              showCancelButton: true,
              confirmButtonText: 'Save',
              inputValidator: (value) => {
                return new Promise((resolve) => {
                  if (value === self.item[keyname.value]) {
                    resolve("You haven't changed anything yet")
                  }else{
                    resolve()
                  }
                })
              }
            }).then((newdata) => {
              if (newdata.value) {
                if (newdata.value[0]==="{" || newdata.value[0]==="[") {
                  var payload = {};
                  payload["item"] = self.item;
                  payload["field"] = keyname.value;
                  payload["change"] = JSON.parse(newdata.value);
                  store.commit('updateJsonItem',payload);
                }else{
                  var payload = {};
                  payload["item"] = self.item;
                  payload["field"] = keyname.value;
                  payload["change"] = newdata.value;
                  store.commit('updateJsonItem',payload);
                }
              }
            })
          }
        })
      },
    },
    computed:{
      short_name:function(){
        if (this.item.name.length > 100) {
          return this.item.name.substring(0,100)+"..."
        }else {
          return this.item.name
        }
      },
      tipInfo:function(){
        return JSON.stringify(this.item,null,2)
      }
    },
    mounted: function(){
      var self = this;

      tippy( '#jsonTable', {
        target:'.tip',
        trigger: 'click',
        placement:'top',
        theme:'light',
        sticky: true,
        content: 'loading',
        interactive: true,
        animation: 'fade',
        onShow(instance) {
          let info = instance.reference.dataset.tippyInfo;
          instance.setContent("<div class='bg-light' style='max-height:300px; overflow:scroll;'><small class='text-left text-light'><pre id='callResults'>"+info+"</pre></small></div>");
        }});

      self.registerJSONItem();
    },
    template: `<tr :class="{'alert-success':successMSG,'alert-warning':errMSG}">
                  <td>
                    <b class="text-info" v-text="number+'- '"></b>
                    <small :title="item.name">
                      <span v-text="short_name"></span> <i class="fas fa-info-circle tip pointer text-primary" :data-tippy-info="tipInfo"></i>
                    </small>
                  </td>
                  <td class="align-middle">
                    <small v-if="loading" class="text-muted">Registering...</small>
                    <small v-if="errMSG" v-html="errMSG"></small>
                    <small v-if="successMSG" v-html="successMSG"></small>
                    <button role="button" v-if="errMSG" @click="edit" class="btn btn-sm mainBackDark text-light mr-1">Edit</button>
                    <button role="button" v-if="errMSG" @click="registerJSONItem(1)" class="btn btn-sm mainBackLight text-light">Retry Registration</button>
                  </td>
                  <td class="bg-dark align-middle">
                    <span class="badge d-block" :class="{'badge-danger':errMSG,'badge-success':successMSG}">
                      <i v-if="loading" class="fas fa-spinner fa-pulse mainTextDark"></i>
                      <small v-if="errMSG">FAILED <i class="fas fa-poo"></i></small>
                      <small v-if="successMSG">REGISTERED <i class="fas fa-registered"></i></small>
                    </span>
                  </td>
                </tr>`
  });

  Vue.component('chart', {
    data: function(){
      return{
        shouldHighlight:false,
        myChart : null
      }
    },
    props: ['name','totals','unique','maincategory'],
    methods:{
      visualize(){
        var self = this;
        let progressColor = self['totals']['todo'] === 0 ?"#28A744":'#17A2B7'
        let mainColor = self.name === "Required" ? "#9fa7aa":"#b4b7b8"
        self.myChart = new Chart(document.getElementById(self.unique), {
            type: 'pie',
            data: {
              labels: ["Done","To-Do"],
              datasets: [{
                backgroundColor: [progressColor,mainColor],
                data: [self.totals['completed'],self.totals['todo']]
              }]
            },
            options: {
              animation: false,
              responsive: true,
              title: {
                display: false,
                text:self.name
              },
              legend:{
                display:false
              },
              elements: {
                arc: {
                    borderWidth: 0
                }
              }
            }
        });
      },
      highlight(){
        var self = this;

        var payload = {};
        payload["category"] = self.maincategory;
        payload["subcategory"] = self.name;
        store.commit('highlight',payload);
      },
    },
    watch:{
      totals:function(n){
        this.visualize()
      },
      shouldHighlight:function(h){
        if (h) {
          this.highlight()
        }else {
          store.commit('unhighlight');
        }
      }
    },
    mounted: function(){
      this.visualize()
      tippy( '.fa-highlighter', {
        maxWidth:'200px',
        placement:'top',
        content: '<div class="text-muted m-0" style="border-radius:none">Highlight All</div>',
        animation: 'fade',
        theme:'light'});
    },
    computed: {

    },
    template:
    `<div>
      <div class="text-center">
        <small :class="[name === 'Required' ? 'text-danger': 'text-muted']">
          <span v-text="name"></span>
          <!--<span class="badge badge-pill pointer unselectable" @click="shouldHighlight = !shouldHighlight" :class="[!shouldHighlight? 'badge-dark text-warning' :'badge-warning text-dark']">
            <i class="fas fa-highlighter pointer unselectable" ></i>
          </span>-->
        </small>
      </div>
      <canvas :id=unique width="90"></canvas>
    </div>`
  });

  Vue.component('catcontainer', {
    data: function(){
      return{
        shouldHighlight:false,
        canRemove: true,
      }
    },
    props: ['cat','subcats','totals'],
    methods:{
      removeCat(){
        var self = this;
        Swal.fire({
          title: 'Are you sure you want to remove '+self.cat+'?',
          showCancelButton: true,
          animation:false,
          customClass:'scale-in-center',
          showCancelButton: true,
          confirmButtonColor:"{{color_main}}",
          cancelButtonColor:"{{color_sec}}",
          confirmButtonText: 'Yes'
        }).then((result) => {
          if (result.value) {
            var payload = {};
            payload["origin"] = self.cat
            store.commit('removeCategory',payload);
            self.added = false;
          }
        })
      },
    },
    watch:{

    },
    mounted: function(){
      var self = this;
      let sp= store.getters.getStartingPoint
      if (sp.name == self.cat) {
        self.canRemove = false
      }
    },
    template:
    `<div class="m-1 text-center p-2 tip rounded" :data-tippy-info="cat" style="max-height:109px;outline:none !important;">
      <small  class="bold text-info d-block">
        <i v-if=" cat ==='Google'" class="fab fa-google googleText mr-1"></i>
        <span v-text="cat+' Progress'"></span>
        <i v-if="canRemove" class="fas fa-minus-square text-danger pointer desc" data-tippy-info="Remove" @click="removeCat()"></i>
      </small>
      <div class="d-flex justify-content-around">
        <template v-for="(totals,subcat) in subcats">
          <chart class="d-inline-block" :name="subcat" :unique="cat+subcat" :maincategory="cat" :totals="totals" :key="cat+subcat"></chart>
        </template>
      </div>
    </div>`
  });

  Vue.component('addcategory', {
    data: function(){
      return{
        added:false,
        loading: false,
        reqfields: [],
        specificSchema:{}
      }
    },
    props: ['item'],
    methods:{
      getCatData:function(){
        var self = this;
        if (!self.added) {
          self.loading = true;
          Swal.fire({
            title: 'Add '+self.item.name+' fields?',
            showCancelButton: true,
            animation:false,
            customClass:'scale-in-center',
            showCancelButton: true,
            confirmButtonColor:"{{color_main}}",
            cancelButtonColor:"{{color_sec}}",
            confirmButtonText: 'Yes, add them!'
          }).then((result) => {
            if (result.value) {
              axios.get('/api/registry/'+self.item.namespace+'/'+self.item.prefix+':'+self.item.name).then(res=>{
                self.loading = false;
                //save schema
                self.specificSchema=res.data
                var payload = {};
                payload["origin"] = self.item.name
                payload["catprops"] = res.data.validation.properties;
                if (res.data.validation.required) {
                  payload["catpropsrequired"] = res.data.validation.required;
                  self.reqfields = res.data.validation.required;
                }else{
                  payload["catpropsrequired"] = [];
                }
                store.commit('mergeCategoryProps',payload);
                self.added = true;

              }).catch(err=>{
                Swal.fire({
                  type: 'error',
                  position: 'center',
                  title: 'Failed because: ',
                  text: err.response.data.reason
                });
                self.loading = false;
                throw err;
              })

            }
          })

        }
      },
      removeCat(){
        var self = this;
        Swal.fire({
          title: 'Are you sure you want to remove '+self.item.name+' fields?',
          showCancelButton: true,
          animation:false,
          customClass:'scale-in-center',
          showCancelButton: true,
          confirmButtonColor:"{{color_main}}",
          cancelButtonColor:"{{color_sec}}",
          confirmButtonText: 'Yes, remove them!'
        }).then((result) => {
          if (result.value) {
            var payload = {};
            payload["origin"] = self.item.name
            payload["catpropsrequired"] = self.reqfields
            store.commit('removeCategory',payload);
            self.added = false;
          }
        })
      },
      formPreviewSpecific(){
        var self = this;
        store.commit('formPreview')
        let output = store.getters.getPreview

        let previewObj = {}
        Vue.set(previewObj,'@type',self.item.name)
        Vue.set(previewObj,'@context','http://discovery.biothings.io/view/schema/')

        // compare combined output and export only props found in this schema
        for (var key in output) {
          if (self.specificSchema.validation.properties.hasOwnProperty(key)) {
            Vue.set(previewObj,key,output[key])
          }
        }

        return previewObj

      },
      previewMetadata(){
        var self = this;
        let preview = self.formPreviewSpecific();
        Swal.fire({
          position: 'center',
          confirmButtonColor:"{{color_main}}",
          cancelButtonColor:"{{color_sec}}",
          animation:false,
          footer:`<small><b>NOTE: </b>Some inputs may be missing as they do not match those specified by `+self.item.name+`</small>`,
          customClass:'scale-in-center',
          html: `<h6 class="text-center mainTextDark">`+self.item.name+` compliant structured metadata</h6><div class="text-left p-1 previewBox">
                  <small>
                    <pre>
                      `+JSON.stringify(preview,null,2)+`
                    </pre>
                  </small>
                </div>`
        });
      },
      exportSchema(){
        var self = this;
          let preview = self.formPreviewSpecific();

          Swal.fire({
            title: 'Name your file',
            input: 'text',
            inputAttributes: {
              autocapitalize: 'off'
            },
            showCancelButton: true,
            confirmButtonText: 'Download JSON-LD',
            allowOutsideClick: () => !Swal.isLoading()
          }).then((result) => {
            if (result.value) {
              self.download(JSON.stringify(preview,null,2), result.value+'.jsonld', 'text/plain')
            }
          })

      },
      download(content, fileName, contentType) {
        var a = document.createElement("a");
        var file = new Blob([content], {type: contentType});
        a.href = URL.createObjectURL(file);
        a.download = fileName;
        a.click();
      }
    },
    watch:{

    },
    mounted: function(){

      tippy( '#widget',{
          target:'.desc',
          content: 'Loading...',
          maxWidth:'200px',
          placement:'bottom',
          animation: 'fade',
          theme:'light',
          onShow(instance) {
            let info = instance.reference.dataset.tippyInfo;
            instance.setContent("<div class='text-muted m-0'>"+info+"</div>")
          }
        });
    },
    computed: {

    },
    template:
    `<div class="mr-2 w-25" :class="{'bg-secondary': !added, 'bg-light': added}">
      <div class="row m-0">
        <div class="col-sm-8 p-1 d-flex align-items-center justify-content-around desc" :data-tippy-info="item.description">
          <span :class="{'text-light': !added, 'text-info': added}">
            <i v-if="item.name ==='Google'" class="fab fa-google googleText mr-1"></i>
            <span v-text="item.name"></span>
          </span>
        </div>
        <div class="col-sm-4 p-1 bg-dark actions d-flex align-items-center justify-content-around">
          <span v-if="!added" class="p-1 desc" @click="getCatData" data-tippy-info="Add Fields">
            <i class="fas fa-plus-circle pointer text-muted"></i>
          </span>
          <span v-if="added" @click="removeCat" class="p-1 desc" data-tippy-info="Remove Fields">
            <i class="fas fa-minus-circle pointer text-danger"></i>
          </span>
          <span v-if="added" class="p-1 desc" @click="previewMetadata" :data-tippy-info="'Preview'">
            <i class="fas fa-code pointer text-success"></i>
          </span>
          <span v-if="added" class="p-1 desc" @click="exportSchema" :data-tippy-info="'Export '+item.name+' compliant structured metadata'">
            <i class="fas fa-file-export pointer text-warning"></i>
          </span>
        </div>
      </div>
    </div>`
  });

  Vue.component('object-input', {
    data: function(){
      return{
        userObj: {},
      }
    },
    props: ['name','info'],
    methods:{
      markCompleted(propname){
        var self = this;

        payload = {'name':self.name,'info': self.info, 'value':self.userObj}
        store.commit('addValue',payload);
        store.dispatch('saveProgress');
      },
      clearFieldFor:function(propname){
        var payload = {};
        payload["clear"] = propname;
        store.commit('clearValueOfProp',payload);
        store.dispatch('saveProgress');
      },
      handleObjectSubmit(event){
        let self = this;
        let fields = event.target.elements;
        console.log(fields)
        for (var i = 0; i < fields.length; i++) {
          if (fields[i].localName == 'input' && fields[i].value) {
            Vue.set(self.userObj, fields[i].dataset.field, fields[i].value)
          }
        }
        console.log('final Object', self.userObj)
        self.markCompleted();
        document.getElementById(self.name+"-form").reset();
      }
    },
    computed: {
      isRequired:function(){
        return store.getters.isRequired(this.name)
      },
      done: {
        get () {
          return this.$store.state.schema.validation.properties[this.name].value
        }
      },
      showDesc:function(){
        return store.getters.getShowDesc
      }
    },
    mounted: function(){

    },
    template:
    `<div>
      <form class="brackets-grey p-1" v-if="!done" :id="name+'-form'" @submit.prevent="handleObjectSubmit($event)">
        <template v-for="(fieldInfo, fieldName) in info.properties">
          <template v-if="fieldInfo && fieldInfo.format == 'uri' ">
            <div class="input-group mb-1 input-group-sm">
              <div class="input-group-prepend">
                <div class="input-group-text" v-text="fieldName"></div>
              </div>
              <input :data-field="fieldName" type="url" class="form-control" placeholder="Enter url here">
            </div>
          </template>
          <template v-else-if="fieldInfo && fieldInfo.format == 'date' ">
            <div class="input-group mb-1 input-group-sm">
              <div class="input-group-prepend">
                <div class="input-group-text" v-text="fieldName"></div>
              </div>
              <input :data-field="fieldName" type="date" class="form-control" placeholder="Enter text here">
            </div>
          </template>
          <template v-else-if="fieldInfo && fieldInfo.type == 'integer' ">
            <div class="input-group mb-1 input-group-sm">
              <div class="input-group-prepend">
                <div class="input-group-text" v-text="fieldName"></div>
              </div>
              <input :data-field="fieldName" type="" class="form-control" placeholder="Enter text here">
            </div>
          </template>
          <template v-else>
            <div class="input-group mb-1 input-group-sm">
              <div class="input-group-prepend">
                <div class="input-group-text" v-text="fieldName"></div>
              </div>
              <input :data-field="fieldName" type="text" class="form-control" placeholder="Enter text here">
            </div>
          </template>
        </template>
        <button class="btn themeButton text-light btn-sm" type="submit"><i class="fas fa-plus"></i> Add <span v-text="name"></span></button>
      </form>
    </div>`
  });

  Vue.component('boolean-input', {
    data: function(){
      return{
        userObj: {},
      }
    },
    props: ['name','info'],
    methods:{
      markCompletedBoolean(val){
        var self = this;
        payload = {'name':self.name,'info': self.info, 'value':val}
        store.commit('addValue',payload);
        store.dispatch('saveProgress');
      },
    },
    computed: {
      done: {
        get () {
          return this.$store.state.schema.validation.properties[this.name].value
        }
      },
    },
    watch:{
    },
    template:
    `<div class="d-flex justify-content-center align-items-center p-2">
      <div :class="[done===true?'text-success border-success bold':'text-muted']" @click="markCompletedBoolean(true)" class="border rounded p-1 mx-2 pointer w-25 text-center">
        <i class="fas fa-check"></i> Yes
      </div>
      <div :class="[done===false?'text-danger border-danger bold':'text-muted']" @click="markCompletedBoolean(false)" class="border rounded p-1 mx-2 pointer w-25 text-center">
        <i class="fas fa-times"></i> No
      </div>
    </div>`
  });

  Vue.component('input-preview', {
    data: function(){
      return{
        userObj: {},
      }
    },
    props: ['userInput','removeItem','name'],
    computed:{
      type:function(){
        var self = this;
        if (self.userInput) {
          switch (self.userInput.constructor) {
            case Object:
              return 'obj'
              break;
            case Array:
              return 'arr'
              break;
            case String:
              return 'str'
              break;
            default:
              return 'arr'
          }
        }
      }
    },
    methods:{

    },
    template:
    `<div>
      <template v-if=" type == 'obj' ">
        <span :data-tippy-info='JSON.stringify(userInput,null,2)' :data-tippy-id='0'  class="badge kwbadge badge-success mr-1 pointer slit-in-vertical desc" title="remove">
          <i class="fas fa-check"></i>
          <template v-if="userInput && userInput.name">
            <span v-text="userInput.name"></span>
          </template>
          <template v-else>
            <span v-text="name"></span> <i class="fas fa-info-circle text-info"></i>
          </template>
          <span style="opacity:0;" class="d-inline" @click="removeItem($event, userInput)"> <i class="fas fa-times"></i></span>
        </span>
      </template>
      <template v-else-if="type == 'arr'" v-for="(person,i) in userInput">
        <span :data-tippy-info='JSON.stringify(person,null,2)' :data-tippy-id='i'  class="badge kwbadge badge-success mr-1 pointer slit-in-vertical desc" title="remove">
          <i class="fas fa-check"></i>
          <template v-if="person && person.name">
            <span v-text="person.name"></span>
          </template>
          <template v-else-if="person && person.constructor == String">
            <span v-text="person"></span>
          </template>
          <span v-else v-text="name+' '+(i+1)"></span>
          <span style="opacity:0;" class="d-inline" @click="removeItem($event, person)"> <i class="fas fa-times"></i></span>
        </span>
      </template>
    </div>`
  });

  Vue.component('input-box', {
    data: function(){
      return{
        constFound:false,
        constObj:{},
        licenseThirdQuestion:false,
        vocabTerm:'',
        vocab:Array,
        userLicense:{
          'text':'',
          'url':'',
          'description':''
        },
        canAcceptMultiple:false,
        vocabDetails:Object,
        vocabSuggestions:[],
        loading:false
      }
    },
    props: ['name','info'],
    methods:{
      markCompleted(propname){
        var self = this;

        var payload = {};
        payload["completed"] = {'name':propname,'value':self.userInput};
        store.commit('markCompleted',payload);
        //unselect after complete
        var payload2 = {};
        payload2["select"] = '';
        store.commit('markSelected',payload2);
        store.dispatch('saveProgress');
      },
      clearFieldFor:function(propname){
        var payload = {};
        payload["clear"] = propname;
        store.commit('clearValueOfProp',payload);
        store.dispatch('saveProgress');
      },
      addKeyword(){
        let self = this;
        let value = self.$refs.keywordInput.value;

        if (value.includes(',')) {
          let arr = value.split(',');
          for (var i = 0; i < arr.length; i++) {
            let val = arr[i].trim();
            var payload = {};
            payload["item"] = val;
            payload["from"] = self.name;
            store.commit('addToArrayFrom',payload);
            self.$refs.keywordInput.value = '';
          }
        }else{
          var payload = {};
          payload["item"] = value;
          payload["from"] = self.name;
          store.commit('addToArrayFrom',payload);
          self.$refs.keywordInput.value = '';
        }

      },
      removeItem(e, name){
        let self = this;
        
        var x = e.pageX-130;
        var y = e.pageY-20;
        var el = $("#puff");
        el.show();
        let audio = document.getElementById("pop-sound");
        audio.play();
        el.css('position', 'absolute');
        el.css("left", x);
        el.css("top", y);
        setTimeout(()=>{
          el.hide()
        },500);

        var payload = {};
        payload["item"] = name;
        payload["from"] = self.name;
        store.commit('removeArrayItemFrom',payload);
      },
      handleOneOf(parentProp,childProp,childPropInfo){
        var self = this;
        setTimeout(function(){
          self.addItem(parentProp,childPropInfo)
        }, 500);
      },
      handleVocab(propName,propInfo){
        let self = this;

        Swal.fire({
          title: propName,
          text: 'Search for an existing term here:',
          input: 'text',
          confirmButtonColor:"{{color_main}}",
          cancelButtonColor:"{{color_sec}}",
          animation:false,
          customClass:'scale-in-center',
          inputAttributes: {
            autocapitalize: 'off'
          },
          showCancelButton: true,
          confirmButtonText: 'Look up',
          showLoaderOnConfirm: true,
          focusConfirm: false,
          preConfirm: (query) => {
            let ontologies = propInfo['vocabulary']['ontology'].toString()
            let children = propInfo['vocabulary']['children_of'].toString()
            let url = `https://www.ebi.ac.uk/ols/api/search?q=${query}`
            +"&ontology="+ontologies
            +"&childrenOf="+children
            +"&type=class&fieldList=id,iri,label,description,obo_id,short_form,ontology_prefix"
            +"&queryFields=label"
            +"&rows=100"

            return fetch(url)
              .then(response => {
                if (!response.ok) {
                  throw new Error(response.statusText)
                }
                return response.json()
              })
              .catch(error => {
                Swal.showValidationMessage(
                  `Request failed: ${error}`
                )
              })
          },
          allowOutsideClick: () => !Swal.isLoading()
        }).then((result) => {
          if (result.value) {
            let html ="<div id='ontology' style='max-height: 500px;overflow: scroll;' class='p-1 text-left'>";
            let docs = result.value.response.docs;
            html += self.getVocabCheckboxHTML(html, docs);
            if (propInfo && !propInfo.strict) {
              html += `<div class="alert alert-info mt-1">
                          <h6>Didn't find what you are looking for? Enter value here:</h6>
                          <input class="form-control" type="text" id="qTerm">
                      </div>`
            }
            html += "</div>";

            Swal.fire({
              title: propName+'(s):',
              html: html,
              confirmButtonColor:"{{color_main}}",
              cancelButtonColor:"{{color_sec}}",
              animation:false,
              customClass:'scale-in-center',
              preConfirm: () => {

                let checked=[]

                  for (var i = 0; i < 100; i++) {
                    let x = document.getElementById("cb"+i)
                    if (x && x.checked) {
                      checked.push(x.value)
                    }
                  }
                  let y = document.getElementById("qTerm")
                  if (y.value) {
                    checked.push(y.value)
                  }
                  return checked
              }
            }).then((result) => {
              if (result.value) {
                for (var i = 0; i < result.value.length; i++) {
                  var payload = {};
                  payload["item"] = result.value[i];
                  payload["from"] = propName;
                  store.commit('addToArrayFrom',payload);
                  store.dispatch('saveProgress');
                }

              }
            })
          }
        });
      },
      getVocabCheckboxHTML(html, docs){
        for (var i = 0; i < docs.length; i++) {
          tippy('#cb'+i,{
            content:docs[i]
          });

          let label = docs[i]['label']
          if (label && label.length > 37) {
            label = label.substring(0,37)+"..."
          }
          html += `<div class="form-check">
                      <input class="form-check-input mr-2 slider" type="checkbox" value="`+docs[i]['iri']+`" id="cb`+i+`">
                      <label class="form-check-label" for="cb`+i+`" title="`+docs[i]['label']+`">
                          `+label+`
                          <i class="fa fa-info-circle text-info modaltip" data-tippy-info='`+JSON.stringify(docs[i])+`'></i>
                      </label>
                  </div>`
        }
        return html;
      },
      oneOfEnum(propName,propInfo){
        var self=this;

        for (var oF_i = 0; oF_i < propInfo['oneOf'].length; oF_i++){
          if (propInfo['oneOf'][oF_i].hasOwnProperty('enum')) {

            let e = propInfo['oneOf'][oF_i]['enum']
            let optionsenum={}

            for (var eIndex = 0; eIndex < e.length; eIndex++) {
              optionsenum[e[eIndex]]=e[eIndex]
            }
            Swal({
              title: propName,
              input: 'select',
              inputOptions: optionsenum,
              inputPlaceholder: 'Select one',
              showCancelButton: true,
              inputValidator: (value) => {
                if (value) {
                  var payload = {};
                  payload["item"] = value;
                  payload["from"] = propName;
                  store.commit('addToArrayFrom',payload);

                  store.dispatch('saveProgress');
                }
              }
            });
          }
          if (propInfo['oneOf'][oF_i].hasOwnProperty('type') && propInfo['oneOf'][oF_i]['type'] == 'array' ) {
            self.canAcceptMultiple = true
          }
        }
      },
      checkBoxModal(propName,propInfo){
        var self=this;

        let html = ''

        for (var oF_i = 0; oF_i < propInfo['oneOf'].length; oF_i++){
          if (propInfo['oneOf'][oF_i].hasOwnProperty('enum')) {

            let e = propInfo['oneOf'][oF_i]['enum']

            for (var eIndex = 0; eIndex < e.length; eIndex++) {
              let name = e[eIndex]
              html += '<div><label><input type="checkbox" class="mr-1 zoom-2" id="cb'+eIndex+'" value="'+name+'"/>'+name+'</label></div>'
            }

            html = `<div class="text-left">
                      <form id=#cbForm">`+html+`</form>
                    </div>`

            Swal({
              title: propName,
              inputAttributes: {
                id:'hideThis'
              },
              animation:false,
              confirmButtonColor:"{{color_main}}",
              cancelButtonColor:"{{color_sec}}",
              customClass:'scale-in-center',
              html: html,
              onOpen: ()=>{
                document.getElementById("hideThis").classList.add('d-none');
              },
              preConfirm: () => {

                let checked=[]

                  for (var i = 0; i < e.length; i++) {
                    let x = document.getElementById("cb"+i)
                    if (x && x.checked) {
                      checked.push(x.value)
                    }
                  }
                  console.log(checked)
                  return checked
              }
            }).then((result) => {
              if (result.value) {
                for (var i = 0; i < result.value.length; i++) {
                  var payload = {};
                  payload["item"] = result.value[i];
                  payload["from"] = propName;
                  store.commit('addToArrayFrom',payload);

                  store.dispatch('saveProgress');
                }

              }
            })

          }
        }
      },
      addItem(propName,propInfo){
        var self=this;
        let progressSteps =[]
        let questions =[]

        let props = {}

        console.log("addItem",propInfo)

        if (propInfo.hasOwnProperty('vocabulary')) {
          self.handleVocab(propName,propInfo)
        }

        if (propInfo.hasOwnProperty('oneOf')) {
          // console.log("ONE OF")

          path= ""

          for (var oF_i = 0; oF_i < propInfo['oneOf'].length; oF_i++){
            if (propInfo['oneOf'][oF_i].hasOwnProperty('enum')) {
              path = 'enum';
            }
            if (propInfo['oneOf'][oF_i].hasOwnProperty('type') && propInfo['oneOf'][oF_i]['type'] == 'string') {
              if (propInfo['oneOf'][oF_i].hasOwnProperty('enum')) {
                path = 'enum';
              }else {
                path = 'string';
              }
            }
            if (propInfo['oneOf'][oF_i].hasOwnProperty('@type')) {
              path ='types'
            }
            if (propInfo['oneOf'][oF_i].hasOwnProperty('type') && propInfo['oneOf'][oF_i]['type'] == 'array' ) {
              self.canAcceptMultiple = true
            }
          }
          // console.log('path',path)
          switch (path) {
            case "string":
            Swal({
                    title: propName,
                    input: 'text',
                    inputPlaceholder: 'Enter text here',
                    footer:propName == 'keywords'? "Multiple keywords can be entered separated by commas." : " ",
                    inputValidator: (value) => {
                      if (value) {
                        if (propName == 'keywords') {
                          slist = value.split(",");
                          for (var sIndex = 0; sIndex < slist.length; sIndex++) {
                            var payload = {};
                            payload["item"] = slist[sIndex];
                            payload["from"] = propName;
                            store.commit('addToArrayFrom',payload);

                            store.dispatch('saveProgress');
                          }
                        }else{
                          var payload = {};
                          payload["item"] = value;
                          payload["from"] = propName;
                          store.commit('addToArrayFrom',payload);

                          store.dispatch('saveProgress');
                        }

                      }
                    }

                  });
              break;
            case 'enum':
              if (self.canAcceptMultiple) {
                self.checkBoxModal(propName,propInfo);
              }else {
                self.oneOfEnum(propName,propInfo);
              }
              break;
            case 'types':
              options ={}
              for (var oF_i = 0; oF_i < propInfo['oneOf'].length; oF_i++) {
                if (propInfo['oneOf'][oF_i].hasOwnProperty('@type')) {
                  // value : user text
                  options[oF_i] = propInfo['oneOf'][oF_i]["@type"]
                }
                if (propInfo['oneOf'][oF_i].hasOwnProperty('type') && propInfo['oneOf'][oF_i]['type'] == 'array' ) {
                  self.canAcceptMultiple = true
                }
              }

              if (Object.keys(options).length == 1) {
                // if only one option auto start
                self.handleOneOf(propName,propInfo['oneOf'][0]['@type'],propInfo['oneOf'][0])
              }else {
                // if options, user chooses type
                Swal({
                  title: "Select type of "+propName,
                  input: 'select',
                  inputOptions: options,
                  inputPlaceholder: 'Select one',
                  animation:false,
                  confirmButtonColor:"{{color_main}}",
                  cancelButtonColor:"{{color_sec}}",
                  customClass:'scale-in-center',
                  showCancelButton: true,
                  inputValidator: (value) => {
                    if (value) {
                      self.handleOneOf(propName,propInfo['oneOf'][value]['@type'],propInfo['oneOf'][value])
                    }
                  }
                });
              }
              break;
            default:
            console.warn('PATH NOT HANDLED',path)

          }




        }

        if (propInfo.hasOwnProperty('anyOf')) {
          options ={}
          for (var oF_i = 0; oF_i < propInfo['anyOf'].length; oF_i++) {
            if (propInfo['anyOf'][oF_i].hasOwnProperty('@type')) {
              // value : user text
              options[oF_i] = propInfo['anyOf'][oF_i]["@type"]
            }
            if (propInfo['anyOf'][oF_i].hasOwnProperty('type') && propInfo['anyOf'][oF_i]['type'] == 'array' ) {
              self.canAcceptMultiple = true
            }
          }

          if (Object.keys(options).length == 1) {
            // if only one option auto start
            self.handleOneOf(propName,propInfo['anyOf'][0]['@type'],propInfo['anyOf'][0])
          }else {
            // if options, user chooses type
            Swal({
              title: "Select type of "+propName,
              input: 'select',
              inputOptions: options,
              inputPlaceholder: 'Select one',
              animation:false,
              confirmButtonColor:"{{color_main}}",
              cancelButtonColor:"{{color_sec}}",
              customClass:'scale-in-center',
              showCancelButton: true,
              inputValidator: (value) => {
                if (value) {
                  self.handleOneOf(propName,propInfo['anyOf'][value]['@type'],propInfo['anyOf'][value])
                }
              }
            });
          }

        }
        else if (propInfo.hasOwnProperty('properties')){
          props = propInfo.properties
          // console.log('props for questions', props)
          // Create questions
          for (key in props) {
            if (key == '@type' && props[key].hasOwnProperty('const')) {
              // TODO: Handle constants found in @type if any.
            }else {
              progressSteps.push(key)

              let description =''
              if (props[key].hasOwnProperty('description')) {
                description = "<small class='text-muted'>"+props[key].description+"</small>";
              }
              let title = "<b>"+propName+"</b>"+'.'+"<b class='text-info'>"+key+"</b>"
              if (propInfo && propInfo.required) {
                if (propInfo.required.includes(key)) {
                  title = title+' <i class="fas fa-asterisk text-danger"></i>'
                }
              }

              switch (props[key]['type']) {
                case 'string':
                  if (props[key].hasOwnProperty('format')) {
                    switch (props[key]['format']) {
                      case 'uri':
                        questions.push({
                          title: title,
                          footer: description,
                          inputValidator: (value) => {
                            return new Promise((resolve) => {

                              function validURL(str) {
                                str = str.replace(/\(/g, '%28').replace(/\)/g, '%29');
                                var pattern = new RegExp('^(https?:\\/\\/)?'+ // protocol
                                  '((([a-z\\d]([a-z\\d-]*[a-z\\d])*)\\.)+[a-z]{2,}|'+ // domain name
                                  '((\\d{1,3}\\.){3}\\d{1,3}))'+ // OR ip (v4) address
                                  '(\\:\\d+)?(\\/[-a-z\\d%_.~+]*)*'+ // port and path
                                  '(\\?[;&a-z\\d%_.~+=-]*)?'+ // query string
                                  '(\\#[-a-z\\d_]*)?$','i'); // fragment locator
                                // var pattern = /(ftp|http|https):\/\/(\w+:{0,1}\w*@)?(\S+)(:[0-9]+)?(\/|\/([\w#!:.?+=&%@!\-\/]))?/
                                return !!pattern.test(str);
                              }

                              if (propInfo && propInfo.hasOwnProperty('required')) {

                                let currentField = document.getElementById("swal2-title").textContent;
                                if (propInfo['required'].includes(currentField)) {
                                  // is required needs to be validated
                                  if (value) {
                                    if (validURL(value)) {
                                      resolve()
                                    } else {
                                      resolve('Input must be a valid URL')
                                    }
                                  }else{
                                    resolve(currentField+' is required')
                                  }
                                }else {
                                  // not required user can skip
                                  resolve()
                                }
                              }
                              if (propInfo && propInfo.hasOwnProperty('oneOf')) {
                                for (var i = 0; i < propInfo['oneOf'].length; i++) {
                                  if (propInfo['oneOf'][i] && propInfo['oneOf'][i].hasOwnProperty('required')) {

                                    let currentField = document.getElementById("swal2-title").textContent;
                                    if (propInfo['oneOf'][i]['required'].includes(currentField)) {
                                      // is required needs to be validated
                                      if (value) {
                                        if (validURL(value)) {
                                          resolve()
                                        } else {
                                          resolve('Input must be a valid URL')
                                        }
                                      }else{
                                        resolve(currentField+' is required')
                                      }
                                    }else {
                                      // not required user can skip
                                      resolve()
                                    }
                                  }
                                }
                              }

                              // if not required or anthything else just resolve()
                              resolve()


                            })
                          }
                        })
                        break;
                      case 'date':
                        questions.push({
                          title: title,
                          footer: description,
                          inputAttributes: {
                            id:'hideThis'
                          },
                          html: '<input type="date" id="datePicked"/>',
                          onOpen: ()=>{
                            document.getElementById("hideThis").classList.add('d-none');
                          },
                          preConfirm: () => {
                            return moment(document.getElementById('datePicked').value).format("YYYY-MM-DD");
                          },
                        })
                        break;
                      default:
                        console.warning("Property not handled by guide: "+props[key])
                    }
                  }else {
                    // any string value
                    questions.push({
                      title: title,
                      footer: description,
                      inputValidator: (value) => {
                        return new Promise((resolve) => {

                          if (propInfo && propInfo.hasOwnProperty('required')) {

                            let currentField = document.getElementById("swal2-title").textContent;
                            if (propInfo['required'].includes(currentField)) {
                              // is required needs to be validated
                              if (value) {
                                resolve()
                              } else {
                                resolve(currentField+' is required')
                              }
                            }else {
                              // not required user can skip
                              resolve()
                            }
                          }
                          if (propInfo && propInfo.hasOwnProperty('oneOf')) {
                            for (var i = 0; i < propInfo['oneOf'].length; i++) {
                              if (propInfo['oneOf'][i] && propInfo['oneOf'][i].hasOwnProperty('required')) {

                                let currentField = document.getElementById("swal2-title").textContent;
                                if (propInfo['oneOf'][i]['required'].includes(currentField)) {
                                  // is required needs to be validated
                                  if (value) {
                                    resolve()
                                  } else {
                                    resolve(currentField+' is required')
                                  }
                                }else {
                                  // not required user can skip
                                  resolve()
                                }
                              }
                            }
                          }
                          // if not required just resolve value
                          resolve()

                        })
                      }
                    });
                    break;
                  }
                  break;
                case 'integer':
                  questions.push({
                    title: title,
                    input: 'number',
                    footer: description,
                    inputValidator: (value) => {
                      return new Promise((resolve) => {
                        if (!value) {
                          return 'You should write something meanignful'
                        }else{
                          return new Promise((resolve) => {
                            function validInteger(str) {
                              var pattern = new RegExp('^[0-9]*$');
                              return !!pattern.test(str);
                            }
                            if (validInteger(value)) {
                              resolve()
                            } else {
                              resolve('Input must be an integer')
                            }
                          })
                        }
                      })
                    }
                  });
                  break;
                case 'array':
                  html =''
                  if (props[key].hasOwnProperty('oneOf')) {
                    for (var ix = 0; ix < props[key]['oneOf'].length; ix++) {
                      if (props[key]['oneOf'][ix]['type'] == 'object') {
                        let obj = props[key]['oneOf'][ix]['properties'];
                        for (var obj_key in obj) {
                          switch (obj[obj_key]['type']) {
                            case 'string':
                              html += '<div class="form-group"><input type="text" class="form-control"  name="'+obj_key+'" placeholder="'+obj_key+'"/></div>'
                              break;
                            case 'url':
                              html += '<div class="form-group"><input type="url" class="form-control" name="'+obj_key+'" placeholder="'+obj_key+'"/></div>'
                              break;
                            case 'date':
                              html += '<div class="form-group"><input class="form-control" name="'+obj_key+'" type="date"/></div>'
                              break;
                            default:
                              html += '<div class="form-group"><input class="form-control" type="text" name="'+obj_key+'" placeholder="'+obj_key+'"/></div>'
                              break;
                          }
                        }
                      }
                    }

                    html = `<div class="alert-light p-1">
                              <form id="arrayForm">`+html+`</form>
                            </div>`
                    questions.push({
                      title: title,
                      footer: description,
                      inputAttributes: {
                        id:'hideThis'
                      },
                      html: html,
                      onOpen: ()=>{
                        document.getElementById("hideThis").classList.add('d-none');
                      },
                      preConfirm: () => {
                        let formArray = $('#arrayForm').serializeArray();
                        var returnArray = {};
                        for (var i = 0; i < formArray.length; i++){
                          if (formArray[i]['name'].includes('date')) {
                            returnArray[formArray[i]['name']] = moment(formArray[i]['value']).format("YYYY-MM-DD");
                          }else {
                            returnArray[formArray[i]['name']] = formArray[i]['value'];
                          }
                        }
                        return returnArray;
                      },
                    })

                  }
                  break;
                case 'object':
                  html =''
                  let obj = props[key]['properties'];
                  for (var obj_key in obj) {
                    switch (obj[obj_key]['type']) {
                      case 'string':
                        html += '<div class="form-group"><input type="text" class="form-control"  name="'+obj_key+'" placeholder="'+obj_key+'"/></div>'
                        break;
                      case 'url':
                        html += '<div class="form-group"><input type="url" class="form-control" name="'+obj_key+'" placeholder="'+obj_key+'"/></div>'
                        break;
                      case 'date':
                        html += '<div class="form-group"><input class="form-control" name="'+obj_key+'" type="date"/></div>'
                        break;
                      default:
                        html += '<div class="form-group"><input class="form-control" type="text" name="'+obj_key+'" placeholder="'+obj_key+'"/></div>'
                        break;
                    }
                  }

                  html = `<div class="alert-light p-1">
                            <form id="arrayForm">`+html+`</form>
                          </div>`
                  questions.push({
                    title: title,
                    footer: description,
                    inputAttributes: {
                      id:'hideThis'
                    },
                    html: html,
                    onOpen: ()=>{
                      document.getElementById("hideThis").classList.add('d-none');
                    },
                    preConfirm: () => {
                      let formArray = $('#arrayForm').serializeArray();
                      var returnArray = {};
                      for (var i = 0; i < formArray.length; i++){
                        if (formArray[i]['name'].includes('date')) {
                          returnArray[formArray[i]['name']] = moment(formArray[i]['value']).format("YYYY-MM-DD");
                        }else {
                          returnArray[formArray[i]['name']] = formArray[i]['value'];
                        }
                      }
                      return returnArray;
                    },
                  })

                  break;
                default:
                  // ONE OF
                  html =''
                  if (props[key].hasOwnProperty('oneOf')) {

                    for (var ix = 0; ix < props[key]['oneOf'].length; ix++) {
                      if (props[key]['oneOf'][ix]['type'] == 'object') {
                        let obj = props[key]['oneOf'][ix]['properties'];
                        for (var obj_key in obj) {
                          switch (obj[obj_key]['type']) {
                            case 'string':
                              html += '<div class="form-group"><input type="text" class="form-control"  name="'+obj_key+'" placeholder="'+obj_key+'"/></div>'
                              break;
                            case 'url':
                              html += '<div class="form-group"><input type="url" class="form-control" name="'+obj_key+'" placeholder="'+obj_key+'"/></div>'
                              break;
                            case 'date':
                              html += '<div class="form-group"><input class="form-control" name="'+obj_key+'" type="date"/></div>'
                              break;
                            default:
                              html += '<div class="form-group"><input class="form-control" type="text" name="'+obj_key+'" placeholder="'+obj_key+'"/></div>'
                              break;
                          }
                        }
                      }
                    }

                    html = `<div class="alert-light p-1">
                              <form id="arrayForm">`+html+`</form>
                            </div>`
                    questions.push({
                      title: title,
                      footer: description,
                      inputAttributes: {
                        id:'hideThis'
                      },
                      html: html,
                      onOpen: ()=>{
                        document.getElementById("hideThis").classList.add('d-none');
                      },
                      preConfirm: () => {
                        let formArray = $('#arrayForm').serializeArray();
                        var returnArray = {};
                        for (var i = 0; i < formArray.length; i++){
                          if (formArray[i]['name'].includes('date')) {
                            returnArray[formArray[i]['name']] = moment(formArray[i]['value']).format("YYYY-MM-DD");
                          }else {
                            returnArray[formArray[i]['name']] = formArray[i]['value'];
                          }
                        }
                        return returnArray;
                      },
                    })

                  }
              }
            }


          }

          let arr = [] //modal header steps
          for (var i = 0; i < progressSteps.length; i++) {
            arr.push(i+1)
          }
          Swal.mixin({
            input: 'text',
            confirmButtonText: 'Next &rarr;',
            showCancelButton: true,
            confirmButtonColor:"{{color_main}}",
            cancelButtonColor:"{{color_sec}}",
            animation:false,
            customClass:'scale-in-center',
            progressSteps: arr
          }).queue(questions).then((result) => {
            if (result.value) {
              let obj = {}

              //check for const @type or @type of input
              if ("@type" in propInfo) {
                console.log("has @type ",propInfo)
                Vue.set(obj,'@type',propInfo["@type"])
              }else if('properties' in propInfo && '@type' in propInfo['properties']){
                if('const' in propInfo['properties']['@type']){
                  console.log("@type COST",propInfo)
                  Vue.set(obj,'@type',propInfo['properties']["@type"]['cost'])
                }
              }

              // console.log('obj',obj)

              for (var i = 0; i < progressSteps.length; i++) {
                // check if value is empty if so skip
                if (result && result.value[i]) {
                  if (result.value[i] == "keywords") {
                    try {
                      let val = result.value[i].split(',');
                      Vue.set(obj,progressSteps[i],val)
                    } catch (e) {
                      let val = result.value[i]
                      Vue.set(obj,progressSteps[i],val)
                    }

                  }else{
                    if (props[progressSteps[i]].hasOwnProperty('type') && props[progressSteps[i]]['type']==='integer') {
                      let val = parseInt(result.value[i]);
                      Vue.set(obj,progressSteps[i],val)
                    }else{
                      let val = result.value[i];
                      Vue.set(obj,progressSteps[i],val)
                    }
                  }
                }
              }

              if ((propInfo && propInfo.hasOwnProperty('oneOf')) && (propInfo['oneOf'][0].hasOwnProperty('vocabulary'))){
                //if its a vocab enum field do nothing. separate modal will launch
              }else {
                if(Object.keys(obj).length !== 0 && obj.constructor === Object){
                  var payload = {};
                  payload["item"] = obj;
                  payload["from"] = propName;
                  store.commit('addToArrayFrom',payload);

                  store.dispatch('saveProgress');
                }
              }

            }
          });

        }
      },
      checkForConstantKey(obj, keyname, parentkey) {
        var self=this;

        _.mapKeys(obj, function(value, key) {
          if (key === keyname) {
            self.constFound = true;
            // console.log('%c from '+self.name,'color:limegreen')
            // console.log(key,value)
            //CONST ISSUE
            // Vue.set(self.constObj, parentkey, value)
          }
          if (typeof value === 'object') {
            self.checkForConstantKey(value,keyname,key)
          }
        });

      },
      getLicense(specialCase){
        let self = this;
        let question1 = this.$refs.license1.value;
        let question2 = this.$refs.license2.value;

        if (specialCase) {
          switch (specialCase) {
            case 'No':
              self.userLicense.description = 'No Rights Reserved';
              self.userLicense.url = 'https://creativecommons.org/share-your-work/public-domain/cc0/';
              self.userLicense.text = 'CC0';
              break;
            case "Yes":
              self.userLicense.description = 'Attribution 4.0 International';
              self.userLicense.url = 'http://creativecommons.org/licenses/by/4.0/';
              self.userLicense.text = 'CC BY 4.0';
              break;
            default:
              self.userLicense.description = "We had trouble with your input, please try this link:";
              self.userLicense.text = '';
              self.userLicense.url = 'https://creativecommons.org/choose/';
              self.thirdQuestion = false;
              break;
          }
        }else{
          switch (question1+'|'+question2) {
            case "Yes|Yes":
              // Special Case
              self.licenseThirdQuestion = true;
              let question3 = this.$refs['license3'].value;
              self.getLicense(question3);
              break;
            case "No|Yes":
              self.userLicense.description = 'Attribution-NoDerivatives 4.0 International';
              self.userLicense.url = 'http://creativecommons.org/licenses/by-nd/4.0/';
              self.userLicense.text = 'CC BY-ND 4.0';
              self.licenseThirdQuestion = false;
              break;
            case "Yes, as long as others share alike|Yes":
              self.userLicense.description = 'Attribution-ShareAlike 4.0 International';
              self.userLicense.url = 'http://creativecommons.org/licenses/by-sa/4.0/';
              self.userLicense.text = 'CC BY-SA 4.0';
              self.licenseThirdQuestion = false;
              break;
            case "Yes|No":
              self.userLicense.description = 'Attribution-NonCommercial 4.0 International';
              self.userLicense.url = 'http://creativecommons.org/licenses/by-nc/4.0/';
              self.userLicense.text = 'CC BY-NC 4.0';
              self.licenseThirdQuestion = false;
              break;
            case "No|No":
              self.userLicense.description = 'Attribution-NonCommercial-NoDerivatives 4.0 International';
              self.userLicense.text = 'CC BY-NC-ND 4.0';
              self.userLicense.url = 'http://creativecommons.org/licenses/by-nc-nd/4.0/';
              self.licenseThirdQuestion = false;
              break;
            case "Yes, as long as others share alike|No":
              self.userLicense.description = 'Attribution-NonCommercial-ShareAlike 4.0 International';
              self.userLicense.text = 'CC BY-NC-SA 4.0';
              self.userLicense.url = 'http://creativecommons.org/licenses/by-nc-nd/4.0/';
              self.licenseThirdQuestion = false;
              break;
            default:
              self.userLicense.description = "We had trouble with your input, please try this link:";
              self.userLicense.text = '';
              self.userLicense.url = 'https://creativecommons.org/choose/';
              self.licenseThirdQuestion = false;
              break;
          }
        }
      },
      getVocabulary(){
        var self=this;
        let obj = self.info

        if (obj.hasOwnProperty('vocabulary')) {
          try {
            let query = self.vocabTerm
            let ontologies = obj['vocabulary']['ontology'].toString()
            let children = obj['vocabulary']['children_of'].toString()

            // AUTOSUGGEST

            // self.loading = true;
            //
            // axios.get("http://www.ebi.ac.uk/ols/api/suggest?q="+query+"&ontology="+ontologies+"&rows=5").then(res=>{
            //   self.vocabSuggestions = res.data.response.docs;
            //   self.loading = false;
            // }).catch(err=>{
            //   throw err;
            // });

            let url = "https://www.ebi.ac.uk/ols/api/search?q="+query
            +"&ontology="+ontologies
            +"&childrenOf="+children
            +"&type=class&fieldList=id,iri,label,description,obo_id,short_form,ontology_prefix"
            +"&queryFields=label"
            +"&rows=100"

            self.loading = true;

            axios.get(url).then(res=>{
              if (res.data.response.hasOwnProperty('docs')&& res.data.response.docs.length >= 1) {
                self.vocab= res.data.response.docs
                self.loading = false;
              }else{
                self.vocab= []
              }

            }).catch(err=>{
              self.vocab= []
              throw err;
            });
          } catch (e) {
            throw e;
          }
        }
      },
    },
    watch:{
      constObj:{
        handler(obj){
          var payload = {};
          payload["completed"] = {'name':this.name,'value':obj};
          store.commit('markCompleted',payload);
        },
        deep:true
      },
      vocabTerm(term){
        this.getVocabulary()
      }
    },
    mounted: function(){
      var self = this

      if (self.info.hasOwnProperty('oneOf')) {
        if (self.info['oneOf'].hasOwnProperty('type') && self.info['oneOf'][0]['type'] == 'array' || self.info['oneOf'][1]['type'] == 'array' ) {
          self.canAcceptMultiple = true
        }
      }
      if (self.info.hasOwnProperty('anyOf')) {
        if (self.info['anyOf'].hasOwnProperty('type') && self.info['anyOf'][0]['type'] == 'array' || self.info['anyOf'][1]['type'] == 'array' ) {
          self.canAcceptMultiple = true
        }
      }
      // self.checkForConstantKey(self.info,'const')
      tippy( '.save', {
        placement:'top',
        maxWidth:'200px',
        content: '<div class="text-success m-0" style="border-radius:none">Done</div>',
        animation: 'fade',
        theme:'light'});
      tippy( '.required', {
        maxWidth:'200px',
        placement:'top',
        content: '<div class="text-danger m-0" style="border-radius:none">This field is required</div>',
        animation: 'fade',
        theme:'light'});
      tippy( '.delete', {
        maxWidth:'200px',
        placement:'top',
        content: '<div class="text-danger m-0" style="border-radius:none">Clear</div>',
        animation: 'fade',
        theme:'light'});
      tippy( '#masterForm', {
          target:'.inputpreview',
          content: 'Loading...',
          maxWidth:'200px',
          placement:'left',
          animation: 'fade',
          theme:'light',
          onShow(instance) {
            let info = instance.reference.dataset.tippyInfo;
            instance.setContent("<div class='text-muted m-0 text-left wraptext'><pre>"+info+"</pre></div>")
          }
        });
      tippy( '#widget', {
          target:'.info',
          content: 'Loading...',
          maxWidth:'200px',
          placement:'left',
          animation: 'fade',
          theme:'light',
          onShow(instance) {
            let info = instance.reference.dataset.tippyInfo;
            instance.setContent("<div class='text-muted m-0'>"+info+"</div>")
          }
        });
    },
    computed: {
      isRequired:function(){
        return store.getters.isRequired(this.name)
      },
      isInputHidden:function(){
        return store.getters.isInputHidden(this.name)
      },
      userInput:{
        get () {
          return store.state.schema.validation.properties[this.name].value
        },
        set (newValue) {
          var payload = {};
          if (name.includes('date')) {
            let v = moment(newValue).format("YYYY-MM-DD")
            payload["completed"] = {'name':this.name,'value': v };
          }else {
            payload["completed"] = {'name':this.name,'value':newValue};
          }
          store.commit('markCompleted',payload);
          store.dispatch('saveProgress');
        }
      },
      datePreset:function(){
        if (this.$store.state.schema.validation.properties.hasOwnProperty('datePublished') && this.$store.state.schema.validation.properties['datePublished'].value) {
          return this.$store.state.schema.validation.properties['datePublished'].value
        }else if (this.$store.state.schema.validation.properties.hasOwnProperty('dateModified') && this.$store.state.schema.validation.properties['dateModified'].value) {
          return this.$store.state.schema.validation.properties['dateModified'].value
        }else{
          return false;
        }
      },
      showDesc:function(){
        return store.getters.getShowDesc
      }
    },
    template:
    `<div class="m-0 inputbox fade-in" :id='name' v-if="!isInputHidden">
      <div class="row m-0">
        <div class="col-sm-10 p-1 text-left d-flex align-items-center justify-content-center" :class="[userInput || userInput === false ? '':'alert-light']">
          <div class="d-flex w-100 justify-content-center">
            <div class="w-100 p-2">
              <div class="pb-3">
                <div class="col-sm-12 p-0 d-flex justify-content-start">
                  <small v-if="isRequired && !userInput && userInput !== false"><i class="fas fa-asterisk fa-xs text-danger required pointer unselectable mr-1"></i></small>
                  <h6 class="m-0" :class="[userInput || userInput === false ? 'text-success':'text-dark']">
                    <span v-text='info.description || "No description provided"'></span>
                    <small class="mainTextLight">
                      (<span v-text="name"></span>)
                    </small>
                  </h6>
                </div>
                <h6 v-show="loading" class="text-primary">Loading <i class="fas fa-spinner fa-pulse"></i></h6>
                <div class="ml-3">
                  <!-- INPUT   TYPES -->
                  <!--  BOOLEAN  -->
                  <template v-if="info && info.type === 'boolean'">
                    <boolean-input :name="name" :info="info"></boolean-input>
                  </template>
                  <template v-if="info && info.type === 'string'">
                    <!--  STRING  -->
                    <template v-if="info && !info.format">
                      <!--  STRING VOCABULARY -->
                      <template v-if="info && info.vocabulary">
                        <small>Input <b v-text="info.vocabulary && !info.vocabulary.strict ? 'CAN' : 'MUST' "></b> be from existing ontology terms.</small>
                        <div class="input-group">
                          <div class="input-group-prepend">
                            <div class="input-group-text bg-secondary text-light"><i class="fas fa-search"></i></div>
                          </div>
                          <input :required="isRequired" type="text" v-model="vocabTerm" class="form-control form-control-sm " :placeholder="userInput? userInput:'Type to begin search' " id="stringInput" list="suggestionlist">
                        </div>
                        <datalist id="suggestionlist">
                          <template v-for="item in vocabSuggestions">
                            <option :value="item.autosuggest" @click="vocabTerm=item.autosuggest;vocabSuggestions=[]">
                          </template>
                        </datalist>
                        <div v-show="vocabTerm" class="alert alert-light optionBox">
                          <small><b class="text-primary" v-text="'('+vocab.length+')'"></b> Existing results related to: <i v-text='vocabTerm'></i></small>
                          <template v-if="vocab.length" v-for="(item,i) in vocab">
                            <div class="form-check">
                              <input class="form-check-input " type="radio" name="exampleRadios" :id="i" :value="item.iri" @click='userInput=item.iri;vocabDetails=item' v-model="userInput">
                              <label class="form-check-label" :for="i">
                                <span v-text='item.label' ></span>
                                <i v-if="userInput && userInput === item.iri" class="fas fa-check text-success"></i>
                              </label>
                            </div>
                          </template>
                          <template v-if="info.vocabulary && !info.vocabulary.strict ">
                            <div class="alert alert-warning">
                              <h6>Didn't find what you are looking for?</h6>
                              <p class="text-muted">
                                Just use <b class="pointer text-success" v-text="vocabTerm" @click="userInput=vocabTerm;vocabDetails={}"></b>
                              </p>
                            </div>
                          </template>
                        </div>
                      </template>
                      <!--  ENUM  -->
                      <template v-else-if="info && info.enum" v-for="(item,i) in info.enum">
                        <div class="form-check">
                          <input class="form-check-input " type="radio" name="exampleRadios" :id="i" :value="item" @click='userInput=item' v-model="userInput">
                          <label :class="{'text-success': userInput === item}" class="form-check-label" :for="i" v-text='item'></label>
                        </div>
                      </template>
                      <!--  STRING NORMAL -->
                      <template v-else>
                        <small class="text-info" v-if="name ==='description'">
                          This field is recommended to be between 50 and 5000 characters long ( <b v-text="userInput && userInput.length || '0'"></b> characters). 
                          <a href="https://developers.google.com/search/docs/data-types/dataset#dataset" target="_blank">Learn more</a>.
                        </small>
                        <textarea :rows="name ==='description'?5:2" type="text" v-model="userInput" class="form-control form-control-sm " placeholder="enter text here"></textarea>
                      </template>
                        <!--  VOCAB PREVIEW -->
                      <template v-if="vocabDetails && vocab.length && vocabDetails.ontology_prefix">
                        <div class="alert alert-info optionBox">
                          <h6>
                            <span v-text='vocabDetails.label' class="bold"></span>
                            <template v-if="vocabDetails && vocabDetails.short_form">
                              (<small v-text='vocabDetails.short_form' ></small>)
                            </template>
                          </h6>
                          <table>
                            <tbody>
                              <tr>
                                <td>
                                  <div class="pillType d-block m-1">
                                    <span class="mainBackDark" style="font-size:1em;">Ontology</span>
                                    <span style="font-size:1em;">
                                      <a :href="vocabDetails.iri" v-text="vocabDetails.ontology_prefix" rel="nonreferrer" target="_blank"></a>
                                    </span>
                                  </div>
                                </td>
                              </tr>
                              <tr>
                                <td>
                                  <div class="pillType d-block m-1">
                                    <span class="mainBackLight" style="font-size:1em;">ID</span>
                                    <span style="font-size:1em;">
                                      <a :href="vocabDetails.iri" v-text="vocabDetails.obo_id" rel="nonreferrer" target="_blank"></a>
                                    </span>
                                  </div>
                                </td>
                              </tr>
                              <tr v-if="vocabDetails && vocabDetails.description">
                                <td>
                                  <small v-html="vocabDetails.description[0]"></small>
                                </td>
                              </tr>
                            </tbody>
                          </table>
                        </div>
                      </template>
                    </template>
                    <!--  URL  -->
                    <template v-if="info && info.format === 'uri'">
                      <input type="url" v-model="userInput" class="form-control form-control-sm " placeholder="enter url here">
                    </template>
                    <!--  EMAIL  -->
                    <template v-if="info && info.format === 'email'">
                      <input type="email" v-model="userInput" class="form-control form-control-sm " placeholder="enter e-mail here">
                    </template>
                    <!--  STRING FORMAT DATE  -->
                    <template v-if="info && info.format === 'date'">
                      <input type="date" v-model="userInput" class="form-control form-control-sm">
                    </template>
                  </template>

                  <!--  LICENSE  -->
                  <template v-if="info.type=== 'object' && name === 'license'">
                    <form id="licenseForm" class="p-1" v-if="!userInput">
                      <small class="text-muted">Allow commercial uses of your work?</small>
                      <select @change="getLicense()" ref="license1" class="form-control form-control-sm" id="ControlSelect1">
                        <option selected>Choose...</option>
                        <option value="Yes">Yes</option>
                        <option value="No">No</option>
                        <option value="Yes, as long as others share alike">Yes, as long as others share alike</option>
                      </select>
                      <small class="text-muted">Allow commercial uses of your work?</small>
                      <select @change="getLicense()" ref="license2" class="form-control form-control-sm" id="ControlSelect2" required="">
                        <option selected>Choose...</option>
                        <option value="Yes">Yes</option>
                        <option value="No">No</option>
                      </select>
                      <div v-show='licenseThirdQuestion'>
                        <small class="text-muted">Impose legal requirement for attribution?</small>
                        <select @change="getLicense()" ref="license3" class="form-control form-control-sm" id="ControlSelect3" required="">
                          <option selected>Choose...</option>
                          <option value="Yes">Yes</option>
                          <option value="No">No</option>
                        </select>
                      </div>
                    </form>
                    <template v-if="userLicense.text && !userInput">
                      <div class="alert alert-success text-center mt-3">
                        <h6 v-text="userLicense.text"></h6>
                        <p>
                          <small v-text="userLicense.description"></small>
                        </p>
                        <small>
                          <a :href="userLicense.url" target="_blank" v-text="'Learn More About '+userLicense.text"></a>
                        </small>
                      </div>
                    </template>
                    <template v-if="userInput && userInput.text">
                      <div class="alert alert-success text-center mt-3">
                        <small><b>License Chosen:</b> </small>
                        <h6 v-text="userInput.text"></h6>
                        <p>
                          <small v-text="userInput.description"></small>
                        </p>
                        <small>
                          <a :href="userInput.url" target="_blank" v-text="'Learn More About '+userInput.text"></a>
                        </small>
                        <hr />
                      </div>
                    </template>
                    <div class="text-center p-1" v-if="userLicense.text && !userInput">
                      <button class="btn btn-success" @click="userInput=userLicense">Use This License</button>
                    </div>
                  </template>

                  <!--   KEYWORDS  -->
                  <template v-if="info.type=== 'array' && name === 'keywords'">
                    <div class="form-group p-2 row">
                      <div class="col-sm-12 mb-2">
                        <form @submit.prevent="addKeyword">
                          <small class="text-muted">Enter single or multiple keywords separated by commas</small>
                          <input ref="keywordInput" autocomplete="off" type="text" class="form-control form-control-sm " placeholder="Enter text here">
                        </form>
                      </div>
                      <div class="col-sm-12 m-auto">
                        <template v-for="text in userInput">
                          <span title="Delete"  class="badge kwbadge badge-success mr-1 pointer slit-in-vertical" title="remove">
                            <span v-html="text"></span>
                            <span style="opacity:0;" class="d-inline" @click.prevent="removeItem($event,text)"> <i class="fas fa-times"></i></span>
                          </span>
                        </template>
                      </div>
                      <div class="alert alert-success m-3 w-75" v-show="userInput">
                        <small><b>Saved Keywords:</b> </small>
                        <template v-for="(text,i) in userInput">
                          <small v-html="text"></small>
                          <small v-if="i !== userInput.length-1">, </small>
                        </template>
                      </div>
                    </div>
                  </template>

                  <!--   CONSTANT DATA CATALOG  -->
                  <template v-if="info.type=== 'object' && name === 'includedInDataCatalog'">
                    <!--<div class="text-center">
                      <div class="text-center bold text-info" v-if="constFound">
                        <small class="bold m-auto">Fixed Value, No Action Needed</small>
                      </div>
                      <div class='alert alert-success m-auto w-75'>
                      <p v-for="(item,index) in userInput" class="m-0">
                        <small class="bold" v-text='index'></small>:<small v-text='item'></small>
                      </p>
                      </div>
                    </div>-->
                  </template>
                  <!--   OBJECT  -->
                  <template v-if="info.type=== 'object' && name !== 'license' && name !== 'includedInDataCatalog' ">
                    <!-- <object-input :name="name" :info="info"></object-input> -->
                    <div class="form-group p-2 row">
                      <!--  <button class="btn themeButton text-light m-auto btnfocus" @click="addItem(name,info)" v-if="info.type=== 'object' && !userInput">
                        <i class="fas fa-plus"></i> <span v-text="'Add '+name"></span>
                      </button> -->
                      <type-selector :info="info" :main_name="name" :isChild="false"></type-selector>
                    </div>
                    <div class="col-sm-12 m-auto">
                    <!--   input preview for object or array -->
                      <input-preview :name="name" :userInput="userInput" :removeItem="removeItem"></input-preview>
                    <!--   input preview for string -->
                      <template v-if="typeof userInput === 'string'">
                        <span style="overflow:hidden; max-width:100%;" class="badge badge-success text-light" v-text="userInput"></span>
                      </template>
                    </div>
                  </template>
                  <!--   ONE OF  OR ANY OF -->
                  <template v-if="info.oneOf || info.anyOf">
                    <!--   ONE OF ANYTHING -->
                    <template v-if="name !== 'datePublished' && name !== 'dateModified'">
                      <div class="form-group p-2 row">
                        <!-- <button class="btn themeButton text-light m-auto btnfocus" @click="addItem(name,info)" v-if="!userInput || canAcceptMultiple">
                          <i class="fas fa-plus"></i> <span v-text="'Add new '+name"></span>
                        </button> -->
                        <type-selector :info="info" :main_name="name" :isChild="false"></type-selector>
                      </div>
                      <div class="col-sm-12 m-auto">
                      <!--   input preview for object or array -->
                        <input-preview :name="name" :userInput="userInput" :removeItem="removeItem"></input-preview>
                      <!--   input preview for string -->
                        <template v-if="typeof userInput === 'string'">
                          <span style="overflow:hidden; max-width:100%;" class="badge badge-success text-light" v-text="userInput"></span>
                        </template>
                      </div>
                    </template>

                    <!--   ONE OF  VOCABULARY
                    <template v-if="info.oneOf && info.oneOf[0].vocabulary">
                      <input-box :name="name" :info="info.oneOf[0]"></input-box>
                    </template> -->

                    <!--   ONE OF  DATES -->
                    <template v-if="name === 'datePublished' || name === 'dateModified'">
                      <div v-if="datePreset && !userInput" class="p-2">
                        <small>Dates used:</small>
                        <small class="badge badge-info pointer m-1" v-text="'Click to use '+datePreset" @click="userInput=datePreset"></small>
                      </div>
                      <template v-for="(item,i) in info.oneOf">
                        <div>
                          <template v-if="item.format === 'date'">
                            <input type="date" v-model="userInput" class="form-control form-control-sm " :placeholder="'enter '+item.format">
                          </template>
                          <template v-if="item.type === 'string' && !item.format">
                            <input  type="text" v-model="userInput" class="form-control form-control-sm " :placeholder="'enter '+item.type">
                          </template>
                        </div>
                      </template>
                    </template>

                  </template>
                </div>
                <small v-if="showDesc && info.categories.length > 1">
                  <small class="text-muted bold">Part of</small>
                  <template v-if="info && info.categories" v-for="category in info.categories">
                    <small v-text="category.category" class="tip pointer mr-2" :data-tippy-info="[category.subcategory === 'Required' ? 'Required' : 'Recommended']" :class="[category.subcategory === 'Required' ? 'text-danger' : 'text-info']"></small>
                  </template>
                </small>
                <!--   ISSUE  -->
                <template v-if="info && info.hasIssue" v-for="(issue,i) in info.hasIssue">
                  <small class="ml-3 d-block" style="color:salmon;" :key="i">
                    <i class="fas fa-exclamation-circle"></i> <span v-text="issue"></span>
                  </small>
                </template>
              </div>

            </div>
          </div>
        </div>
        <div class="col-sm-2 p-2 alert-dark actions d-flex align-items-center justify-content-around">
          <span class="fa-stack fa-1x pointer save" @click="markCompleted(name)" v-show="userInput || userInput === false">
            <i class="fas fa-circle text-success back fa-stack-2x"></i>
            <i class="fas fa-check fa-stack-1x text-light"></i>
          </span>
          <span class="fa-stack fa-1x pointer delete" @click="clearFieldFor(name)" v-show="info && info.value || info && info.value === false">
            <i class="fas fa-circle text-muted fa-stack-2x"></i>
            <i class="fas fa-times fa-stack-1x text-light"></i>
          </span>
        </div>
      </div>
    </div>`
  });

  Vue.component('propcontainer', {
    data: function(){
      return{
        settings: {{guide_settings}},
        allMode: Boolean,
        viewSettings: false,
      }
    },
    props: ['type'],
    methods:{
      isRequired(propname){
        let req = store.getters.getValidation['required']
        if (req.includes(propname)) {
          return true
        }else{
          return false
        }
      },
      nextStep(){
        var self = this;
        if (self.type === "REQUIRED") {
          let payload = {}
          payload["step"] = 4;
          store.commit('changeStep',payload);
        }else{
          if (self.isComplete) {
            let payload = {}
            payload["step"] = 5;
            store.commit('changeStep',payload);
          }else{
            $.notify("Incomplete",{ globalPosition: 'right',style:"danger", showDuration: 40, });
          }
        }
      },
      selectProp(propname){
        var payload = {};
        payload["select"] = propname;
        store.commit('markSelected',payload);
      },
      checkSettings(){
        var self = this;
        if (self.settings && self.settings.hasOwnProperty('form-mode')) {
          self.allMode = self.settings['form-mode']
        }else{
          self.allMode = false
        }
      },
      goToStep(s){
        var self = this;
        let payload = {}
        payload["step"] = s;
        store.commit('changeStep',payload);
      },
      toggleDesc(){
        store.commit('toggleDesc');
      },
    },
    mounted: function(){
      this.checkSettings();
    },
    computed: {
      validation:function(){
        return store.getters.getValidation
      },
      isComplete:function(){
        return store.getters.isComplete
      },
      categoryTotals:function(){
        let totals = store.getters.getCategoryTotals
        return totals
      },
      totals:function(){
        return store.getters.getTotals
      },
      fieldsleft:function(){
        let v = store.getters.getValidation
        let n = 0
        for (var  key in v["properties"]) {
          if (!v["properties"][key]['value']) {
            n += 1
          }
        }
        return n
      },
      step: function(){
        return store.getters.getStep
      },
      showDesc: function(){
        return store.getters.getShowDesc
      }
    },
    template:
    `<div>
      <div class="row m-0">
        <div class="col-sm-12 grad d-flex justify-content-around align-items-center p-1">
          <h3 class="badge d-inline m-0" v-text="type" :class="type === 'REQUIRED' ?'badge-danger':'badge-info'"></h3>
          <button class="btn btn-sm btn-outline-secondary text-light" @click="viewSettings = ! viewSettings">
            <small><i class="fas fa-cog"></i> Display Settings</small>
          </button>
          <div v-show="viewSettings">
            <input class="form-check-input slider" type="checkbox" :checked="allMode"  id="customControlInline2" @click="allMode = !allMode">
            <label class="form-check-label text-light" for="customControlInline2" >
              <small>Change Form Style</small>
            </label>
          </div>
          <!--
          <div v-show="viewSettings">
            <input class="form-check-input slider" type="checkbox" :checked="showDesc"  id="customControlInline" @click="toggleDesc()">
            <label class="form-check-label text-light" for="customControlInline" >
              <small>Toggle Descriptions</small>
            </label>
          </div>
          -->
        </div>
        <div class="col-sm-12 col-md-9 p-0">
          <template v-if="allMode && validation">
            <!--   ALL MODE  -->
            <div class="p-0">
              <template v-if="window.location.pathname == '/guide/n3c/dataset' ">
                <div class="mainTextDark row m-0">
                  <div class="col-sm-10 p-1 text-left p-2">
                    <h6>To request an external dataset accessible in the N3C Enclave</h6>
                    <h6>please fill this out:</h6>
                  </div>
                  <div class="col-sm-2 alert-dark">
                  </div>
                </div>
              </template>
              <template v-if="type === 'REQUIRED' ">
                <template v-for="(prop,index) in validation.properties" v-if="isRequired(index)">
                  <input-box :name='index' :info="prop" :key='index'></input-box>
                </template>
              </template>
              <template v-if="type === 'RECOMMENDED' ">
                <template v-for="(prop,index) in validation.properties" v-if="!isRequired(index)">
                  <input-box :name='index' :info="prop" :key='index'></input-box>
                </template>
              </template>
            </div>
          </template>

          <template v-if="!allMode && validation">
            <!--   1 BY 1 MODE  -->
            <!--   TODO  -->
            <div class="p-1 bg-dark text-left mb-0">
              <span class="badge m-1 badge-dark text-warning">
                TO-DO <i class="fas fa-chevron-right"></i>
              </span>
              <template v-if="type === 'REQUIRED' ">
                <template v-for="(prop,index) in validation.properties" v-if="isRequired(index)">
                  <span class="badge badge-dark m-1 pointer badgeDesc font-weight-normal slit-in-vertical" @click='selectProp(index)' v-if="prop && !prop.value && prop.value !== false" :class="{'highlight': prop.highlighted}">
                    <span v-text='index'></span>
                    <i class="fas fa-asterisk text-danger required pointer unselectable" v-if="isRequired(index)"></i>
                  </span>
                </template>
              </template>
              <template v-if="type === 'RECOMMENDED' ">
                <template v-for="(prop,index) in validation.properties" v-if="!isRequired(index)">
                  <span class="badge badge-dark m-1 pointer badgeDesc font-weight-normal slit-in-vertical" @click='selectProp(index)' v-if="prop && !prop.value && prop.value !== false" :class="{'highlight': prop.highlighted}">
                    <span v-text='index'></span>
                  </span>
                </template>
              </template>
            </div>
            <!--   DONE  -->
            <div class="p-1 alert-success text-left mb-0">
              <span class="badge m-1 badge-light text-success">
                DONE <i class="fas fa-chevron-right"></i>
              </span>
              <template v-if="type === 'REQUIRED' ">
                <template v-for="(prop,index) in validation.properties" v-if="isRequired(index)">
                  <small class="m-1 text-success pointer desc" @click='selectProp(index)' v-if="prop && prop.value || prop.value === false" :class="{'highlight': prop.highlighted}" data-tippy-info="Edit">
                    <i class="fas fa-check-circle text-success"></i> <span v-text='index'></span>
                    <i class="fas fa-asterisk text-danger required pointer unselectable" v-if="isRequired(index)"></i>
                  </small>
                </template>
              </template>
              <template v-if="type === 'RECOMMENDED' ">
                <template v-for="(prop,index) in validation.properties" v-if="!isRequired(index)">
                  <small class="m-1 text-success pointer desc" @click='selectProp(index)' v-if="prop && prop.value || prop.value === false" :class="{'highlight': prop.highlighted}" data-tippy-info="Edit">
                    <i class="fas fa-check-circle text-success"></i> <span v-text='index'></span>
                  </small>
                </template>
              </template>
            </div>
            <div class="p-1">
              <template v-if="validation.properties" v-for="(prop,index) in validation.properties">
                <input-box class="border border-dark" v-if='prop && prop.selected' :name='index' :info="prop" :key='index'></input-box>
              </template>
            </div>
          </template>
        </div>
        <!--   PROGRESS TRACKER  -->
        <div class="col-sm-12 col-md-3 p-0">
          <div class="w-100 text-muted d-flex justify-content-around align-items-center p-1">
            <h6>Progress Tracker</h6>
          </div>
          <template v-if="categoryTotals" v-for="(subcats,cat) in categoryTotals">
            <catcontainer class="fade-in" :cat="cat" :subcats="subcats" :key="cat+subcats"></catcontainer>
          </template>
        </div>
        <div class="col-sm-12 text-right m-0 rounded-0 p-1" :class="{'alert-success':isComplete, 'alert-danger': !isComplete}">
          <div class="bg-none p-2 rounded">
            <template v-if="type === 'REQUIRED' && isComplete ">
              <small class="text-success bold">Ready to proceed!</small>
              <button class="btn themeButton text-light" @click="nextStep()" :class="{'heartbeat':isComplete}" :disabled="!isComplete">NEXT</button>
            </template>
            <template v-if="type === 'REQUIRED' && !isComplete ">
              <small class="text-danger bold">Complete ALL requirements to proceed!</small>
              <button class="btn themeButton text-light" @click="nextStep()" :class="{'heartbeat':isComplete, 'notallowed': !isComplete}" :disabled="!isComplete">NEXT</button>
            </template>

            <template v-if="type === 'RECOMMENDED' ">
              <small v-show="fieldsleft !== 0" class="text-info">Complete as many recommended fields as possible <b class="text-danger">ONLY <span v-text="fieldsleft"></span> LEFT!</b></small>
              <small v-show="fieldsleft === 0" class="text-success bold">Great job! Ready to proceed!</small>
              <button class="btn btn-danger text-light mr-3 ml-3" @click="goToStep(step-1)"><i class="fas fa-chevron-left"></i> BACK</button>
              <button class="btn themeButton text-light" @click="nextStep()">NEXT <i class="fas fa-chevron-right"></i></button>
            </template>
          </div>
        </div>
      </div>
    </div>`
  });


  var app = new Vue({
      el: '#guide',
      store: store,
			data: function(){
				return {
          userInfo:null,
          loading: false,
          presets:{{guide_presets}},
          portals: {{guide_portals}},
				}
			},
      computed:{
        validation:function(){
          return store.getters.getValidation
        },
        valid:function(){
          return store.getters.getValidStatus
        },
        errors:function(){
          return store.getters.getErrors
        },
        isComplete:function(){
          let res = store.getters.isComplete
          if (res) {
            $("#registerReady").notify("Available Now",{style:'trophy', showDuration: 40, placement:'top'});
          }
          return res
        },
        totals:function(){
          return store.getters.getTotals
        },
        categoryTotals:function(){
          let totals = store.getters.getCategoryTotals
          return totals
        },
        startingPoint: function(){
          return store.getters.getStartingPoint
        },
        step: function(){
          return store.getters.getStep
        },
        fieldsleftRegistration:function(){
          let v = store.getters.getValidation
          let n = 0
          for (var  key in v["properties"]) {
            if (!v["properties"][key]['value']) {
              n += 1
            }
          }
          return n
        },
        jsonItems: function(){
          return store.getters.getBulkJSONItems
        },
      },
      watch:{
        step:function(s){
          if (s === '5') {
            store.getters.getCategoryTotals
            store.getters.getTotals
          }
        },
      },
			methods:{
        checkUser(){
          let self = this;
          self.loading = true;
          $.ajax({url: "/user", success: function(result){
              self.loading = false;
             self.userInfo = result;
          },
          cache: false});
        },
        getAndLoadSchema(url){
          var self = this;
          self.loading = true;
          axios.get(url).then(res=>{
            self.loading = false;
            var payload = {};
            payload["schema"] = res.data;
            store.commit('saveSchema',payload);

          }).catch(err=>{
            self.loading = false;
            $.notify("Failed to load schema",{ globalPosition: 'right',style:"danger", showDuration: 40, });
            throw err;
          })
        },
        getStartingPointSchema(item){
          let self = this;
          self.loading = true;
          axios.get('/api/registry/'+item.namespace+'/'+item.prefix+':'+item.name).then(res=>{
            var payload = {};
            payload["name"] = item.name;
            store.commit('saveSchemaName',payload);
            self.parseData(res.data)

            // IF ANY PORTALS AND IF ANY ARE SELECTED
            if (self.portals && self.portals.length) {
              for (var i = 0; i < self.portals.length; i++) {
                if (self.portals[i]['selected']) {
                  axios.get('/api/registry/'+self.portals[i].namespace+'/'+self.portals[i].prefix+':'+self.portals[i].name).then(result=>{

                    var payload = {};
                    payload["portal"] = result.data;
                    store.commit('addPortalSchema',payload);

                    var payload = {};
                    payload["origin"] = result.data.label
                    payload["catprops"] = result.data.validation.properties;
                    if (result.data.validation.required) {
                      payload["catpropsrequired"] = result.data.validation.required;
                      self.reqfields = result.data.validation.required;
                    }else{
                      payload["catpropsrequired"] = [];
                    }
                    store.commit('mergeCategoryProps',payload);
                  }).catch(error=>{
            				throw error;
                  });
                }
              }
            }
            self.loading = false;
    			}).catch(err=>{
            self.loading = false;
            try {
              Swal.fire({
                type: 'error',
                position: 'center',
                title: 'Failed because: ',
                text: err.response.data.error
              });
            } catch (e) {
              throw e;
            }
    				throw err;
    			})
        },
        parseData(data){
          let self = this;
          let schemaName = store.getters.getSchemaName

          if (data.hits) {
            for (var i = 0; i < data.hits.length; i++) {
              if (data.hits[i].hasOwnProperty('name')) {
                if (data.hits[i].name.includes(schemaName)) {
                  var payload = {};
                  payload["schema"] = self.assignCategories(data.hits[i]);
                  store.commit('saveSchema',payload);
                }
              }else if (data.hits[i].hasOwnProperty('label')) {
                if (data.hits[i].label.includes(schemaName)) {
                  var payload = {};
                  payload["schema"] = self.assignCategories(data.hits[i]);
                  store.commit('saveSchema',payload);
                }
              }
            }
          }else {
            if (data.hasOwnProperty('name')) {
              if (data.name.includes(schemaName)) {
                var payload = {};
                payload["schema"] = data;
                store.commit('saveSchema',payload);
              }
            }else if (data.hasOwnProperty('label')) {
              if (data.label.includes(schemaName)) {
                var payload = {};
                payload["schema"] = data;
                store.commit('saveSchema',payload);
              }
            }
          }
          // check for saved progress
          self.checkProgress();
        },
        assignCategories(schema){
          var self = this;
          if (schema.hasOwnProperty('validation')) {
            for (prop in schema['validation']['properties']) {
              //assign if found
              Vue.set(schema['validation']['properties'][prop],'categories',[])
              for (category in self.categories) {
                for (var subcategory in self.categories[category]) {
                  if (self.categories[category][subcategory].includes(prop)) {
                    let cat={
                      'category': category,
                      'subcategory':subcategory
                    }
                    schema['validation']['properties'][prop]['categories'].unshift(cat);
                  }
                }
              }
            }
            return schema
          }else{
            return schema
          }
        },
        reset(){
          if (this.validation) {
            Swal.fire({
              title: 'Are you sure?',
              text: "You won't be able to revert this!",
              animation:false,
              customClass:'scale-in-center',
              showCancelButton: true,
              confirmButtonColor:"{{color_main}}",
              cancelButtonColor:"{{color_sec}}",
              confirmButtonText: 'Yes, start over'
            }).then((result) => {
              if (result.value) {
                store.dispatch('reset')
                sessionStorage.removeItem('guideProgress');
              }
            });
          }
        },
        isRequired(propname){
          let req = store.getters.getValidation['required']
          if (req.includes(propname)) {
            return true
          }else{
            return false
          }
        },
        selectProp(propname){
          var payload = {};
          payload["select"] = propname;
          store.commit('markSelected',payload);
        },
        getPreview(){
          store.commit('formPreview');
          Swal.fire({
            position: 'center',
            confirmButtonColor:"{{color_main}}",
            cancelButtonColor:"{{color_sec}}",
            animation:false,
            customClass:'scale-in-center',
            html: `<h6 class="text-center mainTextDark">Preview</h6><div class="text-left p-1 previewBox"><small><pre>`+JSON.stringify(store.getters.getPreview,null,2)+`</pre></small></div>`
          });
        },
        handleRegistration(){
          var self = this;

          if (this.isComplete) {
            store.commit('formPreview');
            let output = store.getters.getOutput
            self.loading = true;

            let schema = store.getters.getSchema

                let config = {
                   headers: {
                     'content-type': 'application/json'
                   }
                 }

                axios.post('/api/dataset?schema='+schema['namespace']+'::'+schema['prefix']+':'+schema['label']+"&guide="+encodeURI(window.location.pathname),output,config).then(res=>{
                  self.loading = false;
                  if (res.data.success) {

                    sessionStorage.removeItem('guideProgress');

                    if (window.location.pathname == '/guide/n3c/dataset') {

                      Swal.fire({
                        type:'success',
                        title: 'Registration Successful',
                        position: 'center',
                        confirmButtonColor:"{{color_main}}",
                        cancelButtonColor:"{{color_sec}}",
                        animation:false,
                        customClass:'scale-in-center',
                        html:
                          `<div class="row m-0">
                            <div class="col-sm-12 logoText">
                              <h3>Your request is submitted, we will review it and get back to you soon.</h3>
                            </div>
                            <div class="col-sm-12">
                              <h5>
                                <a href="/dataset/`+res.data.id+`" target="_blank" rel="nonreferrer">Click here</a> to view your submission.
                              </h5>
                            </div>
                            <div class="col-sm-12">
                              <h5>
                                <a href="/guide/n3c/dataset">Click here</a> to submit another request.
                              </h5>
                            </div>
                            <div class="col-sm-12">
                              <h5>
                                <a class="text-danger" href="/">I'm all done!</a>
                              </h5>
                            </div>
                          </div>`,
                        onClose: () => {
                          store.dispatch('reset')
                        }
                      }); 
                      
                    } else {
                      let timerInterval
                      Swal.fire({
                        type:'success',
                        title: 'Registration Successful',
                        confirmButtonColor:"{{color_main}}",
                        cancelButtonColor:"{{color_sec}}",
                        animation:false,
                        customClass:'scale-in-center',
                        html:
                          'Taking you to your dataset page in <strong></strong> seconds.',
                        timer: 3000,
                        onBeforeOpen: () => {
                          const content = Swal.getContent()
                          const $ = content.querySelector.bind(content)
                          Swal.showLoading()
                          timerInterval = setInterval(() => {
                            Swal.getContent().querySelector('strong')
                              .textContent = (Swal.getTimerLeft() / 1000)
                                .toFixed(0)
                          }, 100)
                        },
                        onClose: () => {
                          clearInterval(timerInterval)
                          store.dispatch('reset')
                          window.location.href='/dataset/'+res.data.id
                        }
                      });
                    }

                  }else{

                    try {
                      Swal.fire({
                        type: 'error',
                        position: 'top center',
                        confirmButtonColor:"{{color_main}}",
                        cancelButtonColor:"{{color_sec}}",
                        title: 'Registration failed because: ',
                        animation:false,
                        customClass:'scale-in-center',
                        text: res.data.reason
                      });
                    } catch (e) {
                      throw e;
                    }
                  }
                }).catch(err=>{
                  self.loading = false;
                  let culprit = "<h6>"+err.response.data.error+"</h6>"
                  if (err.response.data && err.response.data.path) {
                    culprit += "<h5>Culprit <i class='fas fa-arrow-right'></i> <b class='text-danger'>"+err.response.data.path+"</b></h5>"
                  }
                  if (err.response.data.parent && err.response.data.parent.path){
                    if (true) {
                      culprit += "<h5>Under <i class='fas fa-arrow-right'6</i> <b class='text-danger'>"+err.response.data.parent.path+"</b></h5>"
                    }
                    if (err.response.data.parent && err.response.data.parent.reason) {
                      culprit += "<div class='alert alert-warning'><small>"+err.response.data.parent.reason+"</small></div>"
                    }
                  }
                  if (err.response.data.hasOwnProperty('validator_value') && err.response.data.validator_value.length){
                    culprit += "<div class='alert alert-info'><small> Hint: "+err.response.data.validator_value+"</small></div>"
                  }
                  Swal.fire({
                    type: 'error',
                    position: 'top center',
                    title: 'Registration failed because: ',
                    confirmButtonColor:"{{color_main}}",
                    cancelButtonColor:"{{color_sec}}",
                    animation:false,
                    customClass:'scale-in-center',
                    html: culprit,
                    footer:'<small>Validation Error</small>'
                  });
                  throw err;
                })

          
            self.loading = true;
          }

        },
        showHelp(){
          Swal.fire({
            title: 'Dataset Guide',
            html:`<p>
                    After selecting a starting point you will be able complete a series of fields. It's really easy and fast! Here's a quick introduction to the layout:
                  </p>
                  <small>
                    <ul class="text-left">
                      <li>
                        1. Log-in status
                      </li>
                      <li>
                        2. Start over from scratch
                      </li>
                      <li>
                        3. Preview your progress
                      </li>
                      <li>
                        4. Download your progress (Available after completing all required fields)
                      </li>
                      <li>
                        5. Register your dataset (Available after completing all required fields)
                      </li>
                      <li>
                        6. All fields available to complete (* Required)
                      </li>
                      <li>
                        7. Progress bar
                      </li>
                      <li>
                        8. Complete fields
                      </li>
                      <li>
                        9. Current field clicked
                      </li>
                      <li>
                        10. Actions: Save & Close and Clear Field
                      </li>
                    </ul>
                  </small>`,
            footer:'',
            width:'52em',
            confirmButtonColor:"{{color_main}}",
            cancelButtonColor:"{{color_sec}}",
            confirmButtonText:"Ready!",
            animation:false,
            customClass:'scale-in-center',
            imageUrl: '/static/img/metadata.png',
            imageAlt: 'Dataset Editor'
          })
        },
        handleBulk(){
          var self = this;

          Swal.fire({
            title: 'Bulk registration',
            text: 'What type of file do you have?',
            input: 'select',
            animation:false,
            customClass:'scale-in-center',
            confirmButtonColor:"{{color_main}}",
            cancelButtonColor:"{{color_sec}}",
            inputOptions: {
              'json': 'JSON',
              'csv': 'CSV (WIP)',
            },
            inputPlaceholder: 'Select type',
            showCancelButton: true,
            confirmButtonText: 'Next',
            showLoaderOnConfirm: true,
            preConfirm: (method) => {
              return method
            },
            allowOutsideClick: () => !Swal.isLoading()
          }).then((result) => {
            if (result.value) {
              switch (result.value) {
                case 'json':
                  self.getFile('json');
                  break;
                case 'csv':
                  self.getFile('csv');
                break;
                default:
                  //nothing
              }
            }
          })
        },
        async getFile(type){
          var self = this;

          if (type == 'json') {
            const { value: file } = await Swal.fire({
            title: 'Select file',
            input: 'file',
            confirmButtonColor:"{{color_main}}",
            cancelButtonColor:"{{color_sec}}",
            animation:false,
            customClass:'scale-in-center',
            footer:`<small class="text-danger">Registration will be triggered automatically when upload finishes.</small>`,
            inputAttributes: {
              'accept': 'json',
              'aria-label': 'Upload your file'
            }
            })

            if (file) {
              try {
                const blob = new Blob([file], {type:"application/json"});

                const fr = new FileReader();

                fr.addEventListener("load", e => {
                  var payload = {};
                  let json = JSON.parse(fr.result);
                  if (json.length < 101) {
                    payload["items"] = json;
                    store.commit('saveBulkItems',payload);
                  }else {
                    Swal.fire({
                    icon: 'error',
                    title: 'Over Limit',
                    text: json.length+" items. Please submit 100 items at a time."
                    })
                  }
                });

                fr.readAsText(blob);
              } catch (e) {
                Swal.fire({
                icon: 'error',
                title: 'Something is wrong..',
                text: e
                })
              }

            }
          }else if (type == 'csv') {
            const { value: file } = await Swal.fire({
            title: 'Select file',
            input: 'file',
            confirmButtonColor:"{{color_main}}",
            cancelButtonColor:"{{color_sec}}",
            animation:false,
            customClass:'scale-in-center',
            footer:`<small class="text-danger">Registration will be triggered automatically when upload finishes.</small>`,
            inputAttributes: {
              'accept': 'csv',
              'aria-label': 'Upload your file'
            }
            })
            if (file) {

              Papa.parse(file,{
              header: true,
              delimeter:';',
              complete: function(results) {
                self.parseCSVData(results.data)
              }
              });

            }
          }
        },
        parseCSVData(data){
          let self = this;
          let items = []
          for (let i = 0; i < data.length; i++) {
            let currentDoc = data[i]
            let newDoc = {}
            for (let key in currentDoc) {
              if (key.includes(".")) {
                let keyPath = self.separateByDelimeter(key,'.')
                self.createNested(newDoc, keyPath, currentDoc[key])
              }else{
                let v = currentDoc[key]
                if (key && v) {
                  self.createNested(newDoc,[key], v)
                }
              }
            }
            items.push(newDoc)
            // console.log("%c --------------------------------------------",'color:green')
            // console.log('%c '+JSON.stringify(items,null,2),'color:lightgreen')
            // console.log("%c --------------------------------------------",'color:green')

            var payload = {};
            payload["items"] = items;
            store.commit('saveBulkItems',payload);
          }
        },
        createNested(obj, keyPath, value) {
          var self = this;
          lastKeyIndex = keyPath.length-1;
          for (var i = 0; i < lastKeyIndex; ++ i) {
           key = keyPath[i];
           if (!(key in obj)){
             obj[key] = {}
           }
           obj = obj[key];
          }
          obj[keyPath[lastKeyIndex]] = value;
          return obj
        },
        separateByDelimeter(value, delimeter){
          if (value.includes(delimeter)) {
            return value.split(delimeter)
          }else {
            return value
          }
        },
        loadData(){
          var self = this;
          Swal.fire({
            title: 'Import Metadata',
            text: 'Select the source of metadata',
            input: 'select',
            inputOptions: {
              'giturl': 'Hosted metadata on GitHub (raw url)',
              'registered': 'Copy metadata from an existing dataset authored by you',
              'text':'JSON metadata text',
            },
            inputPlaceholder: 'Select method',
            showCancelButton: true,
            animation:false,
            confirmButtonColor:"{{color_main}}",
            cancelButtonColor:"{{color_sec}}",
            customClass:'scale-in-center',
            confirmButtonText: 'Next',
            showLoaderOnConfirm: true,
            preConfirm: (method) => {
              return method
            },
            allowOutsideClick: () => !Swal.isLoading()
          }).then((result) => {
            if (result.value) {
              switch (result.value) {
                case 'giturl':
                  // URL
                  Swal.fire({
                    title: 'Enter the URL here',
                    input: 'text',
                    inputAttributes: {
                      autocapitalize: 'off'
                    },
                    confirmButtonColor:"{{color_main}}",
                    cancelButtonColor:"{{color_sec}}",
                    animation:false,
                    customClass:'scale-in-center',
                    showCancelButton: true,
                    confirmButtonText: 'Go',
                    allowOutsideClick: () => !Swal.isLoading()
                  }).then((result) => {
                    if (result.value) {
                      let url = result.value
                      axios.get(url).then(res=>{
                        let selected = res.data;
                        for(key in selected){
                          if (!['@context','@type','_id'].includes(key)) {
                            var payload = {};
                            if (typeof selected[key] === 'object') {
                              let value = [selected[key]]
                              payload["completed"] = {'name':key,'value':value};
                              store.commit('markCompleted',payload);
                            }else{
                              let value = selected[key]
                              payload["completed"] = {'name':key,'value':value};
                              store.commit('markCompleted',payload);
                            }

                          }
                        }
                      }).catch(err=>{
                        Swal.fire({
                          type: 'error',
                          title: 'Oops...',
                          text: 'Something went wrong!',
                        })
                        throw err;
                      })
                    }
                  });
                  break;
                case 'registered':
                  axios.get('/api/dataset?&user='+self.userInfo.login).then(publicres=>{
                    let list = publicres.data.hits;
                    self.loading = false;
                    self.loading = true;
                    axios.get('/api/dataset?private=true&user='+self.userInfo.login).then(privateres=>{
                      self.loading = false;
                      list =list.concat(privateres.data.hits)
                      let options = {};
                      for (var i = 0; i < list.length; i++) {
                        Vue.set(options,list[i]['name'],list[i]['name'])
                      }
                      Swal.fire({
                        title: 'Select Metadata To Import',
                        input: 'select',
                        inputOptions: options,
                        animation:false,
                        confirmButtonColor:"{{color_main}}",
                        cancelButtonColor:"{{color_sec}}",
                        animation:false,
                        customClass:'scale-in-center',
                        footer:`<p>
                        WARNING: <span class='text-danger'>You are loading already registered metadata.</span> If -identifier- field <b>IS NOT</b> changed, changes will override current saved data. If -identifier- field <b>IS</b> changed this this create a new entry.
                        </p>`,
                        customClass:'scale-in-center',
                        inputPlaceholder: 'Select an item',
                        showCancelButton: true,
                      }).then((result) => {
                        if (result.value) {
                          for (var i = 0; i < list.length; i++) {
                            if (result.value === list[i]['name']) {
                              let selected = list[i]
                              for(key in selected){
                                if (!['@context','@type','_id'].includes(key)) {
                                  var payload = {};
                                  if (typeof selected[key] === 'object') {
                                    let value = [selected[key]]
                                    payload["completed"] = {'name':key,'value':value};
                                    store.commit('markCompleted',payload);
                                  }else{
                                    let value = selected[key]
                                    payload["completed"] = {'name':key,'value':value};
                                    store.commit('markCompleted',payload);
                                  }

                                }
                              }
                              store.commit('formPreview');
                            }
                          }
                        }
                      })
                    }).catch(err=>{
                      throw err;
                    });
                  }).catch(err=>{
                    throw err;
                  });

                  break;
                case 'text':
                  Swal.fire({
                    title: 'Enter JSON here:',
                    input: 'textarea',
                    inputAttributes: {
                      autocapitalize: 'off'
                    },
                    showCancelButton: true,
                    confirmButtonColor:"{{color_main}}",
                    cancelButtonColor:"{{color_sec}}",
                    animation:false,
                    customClass:'scale-in-center',
                    confirmButtonText: 'Go',
                    allowOutsideClick: () => !Swal.isLoading()
                  }).then((result) => {
                    if (result.value) {

                      try {
                          let selected = JSON.parse(result.value)
                          console.log(selected)
                          for(key in selected){
                            if (!['@context','@type','_id'].includes(key)) {
                              var payload = {};
                              if ( _.isPlainObject(selected[key]) ) {
                                //look at keys and check for dates
                                let obj = selected[key]
                                for (var k in obj) {
                                  if (k.includes('date')) {
                                    let v = moment(obj[k]).format("YYYY-MM-DD")
                                    obj[k] = v
                                    console.log('date checked obj',obj[k])
                                  }
                                }
                                //make obj an array of obj,
                                payload["completed"] = {'name':key,'value':[obj]};
                                store.commit('markCompleted',payload);

                              }else if ( _.isArray(selected[key]) ) {
                                let list = selected[key]

                                for (var i = 0; i < list.length; i++) {
                                  let item = list[i];
                                  if (_.isPlainObject(item)) {
                                    let arrObj = item

                                    for (var k in arrObj) {
                                      if (k.includes('date')) {
                                        let v = moment(arrObj[k]).format("YYYY-MM-DD")
                                        arrObj[k] = v
                                        console.log('date checked obj',arrObj[k])
                                      }
                                    }

                                  }else if (_.isString(item) && item.includes('date')) {
                                    item = moment(item).format("YYYY-MM-DD")
                                    console.log('date checked string',item)
                                  }else {

                                  }
                                }
                                payload["completed"] = {'name':key,'value':list};
                                store.commit('markCompleted',payload);
                              }
                              else{
                                let value = selected[key]
                                if (key.includes('date')) {
                                  let v = moment(value).format("YYYY-MM-DD")
                                  payload["completed"] = {'name':key,'value':v};
                                }else {
                                  payload["completed"] = {'name':key,'value':value};
                                }

                                store.commit('markCompleted',payload);
                              }

                            }
                          }
                      } catch(e) {
                        Swal.fire({
                        icon: 'error',
                        title: 'Oops...',
                        confirmButtonColor:"{{color_main}}",
                        cancelButtonColor:"{{color_sec}}",
                        animation:false,
                        customClass:'scale-in-center',
                        text: e,
                        footer: 'Oh no, something looks wrong...'
                        })
                      }
                    }
                  });
                  break;
                default:
                return false;
              }
            }
          })
        },
        checkAutoLoad(){
          var self = this;
          let payload = {}
          if (self.presets && self.presets.length === 1) {
            payload["startingPoint"] = self.presets[0];
            store.commit('setStartingPoint',payload);
            if (self.portals && self.portals.length) {
              payload["step"] = 2;
              store.commit('changeStep',payload);
            }else{
              payload["step"] = 3;
              store.commit('changeStep',payload);
              self.getFormValues();
            }
          }else{
            payload["step"] = 1;
            store.commit('changeStep',payload);
          }
        },
        getFormValues () {
          var self = this;
          // Handle selections for startingPoint and Portals IF any
          self.getStartingPointSchema(store.getters.getStartingPoint)
          let payload = {}
          payload["step"] = 3;
          store.commit('changeStep',payload);

        },
        setStartingPoint(startingPointInfo){
          var self = this;
          let payload = {}
          payload["startingPoint"] = startingPointInfo;
          store.commit('setStartingPoint',payload);
          if (self.portals && self.portals.length) {
            // IF PORTALS AVAILABLE
            payload["step"] = 2;
            store.commit('changeStep',payload);
          }else{
            // IF NO PORTALS AVAILABLE
            self.getFormValues()
            payload["step"] = 3;
            store.commit('changeStep',payload);
          }

        },
        goToStep(s){
          var self = this;
          let payload = {}
          payload["step"] = s;
          store.commit('changeStep',payload);
        },
        checkProgress(){
          let p = sessionStorage.getItem('guideProgress');
          if (p) {
            $.notify("Progress recovered",{ style:'success', globalPosition: 'top center',style:"success", showDuration: 40, });
            let selected = JSON.parse(p)

            for(key in selected){
              if (!['@context','@type','_id'].includes(key)) {
                var payload = {};
                let value = selected[key]
                payload["completed"] = {'name':key,'value':value};
                store.commit('markCompleted',payload);

              }
            }
          }
        },
        viewErrors(){
          var self = this;

          if (self.errors.length) {
            Swal.fire({
            title: 'Issues',
            animation:false,
            customClass:'scale-in-center',
            showConfirmButton: true,
            confirmButtonColor:"{{color_main}}",
            html: `<div class="text-left previewBox">
                    <div>
                      <small>
<pre>
`+JSON.stringify(self.errors,null,2)+`
</pre>
                      </small>
                    </div>
                  </div>`
            });
          }else {
            Swal.fire({type:'success',
              toast:true,
              title: 'Everything Looks Good!',
              showConfirmButton:false,
              timer:2000})
          }
        }
			},
			mounted:function(){
        this.checkUser();
        this.checkAutoLoad();

        tippy( '#guide', {
            target:'.bar',
            content: 'Loading...',
            maxWidth:'200px',
            placement:'top',
            animation: 'fade',
            theme:'light',
            onShow(instance) {
              let totals = store.getters.getTotals
              let percentage = Math.ceil((totals.complete/totals.total)*100)
              instance.setContent("<div class='text-success bold m-0'>"+percentage+"% Completed</div>")
            }
          });

        tippy( '#tip-cont',{
          target:'.tip',
          content: 'Loading...',
          placement:'top',
          animation: 'fade',
          interactive: true,
          theme:'light',
          onShow(instance) {
            let info = instance.reference.dataset.tippyInfo;
            instance.setContent("<div class='text-info text-left m-0 p-1'>"+info+"</div>")
          }
        });

        tippy( '#widget',{
            target:'.desc',
            content: 'Loading...',
            placement:'top',
            animation: 'fade',
            interactive: true,
            theme:'light',
            onShow(instance) {
              let info = instance.reference.dataset.tippyInfo;
              if (info.substring(0, 5) == '"http') {
                info = info.replace(/['"]+/g, '')
                // EBI API LOOKUP TIP DESCRIPTION
                axios.get("https://www.ebi.ac.uk/ols/api/search?q="+encodeURI(info)+"&exact=1").then(res=>{
                  if (res.data.response.hasOwnProperty('docs')&& res.data.response.docs.length >= 1) {
                    for (var i = 0; i < res.data.response.docs.length; i++) {
                      if (res.data.response.docs[i]['iri']===info) {
                        instance.setContent("<div class='text-muted m-0 p-1'>"+res.data.response.docs[i]['label']+"</div>")
                      }
                    }
                  }else{
                    instance.setContent("<div class='text-muted m-0 p-1'>"+info+"</div>")
                  }
                }).catch(err=>{
                  instance.setContent("<div class='text-muted m-0 p-1'><pre>"+info+"</pre></div>")
                });
              }else{
                // REGULAR TIP DESCRIPTION
                instance.setContent("<div class='text-info text-left m-0 p-1 bg-white'><pre style='margin:0px !important;'>"+info+"</pre></div>")
              }
            }
          });
			}
		});

</script>
{% include "footer.html" %}
{% endblock %}
