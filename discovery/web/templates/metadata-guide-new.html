{% extends "main.html" %}
{% block content %}
{% include "header.html" %}
<style>
  [v-cloak] > * { display:none; }
  [v-cloak]::before { content: "Please wait..."; }
  .tippy-box[data-theme~='tomato'] {
  background-color: tomato;
  color: white;
}
</style>
<div id="guide" class="container-fluid pt-5 m-auto col-sm-12 col-md-10 col-lg-10 col-xl-8" style="min-height:90vh;" v-cloak>
  <div v-if=loading class="loader">
    <img src="/static/img/ripple.svg"/>
  </div>
  <div class="p-2 bg-light text-center mt-5">
    <h6 class="logoText">DISCOVERY GUIDE</h5>
    <p class="text-muted">
      Follow best practices to make your dataset metadata more findable
    </p>
    <a href="/dataset">Browse registered datasets <i class="fas fa-chevron-right"></i></a>
  </div>
  <div id="jsonTable">
    <!-- BULK -->
    <div v-if="jsonItems.length" class="alert grad">
      <small class="text-light">BULK REGISTRATION </small> <small class="text-info" v-text="jsonItems.length+' documents found'"></small>
      <table class="m-0 table table-sm table-dark table-striped">
        <colgroup>
         <col span="1" style="width: 30%;">
         <col span="1" style="width: 60%;">
         <col span="1" style="width: 10%;">
        </colgroup>
        <thead>
          <th>
            <small>Name</small>
          </th>
          <th>
            <small>Result/Details</small>
          </th>
          <th>
            <small>Status</small>
          </th>
        </thead>
      </table>
      <div style="max-height:500px; overflow:scroll;">
        <table class="m-0 table table-sm table-dark">
          <colgroup>
           <col span="1" style="width: 30%;">
           <col span="1" style="width: 60%;">
           <col span="1" style="width: 10%;">
          </colgroup>
          <tbody style="max-height:500px; overflow:scroll;">
            <template v-for="(item,i) in jsonItems">
              <json-item :item="item" :number="i+1"></json-item>
            </template>
          </tbody>
        </table>
      </div>
    </div>
  </div>
  <!-- bulk end -->
  <div id="widget" class="mb-5 grad rounded">
    <div>
      <div class="actions bg-dark p-2 rounded d-flex align-items-center justify-content-start">
        <span class="fa-stack fa-1x pointer desc mr-2" :data-tippy-info="'Logged in as '+userInfo.login" v-if="userInfo && userInfo.login">
          <i class="fas fa-circle text-success fa-stack-2x"></i>
          <i class="fas fa-user-check fa-stack-1x fa-inverse"></i>
        </span>
        <a class='nav-link active text-primary mr-2' :href='"/login?next="+window.location.pathname' v-if="userInfo && !userInfo.login">
          <span class="fa-stack fa-1x pointer desc" data-tippy-info="Click to log in">
            <i class="fas fa-circle text-primary fa-stack-2x"></i>
            <i class="fas fa-sign-in-alt fa-stack-1x fa-inverse"></i>
          </span>
        </a>
        <span class="fa-stack fa-1x pointer desc mr-2" data-tippy-info="Start Over" @click="reset()"  :class="{ 'disabled notallowed': !validation, 'pointer': validation }">
          <i class="fas fa-circle text-success fa-stack-2x"  :class="{ 'text-muted': !validation, 'text-danger': validation }"></i>
          <i class="fas fa-undo fa-stack-1x fa-inverse"></i>
        </span>
        <span class="fa-stack fa-1x pointer desc mr-2" data-tippy-info="Preview Progress" @click="getPreview()"  :class="{ 'disabled notallowed': !validation, 'pointer': validation }">
          <i class="fas fa-circle text-success fa-stack-2x"  :class="{ 'text-muted': !validation, 'mainTextDark': validation }"></i>
          <i class="fas fa-code fa-stack-1x fa-inverse"></i>
        </span>
        <span class="fa-stack fa-1x pointer desc mr-2" data-tippy-info="Import Metadata" @click="loadData()"  v-show="validation">
          <i class="fas fa-circle text-success fa-stack-2x"  :class="{ 'text-muted': !validation, 'mainTextDark': validation }"></i>
          <i class="fas fa-file-import fa-stack-1x fa-inverse"></i>
        </span>
        <span class="fa-stack fa-1x pointer desc mr-2" data-tippy-info="Bulk Registration" @click="handleBulk()"  v-show="validation">
          <i class="fas fa-circle text-success fa-stack-2x"  :class="{ 'text-muted': !validation, 'mainTextDark': validation }"></i>
          <i class="fas fa-registered fa-stack-1x fa-inverse"></i>
        </span>
        <div class="pillType desc pointer" @click="viewErrors()" data-tippy-info="Issues Details" :class="{'shake-horizontal':!valid}" style="outline: none !important;">
          <span class="alert-muted">issues</span>
          <span class="text-light" v-text="errors.length" :class="[valid?'bg-success':'bg-danger']"></span>
        </div>
      </div>
    </div>

    <div v-if="userInfo && !userInfo.login" class="widgetContainer bg-light jumbotron whitefade text-center m-1">
      <div class="alert text-danger text-center p-5">
        <h2><i class="fas fa-exclamation"></i></h2>
        <h5>You must be logged in to proceed</h5>
      </div>
    </div>

    <div v-else class="widgetContainer bg-light text-center">
        <template v-if="step === 1 ">
          <!-- STARTING POINT -->
          <h4 class="logoText">Metadata</h4>
          <p class="text-muted">
            Select the type of metadata you are interested in creating.
          </p>
          <div>
            <template v-for="item in presets">
              <buttom  @click="setStartingPoint(item)" class="btn themeButton text-light mr-2 desc" v-text="item.name" :data-tippy-info="item.description"></buttom>
            </template>
          </div>
        </template>
        <!-- OPTIONAL PORTALS -->
        <template v-if=" step === 2 ">
          <h4 class="logoText">Discovery Portals</h4>
          <p class="text-muted">
            Select the portals you are interested in. Each will add fields required in order to be discovered by that portal.
          </p>
          <form @submit.prevent="getFormValues()">
            <template v-for="item in portals">
              <div class="p-2 text-left w-50 m-auto">
                <input class="form-check-input" type="checkbox" name="portal" :id="item.displayName" :value="item.name" :checked="item.selected" @click="item.selected = !item.selected">
                <label class="form-check-label" :for="item.displayName">
                  <span v-text="item.displayName"></span>
                  <i class="fas fa-info-circle text-info desc" :data-tippy-info="item.description"></i>
                </label>
              </div>
            </template>
            <button class="btn themeButton text-light mt-3" type="submit">NEXT <i class="fas fa-chevron-right"></i></button>
          </form>
        </template>

        <template v-if=" step === 3 ">
          <propcontainer v-show="validation" :type="'REQUIRED'"></propcontainer>
        </template>

        <template v-if=" step === 4 ">
          <propcontainer v-show="validation" :type="'RECOMMENDED'"></propcontainer>
        </template>

        <template v-if=" step === 5">
          <h1 class="logoText">Registration</h1>
          <div class="p-5 text-center m-3">
            <p class="text-muted text-center">
              Are you all done? Click Register Now to proceed. <br />You will leave this page after successfully registering this metadata.
            </p>
            <a class='btn btn-lg btn-success text-light desc' :class="{ 'disabled text-muted notallowed': !isComplete, 'bg-success text-light pointer': isComplete }" @click="handleRegistration()" :data-tippy-info="[!isComplete ? 'Available when all required fields are complete' : 'Click to register your metadata']">
              <small>
                <i class="fas fa-check"></i> Register
              </small>
            </a>
          </div>
          <div class="col-sm-12">
            <div class="row">
              <div class="col-sm-12 text-center p-3">
                <h4 class="bold" :class="{ 'text-info': fieldsleftRegistration !== 0, 'text-success': fieldsleftRegistration !== 0 }">
                  <span v-show="fieldsleftRegistration === 0">Great Job! </span>
                  <span v-text="Math.ceil((totals.complete/totals.total)*100)+'% COMPLETE'" ></span>
                </h4>
                <small class="text-info"> (<span v-text='totals.complete'></span>/<span v-text='totals.total'></span>)</small>
              </div>
            </div>
            <div v-if="fieldsleftRegistration !== 0" class="col-sm-12 text-center p-3 rounded alert-info m-2">
              <h4 class="text-muted">Only <span class="text-danger bold" v-text="fieldsleftRegistration"></span> fields left!</h4>
              <button class="btn themeButton text-light" @click="goToStep(4)">Fill Out Now</button>
            </div>
            <div v-else class="col-sm-12 text-center p-3 rounded m-2">
              <button class="btn btn-danger text-light" @click="goToStep(step-1)"><i class="fas fa-chevron-left"></i> BACK</button>
            </div>
            <div class="d-flex justify-content-center flex-wrap">
              <template v-if="categoryTotals" v-for="(subcats,cat) in categoryTotals">
                <catcontainer class="fade-in" :cat="cat" :subcats="subcats" :key="cat+subcats"></catcontainer>
              </template>
            </div>
          </div>
        </template>
    </div>
  </div>
</div>

{% endblock %}
{% block extra_scripts %}
<script src="https://unpkg.com/vuex"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.18.0/axios.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.bundle.min.js" integrity="sha256-xKeoJ50pzbUGkpQxDYHD7o7hxe0LaOGeguUidbq6vis=" crossorigin="anonymous"></script>
<script src="/static/js/lodash.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ajv/6.12.4/ajv.min.js" integrity="sha512-jT80r/QIunAH3Bng0028a3kMjhpr+ApSrAjshiM+0+6s/O01//jwogIby3WnFle7UxDas+/gf3BgI4Rjju17ww==" crossorigin="anonymous"></script>
<script src="/static/js/renderjson.js"></script>
<script src="/static/js/notify.min.js"></script>
<script src="/static/js/moment.js"></script>
<script src="https://gmousse.github.io/dataframe-js/dist/dataframe.min.js"></script>
<script src="/static/js/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@7.28.11/dist/sweetalert2.all.min.js"></script>
<script>
  // json validation
  // const env = new djv({
  // version: 'draft-07'
  // });

  const store = new Vuex.Store({
    state: {
      schema:Object,
      required:Array,
      validation:null,
      schemaName:'',
      output:{},
      filter:String,
      startingPoint: null,
      selectedPortals:[],
      step: Number,
      settings: Object,
      showDescriptions:true,
      bulkJSONItems:[],
      valid: Boolean,
      errors: []
    },
    strict: true,
    mutations: {
      toggleDesc(state){
        state.showDescriptions = !state.showDescriptions
      },
      saveBulkItems(state,payload){
        state.bulkJSONItems = payload['items'];
      },
      updateJsonItem(state,payload){
        let item = payload['item']
        let change = payload['change']
        let field = payload['field']

        for (var i = 0; i < state.bulkJSONItems.length; i++) {
          if (state.bulkJSONItems[i]['name'] == item['name'] || state.bulkJSONItems[i]['description'] == item['description']) {

            Vue.set(state.bulkJSONItems[i],field,change)

            Swal.fire({type:'success',
              toast:true,
              title: 'Updated',
              showConfirmButton:false,
              timer:1000})
          }
        }
      },
      saveSchema(state,payload){
        state.schema = payload['schema'];
        // console.log('schema saved',state.schema)
        console.log('form properties',state.schema.validation.properties)
        state.output['@type'] = state.schema.name || state.schema.label
        state.output['@context'] = payload['schema']["@context"]

        state.filter = state.schema.label || state.schema.name

        // Add identifier to required if not there, it's required as an ID
        // if ('identifier' in state.schema.validation.properties && !state.schema.validation.required.includes('identifier')) {
        //   state.schema.validation.required.push('identifier')
        // }else{
        //   // console.log('WARNING: identifier field not found and is required')
        //   Vue.set(state.schema.validation.properties['identifier'],{'type':'string','description':'unique identifier for this entry'});
        //   state.schema.validation.required.push('identifier')
        // }

        // helper func to decide right subcategory
        function getProp(propname){
          let cat={
            'category': state.schema.label || state.schema.name
          }
          if (state.schema.validation.required.includes(propname)) {
            Vue.set(cat,'subcategory','Required')
          }else{
            Vue.set(cat,'subcategory','Recommended')
          }
          return cat
        }

        // Assign initial guide_categories
        for (var prop in state.schema.validation.properties) {
          if (state.schema.validation.properties[prop].hasOwnProperty('categories')) {
            state.schema.validation.properties[prop]['categories'].unshift(getProp(prop))
          }else{
            Vue.set(state.schema.validation.properties[prop],'categories',[])
            state.schema.validation.properties[prop]['categories'].unshift(getProp(prop))
          }
        }
        // console.log("add json schema", state.schema.validation)
        // env.addSchema('discovery',state.schema.validation.properties );
      },
      filterProps(state,payload){
        state.filter = payload['cat'];
      },
      saveSchemaName(state,payload){
        state.schemaName = payload['name'];
      },
      reset(state){
        state.schema = {};
        state.validation = null;
        state.step = '1';
        state.selectedPortals = []
        state.startingPoint = null
        window.location.reload()
      },
      markSelected(state,payload){
        let selection = payload['select'];
        for (key in state.schema.validation.properties) {
          if (key === selection) {
            Vue.set(state.schema.validation.properties[selection],'selected',true);
          }else{
            Vue.set(state.schema.validation.properties[key],'selected',false);
          }
        }
      },
      selectNext(state){
        for (key in state.schema.validation.properties) {
          if (state.schema.validation.properties[key] && !state.schema.validation.properties[key].value) {
            Vue.set(state.schema.validation.properties[key],'selected',true);
            break;
          }
        }
      },
      saveSettings(state,payload){
        state.settings = payload['settings']
        // console.log(state.settings)
      },
      highlight(state,payload){
        let cat = payload['category'];
        let subcat = payload['subcategory'];
        for (prop in state.schema.validation.properties) {
          Vue.set(state.schema.validation.properties[prop],'highlighted',false);
        }
        for (prop in state.schema.validation.properties) {
          if (state.schema.validation.properties[prop].hasOwnProperty('categories')) {
            for (var i = 0; i < state.schema.validation.properties[prop]['categories'].length; i++) {
              if (state.schema.validation.properties[prop]['categories'][i]['category'] === cat && state.schema.validation.properties[prop]['categories'][i]['subcategory'] === subcat  ) {
                //Match found
                if (state.schema.validation.properties[prop]['highlighted']) {
                  Vue.set(state.schema.validation.properties[prop],'highlighted',false);
                }else {
                  Vue.set(state.schema.validation.properties[prop],'highlighted',true);
                }
              }
            }
          }
        }
      },
      unhighlight(state){
        for (prop in state.schema.validation.properties) {
          Vue.set(state.schema.validation.properties[prop],'highlighted',false);
        }
      },
      markCompleted(state,payload){
        let selection = payload['completed'];
        for (key in state.schema.validation.properties) {
          if (key === selection.name) {
            //Check if selection has duplicates
            if (key+"s" in state.schema.validation.properties && state.schema.validation.properties[key+"s"].hasOwnProperty('duplicate') ) {
              // console.log('HAS DUPLICATE')
              let obj ={}
              Vue.set(obj,key,selection.value)
              let typeProp= key+'Type';
              Vue.set(obj,typeProp,'')
              // console.log(obj)
              Vue.set(state.schema.validation.properties[key+"s"],'value',[obj]);
            }
            Vue.set(state.schema.validation.properties[selection.name],'value',selection.value);
          }
        }
      },
      clearValueOfProp(state,payload){
        let selection = payload['clear'];
        for (key in state.schema.validation.properties) {
          if (key === selection) {
            Vue.delete(state.schema.validation.properties[selection],'value');
            Vue.set(state.schema.validation.properties[selection],'selected',false);
            $.notify(selection+" was cleared",{ globalPosition: 'right',className:'success', showDuration: 40, });
          }
        }
      },
      removeArrayItemFrom(state,payload){
        let field = payload['from']; //name of prop
        let item = payload['item']; //full info
        let props = state.schema.validation.properties;

        if(typeof item === 'string'){
          for (var i = 0; i < props[field].value.length; i++){
            if (props[field].value[i] === item) {
              Vue.delete(props[field].value,i);
              $.notify(item+" removed",{ globalPosition: 'right',className:'success', showDuration: 40, });
            }
          }
        }else if (typeof item === 'object') {
          let res = _.reject(props[field].value,item)
          props[field].value=res
          $.notify("Item removed",{ globalPosition: 'right',className:'success', showDuration: 40, });
        }

      },
      addToArrayFrom(state,payload){
        let field = payload['from'];
        let item = payload['item'];
        // console.log(item)
        //Initialize array
        if (!state.schema.validation.properties[field].value) {
          Vue.set(state.schema.validation.properties[field], 'value', [])
        }
        state.schema.validation.properties[field]['value'].push(item)
      },
      formPreview(state){
        let props = state.schema.validation.properties;

        for (key in props) {
          if (props[key].hasOwnProperty('value')) {
            if (props[key]['value'] || props[key]['value'] === false) {
              if (_.isArray(props[key]['value']) && props[key]['value'].length === 1) {
                Vue.set(state.output,key,props[key].value[0])
              }else{
                Vue.set(state.output,key,props[key].value)
              }
            }
          }
        }
        // VALIDATION ON COMPLETE
        var ajv = new Ajv({allErrors:true, jsonPointers:true});
        var schema = state.schema.validation
        var data = state.output
        const isValid = ajv.validate(schema, data);

        if(! isValid){
          state.valid = false;
          state.errors = ajv.errors;
          // console.log('errors', state.errors)
          for (var key in props) {
            Vue.delete(props[key],'hasIssue')
          }
          for (var i = 0; i < state.errors.length; i++) {
            if (state.errors[i]['dataPath']) {
              let path = state.errors[i]['dataPath'].replace('/','');
              if (props.hasOwnProperty(path)) {
                Vue.set(props[path],'hasIssue',state.errors[i]['message'])
              }
            }
            if (state.errors[i]['params'].hasOwnProperty('missingProperty')) {
              let missing = state.errors[i]['params']['missingProperty'];
              if (props.hasOwnProperty(missing)) {
                Vue.set(props[missing],'hasIssue',state.errors[i]['message'])
              }
            }
          }
        }else {
          state.valid = true;
          state.errors = []
          for (var key in props) {
            Vue.delete(props[key],'hasIssue')
          }
        }
      },
      mergeCategoryProps(state,payload){
        let origin = payload['origin'];
        let catprops = payload['catprops'];
        let catpropsrequired = payload['catpropsrequired'];
        // console.log(catprops)
        // console.log(catpropsrequired)
        // console.log(origin)
        $.notify(origin+" added",{ globalPosition: 'right',className:'success', showDuration: 40, });

        // add requirements to main reqs to be able to show asterisk
        state.schema.validation.required = state.schema.validation.required.concat(catpropsrequired)

        // helper func to decide right succategory
        function getProp(propname){
          let cat={
            'category': origin,
          }
          if (catpropsrequired.includes(propname)) {
            Vue.set(cat,'subcategory','Required')
          }else{
            Vue.set(cat,'subcategory','Recommended')
          }
          return cat
        }

        // if matching add cat {name:orgin, subcategory: req/rec}
        // else add new prop with origin = name
        for (prop in catprops) {
          if (prop in state.schema.validation.properties) {
            // check if prop has guide_categories
            // if YES push new
            // if NO set-up and add
            if (state.schema.validation.properties[prop].hasOwnProperty('categories')) {
              state.schema.validation.properties[prop]['categories'].unshift(getProp(prop))
            }else{
              Vue.set(state.schema.validation.properties[prop],'categories',[])
              state.schema.validation.properties[prop]['categories'].unshift(getProp(prop))
            }
          }else if (prop.slice(0, -1)  in state.schema.validation.properties) {
            //plural form exists
            // console.log(prop.slice(0, -1))

            let newProp = catprops[prop]
            Vue.set(newProp,'categories',[])
            // set origin to remove by origin
            Vue.set(newProp,'origin', origin)
            // is a duplicate
            Vue.set(newProp,'duplicate', true)

            newProp['categories'].unshift(getProp(prop))
            Vue.set(state.schema.validation.properties,prop,newProp)

          }else{
            let newProp = catprops[prop]
            Vue.set(newProp,'categories',[])
            // set origin to remove by origin
            Vue.set(newProp,'origin', origin)

            newProp['categories'].unshift(getProp(prop))
            Vue.set(state.schema.validation.properties,prop,newProp)
          }
        }
        // console.log("ALL DONE", state.schema.validation.properties)
      },
      removeCategory(state,payload){
        let origin = payload['origin'];
        let catpropsrequired = [];

        // console.log("remove",catpropsrequired)
        // console.log("remove",origin)
        $.notify(origin+" removed",{ globalPosition: 'right',className:'info', showDuration: 40, });

        for (var i = 0; i < state.selectedPortals.length; i++) {
          if (state.selectedPortals[i]['label'] === origin) {
            catpropsrequired = state.selectedPortals[i]['validation']['required']
          }
        }

        for (prop in state.schema.validation.properties) {
          // if origin matches remove prop
          if (state.schema.validation.properties[prop].hasOwnProperty('origin') && state.schema.validation.properties[prop]['origin'] === origin ) {
            Vue.delete(state.schema.validation.properties,prop)
          }else {
            // if not check categories and remove mention of origin
            if (state.schema.validation.properties[prop].hasOwnProperty('categories')) {
              for (var i = 0; i < state.schema.validation.properties[prop]['categories'].length; i++) {
                if (state.schema.validation.properties[prop]['categories'][i]['category'] === origin) {
                  state.schema.validation.properties[prop]['categories'].splice(i,1)
                }
              }
            }
          }
        }
        // console.log("ALL DONE", state.schema.validation.properties)
      },
      setStartingPoint(state,payload){
        state.startingPoint= payload['startingPoint'];
        // console.log("startingPoint selected ",JSON.stringify(state.startingPoint,null,2))
      },
      addPortalSchema(state,payload){
        let portal = payload['portal']
        state.selectedPortals.push(portal)
        // console.log("PORTALS SELECTED ",state.selectedPortals)
      },
      changeStep(state,payload){
        state.step = payload['step']
      },
      addValue(state,payload){
        let name = payload['name'];
        let info = payload['info'];
        let value = payload['value'];


        let props = state.schema.validation.properties;
        for (key in props) {
          if (key === name) {
            if (info.hasOwnProperty('type') && info['type'] == 'object') {
              console.log('OBJECT')
              //SAVE OBJECT
              if (props[name].value) {
                Swal.fire({
                  title: 'Value Already Exists',
                  text: "Do you want to replace the value of: "+name,
                  showCancelButton: true,
                  confirmButtonText: 'Yes'
                }).then((result) => {
                  if (result.value) {
                    Vue.set(props[name],'value',value);
                  }
                })
              }else{
                //no value yet
                Vue.set(props[name],'value',value);
              }
            }else if (info.hasOwnProperty('anyOf')) {
              console.log('ANY OF')
              // SAVE OBJECT TO ARRAY IF AVAILABLE
              for (var i = 0; i < info['anyOf'].length; i++) {
                if (info['anyOf'][i].hasOwnProperty('type') && info['anyOf'][i]['type'] == 'array') {
                  // CAN BE ARRAY
                  if (props[name].value) {
                    let val = props[name].value
                    if (_.isPlainObject(val)) {
                      // will replace
                      Swal.fire({
                        title: 'Value Exists',
                        text: "Do you want to replace the value of: "+name,
                        showCancelButton: true,
                        confirmButtonText: 'Yes'
                      }).then((result) => {
                        if (result.value) {
                          Vue.set(props[name],'value',value);
                        }
                      })
                    }
                    else if (_.isArray(val)) {
                      //push to exisiting array
                      props[name]['value'].push(value)
                    }else {
                      //no value yet
                      Vue.set(props[name],'value',value);
                    }
                  }else{
                    //no value yet
                    Vue.set(props[name],'value',value);
                  }
                }else{
                  //no ability to be array
                  console.log('no ability to be array')
                  Vue.set(props[name],'value',value);
                }
              }
            }else if (info.hasOwnProperty('oneOf')) {
              console.log('ONE OF')
              // SAVE OBJECT TO ARRAY IF AVAILABLE
              for (var i = 0; i < info['oneOf'].length; i++) {
                if (info['oneOf'][i].hasOwnProperty('type') && info['oneOf'][i]['type'] == 'array') {
                  // CAN BE ARRAY
                  if (props[name].value) {
                    let val = props[name].value
                    if (_.isPlainObject(val)) {
                      // will replace
                      Swal.fire({
                        title: 'Value Exists',
                        text: "Do you want to replace the value of: "+name,
                        showCancelButton: true,
                        confirmButtonText: 'Yes'
                      }).then((result) => {
                        if (result.value) {
                          Vue.set(props[name],'value',value);
                        }
                      })
                    }
                    else if (_.isArray(val)) {
                      //push to exisiting array
                      props[name]['value'].push(value)
                    }else {
                      //no value yet
                      Vue.set(props[name],'value',value);
                    }
                  }else{
                    //no value yet
                    Vue.set(props[name],'value',value);
                  }
                }else{
                  //no ability to be array
                  console.log('no ability to be array')
                  Vue.set(props[name],'value',value);
                }
              }
            }else{
              Vue.set(props[name],'value',value);
            }
          }
        }
      },
    },
    getters:{
      getBulkJSONItems:state=>{
        return state.bulkJSONItems
      },
      getValidStatus:state=>{
        return state.valid
      },
      getErrors:state=>{
        return state.errors
      },
      getShowDesc:state=>{
        return state.showDescriptions
      },
      // exposed as store.getters.nameOfGetter
      getSchema: (state) => {
        return state.schema
      },
      getValidation: (state) => {
        if (state.schema.hasOwnProperty('validation')) {
          return state.schema.validation
        }else{
          return false;
        }
      },
      isRequired: (state) => (propname) =>{
        if (state.schema.validation.required.includes(propname)) {
          return true
        }else{
          return false
        }
      },
      getSchemaName: (state)=>{
        return state.schemaName
      },
      getValueOf: (state) => (propname) =>{
        return state.schema.validation.properties[propname].value
      },
      getTotals:(state) => {
        let completeCount = 0;
        if (state.schema.hasOwnProperty('validation')) {
          let totalprops = Object.keys(state.schema.validation.properties).length
          for (key in state.schema.validation.properties) {
            if (state.schema.validation.properties[key] && state.schema.validation.properties[key].value) {
              completeCount++;
            }
          }
          let left = totalprops - completeCount;
          if (left === 0) {
            state.complete = true
          }
          let res = {'left':left,'complete':completeCount,'total':totalprops}
          return res
        }

      },
      getCategoryTotals: (state)=>{
        let cats = {}
        if (state.schema.hasOwnProperty('validation')) {
          for (key in state.schema.validation.properties) {
            if (state.schema.validation.properties[key].hasOwnProperty('categories')) {
              for (var i = 0; i < state.schema.validation.properties[key]['categories'].length; i++) {
                let c = state.schema.validation.properties[key]['categories'][i]['category']
                if(!cats.hasOwnProperty(c)) {
                  Vue.set(cats,c,{})
                  Vue.set(cats[c],'Required',{'completed':0,'todo':0})
                  Vue.set(cats[c],'Recommended',{'completed':0,'todo':0})

                  switch (state.schema.validation.properties[key]['categories'][i]['subcategory']) {
                    case 'Required':
                      cats[c]['Required']['todo'] += 1
                      break;
                    case 'Recommended':
                      cats[c]['Recommended']['todo'] += 1
                      break;
                    default:
                  }

                }else{
                  switch (state.schema.validation.properties[key]['categories'][i]['subcategory']) {
                    case 'Required':
                      cats[c]['Required']['todo'] += 1
                      break;
                    case 'Recommended':
                      cats[c]['Recommended']['todo'] += 1
                      break;
                    default:
                  }
                }
              }
            }
          }
          // UPDATE TOTALS
          for (key in state.schema.validation.properties) {
            if (state.schema.validation.properties[key] && state.schema.validation.properties[key].value) {
              if (state.schema.validation.properties[key].hasOwnProperty('categories')) {
                for (var i = 0; i < state.schema.validation.properties[key]['categories'].length; i++) {

                  let c = state.schema.validation.properties[key]['categories'][i]['category']

                  switch (state.schema.validation.properties[key]['categories'][i]['subcategory']) {
                    case 'Required':
                      cats[c]['Required']['todo'] -= 1
                      cats[c]['Required']['completed'] += 1
                      break;
                    case 'Recommended':
                      cats[c]['Recommended']['todo'] -= 1
                      cats[c]['Recommended']['completed'] += 1
                      break;
                    default:
                  }
                }
              }
            }
          }
        }
        // console.log('CATS',JSON.stringify(cats,null,2))
        return cats
      },
      getPreview(state){
        return state.output
      },
      isComplete(state){
        let complete = false;
        if (state.schema && state.schema.hasOwnProperty('validation') && state.schema.validation.hasOwnProperty('required')) {
          let required = state.schema.validation['required']
          for (var i = 0; i < required.length; i++) {
            if (state.schema.validation.properties.hasOwnProperty(required[i]) && state.schema.validation.properties[required[i]].value || state.schema.validation.properties[required[i]].value === false) {
              complete = true
            }else{
              complete = false
              break;
            }
          }
        }
        return complete
      },
      getOutput(state){
        return state.output
      },
      getSelectedProps: (state)=>{
        let selected = {}

        for (var prop in state.schema.validation.properties) {
          if (state.schema.validation.properties[prop].hasOwnProperty('categories')) {
            for (var i = 0; i < state.schema.validation.properties[prop]['categories'].length; i++) {
              if (state.schema.validation.properties[prop]['categories'][i]['category'] === state.filter) {
                Vue.set(selected,prop,state.schema.validation.properties[prop])
              }
            }
          }
        }
        return selected
      },
      getFilter: (state)=>{
        return state.filter
      },
      getStartingPoint:(state)=>{
        return state.startingPoint
      },
      getSelectedPortals:(state)=>{
        return state.selectedPortals
      },
      getStep:(state)=>{
        return state.step
      },
      getSettings:(state)=>{
        return state.settings
      }
    },
    actions:{
      reset ({ commit }) {
        commit('reset')
      },
      saveProgress({commit, state}){
        commit('formPreview')
        let obj = state.output
        sessionStorage.setItem('guideProgress',JSON.stringify(obj));
      },
    }
  });

  Vue.component('json-item', {
    data: function(){
      return{
        errMSG:"",
        successMSG:"",
        loading: false,
      }
    },
    props: ['item', 'number'],
    methods:{
      registerJSONItem(isRetry){
        var self = this;

        let schema = store.getters.getSchema

        let config = {
           headers: {
             'content-type': 'application/json'
           }
         }

        axios.post('/api/dataset?schema='+schema['namespace']+'::'+schema['prefix']+':'+schema['label'],self.item,config).then(res=>{
          self.loading = false;
          if (res.data.success) {
            self.successMSG = `<a href="/dataset/`+res.data.id+`" target="_blank" rel="nonreferrer"><small>Registration Successful! Click here to view.</small></a>`;
            self.errMSG = '';
          }
        }).catch(err=>{
          self.loading = false;
          if (isRetry) {
            Swal.fire({type:'error',
              toast:true,
              title: 'Failed',
              showConfirmButton:false,
              timer:1000})
          }
          // console.log('err',err.response.data)
          let culprit = "<small class='d-block text-danger'><b>ERROR: "+err.response.data.error+"</b></small>"
          if (err.response.data && err.response.data.path) {
            culprit += "<small class='mr-2'>Culprit (index/property)<i class='fas fa-arrow-right'></i> <b class='text-danger'>"+err.response.data.path+"</b></small>"
          }
          if (err.response.data.parent && err.response.data.parent.path){
            if (true) {
              culprit += "<small>Under <i class='fas fa-arrow-right'6</i> <b class='text-danger'>"+err.response.data.parent.path+"</b></small>"
            }
            if (err.response.data.parent && err.response.data.parent.reason) {
              culprit += "<div class='text-danger p-1 m-0'><small> "+err.response.data.parent.reason+"</small></div>"
            }
          }
          if (err.response.data.hasOwnProperty('validator_value') && err.response.data.validator_value.length){
            culprit += "<div class='text-info p-1 m-0'><small> Hint: "+err.response.data.validator_value+"</small></div>"
          }
          self.errMSG = culprit;
          throw err;
        })
      },
      edit(isRetry){
        var self = this;
        let list ={}
        let notAllowed=['@context','@type']
        for(key in self.item){
          if (!notAllowed.includes(key)) {
            list[key] = key
          }
        }

        Swal.fire({
          title: `Quick Edit`,
          text:"Which field would you like to edit?",
          input: 'select',
          footer:"<b class='text-danger'>Important:<b>Only existing fields can be edited.</b>",
          inputOptions: list,
          inputPlaceholder: 'Select a field to edit',
          showCancelButton: true,
          confirmButtonColor:"{{color_main}}",
          cancelButtonColor:"{{color_sec}}",
          confirmButtonText: 'Edit',
          inputValidator: (value) => {
            return new Promise((resolve) => {
              if (!value) {
                resolve('You must select something first')
              }else{
                resolve()
              }
            })
          }
        }).then((keyname) => {
          if (keyname.value) {
            let iValue =''

            if (typeof self.item[keyname.value] === 'string' ||  typeof self.item[keyname.value] === 'number' ||  typeof self.item[keyname.value] === 'boolean') {
              iValue = self.item[keyname.value]
            }else{
              iValue = JSON.stringify(self.item[keyname.value],null,2)
            }

            Swal.fire({
              title: "Edit: "+keyname.value,
              input: 'textarea',
              footer:`<small>Make sure to close all: {},[] and quotes</small>`,
              confirmButtonColor:"{{color_main}}",
              cancelButtonColor:"{{color_sec}}",
              animation:false,
              customClass:'scale-in-center',
              inputPlaceholder: self.item[keyname.value],
              inputValue: iValue,
              inputAttributes: {
                'aria-label': keyname.value,
                'rows':15
              },
              showCancelButton: true,
              confirmButtonText: 'Save',
              inputValidator: (value) => {
                return new Promise((resolve) => {
                  if (value === self.item[keyname.value]) {
                    resolve("You haven't changed anything yet")
                  }else{
                    resolve()
                  }
                })
              }
            }).then((newdata) => {
              if (newdata.value) {
                if (newdata.value[0]==="{" || newdata.value[0]==="[") {
                  var payload = {};
                  payload["item"] = self.item;
                  payload["field"] = keyname.value;
                  payload["change"] = JSON.parse(newdata.value);
                  store.commit('updateJsonItem',payload);
                }else{
                  var payload = {};
                  payload["item"] = self.item;
                  payload["field"] = keyname.value;
                  payload["change"] = newdata.value;
                  store.commit('updateJsonItem',payload);
                }
              }
            })
          }
        })
      },
    },
    computed:{
      short_name:function(){
        if (this.item.name.length > 100) {
          return this.item.name.substring(0,100)+"..."
        }else {
          return this.item.name
        }
      },
      tipInfo:function(){
        return JSON.stringify(this.item,null,2)
      }
    },
    mounted: function(){
      var self = this;

      tippy( '#jsonTable', {
        target:'.tip',
        trigger: 'click',
        placement:'top',
        theme:'light',
        sticky: true,
        content: 'loading',
        interactive: true,
        animation: 'fade',
        onShow(instance) {
          let info = instance.reference.dataset.tippyInfo;
          instance.setContent("<div class='bg-light' style='max-height:300px; overflow:scroll;'><small class='text-left text-light'><pre id='callResults'>"+info+"</pre></small></div>");
        }});

      self.registerJSONItem();
    },
    template: `<tr :class="{'alert-success':successMSG,'alert-warning':errMSG}">
                  <td>
                    <b class="text-info" v-text="number+'- '"></b>
                    <small :title="item.name">
                      <span v-text="short_name"></span> <i class="fas fa-info-circle tip pointer text-primary" :data-tippy-info="tipInfo"></i>
                    </small>
                  </td>
                  <td class="align-middle">
                    <small v-if="loading" class="text-muted">Registering...</small>
                    <small v-if="errMSG" v-html="errMSG"></small>
                    <small v-if="successMSG" v-html="successMSG"></small>
                    <button role="button" v-if="errMSG" @click="edit" class="btn btn-sm mainBackDark text-light mr-1">Edit</button>
                    <button role="button" v-if="errMSG" @click="registerJSONItem(1)" class="btn btn-sm mainBackLight text-light">Retry Registration</button>
                  </td>
                  <td class="bg-dark align-middle">
                    <span class="badge d-block" :class="{'badge-danger':errMSG,'badge-success':successMSG}">
                      <i v-if="loading" class="fas fa-spinner fa-pulse mainTextDark"></i>
                      <small v-if="errMSG">FAILED <i class="fas fa-poo"></i></small>
                      <small v-if="successMSG">REGISTERED <i class="fas fa-registered"></i></small>
                    </span>
                  </td>
                </tr>`
  });

  Vue.component('chart', {
    data: function(){
      return{
        shouldHighlight:false,
        myChart : null
      }
    },
    props: ['name','totals','unique','maincategory'],
    methods:{
      visualize(){
        var self = this;
        let progressColor = self['totals']['todo'] === 0 ?"#28A744":'#17A2B7'
        let mainColor = self.name === "Required" ? "#9fa7aa":"#b4b7b8"
        self.myChart = new Chart(document.getElementById(self.unique), {
            type: 'pie',
            data: {
              labels: ["Done","To-Do"],
              datasets: [{
                backgroundColor: [progressColor,mainColor],
                data: [self.totals['completed'],self.totals['todo']]
              }]
            },
            options: {
              animation: false,
              responsive: true,
              title: {
                display: false,
                text:self.name
              },
              legend:{
                display:false
              },
              elements: {
                arc: {
                    borderWidth: 0
                }
              }
            }
        });
      },
      highlight(){
        var self = this;

        var payload = {};
        payload["category"] = self.maincategory;
        payload["subcategory"] = self.name;
        store.commit('highlight',payload);
      },
    },
    watch:{
      totals:function(n){
        this.visualize()
      },
      shouldHighlight:function(h){
        if (h) {
          this.highlight()
        }else {
          store.commit('unhighlight');
        }
      }
    },
    mounted: function(){
      this.visualize()
      tippy( '.fa-highlighter', {
        maxWidth:'200px',
        placement:'top',
        content: '<div class="text-muted m-0" style="border-radius:none">Highlight All</div>',
        animation: 'fade',
        theme:'light'});
    },
    computed: {

    },
    template:
    `<div>
      <div class="text-center">
        <small :class="[name === 'Required' ? 'text-danger': 'text-muted']">
          <span v-text="name"></span>
          <!--<span class="badge badge-pill pointer unselectable" @click="shouldHighlight = !shouldHighlight" :class="[!shouldHighlight? 'badge-dark text-warning' :'badge-warning text-dark']">
            <i class="fas fa-highlighter pointer unselectable" ></i>
          </span>-->
        </small>
      </div>
      <canvas :id=unique width="90"></canvas>
    </div>`
  });

  Vue.component('catcontainer', {
    data: function(){
      return{
        shouldHighlight:false,
        canRemove: true,
      }
    },
    props: ['cat','subcats','totals'],
    methods:{
      filterProps(cat){
        var payload = {};
        payload["cat"] = cat
        store.commit('filterProps',payload);
      },
      removeCat(){
        var self = this;
        Swal.fire({
          title: 'Are you sure you want to remove '+self.cat+'?',
          showCancelButton: true,
          animation:false,
          customClass:'scale-in-center',
          showCancelButton: true,
          confirmButtonColor:"{{color_main}}",
          cancelButtonColor:"{{color_sec}}",
          confirmButtonText: 'Yes'
        }).then((result) => {
          if (result.value) {
            var payload = {};
            payload["origin"] = self.cat
            store.commit('removeCategory',payload);
            self.added = false;
          }
        })
      },
    },
    watch:{

    },
    mounted: function(){
      // Update chart on mount
      // Chart.update()
      var self = this;
      let sp= store.getters.getStartingPoint
      if (sp.name == self.cat) {
        self.canRemove = false
      }
    },
    computed: {
      currentlySelected:function(){
        let f = store.getters.getFilter
        if (this.cat === f) {
          return true
        }else {
          return false
        }
      }
    },
    template:
    `<div class="m-1 text-center p-2 desc rounded" :data-tippy-info="cat" style="max-height:109px;outline:none !important;">
      <small  class="bold text-info d-block">
        <i v-if=" cat ==='Google'" class="fab fa-google googleText mr-1"></i>
        <span v-text="cat+' Progress'"></span>
        <i v-if="canRemove" class="fas fa-minus-square text-danger pointer desc" data-tippy-info="Remove" @click="removeCat()"></i>
      </small>
      <div class="d-flex justify-content-around">
        <template v-for="(totals,subcat) in subcats">
          <chart class="d-inline-block" :name="subcat" :unique="cat+subcat" :maincategory="cat" :totals="totals" :key="cat+subcat"></chart>
        </template>
      </div>
    </div>`
  });

  Vue.component('addcategory', {
    data: function(){
      return{
        added:false,
        loading: false,
        reqfields: [],
        specificSchema:{}
      }
    },
    props: ['item'],
    methods:{
      getCatData:function(){
        var self = this;
        if (!self.added) {
          self.loading = true;
          Swal.fire({
            title: 'Add '+self.item.name+' fields?',
            showCancelButton: true,
            animation:false,
            customClass:'scale-in-center',
            showCancelButton: true,
            confirmButtonColor:"{{color_main}}",
            cancelButtonColor:"{{color_sec}}",
            confirmButtonText: 'Yes, add them!'
          }).then((result) => {
            if (result.value) {
              axios.get('/api/registry/'+self.item.namespace+'/'+self.item.prefix+':'+self.item.name).then(res=>{
                self.loading = false;
                // console.log('CAT DATA', res.data)
                //save schema
                self.specificSchema=res.data
                var payload = {};
                payload["origin"] = self.item.name
                payload["catprops"] = res.data.validation.properties;
                if (res.data.validation.required) {
                  payload["catpropsrequired"] = res.data.validation.required;
                  self.reqfields = res.data.validation.required;
                }else{
                  payload["catpropsrequired"] = [];
                }
                store.commit('mergeCategoryProps',payload);
                self.added = true;

              }).catch(err=>{
                Swal.fire({
                  type: 'error',
                  position: 'center',
                  title: 'Failed because: ',
                  text: err.response.data.reason
                });
                self.loading = false;
                throw err;
              })

            }
          })

        }
      },
      removeCat(){
        var self = this;
        Swal.fire({
          title: 'Are you sure you want to remove '+self.item.name+' fields?',
          showCancelButton: true,
          animation:false,
          customClass:'scale-in-center',
          showCancelButton: true,
          confirmButtonColor:"{{color_main}}",
          cancelButtonColor:"{{color_sec}}",
          confirmButtonText: 'Yes, remove them!'
        }).then((result) => {
          if (result.value) {
            var payload = {};
            payload["origin"] = self.item.name
            payload["catpropsrequired"] = self.reqfields
            store.commit('removeCategory',payload);
            self.added = false;
          }
        })
      },
      formPreviewSpecific(){
        var self = this;
        store.commit('formPreview')
        // console.log(store.getters.getPreview)
        let output = store.getters.getPreview

        let previewObj = {}
        Vue.set(previewObj,'@type',self.item.name)
        Vue.set(previewObj,'@context','http://discovery.biothings.io/view/schema/')

        // compare combined output and export only props found in this schema
        for (var key in output) {
          if (self.specificSchema.validation.properties.hasOwnProperty(key)) {
            // console.log('key match', key)
            Vue.set(previewObj,key,output[key])
          }
        }

        return previewObj

      },
      previewMetadata(){
        var self = this;
        let preview = self.formPreviewSpecific();
        // console.log('preview', preview)
        Swal.fire({
          position: 'center',
          confirmButtonColor:"{{color_main}}",
          cancelButtonColor:"{{color_sec}}",
          animation:false,
          footer:`<small><b>NOTE: </b>Some inputs may be missing as they do not match those specified by `+self.item.name+`</small>`,
          customClass:'scale-in-center',
          html: `<h6 class="text-center mainTextDark">`+self.item.name+` compliant structured metadata</h6><div class="text-left p-1 previewBox">
                  <small>
                    <pre>
                      `+JSON.stringify(preview,null,2)+`
                    </pre>
                  </small>
                </div>`
        });
      },
      exportSchema(){
        var self = this;
          let preview = self.formPreviewSpecific();

          Swal.fire({
            title: 'Name your file',
            input: 'text',
            inputAttributes: {
              autocapitalize: 'off'
            },
            showCancelButton: true,
            confirmButtonText: 'Download JSON-LD',
            allowOutsideClick: () => !Swal.isLoading()
          }).then((result) => {
            if (result.value) {
              self.download(JSON.stringify(preview,null,2), result.value+'.jsonld', 'text/plain')
            }
          })

      },
      download(content, fileName, contentType) {
        var a = document.createElement("a");
        var file = new Blob([content], {type: contentType});
        a.href = URL.createObjectURL(file);
        a.download = fileName;
        a.click();
      }
    },
    watch:{

    },
    mounted: function(){

      tippy( '#widget',{
          target:'.desc',
          content: 'Loading...',
          maxWidth:'200px',
          placement:'bottom',
          animation: 'fade',
          theme:'light',
          onShow(instance) {
            let info = instance.reference.dataset.tippyInfo;
            instance.setContent("<div class='text-muted m-0'>"+info+"</div>")
          }
        });
    },
    computed: {

    },
    template:
    `<div class="mr-2 w-25" :class="{'bg-secondary': !added, 'bg-light': added}">
      <div class="row m-0">
        <div class="col-sm-8 p-1 d-flex align-items-center justify-content-around desc" :data-tippy-info="item.description">
          <span :class="{'text-light': !added, 'text-info': added}">
            <i v-if="item.name ==='Google'" class="fab fa-google googleText mr-1"></i>
            <span v-text="item.name"></span>
          </span>
        </div>
        <div class="col-sm-4 p-1 bg-dark actions d-flex align-items-center justify-content-around">
          <span v-if="!added" class="p-1 desc" @click="getCatData" data-tippy-info="Add Fields">
            <i class="fas fa-plus-circle pointer text-muted"></i>
          </span>
          <span v-if="added" @click="removeCat" class="p-1 desc" data-tippy-info="Remove Fields">
            <i class="fas fa-minus-circle pointer text-danger"></i>
          </span>
          <span v-if="added" class="p-1 desc" @click="previewMetadata" :data-tippy-info="'Preview'">
            <i class="fas fa-code pointer text-success"></i>
          </span>
          <span v-if="added" class="p-1 desc" @click="exportSchema" :data-tippy-info="'Export '+item.name+' compliant structured metadata'">
            <i class="fas fa-file-export pointer text-warning"></i>
          </span>
        </div>
      </div>
    </div>`
  });

  Vue.component('object-input', {
    data: function(){
      return{
        userObj: {},
      }
    },
    props: ['name','info'],
    methods:{
      markCompleted(propname){
        var self = this;

        payload = {'name':self.name,'info': self.info, 'value':self.userObj}
        store.commit('addValue',payload);
        // save progress
        store.dispatch('saveProgress');
      },
      clearFieldFor:function(propname){
        var payload = {};
        payload["clear"] = propname;
        store.commit('clearValueOfProp',payload);
        store.dispatch('saveProgress');
      },
      handleObjectSubmit(event){
        let self = this;
        let fields = event.target.elements;
        console.log(fields)
        for (var i = 0; i < fields.length; i++) {
          if (fields[i].localName == 'input' && fields[i].value) {
            Vue.set(self.userObj, fields[i].dataset.field, fields[i].value)
          }
        }
        console.log('final Object', self.userObj)
        self.markCompleted();
        document.getElementById(self.name+"-form").reset();
      }
    },
    computed: {
      isRequired:function(){
        return store.getters.isRequired(this.name)
      },
      done: {
        get () {
          return this.$store.state.schema.validation.properties[this.name].value
        }
      },
      showDesc:function(){
        return store.getters.getShowDesc
      }
    },
    mounted: function(){

    },
    template:
    `<div>
      <form class="brackets-grey p-1" v-if="!done" :id="name+'-form'" @submit.prevent="handleObjectSubmit($event)">
        <template v-for="(fieldInfo, fieldName) in info.properties">
          <template v-if="fieldInfo && fieldInfo.format == 'uri' ">
            <div class="input-group mb-1 input-group-sm">
              <div class="input-group-prepend">
                <div class="input-group-text" v-text="fieldName"></div>
              </div>
              <input :data-field="fieldName" type="url" class="form-control" placeholder="Enter url here">
            </div>
          </template>
          <template v-else-if="fieldInfo && fieldInfo.format == 'date' ">
            <div class="input-group mb-1 input-group-sm">
              <div class="input-group-prepend">
                <div class="input-group-text" v-text="fieldName"></div>
              </div>
              <input :data-field="fieldName" type="date" class="form-control" placeholder="Enter text here">
            </div>
          </template>
          <template v-else-if="fieldInfo && fieldInfo.type == 'integer' ">
            <div class="input-group mb-1 input-group-sm">
              <div class="input-group-prepend">
                <div class="input-group-text" v-text="fieldName"></div>
              </div>
              <input :data-field="fieldName" type="" class="form-control" placeholder="Enter text here">
            </div>
          </template>
          <template v-else>
            <div class="input-group mb-1 input-group-sm">
              <div class="input-group-prepend">
                <div class="input-group-text" v-text="fieldName"></div>
              </div>
              <input :data-field="fieldName" type="text" class="form-control" placeholder="Enter text here">
            </div>
          </template>
        </template>
        <button class="btn themeButton text-light btn-sm" type="submit"><i class="fas fa-plus"></i> Add <span v-text="name"></span></button>
      </form>
    </div>`
  });

  Vue.component('boolean-input', {
    data: function(){
      return{
        userObj: {},
      }
    },
    props: ['name','info'],
    methods:{
      markCompletedBoolean(val){
        var self = this;
        payload = {'name':self.name,'info': self.info, 'value':val}
        store.commit('addValue',payload);
        // save progress
        store.dispatch('saveProgress');
      },
    },
    computed: {
      done: {
        get () {
          return this.$store.state.schema.validation.properties[this.name].value
        }
      },
    },
    watch:{
    },
    template:
    `<div class="d-flex justify-content-center align-items-center">
      <div :class="[done===true?'text-success border-success bold':'text-muted']" @click="markCompletedBoolean(true)" class="border rounded p-1 mx-2 pointer w-25 text-center">
        <i class="fas fa-check"></i> Yes
      </div>
      <div :class="[done===false?'text-danger border-danger bold':'text-muted']" @click="markCompletedBoolean(false)" class="border rounded p-1 mx-2 pointer w-25 text-center">
        <i class="fas fa-times"></i> No
      </div>
    </div>`
  });

  Vue.component('input-box', {
    data: function(){
      return{
        constFound:false,
        constObj:{},
        licenseThirdQuestion:false,
        vocabTerm:'',
        vocab:Array,
        userLicense:{
          'text':'',
          'url':'',
          'description':''
        },
        canAcceptMultiple:false,
        vocabDetails:Object,
        vocabSuggestions:[],
        loading:false
      }
    },
    props: ['name','info'],
    methods:{
      markCompleted(propname){
        var self = this;

        var payload = {};
        payload["completed"] = {'name':propname,'value':self.userInput};
        store.commit('markCompleted',payload);
        //unselect after complete
        var payload = {};
        payload["select"] = '';
        store.commit('markSelected',payload);
        // save progress
        store.dispatch('saveProgress');
      },
      clearFieldFor:function(propname){
        var payload = {};
        payload["clear"] = propname;
        store.commit('clearValueOfProp',payload);
        store.dispatch('saveProgress');
      },
      addKeyword(){
        let self = this;
        let value = self.$refs.keywordInput.value;

        if (value.includes(',')) {
          let arr = value.split(',');
          for (var i = 0; i < arr.length; i++) {
            let val = arr[i].trim();
            var payload = {};
            payload["item"] = val;
            payload["from"] = self.name;
            store.commit('addToArrayFrom',payload);
            self.$refs.keywordInput.value = '';
          }
        }else{
          var payload = {};
          payload["item"] = value;
          payload["from"] = self.name;
          store.commit('addToArrayFrom',payload);
          self.$refs.keywordInput.value = '';
        }

      },
      removeItem(name){
        let self = this;
        var payload = {};
        payload["item"] = name;
        payload["from"] = self.name;
        store.commit('removeArrayItemFrom',payload);
      },
      addPerson(type){
        let self = this;
        switch (type) {
          case "citation":
            self.addCitationModal(type)
            break;
          default:
            self.addPersonModal(type)
        }

      },
      addPersonModal(type){
        let self = this;
        Swal.mixin({
          input: 'text',
          confirmButtonText: 'Next &rarr;',
          showCancelButton: true,
          animation:false,
          customClass:'scale-in-center',
          confirmButtonColor:"{{color_main}}",
          cancelButtonColor:"{{color_sec}}",
          progressSteps: ['1', '2',]
        }).queue([
          {
            title: "Name*",
            text: "Enter the "+type+"'s full name",
            inputValidator: (value) => {
              if (!value) {
                return 'Name is a required field!'
              }
            }
          },
          {
            title: "URL",
            text: "Enter a URL for this "+type+"'s online profile (faculty page, GitHub page, Linkedin page, etc)",
            inputValidator: (value) => {
              return new Promise((resolve) => {
                function validURL(str) {
                  str = str.replace(/\(/g, '%28').replace(/\)/g, '%29');
                  var pattern = new RegExp('^(https?:\\/\\/)?'+ // protocol
                    '((([a-z\\d]([a-z\\d-]*[a-z\\d])*)\\.)+[a-z]{2,}|'+ // domain name
                    '((\\d{1,3}\\.){3}\\d{1,3}))'+ // OR ip (v4) address
                    '(\\:\\d+)?(\\/[-a-z\\d%_.~+]*)*'+ // port and path
                    '(\\?[;&a-z\\d%_.~+=-]*)?'+ // query string
                    '(\\#[-a-z\\d_]*)?$','i'); // fragment locator
                  // var pattern = /(ftp|http|https):\/\/(\w+:{0,1}\w*@)?(\S+)(:[0-9]+)?(\/|\/([\w#!:.?+=&%@!\-\/]))?/
                  return !!pattern.test(str);
                }
                if (validURL(value)) {
                  resolve()
                } else {
                  resolve('Input must be a valid URL')
                }
              })
            }
          }

        ]).then((result) => {
          if (result.value) {
            let name='';
            let url ='';
            if (result.value[0]) {
              name = result.value[0]
            }
            if (result.value[1]) {
              url = result.value[1]
            }else{
              url = ''
            }
            if (name) {

              let person = {'name':name,'url':url};

              switch (type) {
                case 'publisher':
                  Vue.set(person,'@type','Organization')
                  break;
                case 'creator':
                  Vue.set(person,'@type','Person')
                  break;
                case 'contributor':
                  Vue.set(person,'@type','Person')
                  break;
                case 'funding':
                  Vue.set(person,'@type','Organization')
                  break;
                default:
                  Vue.set(person,'@type','Thing')
              }

              let self = this;
              var payload = {};
              payload["item"] = person;
              payload["from"] = self.name;
              store.commit('addToArrayFrom',payload);
            }else{
              $.notify("A "+type+"'s name is required",{ globalPosition: 'right',className:'error', showDuration: 40, });
            }


          }
        })
      },
      addCitationModal(type){
        let self = this;
        Swal.mixin({
          input: 'text',
          confirmButtonText: 'Next &rarr;',
          showCancelButton: true,
          confirmButtonColor:"{{color_main}}",
          cancelButtonColor:"{{color_sec}}",
          progressSteps: ['1', '2',]
        }).queue([
          {
            title: "Name*",
            text: "Enter the "+type+"'s title or name",
            inputValidator: (value) => {
              if (!value) {
                return 'Name is a required field!'
              }
            }
          },
          {
            title: "URL",
            text: "Enter a URL for this "+type+" (web page, GitHub page, Linkedin page, etc)",
            inputValidator: (value) => {
              return new Promise((resolve) => {
                function validURL(str) {
                  str = str.replace(/\(/g, '%28').replace(/\)/g, '%29');
                  var pattern = new RegExp('^(https?:\\/\\/)?'+ // protocol
                    '((([a-z\\d]([a-z\\d-]*[a-z\\d])*)\\.)+[a-z]{2,}|'+ // domain name
                    '((\\d{1,3}\\.){3}\\d{1,3}))'+ // OR ip (v4) address
                    '(\\:\\d+)?(\\/[-a-z\\d%_.~+]*)*'+ // port and path
                    '(\\?[;&a-z\\d%_.~+=-]*)?'+ // query string
                    '(\\#[-a-z\\d_]*)?$','i'); // fragment locator
                  // var pattern = /(ftp|http|https):\/\/(\w+:{0,1}\w*@)?(\S+)(:[0-9]+)?(\/|\/([\w#!:.?+=&%@!\-\/]))?/
                  return !!pattern.test(str);
                }
                if (validURL(value)) {
                  resolve()
                } else {
                  resolve('Input must be a valid URL')
                }
              })
            }
          },
          {
            title: "Identifier",
            text: "Enter this "+type+"'s PubMed id here",
            inputValidator: (value) => {
              if (!value) {
                return 'You need to write something!'
              }
            }
          }

        ]).then((result) => {
          if (result.value) {
            let name='';
            let url ='';
            let ident = '';
            if (result.value[0]) {
              name = result.value[0]
            }
            if (result.value[1]) {
              url = result.value[1]
            }
            if (result.value[2]) {
              ident = result.value[2]
            }

            if (name) {
              let citation = {'name':name,'url':url,'identifier':ident};
              var payload = {};
              payload["item"] = citation;
              payload["from"] = self.name;
              store.commit('addToArrayFrom',payload);
            }else{
              $.notify("A "+type+"'s name is required",{ globalPosition: 'right',className:'error', showDuration: 40, });
            }


          }
        })
      },
      handleOneOf(parentProp,childProp,childPropInfo){
        var self = this;
        // console.log("parent ",parentProp)
        // console.log("child ",childProp)
        // console.log("handle this ",childPropInfo)

        setTimeout(function(){
          self.addItem(parentProp,childPropInfo)
        }, 500);


      },
      handleVocab(propName,propInfo){

        Swal.fire({
          title: propName,
          text: 'Search for an existing term here:',
          input: 'text',
          confirmButtonColor:"{{color_main}}",
          cancelButtonColor:"{{color_sec}}",
          animation:false,
          customClass:'scale-in-center',
          inputAttributes: {
            autocapitalize: 'off'
          },
          showCancelButton: true,
          confirmButtonText: 'Look up',
          showLoaderOnConfirm: true,
          focusConfirm: false,
          preConfirm: (query) => {

            let ontologies = propInfo['vocabulary']['ontology'].toString()
            let children = propInfo['vocabulary']['children_of'].toString()

            let url = `https://www.ebi.ac.uk/ols/api/search?q=${query}`
            +"&ontology="+ontologies
            +"&childrenOf="+children
            +"&type=class&fieldList=id,iri,label,description,obo_id,short_form,ontology_prefix"
            +"&queryFields=label"
            +"&rows=100"

            return fetch(url)
              .then(response => {
                if (!response.ok) {
                  throw new Error(response.statusText)
                }
                return response.json()
              })
              .catch(error => {
                Swal.showValidationMessage(
                  `Request failed: ${error}`
                )
              })
          },
          allowOutsideClick: () => !Swal.isLoading()
        }).then((result) => {
          if (result.value) {
            let html ="<div id='ontology' class='p-1 text-left'>";

            for (var i = 0; i < result.value.response.docs.length; i++) {
              tippy('#cb'+i,{
                content:result.value.response.docs[i]
              });

              let label = result.value.response.docs[i]['label']
              if (label && label.length > 37) {
                label = label.substring(0,37)+"..."
              }

              html += `<div class="form-check">
                          <input class="form-check-input mr-2" type="checkbox" value="`+result.value.response.docs[i]['iri']+`" id="cb`+i+`">
                          <label class="form-check-label" for="cb`+i+`" title="`+result.value.response.docs[i]['label']+`">
                              `+label+`
                              <i class="fa fa-info-circle text-info modaltip" data-tippy-info='`+JSON.stringify(result.value.response.docs[i])+`'></i>
                          </label>
                      </div>`
            }
            if (propInfo && !propInfo.strict) {
              html += `<div class="alert alert-info mt-1">
                          <h6>Didn't find what you are looking for? Enter value here:</h6>
                          <input class="form-control" type="text" id="qTerm">
                      </div>`
            }
            html += "</div>";

            Swal.fire({
              title: propName+'(s):',
              html: html,
              confirmButtonColor:"{{color_main}}",
              cancelButtonColor:"{{color_sec}}",
              animation:false,
              customClass:'scale-in-center',
              preConfirm: () => {

                let checked=[]

                  for (var i = 0; i < 100; i++) {
                    let x = document.getElementById("cb"+i)
                    if (x && x.checked) {
                      checked.push(x.value)
                    }
                  }
                  let y = document.getElementById("qTerm")
                  if (y.value) {
                    checked.push(y.value)
                  }
                  return checked
              }
            }).then((result) => {
              if (result.value) {
                // console.log('FINAL RES', result.value)
                for (var i = 0; i < result.value.length; i++) {
                  var payload = {};
                  payload["item"] = result.value[i];
                  payload["from"] = propName;
                  store.commit('addToArrayFrom',payload);

                  store.dispatch('saveProgress');
                }

              }
            })

          }
        });

      },
      getQuestion(parentName,obj){
        // console.log('getting questions for',parentName)
        // console.log('using',obj)
        return swal.withForm({
         title: 'More complex Swal-Forms example',
         text: 'This has different types of inputs',
         showCancelButton: true,
         confirmButtonColor: '#DD6B55',
         confirmButtonText: 'Get form data!',
         closeOnConfirm: true,
         formFields: [
           { id: 'name', placeholder: 'Name Field' },
           { id: 'nickname', placeholder: 'Add a cool nickname' },
           { id: 'password', type: 'password' },

           { name: 'sex', value: 'Male', type: 'radio' },
           { name: 'sex', value: 'Female', type: 'radio' },

           { name: 'skills', value: 'JS', type: 'checkbox' },
           { name: 'skills', value: 'Ruby', type: 'checkbox' },
           { name: 'skills', value: 'Java', type: 'checkbox' },

           { id: 'select',
             type: 'select',
             options: [
               {value: 'test1', text: 'test1'},
               {value: 'test2', text: 'test2'},
               {value: 'test3', text: 'test3'},
               {value: 'test4', text: 'test4'},
               {value: 'test5', text: 'test5'}
             ]}
         ]
       }, function (isConfirm) {
         // do whatever you want with the form data
         // console.log(this.swalForm) // { name: 'user name', nickname: 'what the user sends' }
       })
      },
      oneOfEnum(propName,propInfo){
        var self=this;

        // console.log('oneOfEnum happening')
        // console.log(propName,propInfo)

        for (var oF_i = 0; oF_i < propInfo['oneOf'].length; oF_i++){
          if (propInfo['oneOf'][oF_i].hasOwnProperty('enum')) {

            let e = propInfo['oneOf'][oF_i]['enum']
            let optionsenum={}

            for (var eIndex = 0; eIndex < e.length; eIndex++) {
              optionsenum[e[eIndex]]=e[eIndex]
            }
            // console.log(e,optionsenum)


            Swal({
              title: propName,
              input: 'select',
              inputOptions: optionsenum,
              inputPlaceholder: 'Select one',
              showCancelButton: true,
              inputValidator: (value) => {
                if (value) {
                  var payload = {};
                  payload["item"] = value;
                  payload["from"] = propName;
                  store.commit('addToArrayFrom',payload);

                  store.dispatch('saveProgress');
                }
              }
            });
          }
          if (propInfo['oneOf'][oF_i].hasOwnProperty('type') && propInfo['oneOf'][oF_i]['type'] == 'array' ) {
            self.canAcceptMultiple = true
          }
        }
      },
      addItem(propName,propInfo){
        var self=this;
        let progressSteps =[]
        let questions =[]

        let props = {}

        console.log("addItem",propInfo)

        if (propInfo.hasOwnProperty('vocabulary')) {
          self.handleVocab(propName,propInfo)
        }

        if (propInfo.hasOwnProperty('oneOf')) {
          // console.log("ONE OF")

          path= ""

          for (var oF_i = 0; oF_i < propInfo['oneOf'].length; oF_i++){
            if (propInfo['oneOf'][oF_i].hasOwnProperty('enum')) {
              path = 'enum';
            }
            if (propInfo['oneOf'][oF_i].hasOwnProperty('type') && propInfo['oneOf'][oF_i]['type'] == 'string') {
              path = 'string';
            }
            if (propInfo['oneOf'][oF_i].hasOwnProperty('@type')) {
              path ='types'
            }
            if (propInfo['oneOf'][oF_i].hasOwnProperty('type') && propInfo['oneOf'][oF_i]['type'] == 'array' ) {
              self.canAcceptMultiple = true
            }
          }

          switch (path) {
            case "string":
            // console.log("path:",path)
            Swal({
                    title: propName,
                    input: 'text',
                    inputPlaceholder: 'Enter text here',
                    footer:propName == 'keywords'? "Multiple keywords can be entered separated by commas." : " ",
                    inputValidator: (value) => {
                      if (value) {
                        if (propName == 'keywords') {
                          slist = value.split(",");
                          for (var sIndex = 0; sIndex < slist.length; sIndex++) {
                            var payload = {};
                            payload["item"] = slist[sIndex];
                            payload["from"] = propName;
                            store.commit('addToArrayFrom',payload);

                            store.dispatch('saveProgress');
                          }
                        }else{
                          var payload = {};
                          payload["item"] = value;
                          payload["from"] = propName;
                          store.commit('addToArrayFrom',payload);

                          store.dispatch('saveProgress');
                        }

                      }
                    }

                  });
              break;
            case 'enum':
              // console.log("path:",path)
              self.oneOfEnum(propName,propInfo);
              break;
            case 'types':
              // console.log("path:",path)
              options ={}
              for (var oF_i = 0; oF_i < propInfo['oneOf'].length; oF_i++) {
                if (propInfo['oneOf'][oF_i].hasOwnProperty('@type')) {
                  // value : user text
                  options[oF_i] = propInfo['oneOf'][oF_i]["@type"]
                }
                if (propInfo['oneOf'][oF_i].hasOwnProperty('type') && propInfo['oneOf'][oF_i]['type'] == 'array' ) {
                  self.canAcceptMultiple = true
                }
              }

              if (Object.keys(options).length == 1) {
                // if only one option auto start
                self.handleOneOf(propName,propInfo['oneOf'][0]['@type'],propInfo['oneOf'][0])
              }else {
                // if options, user chooses type
                Swal({
                  title: "Select type of "+propName,
                  input: 'select',
                  inputOptions: options,
                  inputPlaceholder: 'Select one',
                  animation:false,
                  confirmButtonColor:"{{color_main}}",
                  cancelButtonColor:"{{color_sec}}",
                  customClass:'scale-in-center',
                  showCancelButton: true,
                  inputValidator: (value) => {
                    if (value) {
                      // console.log('value',value)
                      self.handleOneOf(propName,propInfo['oneOf'][value]['@type'],propInfo['oneOf'][value])
                    }
                  }
                });
              }
              break;
            default:
            console.warn('PATH NOT HANDLED',path)

          }




        }

        if (propInfo.hasOwnProperty('anyOf')) {
          // console.log("ANY OF")
          options ={}
          for (var oF_i = 0; oF_i < propInfo['anyOf'].length; oF_i++) {
            if (propInfo['anyOf'][oF_i].hasOwnProperty('@type')) {
              // value : user text
              options[oF_i] = propInfo['anyOf'][oF_i]["@type"]
            }
            if (propInfo['anyOf'][oF_i].hasOwnProperty('type') && propInfo['anyOf'][oF_i]['type'] == 'array' ) {
              self.canAcceptMultiple = true
            }
          }

          if (Object.keys(options).length == 1) {
            // if only one option auto start
            self.handleOneOf(propName,propInfo['anyOf'][0]['@type'],propInfo['anyOf'][0])
          }else {
            // if options, user chooses type
            Swal({
              title: "Select type of "+propName,
              input: 'select',
              inputOptions: options,
              inputPlaceholder: 'Select one',
              animation:false,
              confirmButtonColor:"{{color_main}}",
              cancelButtonColor:"{{color_sec}}",
              customClass:'scale-in-center',
              showCancelButton: true,
              inputValidator: (value) => {
                if (value) {
                  // console.log('value',value)
                  self.handleOneOf(propName,propInfo['anyOf'][value]['@type'],propInfo['anyOf'][value])
                }
              }
            });
          }

        }
        else if (propInfo.hasOwnProperty('properties')){
          props = propInfo.properties

          // Create questions
          for (key in props) {
            progressSteps.push(key)
            switch (props[key]['type']) {
              case 'string':
                // console.log(key,props[key]['type'])
                if (props[key].hasOwnProperty('format')) {
                  switch (props[key]['format']) {
                    case 'uri':
                      questions.push({
                        title: key,
                        text: props[key].description,
                        inputValidator: (value) => {
                          return new Promise((resolve) => {

                            function validURL(str) {
                              str = str.replace(/\(/g, '%28').replace(/\)/g, '%29');
                              var pattern = new RegExp('^(https?:\\/\\/)?'+ // protocol
                                '((([a-z\\d]([a-z\\d-]*[a-z\\d])*)\\.)+[a-z]{2,}|'+ // domain name
                                '((\\d{1,3}\\.){3}\\d{1,3}))'+ // OR ip (v4) address
                                '(\\:\\d+)?(\\/[-a-z\\d%_.~+]*)*'+ // port and path
                                '(\\?[;&a-z\\d%_.~+=-]*)?'+ // query string
                                '(\\#[-a-z\\d_]*)?$','i'); // fragment locator
                              // var pattern = /(ftp|http|https):\/\/(\w+:{0,1}\w*@)?(\S+)(:[0-9]+)?(\/|\/([\w#!:.?+=&%@!\-\/]))?/
                              return !!pattern.test(str);
                            }

                            if (propInfo && propInfo.hasOwnProperty('required')) {

                              let currentField = document.getElementById("swal2-title").textContent;
                              if (propInfo['required'].includes(currentField)) {
                                // is required needs to be validated
                                if (value) {
                                  if (validURL(value)) {
                                    resolve()
                                  } else {
                                    resolve('Input must be a valid URL')
                                  }
                                }else{
                                  resolve(currentField+' is required')
                                }
                              }else {
                                // not required user can skip
                                resolve()
                              }
                            }
                            if (propInfo && propInfo.hasOwnProperty('oneOf')) {
                              for (var i = 0; i < propInfo['oneOf'].length; i++) {
                                if (propInfo['oneOf'][i] && propInfo['oneOf'][i].hasOwnProperty('required')) {

                                  let currentField = document.getElementById("swal2-title").textContent;
                                  if (propInfo['oneOf'][i]['required'].includes(currentField)) {
                                    // is required needs to be validated
                                    if (value) {
                                      if (validURL(value)) {
                                        resolve()
                                      } else {
                                        resolve('Input must be a valid URL')
                                      }
                                    }else{
                                      resolve(currentField+' is required')
                                    }
                                  }else {
                                    // not required user can skip
                                    resolve()
                                  }
                                }
                              }
                            }

                            // if not required or anthything else just resolve()
                            resolve()


                          })
                        }
                      })
                      break;
                    case 'date':
                      questions.push({
                        title: key,
                        inputAttributes: {
                          id:'hideThis'
                        },
                        html: '<input type="date" id="datePicked"/>',
                        onOpen: ()=>{
                          document.getElementById("hideThis").classList.add('d-none');
                        },
                        preConfirm: () => {
                          // console.log('%c date format check','color:pink')
                          return moment(document.getElementById('datePicked').value).format("YYYY-MM-DD");
                        },
                      })
                      break;
                    default:
                      // console.log('TYPE STRING BUT FORMAT NOT HANDLED')
                  }
                }else {
                  // Simple String
                  questions.push({
                    title: key,
                    text: props[key].description,
                    inputValidator: (value) => {
                      return new Promise((resolve) => {

                        if (propInfo && propInfo.hasOwnProperty('required')) {

                          let currentField = document.getElementById("swal2-title").textContent;
                          if (propInfo['required'].includes(currentField)) {
                            // is required needs to be validated
                            if (value) {
                              resolve()
                            } else {
                              resolve(currentField+' is required')
                            }
                          }else {
                            // not required user can skip
                            resolve()
                          }
                        }
                        if (propInfo && propInfo.hasOwnProperty('oneOf')) {
                          for (var i = 0; i < propInfo['oneOf'].length; i++) {
                            if (propInfo['oneOf'][i] && propInfo['oneOf'][i].hasOwnProperty('required')) {

                              let currentField = document.getElementById("swal2-title").textContent;
                              if (propInfo['oneOf'][i]['required'].includes(currentField)) {
                                // is required needs to be validated
                                if (value) {
                                  resolve()
                                } else {
                                  resolve(currentField+' is required')
                                }
                              }else {
                                // not required user can skip
                                resolve()
                              }
                            }
                          }
                        }
                        // if not required just resolve value
                        resolve()

                      })
                    }
                  });
                  break;
                }
                break;
              case 'integer':
                // console.log('integer',key)
                questions.push({
                  title: key,
                  input: 'number',
                  text: props[key].description,
                  inputValidator: (value) => {
                    return new Promise((resolve) => {
                      if (!value) {
                        return 'You should write something meanignful'
                      }else{
                        return new Promise((resolve) => {
                          function validInteger(str) {
                            var pattern = new RegExp('^[0-9]*$');
                            return !!pattern.test(str);
                          }
                          if (validInteger(value)) {
                            resolve()
                          } else {
                            resolve('Input must be an integer')
                          }
                        })
                      }
                    })
                  }
                });
                break;
              case 'array':
                // console.log(key,props[key]['type'])
                // console.log("ARRAY",key,props[key])
                html =''
                if (props[key].hasOwnProperty('oneOf')) {
                  // console.log("Array Has One Of")

                  for (var ix = 0; ix < props[key]['oneOf'].length; ix++) {
                    if (props[key]['oneOf'][ix]['type'] == 'object') {
                      let obj = props[key]['oneOf'][ix]['properties'];
                      for (var obj_key in obj) {
                        switch (obj[obj_key]['type']) {
                          case 'string':
                            html += '<div class="form-group"><input type="text" class="form-control"  name="'+obj_key+'" placeholder="'+obj_key+'"/></div>'
                            break;
                          case 'url':
                            html += '<div class="form-group"><input type="url" class="form-control" name="'+obj_key+'" placeholder="'+obj_key+'"/></div>'
                            break;
                          case 'date':
                            html += '<div class="form-group"><input class="form-control" name="'+obj_key+'" type="date"/></div>'
                            break;
                          default:
                            html += '<div class="form-group"><input class="form-control" type="text" name="'+obj_key+'" placeholder="'+obj_key+'"/></div>'
                            break;
                        }
                      }
                    }
                  }

                  html = `<div class="alert-info p-1">
                            <form id="arrayForm">`+html+`</form>
                          </div>`
                  questions.push({
                    title: key,
                    inputAttributes: {
                      id:'hideThis'
                    },
                    html: html,
                    onOpen: ()=>{
                      document.getElementById("hideThis").classList.add('d-none');
                    },
                    preConfirm: () => {
                      let formArray = $('#arrayForm').serializeArray();
                      // console.log('arrayForm Data', arrayForm)
                      var returnArray = {};
                      for (var i = 0; i < formArray.length; i++){
                        if (formArray[i]['name'].includes('date')) {
                          // console.log('%c date format check','color:pink')
                          returnArray[formArray[i]['name']] = moment(formArray[i]['value']).format("YYYY-MM-DD");
                        }else {
                          returnArray[formArray[i]['name']] = formArray[i]['value'];
                        }
                      }
                      // console.log('arrayForm Data', returnArray)
                      return returnArray;
                    },
                  })

                }
                break;
              case 'object':
                // console.log(key,props[key]['type'])
                html =''
                let obj = props[key]['properties'];

                for (var obj_key in obj) {
                  switch (obj[obj_key]['type']) {
                    case 'string':
                      html += '<div class="form-group"><input type="text" class="form-control"  name="'+obj_key+'" placeholder="'+obj_key+'"/></div>'
                      break;
                    case 'url':
                      html += '<div class="form-group"><input type="url" class="form-control" name="'+obj_key+'" placeholder="'+obj_key+'"/></div>'
                      break;
                    case 'date':
                      html += '<div class="form-group"><input class="form-control" name="'+obj_key+'" type="date"/></div>'
                      break;
                    default:
                      html += '<div class="form-group"><input class="form-control" type="text" name="'+obj_key+'" placeholder="'+obj_key+'"/></div>'
                      break;
                  }
                }

                html = `<div class="alert-info p-1">
                          <form id="arrayForm">`+html+`</form>
                        </div>`
                questions.push({
                  title: key,
                  inputAttributes: {
                    id:'hideThis'
                  },
                  html: html,
                  onOpen: ()=>{
                    document.getElementById("hideThis").classList.add('d-none');
                  },
                  preConfirm: () => {
                    let formArray = $('#arrayForm').serializeArray();
                    // console.log('arrayForm Data', arrayForm)
                    var returnArray = {};
                    for (var i = 0; i < formArray.length; i++){
                      if (formArray[i]['name'].includes('date')) {
                        // console.log('%c date format check','color:pink')
                        returnArray[formArray[i]['name']] = moment(formArray[i]['value']).format("YYYY-MM-DD");
                      }else {
                        returnArray[formArray[i]['name']] = formArray[i]['value'];
                      }
                    }
                    // console.log('arrayForm Data', returnArray)
                    return returnArray;
                  },
                })

                break;
              default:
                // console.log('DEFAULT PROP HANDLER...')

                // ONE OF
                html =''
                if (props[key].hasOwnProperty('oneOf')) {
                  // console.log("Array Has One Of")

                  for (var ix = 0; ix < props[key]['oneOf'].length; ix++) {
                    if (props[key]['oneOf'][ix]['type'] == 'object') {
                      let obj = props[key]['oneOf'][ix]['properties'];
                      for (var obj_key in obj) {
                        switch (obj[obj_key]['type']) {
                          case 'string':
                            html += '<div class="form-group"><input type="text" class="form-control"  name="'+obj_key+'" placeholder="'+obj_key+'"/></div>'
                            break;
                          case 'url':
                            html += '<div class="form-group"><input type="url" class="form-control" name="'+obj_key+'" placeholder="'+obj_key+'"/></div>'
                            break;
                          case 'date':
                            html += '<div class="form-group"><input class="form-control" name="'+obj_key+'" type="date"/></div>'
                            break;
                          default:
                            html += '<div class="form-group"><input class="form-control" type="text" name="'+obj_key+'" placeholder="'+obj_key+'"/></div>'
                            break;
                        }
                      }
                    }
                  }

                  html = `<div class="alert-info p-1">
                            <form id="arrayForm">`+html+`</form>
                          </div>`
                  questions.push({
                    title: key,
                    inputAttributes: {
                      id:'hideThis'
                    },
                    html: html,
                    onOpen: ()=>{
                      document.getElementById("hideThis").classList.add('d-none');
                    },
                    preConfirm: () => {
                      let formArray = $('#arrayForm').serializeArray();
                      // console.log('arrayForm Data', arrayForm)
                      var returnArray = {};
                      for (var i = 0; i < formArray.length; i++){
                        if (formArray[i]['name'].includes('date')) {
                          // console.log('%c date format check','color:pink')
                          returnArray[formArray[i]['name']] = moment(formArray[i]['value']).format("YYYY-MM-DD");
                        }else {
                          returnArray[formArray[i]['name']] = formArray[i]['value'];
                        }
                      }
                      // console.log('arrayForm Data', returnArray)
                      return returnArray;
                    },
                  })

                }
            }

          }

          let arr = [] //modal header steps
          for (var i = 0; i < progressSteps.length; i++) {
            arr.push(i+1)
          }

          Swal.mixin({
            input: 'text',
            confirmButtonText: 'Next &rarr;',
            showCancelButton: true,
            confirmButtonColor:"{{color_main}}",
            cancelButtonColor:"{{color_sec}}",
            animation:false,
            customClass:'scale-in-center',
            progressSteps: arr
          }).queue(questions).then((result) => {
            if (result.value) {
              let obj = {}
              try {
                Vue.set(obj,'@type',propInfo["@type"])
              } catch (e) {
                switch (propName) {
                  case 'creator':
                    Vue.set(obj,'@type','Person')
                    break;
                    case 'contributor':
                      Vue.set(obj,'@type','Person')
                      break;
                      case 'publisher':
                        Vue.set(obj,'@type','Organization')
                        break;
                        case 'funding':
                          Vue.set(obj,'@type','Organization')
                          break;
                  default:
                }
              }

              for (var i = 0; i < progressSteps.length; i++) {
                // check if value is empty if so skip
                if (result && result.value[i]) {
                  if (result.value[i] == "keywords") {
                    try {
                      let val = result.value[i].split(',');
                      Vue.set(obj,progressSteps[i],val)
                    } catch (e) {
                      let val = result.value[i]
                      Vue.set(obj,progressSteps[i],val)
                    }

                  }else{
                    if (props[progressSteps[i]].hasOwnProperty('type') && props[progressSteps[i]]['type']==='integer') {
                      let val = parseInt(result.value[i]);
                      Vue.set(obj,progressSteps[i],val)
                    }else{
                      let val = result.value[i];
                      Vue.set(obj,progressSteps[i],val)
                    }
                  }
                }
              }

              if ((propInfo && propInfo.hasOwnProperty('oneOf')) && (propInfo['oneOf'][0].hasOwnProperty('vocabulary'))){
                //if its a vocab enum field do nothing. separate modal will launch
              }else {
                if(Object.keys(obj).length !== 0 && obj.constructor === Object){
                  var payload = {};
                  payload["item"] = obj;
                  payload["from"] = propName;
                  store.commit('addToArrayFrom',payload);

                  store.dispatch('saveProgress');
                }
              }

            }
          });

        }
      },
      checkForConstantKey(obj, keyname, parentkey) {
        var self=this;
        _.mapKeys(obj, function(value, key) {
          if (key === keyname) {
            self.constFound = true;
            Vue.set(self.constObj, parentkey, value)
          }
          if (typeof value === 'object') {
            self.checkForConstantKey(value,keyname,key)
          }
        });

      },
      getLicense(specialCase){
        let self = this;
        let question1 = this.$refs.license1.value;
        let question2 = this.$refs.license2.value;

        if (specialCase) {
          switch (specialCase) {
            case 'No':
              self.userLicense.description = 'No Rights Reserved';
              self.userLicense.url = 'https://creativecommons.org/share-your-work/public-domain/cc0/';
              self.userLicense.text = 'CC0';
              break;
            case "Yes":
              self.userLicense.description = 'Attribution 4.0 International';
              self.userLicense.url = 'http://creativecommons.org/licenses/by/4.0/';
              self.userLicense.text = 'CC BY 4.0';
              break;
            default:
              self.userLicense.description = "We had trouble with your input, please try this link:";
              self.userLicense.text = '';
              self.userLicense.url = 'https://creativecommons.org/choose/';
              self.thirdQuestion = false;
              break;
          }
        }else{
          switch (question1+'|'+question2) {
            case "Yes|Yes":
              // Special Case
              self.licenseThirdQuestion = true;
              let question3 = this.$refs['license3'].value;
              self.getLicense(question3);
              break;
            case "No|Yes":
              self.userLicense.description = 'Attribution-NoDerivatives 4.0 International';
              self.userLicense.url = 'http://creativecommons.org/licenses/by-nd/4.0/';
              self.userLicense.text = 'CC BY-ND 4.0';
              self.licenseThirdQuestion = false;
              break;
            case "Yes, as long as others share alike|Yes":
              self.userLicense.description = 'Attribution-ShareAlike 4.0 International';
              self.userLicense.url = 'http://creativecommons.org/licenses/by-sa/4.0/';
              self.userLicense.text = 'CC BY-SA 4.0';
              self.licenseThirdQuestion = false;
              break;
            case "Yes|No":
              self.userLicense.description = 'Attribution-NonCommercial 4.0 International';
              self.userLicense.url = 'http://creativecommons.org/licenses/by-nc/4.0/';
              self.userLicense.text = 'CC BY-NC 4.0';
              self.licenseThirdQuestion = false;
              break;
            case "No|No":
              self.userLicense.description = 'Attribution-NonCommercial-NoDerivatives 4.0 International';
              self.userLicense.text = 'CC BY-NC-ND 4.0';
              self.userLicense.url = 'http://creativecommons.org/licenses/by-nc-nd/4.0/';
              self.licenseThirdQuestion = false;
              break;
            case "Yes, as long as others share alike|No":
              self.userLicense.description = 'Attribution-NonCommercial-ShareAlike 4.0 International';
              self.userLicense.text = 'CC BY-NC-SA 4.0';
              self.userLicense.url = 'http://creativecommons.org/licenses/by-nc-nd/4.0/';
              self.licenseThirdQuestion = false;
              break;
            default:
              self.userLicense.description = "We had trouble with your input, please try this link:";
              self.userLicense.text = '';
              self.userLicense.url = 'https://creativecommons.org/choose/';
              self.licenseThirdQuestion = false;
              break;
          }
        }
      },
      getVocabulary(){
        var self=this;
        let obj = self.info

        if (obj.hasOwnProperty('vocabulary')) {
          try {
            let query = self.vocabTerm
            let ontologies = obj['vocabulary']['ontology'].toString()
            let children = obj['vocabulary']['children_of'].toString()

            // AUTOSUGGEST

            // self.loading = true;
            //
            // axios.get("http://www.ebi.ac.uk/ols/api/suggest?q="+query+"&ontology="+ontologies+"&rows=5").then(res=>{
            //   self.vocabSuggestions = res.data.response.docs;
            //   self.loading = false;
            // }).catch(err=>{
            //   throw err;
            // });

            let url = "https://www.ebi.ac.uk/ols/api/search?q="+query
            +"&ontology="+ontologies
            +"&childrenOf="+children
            +"&type=class&fieldList=id,iri,label,description,obo_id,short_form,ontology_prefix"
            +"&queryFields=label"
            +"&rows=100"

            self.loading = true;

            axios.get(url).then(res=>{
              // console.log('result VOCAB',res.data.response)
              if (res.data.response.hasOwnProperty('docs')&& res.data.response.docs.length >= 1) {
                self.vocab= res.data.response.docs
                self.loading = false;
                // console.log('res',self.vocab.length)
              }else{
                self.vocab= []
              }

            }).catch(err=>{
              self.vocab= []
              throw err;
            });
          } catch (e) {

          }
        }
      }
    },
    watch:{
      constObj:{
        handler(obj){
          var payload = {};
          payload["completed"] = {'name':this.name,'value':obj};
          store.commit('markCompleted',payload);
        },
        deep:true
      },
      vocabTerm(term){
        this.getVocabulary()
      }
    },
    mounted: function(){
      var self = this

      self.checkForConstantKey(self.info,'const')

      try {
        var x = document.getElementsByClassName("form-control");
        x[0].focus();
      } catch (e) {
        var x = document.getElementsByClassName("btnfocus");
        x[0].focus();
      }

      // self.tip = tippy('#'+self.name, {
      //   placement:'right',
      //   appendTo: document.querySelector('#'+self.name),
      //   content: `<i class="fas fa-exclamation-circle text-danger"></i> There's an issue`,
      //   interactive: true,
      //   arrow: true,});
      //
      // self.tip.instances[0].show()

      tippy( '.save', {
        placement:'top',
        maxWidth:'200px',
        content: '<div class="text-success m-0" style="border-radius:none">Done</div>',
        animation: 'fade',
        theme:'light'});

      tippy( '.required', {
        maxWidth:'200px',
        placement:'top',
        content: '<div class="text-danger m-0" style="border-radius:none">This field is required</div>',
        animation: 'fade',
        theme:'light'});

      tippy( '.delete', {
        maxWidth:'200px',
        placement:'top',
        content: '<div class="text-danger m-0" style="border-radius:none">Clear</div>',
        animation: 'fade',
        theme:'light'});

      tippy( '#masterForm', {
          target:'.inputpreview',
          content: 'Loading...',
          maxWidth:'200px',
          placement:'left',
          animation: 'fade',
          theme:'light',
          onShow(instance) {
            let info = instance.reference.dataset.tippyInfo;
            instance.setContent("<div class='text-muted m-0 text-left wraptext'><pre>"+info+"</pre></div>")
          }
        });

        tippy( '#widget', {
            target:'.info',
            content: 'Loading...',
            maxWidth:'200px',
            placement:'left',
            animation: 'fade',
            theme:'light',
            onShow(instance) {
              let info = instance.reference.dataset.tippyInfo;
              instance.setContent("<div class='text-muted m-0'>"+info+"</div>")
            }
          });

    },
    computed: {
      isRequired:function(){
        return store.getters.isRequired(this.name)
      },
      userInput: {
        get () {
          return this.$store.state.schema.validation.properties[this.name].value
        },
        set (newValue) {
          var payload = {};
          if (name.includes('date')) {
            // console.log('%c date format check','color:pink')
            let v = moment(newValue).format("YYYY-MM-DD")
            payload["completed"] = {'name':this.name,'value': v };
          }else {
            payload["completed"] = {'name':this.name,'value':newValue};
          }
          store.commit('markCompleted',payload);

          store.dispatch('saveProgress');
        }
      },
      datePreset:function(){
        if (this.$store.state.schema.validation.properties.hasOwnProperty('datePublished') && this.$store.state.schema.validation.properties['datePublished'].value) {
          return this.$store.state.schema.validation.properties['datePublished'].value
        }else if (this.$store.state.schema.validation.properties.hasOwnProperty('dateModified') && this.$store.state.schema.validation.properties['dateModified'].value) {
          return this.$store.state.schema.validation.properties['dateModified'].value
        }else{
          return false;
        }
      },
      showDesc:function(){
        return store.getters.getShowDesc
      }
    },
    template:
    `<div class="m-0 inputbox fade-in" :id='name'>
      <div class="row">
        <div class="col-sm-10 p-1 text-left d-flex align-items-center justify-content-center" :class="[userInput || userInput === false ? 'completefield':'alert-light']">
          <div class="d-flex w-100 justify-content-center">
            <div class="row m-0 w-100">
              <div class="col-sm-2 d-flex align-items-center justify-content-center" style="word-break: break-all;">
                <small class="bold" :class="[userInput || userInput === false ? 'text-success':'text-muted']">
                  <i class="fas fa-asterisk fa-xs text-danger required pointer unselectable" v-if="isRequired"></i>&nbsp;<span v-text="name"></span>
                </small>
              </div>
              <div class="col-sm-10">
                <div v-if="showDesc"  class="col-sm-12">
                  <small  class="text-muted">
                    <span v-text='info.description || "No description provided"'></span>
                  </small>
                </div>
                <h6 v-show="loading" class="text-primary">Loading <i class="fas fa-spinner fa-pulse"></i></h6>
                <!--🌈🌈🌈 INPUT 🌈 🌈🌈 TYPES 🌈🌈🌈-->
                <!-- 🌈 BOOLEAN 🌈 -->
                <template v-if="info && info.type === 'boolean'">
                  <boolean-input :name="name" :info="info"></boolean-input>
                </template>
                <template v-if="info && info.type === 'string'">
                  <!-- 🌈 STRING 🌈 -->
                  <template v-if="info && !info.format">
                    <!-- 🌈 STRING VOCABULARY🌈 -->
                    <template v-if="info && info.vocabulary">
                      <small>Input <b v-text="info.vocabulary && !info.vocabulary.strict ? 'CAN' : 'MUST' "></b> be from existing ontology terms.</small>
                      <div class="input-group">
                        <div class="input-group-prepend">
                          <div class="input-group-text bg-secondary text-light"><i class="fas fa-search"></i></div>
                        </div>
                        <input :required="isRequired" type="text" v-model="vocabTerm" class="form-control form-control-sm " :placeholder="userInput? userInput:'Type to begin search' " id="stringInput" list="suggestionlist">
                      </div>
                      <datalist id="suggestionlist">
                        <template v-for="item in vocabSuggestions">
                          <option :value="item.autosuggest" @click="vocabTerm=item.autosuggest;vocabSuggestions=[]">
                        </template>
                      </datalist>
                      <div v-show="vocabTerm" class="alert alert-light optionBox">
                        <small><b class="text-primary" v-text="'('+vocab.length+')'"></b> Existing results related to: <i v-text='vocabTerm'></i></small>
                        <template v-if="vocab.length" v-for="(item,i) in vocab">
                          <div class="form-check">
                            <input class="form-check-input " type="radio" name="exampleRadios" :id="i" :value="item.iri" @click='userInput=item.iri;vocabDetails=item' v-model="userInput">
                            <label class="form-check-label" :for="i">
                              <span v-text='item.label' ></span>
                              <i v-if="userInput && userInput === item.iri" class="fas fa-check text-success"></i>
                            </label>
                          </div>
                        </template>
                        <template v-if="info.vocabulary && !info.vocabulary.strict ">
                          <div class="alert alert-warning">
                            <h6>Didn't find what you are looking for?</h6>
                            <p class="text-muted">
                              Just use <b class="pointer text-success" v-text="vocabTerm" @click="userInput=vocabTerm;vocabDetails={}"></b>
                            </p>
                          </div>
                        </template>
                      </div>
                    </template>
                    <!-- 🌈 STRING NORMAL🌈 -->
                    <template v-else>
                      <textarea :rows="name ==='description'?5:2" type="text" v-model="userInput" class="form-control form-control-sm " placeholder="enter text here"></textarea>
                    </template>
                      <!-- 🌈 VOCAB PREVIEW🌈 -->
                    <template v-if="vocabDetails && vocab.length && vocabDetails.ontology_prefix">
                      <div class="alert alert-info optionBox">
                        <h6>
                          <span v-text='vocabDetails.label' class="bold"></span>
                          <template v-if="vocabDetails && vocabDetails.short_form">
                            (<small v-text='vocabDetails.short_form' ></small>)
                          </template>
                        </h6>
                        <table>
                          <tbody>
                            <tr>
                              <td>
                                <div class="pillType d-block m-1">
                                  <span class="mainBackDark" style="font-size:1em;">Ontology</span>
                                  <span style="font-size:1em;">
                                    <a :href="vocabDetails.iri" v-text="vocabDetails.ontology_prefix" rel="nonreferrer" target="_blank"></a>
                                  </span>
                                </div>
                              </td>
                            </tr>
                            <tr>
                              <td>
                                <div class="pillType d-block m-1">
                                  <span class="mainBackLight" style="font-size:1em;">ID</span>
                                  <span style="font-size:1em;">
                                    <a :href="vocabDetails.iri" v-text="vocabDetails.obo_id" rel="nonreferrer" target="_blank"></a>
                                  </span>
                                </div>
                              </td>
                            </tr>
                            <tr v-if="vocabDetails && vocabDetails.description">
                              <td>
                                <small v-html="vocabDetails.description[0]"></small>
                              </td>
                            </tr>
                          </tbody>
                        </table>
                      </div>
                    </template>
                  </template>
                  <!-- 🌈 URL 🌈 -->
                  <template v-if="info && info.format === 'uri'">
                    <input type="url" v-model="userInput" class="form-control form-control-sm " placeholder="enter url here">
                  </template>
                  <!-- 🌈 STRING FORMAT DATE 🌈 -->
                  <template v-if="info && info.format === 'date'">
                    <input type="date" v-model="userInput" class="form-control form-control-sm">
                  </template>
                </template>
                <!-- 🌈 ENUM 🌈 -->
                <template v-if="info && info.enum" v-for="(item,i) in info.enum">
                  <div class="form-check">
                    <input class="form-check-input " type="radio" name="exampleRadios" :id="i" :value="item" @click='userInput=item' v-model="userInput">
                    <label class="form-check-label" :for="i" v-text='item'></label>
                  </div>
                </template>
                <!-- 🌈 LICENSE 🌈 -->
                <template v-if="info.type=== 'object' && name === 'license'">
                  <form id="licenseForm" class="p-1" v-if="!userInput">
                    <small class="text-muted">Allow commercial uses of your work?</small>
                    <select @change="getLicense()" ref="license1" class="form-control form-control-sm" id="ControlSelect1">
                      <option selected>Choose...</option>
                      <option value="Yes">Yes</option>
                      <option value="No">No</option>
                      <option value="Yes, as long as others share alike">Yes, as long as others share alike</option>
                    </select>
                    <small class="text-muted">Allow commercial uses of your work?</small>
                    <select @change="getLicense()" ref="license2" class="form-control form-control-sm" id="ControlSelect2" required="">
                      <option selected>Choose...</option>
                      <option value="Yes">Yes</option>
                      <option value="No">No</option>
                    </select>
                    <div v-show='licenseThirdQuestion'>
                      <small class="text-muted">Impose legal requirement for attribution?</small>
                      <select @change="getLicense()" ref="license3" class="form-control form-control-sm" id="ControlSelect3" required="">
                        <option selected>Choose...</option>
                        <option value="Yes">Yes</option>
                        <option value="No">No</option>
                      </select>
                    </div>
                  </form>
                  <template v-if="userLicense.text && !userInput">
                    <div class="alert alert-success text-center mt-3">
                      <h6 v-text="userLicense.text"></h6>
                      <p>
                        <small v-text="userLicense.description"></small>
                      </p>
                      <small>
                        <a :href="userLicense.url" target="_blank" v-text="'Learn More About '+userLicense.text"></a>
                      </small>
                    </div>
                  </template>
                  <template v-if="userInput && userInput.text">
                    <div class="alert alert-success text-center mt-3">
                      <small><b>License Chosen:</b> </small>
                      <h6 v-text="userInput.text"></h6>
                      <p>
                        <small v-text="userInput.description"></small>
                      </p>
                      <small>
                        <a :href="userInput.url" target="_blank" v-text="'Learn More About '+userInput.text"></a>
                      </small>
                      <hr />
                    </div>
                  </template>
                  <div class="text-center p-1" v-if="userLicense.text && !userInput">
                    <button class="btn btn-success" @click="userInput=userLicense">Use This License</button>
                  </div>
                </template>

                <!-- 🌈  KEYWORDS 🌈 -->
                <template v-if="info.type=== 'array' && name === 'keywords'">
                  <div class="form-group p-2 row">
                    <div class="col-sm-12 mb-2">
                      <form @submit.prevent="addKeyword">
                        <small class="text-muted">Enter single or multiple keywords separated by commas</small>
                        <input ref="keywordInput" autocomplete="off" type="text" class="form-control form-control-sm " placeholder="Enter text here">
                      </form>
                    </div>
                    <div class="col-sm-12 m-auto">
                      <template v-for="text in userInput">
                        <span title="Delete"  class="badge kwbadge badge-success mr-1 pointer slit-in-vertical" title="remove">
                          <span v-html="text"></span>
                          <span style="opacity:0;" class="d-inline" @click.prevent="removeItem(text)"> <i class="fas fa-times"></i></span>
                        </span>
                      </template>
                    </div>
                    <div class="alert alert-success m-3 w-75" v-show="userInput">
                      <small><b>Saved Keywords:</b> </small>
                      <template v-for="(text,i) in userInput">
                        <small v-html="text"></small>
                        <small v-if="i !== userInput.length-1">, </small>
                      </template>
                    </div>
                  </div>
                </template>

                <!-- 🌈  CONSTANT DATA CATALOG 🌈 -->
                <template v-if="info.type=== 'object' && name === 'includedInDataCatalog'">
                  <div class="text-center">
                    <div class="text-center bold text-info" v-if="constFound">
                      <small class="bold m-auto">Fixed Value, No Action Needed</small>
                    </div>
                    <div class='alert alert-success m-auto w-75'>
                    <p v-for="(item,index) in userInput" class="m-0">
                      <small class="bold" v-text='index'></small>:<small v-text='item'></small>
                    </p>
                    </div>
                  </div>
                </template>
                <!-- 🌈  OBJECT 🌈 -->
                <template v-if="info.type=== 'object' && name !== 'license' && name !== 'includedInDataCatalog' ">
                  <!-- <object-input :name="name" :info="info"></object-input> -->
                  <div class="form-group p-2 row">
                    <button class="btn themeButton text-light m-auto btnfocus" @click="addItem(name,info)" v-if="info.type=== 'object' && !userInput">
                      <i class="fas fa-plus"></i> <span v-text="'Add '+name"></span>
                    </button>
                  </div>
                  <div class="col-sm-12 m-auto">
                  <!-- 🌈  input preview for object or array🌈 -->
                    <template v-if="typeof userInput === 'object' || typeof userInput === 'array'  " v-for="(person,i) in userInput">
                      <span :data-tippy-info='JSON.stringify(person,null,2)' :data-tippy-id='i'  class="badge kwbadge badge-success mr-1 pointer slit-in-vertical desc" title="remove">
                        <i class="fas fa-check"></i>
                        <span v-text="name+' '+(i+1)"></span>
                        <span style="opacity:0;" class="d-inline" @click="removeItem(person)"> <i class="fas fa-times"></i></span>
                      </span>
                    </template>
                  <!-- 🌈  input preview for string🌈 -->
                    <template v-if="typeof userInput === 'string'">
                      <span style="overflow:hidden; max-width:100%;" class="badge badge-success text-light" v-text="userInput"></span>
                    </template>
                  </div>
                </template>
                <!-- 🌈  ONE OF 🌈 -->
                <template v-if="info.oneOf || info.anyOf">
                  <!-- 🌈  ONE OF ANYTHING🌈 -->
                  <template v-if="name !== 'datePublished' && name !== 'dateModified'">
                    <div class="form-group p-2 row">
                      <button class="btn themeButton text-light m-auto btnfocus" @click="addItem(name,info)" v-if="!userInput || canAcceptMultiple">
                        <i class="fas fa-plus"></i> <span v-text="'Add new '+name"></span>
                      </button>
                    </div>
                    <div class="col-sm-12 m-auto">
                    <!-- 🌈  input preview for object or array🌈 -->
                      <template v-if="typeof userInput === 'object' || typeof userInput === 'array'  " v-for="(person,i) in userInput">
                        <span :data-tippy-info='JSON.stringify(person,null,2)' :data-tippy-id='i'  class="badge kwbadge badge-success mr-1 pointer slit-in-vertical desc" title="remove">
                          <i class="fas fa-check"></i>
                          <span v-text="name+' '+(i+1)"></span>
                          <span style="opacity:0;" class="d-inline" @click="removeItem(person)"> <i class="fas fa-times"></i></span>
                        </span>
                      </template>
                    <!-- 🌈  input preview for string🌈 -->
                      <template v-if="typeof userInput === 'string'">
                        <span style="overflow:hidden; max-width:100%;" class="badge badge-success text-light" v-text="userInput"></span>
                      </template>
                    </div>
                  </template>

                  <!-- 🌈  ONE OF  VOCABULARY🌈
                  <template v-if="info.oneOf && info.oneOf[0].vocabulary">
                    <input-box :name="name" :info="info.oneOf[0]"></input-box>
                  </template> -->

                  <!-- 🌈  ONE OF  DATES🌈 -->
                  <template v-if="name === 'datePublished' || name === 'dateModified'">
                    <div v-if="datePreset && !userInput" class="p-2">
                      <small>Dates used:</small>
                      <small class="badge badge-info pointer m-1" v-text="'Click to use '+datePreset" @click="userInput=datePreset"></small>
                    </div>
                    <template v-for="(item,i) in info.oneOf">
                      <div>
                        <template v-if="item.format === 'date'">
                          <input type="date" v-model="userInput" class="form-control form-control-sm " :placeholder="'enter '+item.format">
                        </template>
                        <template v-if="item.type === 'string' && !item.format">
                          <input  type="text" v-model="userInput" class="form-control form-control-sm " :placeholder="'enter '+item.type">
                        </template>
                      </div>
                    </template>
                  </template>

                </template>
                <small v-if="showDesc && info.categories.length > 1">
                  <small class="text-muted bold">Part of</small>
                  <template v-if="info && info.categories" v-for="category in info.categories">
                    <small v-text="category.category" class="desc pointer mr-2" :data-tippy-info="[category.subcategory === 'Required' ? 'Required' : 'Recommended']" :class="[category.subcategory === 'Required' ? 'text-danger' : 'text-info']"></small>
                  </template>
                </small>
                <!-- 🌈  ISSUE 🌈 -->
                <template v-if="info && info.hasIssue">
                  <small style="color:salmon;">
                    <i class="fas fa-exclamation-circle"></i> <span v-text="info.hasIssue"></span>
                  </small>
                </template>
              </div>


            </div>
          </div>
        </div>
        <div class="col-sm-2 p-2 alert-dark actions d-flex align-items-center justify-content-around">
          <span class="fa-stack fa-1x pointer save" @click="markCompleted(name)" v-show="userInput || userInput === false">
            <i class="fas fa-circle text-success back fa-stack-2x"></i>
            <i class="fas fa-check fa-stack-1x text-light"></i>
          </span>
          <span class="fa-stack fa-1x pointer delete" @click="clearFieldFor(name)" v-show="info && info.value || info && info.value === false">
            <i class="fas fa-circle text-muted fa-stack-2x"></i>
            <i class="fas fa-times fa-stack-1x text-light"></i>
          </span>
        </div>
      </div>
    </div>`
  });

  Vue.component('propcontainer', {
    data: function(){
      return{
        settings: {{guide_settings}},
        allMode: Boolean,
        viewSettings: false,
      }
    },
    props: ['type'],
    methods:{
      isRequired(propname){
        let req = store.getters.getValidation['required']
        if (req.includes(propname)) {
          return true
        }else{
          return false
        }
      },
      nextStep(){
        var self = this;
        if (self.type === "REQUIRED") {
          let payload = {}
          payload["step"] = 4;
          store.commit('changeStep',payload);
        }else{
          if (self.isComplete) {
            let payload = {}
            payload["step"] = 5;
            store.commit('changeStep',payload);
          }else{
            $.notify("Incomplete",{ globalPosition: 'right',className:'error', showDuration: 40, });
          }
        }
      },
      selectProp(propname){
        var payload = {};
        payload["select"] = propname;
        store.commit('markSelected',payload);
      },
      checkSettings(){
        var self = this;
        if (self.settings && self.settings.hasOwnProperty('form-mode')) {
          self.allMode = self.settings['form-mode']
        }else{
          self.allMode = false
        }
      },
      goToStep(s){
        var self = this;
        let payload = {}
        payload["step"] = s;
        store.commit('changeStep',payload);
      },
      toggleDesc(){
        store.commit('toggleDesc');
      },
    },
    watch:{
      allMode: function(m){
        if (m) {
          $.notify("View All",{ globalPosition: 'right',className:'info', showDuration: 40, });
        }else{
          $.notify("View 1 by 1",{ globalPosition: 'right',className:'info', showDuration: 40, });
        }
      }
    },
    mounted: function(){
      this.checkSettings();
    },
    computed: {
      validation:function(){
        return store.getters.getValidation
      },
      isComplete:function(){
        return store.getters.isComplete
      },
      categoryTotals:function(){
        let totals = store.getters.getCategoryTotals
        return totals
      },
      totals:function(){
        return store.getters.getTotals
      },
      fieldsleft:function(){
        let v = store.getters.getValidation
        let n = 0
        for (var  key in v["properties"]) {
          if (!v["properties"][key]['value']) {
            n += 1
          }
        }
        return n
      },
      step: function(){
        return store.getters.getStep
      },
      showDesc: function(){
        return store.getters.getShowDesc
      }
    },
    template:
    `<div>
      <div class="row m-0">
        <div class="col-sm-12 grad d-flex justify-content-around align-items-center p-1">
          <h3 class="badge d-inline m-0" v-text="type" :class="type === 'REQUIRED' ?'badge-required':'badge-info'"></h3>
          <button class="btn btn-sm btn-outline-secondary text-light" @click="viewSettings = ! viewSettings">
            <small><i class="fas fa-cog"></i> Display Settings</small>
          </button>
          <div v-show="viewSettings">
            <input class="form-check-input" type="checkbox" :checked="allMode"  id="customControlInline2" @click="allMode = !allMode">
            <label class="form-check-label text-light" for="customControlInline2" >
              <small>Change Form Style</small>
            </label>
          </div>
          <div v-show="viewSettings">
            <input class="form-check-input" type="checkbox" :checked="showDesc"  id="customControlInline" @click="toggleDesc()">
            <label class="form-check-label text-light" for="customControlInline" >
              <small>Toggle Descriptions</small>
            </label>
          </div>
        </div>
        <div class="col-sm-12 col-md-9 p-0">
          <template v-if="allMode && validation">
            <!-- 🌈  ALL MODE 🌈 -->
            <div class="px-3">
              <template v-if="type === 'REQUIRED' ">
                <template v-for="(prop,index) in validation.properties" v-if="isRequired(index)">
                  <input-box :name='index' :info="prop" :key='index'></input-box>
                </template>
              </template>
              <template v-if="type === 'RECOMMENDED' ">
                <template v-for="(prop,index) in validation.properties" v-if="!isRequired(index)">
                  <input-box :name='index' :info="prop" :key='index'></input-box>
                </template>
              </template>
            </div>
          </template>

          <template v-if="!allMode && validation">
            <!-- 🌈  1 BY 1 MODE 🌈 -->
            <!-- 🌈  TODO 🌈 -->
            <div class="p-1 bg-dark text-left mb-0">
              <span class="badge m-1 badge-dark text-warning">
                TO-DO <i class="fas fa-chevron-right"></i>
              </span>
              <template v-if="type === 'REQUIRED' ">
                <template v-for="(prop,index) in validation.properties" v-if="isRequired(index)">
                  <span class="badge badge-dark m-1 pointer badgeDesc font-weight-normal slit-in-vertical" @click='selectProp(index)' v-if="prop && !prop.value" :class="{'highlight': prop.highlighted}">
                    <span v-text='index'></span>
                    <i class="fas fa-asterisk text-danger required pointer unselectable" v-if="isRequired(index)"></i>
                  </span>
                </template>
              </template>
              <template v-if="type === 'RECOMMENDED' ">
                <template v-for="(prop,index) in validation.properties" v-if="!isRequired(index)">
                  <span class="badge badge-dark m-1 pointer badgeDesc font-weight-normal slit-in-vertical" @click='selectProp(index)' v-if="prop && !prop.value" :class="{'highlight': prop.highlighted}">
                    <span v-text='index'></span>
                  </span>
                </template>
              </template>
            </div>
            <!-- 🌈  DONE 🌈 -->
            <div class="p-1 alert-success text-left mb-0">
              <span class="badge m-1 badge-light text-success">
                DONE <i class="fas fa-chevron-right"></i>
              </span>
              <template v-if="type === 'REQUIRED' ">
                <template v-for="(prop,index) in validation.properties" v-if="isRequired(index)">
                  <small class="m-1 text-success pointer desc" @click='selectProp(index)' v-if="prop && prop.value" :class="{'highlight': prop.highlighted}" data-tippy-info="Edit">
                    <i class="fas fa-check-circle text-success"></i> <span v-text='index'></span>
                    <i class="fas fa-asterisk text-danger required pointer unselectable" v-if="isRequired(index)"></i>
                  </small>
                </template>
              </template>
              <template v-if="type === 'RECOMMENDED' ">
                <template v-for="(prop,index) in validation.properties" v-if="!isRequired(index)">
                  <small class="m-1 text-success pointer desc" @click='selectProp(index)' v-if="prop && prop.value" :class="{'highlight': prop.highlighted}" data-tippy-info="Edit">
                    <i class="fas fa-check-circle text-success"></i> <span v-text='index'></span>
                  </small>
                </template>
              </template>
            </div>
            <div>
              <template v-if="validation.properties" v-for="(prop,index) in validation.properties">
                <input-box v-if='prop && prop.selected' :name='index' :info="prop" :key='index'></input-box>
              </template>
            </div>
          </template>

        </div>
        <div class="col-sm-12 col-md-3 p-0">
          <div class="w-100 text-muted d-flex justify-content-around align-items-center p-1">
            <h6>Progress Tracker</h6>
          </div>
          <template v-if="categoryTotals" v-for="(subcats,cat) in categoryTotals">
            <catcontainer class="fade-in" :cat="cat" :subcats="subcats" :key="cat+subcats"></catcontainer>
          </template>
        </div>
        <div class="col-sm-12 text-right m-0 rounded-0 p-1" :class="{'alert-success':isComplete, 'alert-danger': !isComplete}">
          <div class="bg-none p-2 rounded">
            <template v-if="type === 'REQUIRED' && isComplete ">
              <small class="text-success bold">Ready to proceed!</small>
              <button class="btn themeButton text-light" @click="nextStep()" :class="{'heartbeat':isComplete}" :disabled="!isComplete">NEXT</button>
            </template>
            <template v-if="type === 'REQUIRED' && !isComplete ">
              <small class="text-danger bold">Complete ALL requirements to proceed!</small>
              <button class="btn themeButton text-light" @click="nextStep()" :class="{'heartbeat':isComplete, 'notallowed': !isComplete}" :disabled="!isComplete">NEXT</button>
            </template>

            <template v-if="type === 'RECOMMENDED' ">
              <small v-show="fieldsleft !== 0" class="text-info">Complete as many recommended fields as possible <b class="text-danger">ONLY <span v-text="fieldsleft"></span> LEFT!</b></small>
              <small v-show="fieldsleft === 0" class="text-success bold">Great job! Ready to proceed!</small>
              <button class="btn btn-danger text-light mr-3 ml-3" @click="goToStep(step-1)"><i class="fas fa-chevron-left"></i> BACK</button>
              <button class="btn themeButton text-light" @click="nextStep()">NEXT <i class="fas fa-chevron-right"></i></button>
            </template>
          </div>
        </div>
      </div>
    </div>`
  });


  var app = new Vue({
      el: '#guide',
      store: store,
			data: function(){
				return {
          userInfo:null,
          loading: false,
          presets:{{guide_presets}},
          portals: {{guide_portals}},
				}
			},
      computed:{
        validation:function(){
          return store.getters.getValidation
        },
        valid:function(){
          return store.getters.getValidStatus
        },
        errors:function(){
          return store.getters.getErrors
        },
        isComplete:function(){
          let res = store.getters.isComplete
          if (res) {
            $.notify.addStyle('trophy', {
              html: `<div class="bg-dark p-1 text-light">
                  <i class="fas fa-thumbs-up text-success"></i> <span data-notify-text/>
                </div>`,
                classes: {
                  base: {
                    "white-space": "nowrap",
                    "background-color": "#343a40",
                    "padding": "5px",
                    "color":'white',
                    "border-radius":"5px"
                  }
                }
            });
            // id is the id of the chart
            $("#registerReady").notify("Available Now",{style:'trophy', showDuration: 40, placement:'top'});
          }
          return res
        },
        totals:function(){
          return store.getters.getTotals
        },
        categoryTotals:function(){
          let totals = store.getters.getCategoryTotals
          return totals
        },
        selectedProps: function(){
          return store.getters.getSelectedProps
        },
        filter: function(){
          return store.getters.getFilter
        },
        startingPoint: function(){
          return store.getters.getStartingPoint
        },
        step: function(){
          return store.getters.getStep
        },
        fieldsleftRegistration:function(){
          let v = store.getters.getValidation
          let n = 0
          for (var  key in v["properties"]) {
            if (!v["properties"][key]['value']) {
              n += 1
            }
          }
          return n
        },
        jsonItems: function(){
          return store.getters.getBulkJSONItems
        },
      },
      watch:{
        step:function(s){
          if (s === '5') {
            store.getters.getCategoryTotals
            store.getters.getTotals
          }
        },
      },
			methods:{
        checkUser(){
          let self = this;
          self.loading = true;
          $.ajax({url: "/user", success: function(result){
              self.loading = false;
             self.userInfo = result;
          },
          cache: false});
        },
        getAndLoadSchema(url){
          var self = this;
          self.loading = true;
          axios.get(url).then(res=>{
            self.loading = false;
            var payload = {};
            payload["schema"] = res.data;
            store.commit('saveSchema',payload);

          }).catch(err=>{
            self.loading = false;
            $.notify("Failed to load schema",{ globalPosition: 'right',className:'error', showDuration: 40, });
            throw err;
          })
        },
        // getStartingPointSchema(url,schemaName){
        //   let self = this;
        //   self.loading = true;
        //   axios.get("/api/view?url="+url).then(res=>{
        //
        //     var payload = {};
        //     payload["name"] = schemaName;
        //     store.commit('saveSchemaName',payload);
        //
        //     self.parseData(res.data)
        //
        //     self.loading = false;
        //   }).catch(err=>{
        //     self.loading = false;
        //     throw err;
        //   })
        // },
        getStartingPointSchema(item){
          let self = this;
          self.loading = true;
          axios.get('/api/registry/'+item.namespace+'/'+item.prefix+':'+item.name).then(res=>{
            var payload = {};
            payload["name"] = item.name;
            store.commit('saveSchemaName',payload);
            self.parseData(res.data)

            // IF ANY PORTALS AND IF ANY ARE SELECTED
            if (self.portals && self.portals.length) {
              for (var i = 0; i < self.portals.length; i++) {
                if (self.portals[i]['selected']) {
                  axios.get('/api/registry/'+self.portals[i].namespace+'/'+self.portals[i].prefix+':'+self.portals[i].name).then(result=>{

                    var payload = {};
                    payload["portal"] = result.data;
                    store.commit('addPortalSchema',payload);

                    var payload = {};
                    payload["origin"] = result.data.label
                    payload["catprops"] = result.data.validation.properties;
                    if (result.data.validation.required) {
                      payload["catpropsrequired"] = result.data.validation.required;
                      self.reqfields = result.data.validation.required;
                    }else{
                      payload["catpropsrequired"] = [];
                    }
                    store.commit('mergeCategoryProps',payload);


                  }).catch(error=>{

            				throw error;
                  });
                }
              }
            }
            self.loading = false;
    			}).catch(err=>{
            self.loading = false;
            try {
              Swal.fire({
                type: 'error',
                position: 'center',
                title: 'Failed because: ',
                text: err.response.data.reason
              });
            } catch (e) {
              // console.log(e)
            } finally {

            }
    				throw err;
    			})
        },
        parseData(data){
          let self = this;
          let schemaName = store.getters.getSchemaName

          if (data.hits) {
            for (var i = 0; i < data.hits.length; i++) {
              if (data.hits[i].hasOwnProperty('name')) {
                if (data.hits[i].name.includes(schemaName)) {
                  var payload = {};
                  payload["schema"] = self.assignCategories(data.hits[i]);
                  store.commit('saveSchema',payload);
                }
              }else if (data.hits[i].hasOwnProperty('label')) {
                if (data.hits[i].label.includes(schemaName)) {
                  var payload = {};
                  payload["schema"] = self.assignCategories(data.hits[i]);
                  store.commit('saveSchema',payload);
                }
              }
            }
          }else {
            if (data.hasOwnProperty('name')) {
              if (data.name.includes(schemaName)) {
                var payload = {};
                payload["schema"] = data;
                store.commit('saveSchema',payload);
              }
            }else if (data.hasOwnProperty('label')) {
              if (data.label.includes(schemaName)) {
                var payload = {};
                payload["schema"] = data;
                store.commit('saveSchema',payload);
              }
            }
          }
          // check for saved progress
          self.checkProgress();
        },
        assignCategories(schema){
          var self = this;

          if (schema.hasOwnProperty('validation')) {

            for (prop in schema['validation']['properties']) {
              //assign if found
              Vue.set(schema['validation']['properties'][prop],'categories',[])

              for (category in self.categories) {
                for (var subcategory in self.categories[category]) {
                  if (self.categories[category][subcategory].includes(prop)) {
                    let cat={
                      'category': category,
                      'subcategory':subcategory
                    }
                    schema['validation']['properties'][prop]['categories'].unshift(cat);
                  }
                }
              }
            }
            // console.log('WITH CATS', schema)
            return schema
          }else{
            return schema
          }
        },
        reset(){
          if (this.validation) {
            Swal.fire({
              title: 'Are you sure?',
              text: "You won't be able to revert this!",
              animation:false,
              customClass:'scale-in-center',
              showCancelButton: true,
              confirmButtonColor:"{{color_main}}",
              cancelButtonColor:"{{color_sec}}",
              confirmButtonText: 'Yes, start over'
            }).then((result) => {
              if (result.value) {
                store.dispatch('reset')
                sessionStorage.removeItem('guideProgress');
              }
            });
          }
        },
        isRequired(propname){
          let req = store.getters.getValidation['required']
          if (req.includes(propname)) {
            return true
          }else{
            return false
          }
        },
        selectProp(propname){
          var payload = {};
          payload["select"] = propname;
          store.commit('markSelected',payload);
        },
        getPreview(){
          store.commit('formPreview');
          Swal.fire({
            position: 'center',
            confirmButtonColor:"{{color_main}}",
            cancelButtonColor:"{{color_sec}}",
            animation:false,
            customClass:'scale-in-center',
            html: `<h6 class="text-center mainTextDark">Preview</h6><div class="text-left p-1 previewBox"><small><pre>`+JSON.stringify(store.getters.getPreview,null,2)+`</pre></small></div>`
          });
        },
        handleRegistration(){
          var self = this;

          if (this.isComplete) {
            store.commit('formPreview');
            let output = store.getters.getOutput
            self.loading = true;

            Swal.fire({
              title: 'Register this dataset?',
              html:"<small>Are you all done? Click <b>Register Now</b> to proceed.</small>",
              footer:`<small class='text-danger'>You will leave this page after successfully registering this metadata.</small>`,
              confirmButtonColor:"{{color_main}}",
              cancelButtonColor:"{{color_sec}}",
              animation:false,
              customClass:'scale-in-center',
              showCancelButton: true,
              confirmButtonText: 'Register Now',
              showLoaderOnConfirm: true,
              onClose:function(){
                self.loading = false;
              },
              preConfirm: (input) => {

                let schema = store.getters.getSchema

                let config = {
                   headers: {
                     'content-type': 'application/json'
                   }
                 }

                axios.post('/api/dataset?schema='+schema['namespace']+'::'+schema['prefix']+':'+schema['label']+"&guide="+encodeURI(window.location.href),output,config).then(res=>{
                  self.loading = false;
                  if (res.data.success) {

                    sessionStorage.removeItem('guideProgress');

                    let timerInterval
                    Swal.fire({
                      type:'success',
                      title: 'Registration Successful',
                      html:
                        'Taking you to your dataset page in <strong></strong> seconds.',
                      timer: 3000,
                      onBeforeOpen: () => {
                        const content = Swal.getContent()
                        const $ = content.querySelector.bind(content)
                        Swal.showLoading()
                        timerInterval = setInterval(() => {
                          Swal.getContent().querySelector('strong')
                            .textContent = (Swal.getTimerLeft() / 1000)
                              .toFixed(0)
                        }, 100)
                      },
                      onClose: () => {
                        clearInterval(timerInterval)
                        store.dispatch('reset')
                        window.location.href='/dataset/'+res.data.id
                      }
                    })
                  }else{

                    try {
                      Swal.fire({
                        type: 'error',
                        position: 'top center',
                        title: 'Registration failed because: ',
                        text: res.data.reason
                      });
                    } catch (e) {
                      throw e;
                    }
                  }
                }).catch(err=>{
                  self.loading = false;
                  // console.log('err',err.response.data)
                  let culprit = "<h6>"+err.response.data.error+"</h6>"
                  if (err.response.data && err.response.data.path) {
                    culprit += "<h5>Culprit <i class='fas fa-arrow-right'></i> <b class='text-danger'>"+err.response.data.path+"</b></h5>"
                  }
                  if (err.response.data.parent && err.response.data.parent.path){
                    if (true) {
                      culprit += "<h5>Under <i class='fas fa-arrow-right'6</i> <b class='text-danger'>"+err.response.data.parent.path+"</b></h5>"
                    }
                    if (err.response.data.parent && err.response.data.parent.reason) {
                      culprit += "<div class='alert alert-warning'><small>"+err.response.data.parent.reason+"</small></div>"
                    }
                  }
                  if (err.response.data.hasOwnProperty('validator_value') && err.response.data.validator_value.length){
                    culprit += "<div class='alert alert-info'><small> Hint: "+err.response.data.validator_value+"</small></div>"
                  }
                  Swal.fire({
                    type: 'error',
                    position: 'top center',
                    title: 'Registration failed because: ',
                    html: culprit,
                    footer:'<small>Validation Error</small>'
                  });
                  throw err;
                })
              },
              allowOutsideClick: () => !Swal.isLoading(),

            });
            self.loading = true;
          }

        },
        downnloadSchema(){
          var self = this;
          if (this.isComplete){
            store.commit('formPreview');
            Swal.fire({
              title: 'Name your file',
              input: 'text',
              inputAttributes: {
                autocapitalize: 'off'
              },
              showCancelButton: true,
              confirmButtonText: 'Download JSON-LD',
              allowOutsideClick: () => !Swal.isLoading()
            }).then((result) => {
              if (result.value) {
                self.download(JSON.stringify(store.getters.getPreview,null,2), result.value+'.jsonld', 'text/plain')
              }
            })
          }

        },
        download(content, fileName, contentType) {
          var a = document.createElement("a");
          var file = new Blob([content], {type: contentType});
          a.href = URL.createObjectURL(file);
          a.download = fileName;
          a.click();
        },
        showHelp(){
          Swal.fire({
            title: 'Dataset Guide',
            html:`<p>
                    After selecting a starting point you will be able complete a series of fields. It's really easy and fast! Here's a quick introduction to the layout:
                  </p>
                  <small>
                    <ul class="text-left">
                      <li>
                        1. Log-in status
                      </li>
                      <li>
                        2. Start over from scratch
                      </li>
                      <li>
                        3. Preview your progress
                      </li>
                      <li>
                        4. Download your progress (Available after completing all required fields)
                      </li>
                      <li>
                        5. Register your dataset (Available after completing all required fields)
                      </li>
                      <li>
                        6. All fields available to complete (* Required)
                      </li>
                      <li>
                        7. Progress bar
                      </li>
                      <li>
                        8. Complete fields
                      </li>
                      <li>
                        9. Current field clicked
                      </li>
                      <li>
                        10. Actions: Save & Close and Clear Field
                      </li>
                    </ul>
                  </small>`,
            footer:'',
            width:'52em',
            cconfirmButtonColor:"{{color_main}}",
            cancelButtonColor:"{{color_sec}}",
            confirmButtonText:"Ready!",
            animation:false,
            customClass:'scale-in-center',
            imageUrl: '/static/img/metadata.png',
            imageAlt: 'Dataset Editor'
          })
        },
        handleBulk(){
          var self = this;

          Swal.fire({
            title: 'Bulk registration',
            text: 'What type of file do you have?',
            input: 'select',
            animation:false,
            customClass:'scale-in-center',
            inputOptions: {
              'json': 'JSON',
              'csv': 'CSV',
            },
            inputPlaceholder: 'Select type',
            showCancelButton: true,
            confirmButtonText: 'Next',
            showLoaderOnConfirm: true,
            preConfirm: (method) => {
              return method
            },
            allowOutsideClick: () => !Swal.isLoading()
          }).then((result) => {
            if (result.value) {
              switch (result.value) {
                case 'json':
                  self.getFile('json');
                  break;
                case 'csv':
                  self.getFile('csv');
                break;
                default:
                  //nothing
              }
            }
          })
        },
        async getFile(type){
          var self = this;

          if (type == 'json') {
            const { value: file } = await Swal.fire({
            title: 'Select file',
            input: 'file',
            footer:`<small class="text-danger">Registration will be triggered automatically when upload finishes.</small>`,
            inputAttributes: {
              'accept': 'json',
              'aria-label': 'Upload your file'
            }
            })

            if (file) {
              try {
                const blob = new Blob([file], {type:"application/json"});

                const fr = new FileReader();

                fr.addEventListener("load", e => {
                  var payload = {};
                  let json = JSON.parse(fr.result);
                  if (json.length < 101) {
                    payload["items"] = json;
                    store.commit('saveBulkItems',payload);
                  }else {
                    Swal.fire({
                    icon: 'error',
                    title: 'Over Limit',
                    text: json.length+" items. Please submit 100 items at a time."
                    })
                  }
                });

                fr.readAsText(blob);
              } catch (e) {
                Swal.fire({
                icon: 'error',
                title: 'Something is wrong..',
                text: e
                })
              }

            }
          }else if (type == 'csv') {
            const { value: file } = await Swal.fire({
            title: 'Select file',
            input: 'file',
            footer:`<small class="text-danger">Registration will be triggered automatically when upload finishes.</small>`,
            inputAttributes: {
              'accept': 'csv',
              'aria-label': 'Upload your file'
            }
            })
            if (file) {

              Papa.parse(file,{
              header: true,
              delimeter:';',
              complete: function(results) {
                self.parseCSVData(results.data)
              }
              });

            }
          }
        },
        parseCSVData(data){
          let self = this;
          let items = []
          // console.log('Raw CSV data', data)
          for (let i = 0; i < data.length; i++) {
            let currentDoc = data[i]
            let newDoc = {}
            for (let key in currentDoc) {
              if (key.includes(".")) {
                let keyPath = self.separateByDelimeter(key,'.')
                // console.log('%c keypath '+key,'color:orange')
                self.createNested(newDoc, keyPath, currentDoc[key])
              }else{
                let v = currentDoc[key]
                if (key && v) {
                  // console.log('%c simple value: '+key,'color:pink')
                  self.createNested(newDoc,[key], v)
                }
              }
            }
            items.push(newDoc)
            // console.log("%c --------------------------------------------",'color:green')
            // console.log('%c '+JSON.stringify(items,null,2),'color:lightgreen')
            // console.log("%c --------------------------------------------",'color:green')

            var payload = {};
            payload["items"] = items;
            store.commit('saveBulkItems',payload);
          }
        },
        createNested(obj, keyPath, value) {
          var self = this;
          // console.log("obj",obj)
          // console.log("keyPath",keyPath)
          // console.log("value",value)
          // console.log("%c --------------------------------------------",'color:yellow')

          lastKeyIndex = keyPath.length-1;
          for (var i = 0; i < lastKeyIndex; ++ i) {
           key = keyPath[i];
           // console.log("looking at key",key)
           if (!(key in obj)){
             obj[key] = {}
           }
           obj = obj[key];
          }
          obj[keyPath[lastKeyIndex]] = value;
          return obj
        },
        separateByDelimeter(value, delimeter){
          if (value.includes(delimeter)) {
            return value.split(delimeter)
          }else {
            return value
          }
        },
        loadData(){
          var self = this;
          Swal.fire({
            title: 'Import Metadata',
            text: 'Select the source of metadata',
            input: 'select',
            inputOptions: {
              'giturl': 'Hosted metadata on GitHub (raw url)',
              'registered': 'Metadata by you registered here',
              'text':'JSON metadata text',
            },
            inputPlaceholder: 'Select method',
            showCancelButton: true,
            animation:false,
            customClass:'scale-in-center',
            confirmButtonText: 'Next',
            showLoaderOnConfirm: true,
            preConfirm: (method) => {
              return method
            },
            allowOutsideClick: () => !Swal.isLoading()
          }).then((result) => {
            if (result.value) {
              switch (result.value) {
                case 'giturl':
                  // URL
                  Swal.fire({
                    title: 'Enter the URL here',
                    input: 'text',
                    inputAttributes: {
                      autocapitalize: 'off'
                    },
                    showCancelButton: true,
                    confirmButtonText: 'Go',
                    allowOutsideClick: () => !Swal.isLoading()
                  }).then((result) => {
                    if (result.value) {
                      let url = result.value
                      axios.get(url).then(res=>{
                        let selected = res.data;
                        for(key in selected){
                          if (!['@context','@type','_id'].includes(key)) {
                            var payload = {};
                            if (typeof selected[key] === 'object') {
                              let value = [selected[key]]
                              payload["completed"] = {'name':key,'value':value};
                              store.commit('markCompleted',payload);
                            }else{
                              let value = selected[key]
                              payload["completed"] = {'name':key,'value':value};
                              store.commit('markCompleted',payload);
                            }

                          }
                        }
                      }).catch(err=>{
                        Swal.fire({
                          type: 'error',
                          title: 'Oops...',
                          text: 'Something went wrong!',
                        })
                        throw err;
                      })
                    }
                  });
                  break;
                case 'registered':
                  axios.get('/api/dataset?&user='+self.userInfo.login).then(publicres=>{
                    // console.log("PUBLIC",res.data)
                    let list = publicres.data.hits;
                    self.loading = false;
                    self.loading = true;
                    axios.get('/api/dataset?private=true&user='+self.userInfo.login).then(privateres=>{
                      self.loading = false;
                      list =list.concat(privateres.data.hits)
                      let options = {};
                      for (var i = 0; i < list.length; i++) {
                        Vue.set(options,list[i]['name'],list[i]['name'])
                      }
                      Swal.fire({
                        title: 'Select Metadata To Import',
                        input: 'select',
                        inputOptions: options,
                        animation:false,
                        footer:`<p>
                        WARNING: <span class='text-danger'>You are loading already registered metadata.</span> If -identifier- field <b>IS NOT</b> changed, changes will override current saved data. If -identifier- field <b>IS</b> changed this this create a new entry.
                        </p>`,
                        customClass:'scale-in-center',
                        inputPlaceholder: 'Select an item',
                        showCancelButton: true,
                      }).then((result) => {
                        if (result.value) {
                          for (var i = 0; i < list.length; i++) {
                            if (result.value === list[i]['name']) {
                              let selected = list[i]
                              for(key in selected){
                                if (!['@context','@type','_id'].includes(key)) {
                                  var payload = {};
                                  if (typeof selected[key] === 'object') {
                                    let value = [selected[key]]
                                    payload["completed"] = {'name':key,'value':value};
                                    store.commit('markCompleted',payload);
                                  }else{
                                    let value = selected[key]
                                    payload["completed"] = {'name':key,'value':value};
                                    store.commit('markCompleted',payload);
                                  }

                                }
                              }
                            }
                          }
                        }
                      })
                    }).catch(err=>{
                      throw err;
                    });
                  }).catch(err=>{
                    throw err;
                  });

                  break;
                case 'text':
                  Swal.fire({
                    title: 'Enter JSON here:',
                    input: 'textarea',
                    inputAttributes: {
                      autocapitalize: 'off'
                    },
                    showCancelButton: true,
                    confirmButtonText: 'Go',
                    allowOutsideClick: () => !Swal.isLoading()
                  }).then((result) => {
                    if (result.value) {

                      try {
                          let selected = JSON.parse(result.value)
                          console.log(selected)
                          for(key in selected){
                            if (!['@context','@type','_id'].includes(key)) {
                              var payload = {};
                              if ( _.isPlainObject(selected[key]) ) {
                                //look at keys and check for dates
                                let obj = selected[key]
                                for (var k in obj) {
                                  if (k.includes('date')) {
                                    let v = moment(obj[k]).format("YYYY-MM-DD")
                                    obj[k] = v
                                    console.log('date checked obj',obj[k])
                                  }
                                }
                                //make obj an array of obj,
                                payload["completed"] = {'name':key,'value':[obj]};
                                store.commit('markCompleted',payload);

                              }else if ( _.isArray(selected[key]) ) {
                                let list = selected[key]

                                for (var i = 0; i < list.length; i++) {
                                  let item = list[i];
                                  if (_.isPlainObject(item)) {
                                    let arrObj = item

                                    for (var k in arrObj) {
                                      if (k.includes('date')) {
                                        let v = moment(arrObj[k]).format("YYYY-MM-DD")
                                        arrObj[k] = v
                                        console.log('date checked obj',arrObj[k])
                                      }
                                    }

                                  }else if (_.isString(item) && item.includes('date')) {
                                    item = moment(item).format("YYYY-MM-DD")
                                    console.log('date checked string',item)
                                  }else {

                                  }
                                }
                                payload["completed"] = {'name':key,'value':list};
                                store.commit('markCompleted',payload);
                              }
                              else{
                                let value = selected[key]
                                if (key.includes('date')) {
                                  let v = moment(value).format("YYYY-MM-DD")
                                  payload["completed"] = {'name':key,'value':v};
                                }else {
                                  payload["completed"] = {'name':key,'value':value};
                                }

                                store.commit('markCompleted',payload);
                              }

                            }
                          }
                      } catch(e) {
                        Swal.fire({
                        icon: 'error',
                        title: 'Oops...',
                        text: e,
                        footer: 'Oh no, something looks wrong...'
                        })
                      }



                    }
                  });

                  break;
                default:
              }
            }
          })
        },
        checkAutoLoad(){
          var self = this;
          // console.log('checkAutoLoad')
          let payload = {}
          if (self.presets && self.presets.length === 1) {
            payload["startingPoint"] = self.presets[0];
            store.commit('setStartingPoint',payload);
            if (self.portals && self.portals.length) {
              payload["step"] = 2;
              store.commit('changeStep',payload);
            }else{
              // console.log('3')
              payload["step"] = 3;
              store.commit('changeStep',payload);
              self.getFormValues();
            }
          }else{
            payload["step"] = 1;
            store.commit('changeStep',payload);
          }
        },
        getFormValues () {
          var self = this;
          // Handle selections for startingPoint and Portals IF any
          self.getStartingPointSchema(store.getters.getStartingPoint)
          let payload = {}
          payload["step"] = 3;
          store.commit('changeStep',payload);

        },
        setStartingPoint(startingPointInfo){
          var self = this;
          let payload = {}
          payload["startingPoint"] = startingPointInfo;
          store.commit('setStartingPoint',payload);
          if (self.portals && self.portals.length) {
            // IF PORTALS AVAILABLE
            payload["step"] = 2;
            store.commit('changeStep',payload);
          }else{
            // IF NO PORTALS AVAILABLE
            self.getFormValues()
            payload["step"] = 3;
            store.commit('changeStep',payload);
          }

        },
        goToStep(s){
          var self = this;
          let payload = {}
          payload["step"] = s;
          store.commit('changeStep',payload);
        },
        checkProgress(){
          let p = sessionStorage.getItem('guideProgress');
          if (p) {
            $.notify("Progress recovered",{ globalPosition: 'right',className:'info', showDuration: 40, });
            let selected = JSON.parse(p)

            for(key in selected){
              if (!['@context','@type','_id'].includes(key)) {
                var payload = {};
                if (typeof selected[key] === 'object') {
                  let value = [selected[key]]
                  payload["completed"] = {'name':key,'value':value};
                  store.commit('markCompleted',payload);
                }else{
                  let value = selected[key]
                  payload["completed"] = {'name':key,'value':value};
                  store.commit('markCompleted',payload);
                }

              }
            }
          }

        },
        viewErrors(){
          var self = this;

          if (self.errors.length) {
            Swal.fire({
            title: 'Issues',
            animation:false,
            customClass:'scale-in-center',
            html: `<div class="text-left previewBox">
                    <div>
                      <small>
<pre>
`+JSON.stringify(self.errors,null,2)+`
</pre>
                      </small>
                    </div>
                  </div>`
            });
          }else {
            Swal.fire({
            type: 'success',
            title: 'Valid',
            text: "All good!",
            })
          }
        }
			},
			mounted:function(){
        this.checkUser();
        this.checkAutoLoad();

        tippy( '#guide', {
            target:'.bar',
            content: 'Loading...',
            maxWidth:'200px',
            placement:'top',
            animation: 'fade',
            theme:'light',
            onShow(instance) {
              let totals = store.getters.getTotals
              let percentage = Math.ceil((totals.complete/totals.total)*100)
              instance.setContent("<div class='text-success bold m-0'>"+percentage+"% Completed</div>")
            }
          });
        tippy( '#widget',{
            target:'.desc',
            content: 'Loading...',
            // maxWidth:'200px',
            placement:'top',
            animation: 'fade',
            interactive: true,
            theme:'light',
            onShow(instance) {
              let info = instance.reference.dataset.tippyInfo;
              if (info.includes('http')) {
                info = info.replace(/['"]+/g, '')
                // EBI API LOOKUP TIP DESCRIPTION
                axios.get("https://www.ebi.ac.uk/ols/api/search?q="+encodeURI(info)+"&exact=1").then(res=>{
                  if (res.data.response.hasOwnProperty('docs')&& res.data.response.docs.length >= 1) {
                    for (var i = 0; i < res.data.response.docs.length; i++) {
                      if (res.data.response.docs[i]['iri']===info) {
                        instance.setContent("<div class='text-muted m-0 p-1'>"+res.data.response.docs[i]['label']+"</div>")
                      }
                    }
                  }else{
                    instance.setContent("<div class='text-muted m-0 p-1'>"+info+"</div>")
                  }
                }).catch(err=>{
                  instance.setContent("<div class='text-muted m-0 p-1'>"+info+"</div>")
                });
              }else{
                // REGULAR TIP DESCRIPTION
                instance.setContent("<div class='text-muted m-0 p-1'>"+info+"</div>")
              }
            }
          });
			}
		});


</script>
{% include "footer.html" %}
{% endblock %}
