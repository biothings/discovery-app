{% extends "main.html" %}
{% block content %}
{% include "header.html" %}
<style>
[v-cloak] > * { display:none; }
[v-cloak]::before { content: "Please wait..."; }
</style>
<div id="guide" class="container pt-5" style="min-height:90vh;" v-cloak>
  <div v-if=loading class="loader">
    <img src="/static/img/ripple.svg"/>
  </div>
  <div class="jumbotron bg-light text-center m-0">
    <h1 class="logoText">DISCOVERY GUIDE</h1>
    <p class="text-muted">
      Follow best practices to make your dataset metadata more findable
    </p>
    <a href="/dataset">Browse registered datasets <i class="fas fa-chevron-right"></i></a>
  </div>
  <div id="widget" class="mb-5 grad">
    <div>
      <div class="actions bg-dark p-2 rounded d-flex align-items-center justify-content-start">
        <span class="fa-stack fa-1x pointer desc mr-2" :data-tippy-info="'Logged in as '+userInfo.login" v-if="userInfo && userInfo.login">
          <i class="fas fa-circle text-success fa-stack-2x"></i>
          <i class="fas fa-user-check fa-stack-1x fa-inverse"></i>
        </span>
        <a class='nav-link active text-primary mr-2' href='./oauth' v-if="userInfo && !userInfo.login">
          <span class="fa-stack fa-1x pointer desc" data-tippy-info="Click to log in">
            <i class="fas fa-circle text-primary fa-stack-2x"></i>
            <i class="fas fa-sign-in-alt fa-stack-1x fa-inverse"></i>
          </span>
        </a>
        <span class="fa-stack fa-1x pointer desc mr-2" data-tippy-info="Start Over" @click="reset()"  :class="{ 'disabled notallowed': !validation, 'pointer': validation }">
          <i class="fas fa-circle text-success fa-stack-2x"  :class="{ 'text-muted': !validation, 'text-danger': validation }"></i>
          <i class="fas fa-undo fa-stack-1x fa-inverse"></i>
        </span>
        <span class="fa-stack fa-1x pointer desc mr-2" data-tippy-info="Preview Progress" @click="getPreview()"  :class="{ 'disabled notallowed': !validation, 'pointer': validation }">
          <i class="fas fa-circle text-success fa-stack-2x"  :class="{ 'text-muted': !validation, 'mainTextDark': validation }"></i>
          <i class="fas fa-code fa-stack-1x fa-inverse"></i>
        </span>
        <span class="fa-stack fa-1x pointer desc mr-2" data-tippy-info="Import Metadata" @click="loadData()"  v-show="validation">
          <i class="fas fa-circle text-success fa-stack-2x"  :class="{ 'text-muted': !validation, 'mainTextDark': validation }"></i>
          <i class="fas fa-file-import fa-stack-1x fa-inverse"></i>
        </span>
      </div>
    </div>

    <div v-if="userInfo && !userInfo.login" class="widgetContainer bg-light jumbotron whitefade text-center m-1">
      <div class="alert text-danger text-center p-5">
        <h2><i class="fas fa-exclamation"></i></h2>
        <h5>You must be logged in to proceed</h5>
      </div>
    </div>

    <div v-else class="widgetContainer bg-light jumbotron whitefade text-center m-1">

        <template v-if="step === 1 ">
          <!-- STARTING POINT -->
          <h4 class="logoText">Metadata</h4>
          <p class="text-muted">
            Select the type of metadata you are interested in creating.
          </p>
          <div>
            <template v-for="item in presets">
              <buttom  @click="setStartingPoint(item)" class="btn themeButton text-light mr-2 desc" v-text="item.name" :data-tippy-info="item.description"></buttom>
            </template>
          </div>
        </template>

        <!-- OPTIONAL PORTALS -->
        <template v-if=" step === 2 ">
          <h4 class="logoText">Discovery Portals</h4>
          <p class="text-muted">
            Select the portals you are interested in. Each will add fields required by that portal.
          </p>
          <form @submit.prevent="getFormValues()">
            <template v-for="item in portals">
              <div class="p-2">
                <input class="form-check-input" type="checkbox" name="portal" :id="item.name" :value="item.name" :checked="item.selected" @click="item.selected = !item.selected">
                <label class="form-check-label" :for="item.name">
                  <span v-text="item.name"></span>
                  <i class="fas fa-info-circle text-info desc" :data-tippy-info="item.description"></i>
                </label>
              </div>
            </template>
            <button class="btn themeButton text-light mt-3" type="submit">NEXT <i class="fas fa-chevron-right"></i></button>
          </form>
        </template>

        <template v-if=" step === 3 ">
          <propcontainer v-show="validation" :type="'REQUIRED'"></propcontainer>
        </template>

        <template v-if=" step === 4 ">
          <propcontainer v-show="validation" :type="'RECOMMENDED'"></propcontainer>
        </template>

        <template v-if=" step === 5">
          <h1 class="logoText">Registration</h1>
          <div class="p-5 text-center m-3">
            <p class="text-muted text-center">
              Are you all done? Click Register Now to proceed. <br />You will leave this page after successfully registering this metadata.
            </p>
            <a class='btn btn-lg btn-success text-light desc' :class="{ 'disabled text-muted notallowed': !isComplete, 'bg-success text-light pointer': isComplete }" @click="handleRegistration()" :data-tippy-info="[!isComplete ? 'Available when all required fields are complete' : 'Click to register your metadata']">
              <small>
                <i class="fas fa-check"></i> Register
              </small>
            </a>
          </div>
          <div class="col-sm-12">
            <div class="row">
              <div class="col-sm-12 text-center p-3">
                <h4 class="bold" :class="{ 'text-info': fieldsleftRegistration !== 0, 'text-success': fieldsleftRegistration !== 0 }">
                  <span v-show="fieldsleftRegistration === 0">Great Job! </span>
                  <span v-text="Math.ceil((totals.complete/totals.total)*100)+'% COMPLETE'" ></span>
                </h4>
                <small class="text-info"> (<span v-text='totals.complete'></span>/<span v-text='totals.total'></span>)</small>
              </div>
            </div>
            <div v-if="fieldsleftRegistration !== 0" class="col-sm-12 text-center p-3 rounded alert-info m-2">
              <h4 class="text-muted">Only <span class="text-danger bold" v-text="fieldsleftRegistration"></span> fields left!</h4>
              <button class="btn themeButton text-light" @click="goToStep(4)">Fill Out Now</button>
            </div>
            <div v-else class="col-sm-12 text-center p-3 rounded m-2">
              <button class="btn btn-danger text-light" @click="goToStep(step-1)"><i class="fas fa-chevron-left"></i> BACK</button>
            </div>
            <div class="d-flex justify-content-center flex-wrap">
              <template v-if="categoryTotals" v-for="(subcats,cat) in categoryTotals">
                <catcontainer class="fade-in" :cat="cat" :subcats="subcats" :key="cat+subcats"></catcontainer>
              </template>
            </div>
          </div>
        </template>

  </div>
</div>

{% endblock %}
{% block extra_scripts %}
<script src="https://unpkg.com/vuex"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.18.0/axios.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.bundle.min.js" integrity="sha256-xKeoJ50pzbUGkpQxDYHD7o7hxe0LaOGeguUidbq6vis=" crossorigin="anonymous"></script>
<script src="/static/js/lodash.js"></script>
<script src="/static/js/notify.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@7.28.11/dist/sweetalert2.all.min.js"></script>
<script>
  const store = new Vuex.Store({
    state: {
      schema:Object,
      required:Array,
      validation:null,
      schemaName:'',
      output:{},
      filter:String,
      startingPoint: null,
      selectedPortals:[],
      step: Number,
      settings: Object
    },
    strict: true,
    mutations: {
      saveSchema(state,payload){
        state.schema = payload['schema'];
        console.log('schema saved',state.schema)
        state.output['@type'] = state.schema.label || state.schema.name
        state.output['@context'] = 'http://discovery.biothings.io/'

        state.filter = state.schema.label || state.schema.name

        // helper func to decide right subcategory
        function getProp(propname){
          let cat={
            'category': state.schema.label || state.schema.name
          }
          if (state.schema.validation.required.includes(propname)) {
            Vue.set(cat,'subcategory','Required')
          }else{
            Vue.set(cat,'subcategory','Recommended')
          }
          return cat
        }

        // Assign initial guide_categories
        for (var prop in state.schema.validation.properties) {
          if (state.schema.validation.properties[prop].hasOwnProperty('categories')) {
            state.schema.validation.properties[prop]['categories'].unshift(getProp(prop))
          }else{
            Vue.set(state.schema.validation.properties[prop],'categories',[])
            state.schema.validation.properties[prop]['categories'].unshift(getProp(prop))
          }
        }
      },
      filterProps(state,payload){
        state.filter = payload['cat'];
      },
      saveSchemaName(state,payload){
        state.schemaName = payload['name'];
      },
      reset(state){
        state.schema = {};
        state.validation = null;
        state.step = '1';
        state.selectedPortals = []
        state.startingPoint = null
        window.location.reload()
      },
      markSelected(state,payload){
        let selection = payload['select'];
        for (key in state.schema.validation.properties) {
          if (key === selection) {
            Vue.set(state.schema.validation.properties[selection],'selected',true);
          }else{
            Vue.set(state.schema.validation.properties[key],'selected',false);
          }
        }
      },
      selectNext(state){
        for (key in state.schema.validation.properties) {
          if (state.schema.validation.properties[key] && !state.schema.validation.properties[key].value) {
            Vue.set(state.schema.validation.properties[key],'selected',true);
            break;
          }
        }
      },
      saveSettings(state,payload){
        state.settings = payload['settings']
        console.log(state.settings)
      },
      highlight(state,payload){
        let cat = payload['category'];
        let subcat = payload['subcategory'];
        for (prop in state.schema.validation.properties) {
          Vue.set(state.schema.validation.properties[prop],'highlighted',false);
        }
        for (prop in state.schema.validation.properties) {
          if (state.schema.validation.properties[prop].hasOwnProperty('categories')) {
            for (var i = 0; i < state.schema.validation.properties[prop]['categories'].length; i++) {
              if (state.schema.validation.properties[prop]['categories'][i]['category'] === cat && state.schema.validation.properties[prop]['categories'][i]['subcategory'] === subcat  ) {
                //Match found
                if (state.schema.validation.properties[prop]['highlighted']) {
                  Vue.set(state.schema.validation.properties[prop],'highlighted',false);
                }else {
                  Vue.set(state.schema.validation.properties[prop],'highlighted',true);
                }
              }
            }
          }
        }
      },
      unhighlight(state){
        for (prop in state.schema.validation.properties) {
          Vue.set(state.schema.validation.properties[prop],'highlighted',false);
        }
      },
      markCompleted(state,payload){
        let selection = payload['completed'];
        for (key in state.schema.validation.properties) {
          if (key === selection.name) {
            //Check if selection has duplicates
            if (key+"s" in state.schema.validation.properties && state.schema.validation.properties[key+"s"].hasOwnProperty('duplicate') ) {
              // console.log('HAS DUPLICATE')
              let obj ={}
              Vue.set(obj,key,selection.value)
              let typeProp= key+'Type';
              Vue.set(obj,typeProp,'')
              console.log(obj)
              Vue.set(state.schema.validation.properties[key+"s"],'value',[obj]);
            }
            Vue.set(state.schema.validation.properties[selection.name],'value',selection.value);
          }
        }
      },
      clearValueOfProp(state,payload){
        let selection = payload['clear'];
        for (key in state.schema.validation.properties) {
          if (key === selection) {
            Vue.delete(state.schema.validation.properties[selection],'value');
            Vue.set(state.schema.validation.properties[selection],'selected',false);
            $.notify(selection+" was cleared",{ globalPosition: 'right',className:'success', showDuration: 40, });
          }
        }
      },
      removeArrayItemFrom(state,payload){
        let field = payload['from']; //name of prop
        let item = payload['item']; //full info
        let props = state.schema.validation.properties;

        if(typeof item === 'string'){
          for (var i = 0; i < props[field].value.length; i++){
            if (props[field].value[i] === item) {
              Vue.delete(props[field].value,i);
              $.notify(item+" removed",{ globalPosition: 'right',className:'success', showDuration: 40, });
            }
          }
        }else if (typeof item === 'object') {
          let res = _.reject(props[field].value,item)
          props[field].value=res
          $.notify("Item removed",{ globalPosition: 'right',className:'success', showDuration: 40, });
        }

      },
      addToArrayFrom(state,payload){
        let field = payload['from'];
        let item = payload['item'];
        // console.log(item)
        //Initialize array
        if (!state.schema.validation.properties[field].value) {
          Vue.set(state.schema.validation.properties[field], 'value', [])
        }
        state.schema.validation.properties[field]['value'].push(item)
      },
      formPreview(state){
        let props = state.schema.validation.properties;
        Vue.set(state,'output',{})
        Vue.set(state.output,'@type',state.schema.label || state.schema.name)
        Vue.set(state.output,'@context','http://discovery.biothings.io/')
        for (key in props) {
          if (props[key].hasOwnProperty('value') && props[key]['value']) {
            if (_.isArray(props[key]['value']) && props[key]['value'].length === 1) {
              Vue.set(state.output,key,props[key].value[0])
            }else{
              Vue.set(state.output,key,props[key].value)
            }

          }
        }
      },
      mergeCategoryProps(state,payload){
        let origin = payload['origin'];
        let catprops = payload['catprops'];
        let catpropsrequired = payload['catpropsrequired'];
        // console.log(catprops)
        // console.log(catpropsrequired)
        // console.log(origin)
        $.notify(origin+" added",{ globalPosition: 'right',className:'success', showDuration: 40, });

        // add requirements to main reqs to be able to show asterisk
        state.schema.validation.required = state.schema.validation.required.concat(catpropsrequired)

        // helper func to decide right succategory
        function getProp(propname){
          let cat={
            'category': origin,
          }
          if (catpropsrequired.includes(propname)) {
            Vue.set(cat,'subcategory','Required')
          }else{
            Vue.set(cat,'subcategory','Recommended')
          }
          return cat
        }

        // if matching add cat {name:orgin, subcategory: req/rec}
        // else add new prop with origin = name
        for (prop in catprops) {
          if (prop in state.schema.validation.properties) {
            // check if prop has guide_categories
            // if YES push new
            // if NO set-up and add
            if (state.schema.validation.properties[prop].hasOwnProperty('categories')) {
              state.schema.validation.properties[prop]['categories'].unshift(getProp(prop))
            }else{
              Vue.set(state.schema.validation.properties[prop],'categories',[])
              state.schema.validation.properties[prop]['categories'].unshift(getProp(prop))
            }
          }else if (prop.slice(0, -1)  in state.schema.validation.properties) {
            //plural form exists
            console.log(prop.slice(0, -1))

            let newProp = catprops[prop]
            Vue.set(newProp,'categories',[])
            // set origin to remove by origin
            Vue.set(newProp,'origin', origin)
            // is a duplicate
            Vue.set(newProp,'duplicate', true)

            newProp['categories'].unshift(getProp(prop))
            Vue.set(state.schema.validation.properties,prop,newProp)

          }else{
            let newProp = catprops[prop]
            Vue.set(newProp,'categories',[])
            // set origin to remove by origin
            Vue.set(newProp,'origin', origin)

            newProp['categories'].unshift(getProp(prop))
            Vue.set(state.schema.validation.properties,prop,newProp)
          }
        }

        // console.log("ALL DONE", state.schema.validation.properties)

      },
      // removeCategory(state,payload){
      //   let origin = payload['origin'];
      //   let catpropsrequired = payload['catpropsrequired'];
      //
      //   // console.log("remove",catpropsrequired)
      //   // console.log("remove",origin)
      //   $.notify(origin+" removed",{ globalPosition: 'right',className:'info', showDuration: 40, });
      //
      //   for (prop in state.schema.validation.properties) {
      //     // if origin matches remove prop
      //     if (state.schema.validation.properties[prop].hasOwnProperty('origin') && state.schema.validation.properties[prop]['origin'] === origin ) {
      //       Vue.delete(state.schema.validation.properties,prop)
      //     }else {
      //       // if not check categories and remove mention of origin
      //       if (state.schema.validation.properties[prop].hasOwnProperty('categories')) {
      //         for (var i = 0; i < state.schema.validation.properties[prop]['categories'].length; i++) {
      //           if (state.schema.validation.properties[prop]['categories'][i]['category'] === origin) {
      //             state.schema.validation.properties[prop]['categories'].splice(i,1)
      //           }
      //         }
      //       }
      //     }
      //   }
      //
      //   // console.log("ALL DONE", state.schema.validation.properties)
      //
      // },
      removeCategory(state,payload){
        let origin = payload['origin'];
        let catpropsrequired = [];

        // console.log("remove",catpropsrequired)
        // console.log("remove",origin)
        $.notify(origin+" removed",{ globalPosition: 'right',className:'info', showDuration: 40, });

        for (var i = 0; i < state.selectedPortals.length; i++) {
          if (state.selectedPortals[i]['label'] === origin) {
            catpropsrequired = state.selectedPortals[i]['validation']['required']
          }
        }

        for (prop in state.schema.validation.properties) {
          // if origin matches remove prop
          if (state.schema.validation.properties[prop].hasOwnProperty('origin') && state.schema.validation.properties[prop]['origin'] === origin ) {
            Vue.delete(state.schema.validation.properties,prop)
          }else {
            // if not check categories and remove mention of origin
            if (state.schema.validation.properties[prop].hasOwnProperty('categories')) {
              for (var i = 0; i < state.schema.validation.properties[prop]['categories'].length; i++) {
                if (state.schema.validation.properties[prop]['categories'][i]['category'] === origin) {
                  state.schema.validation.properties[prop]['categories'].splice(i,1)
                }
              }
            }
          }
        }

        // console.log("ALL DONE", state.schema.validation.properties)

      },
      setStartingPoint(state,payload){
        state.startingPoint= payload['startingPoint'];
        // console.log("startingPoint selected ",JSON.stringify(state.startingPoint,null,2))
      },
      addPortalSchema(state,payload){
        let portal = payload['portal']
        state.selectedPortals.push(portal)
        // console.log("PORTALS SELECTED ",state.selectedPortals)
      },
      changeStep(state,payload){
        state.step = payload['step']
      }
    },
    getters:{
      // exposed as store.getters.nameOfGetter
      getSchema: (state) => {
        return state.schema
      },
      getValidation: (state) => {
        if (state.schema.hasOwnProperty('validation')) {
          return state.schema.validation
        }else{
          return false;
        }
      },
      isRequired: (state) => (propname) =>{
        if (state.schema.validation.required.includes(propname)) {
          return true
        }else{
          return false
        }
      },
      getSchemaName: (state)=>{
        return state.schemaName
      },
      getValueOf: (state) => (propname) =>{
        return state.schema.validation.properties[propname].value
      },
      getTotals:(state) => {
        let completeCount = 0;
        if (state.schema.hasOwnProperty('validation')) {
          let totalprops = Object.keys(state.schema.validation.properties).length
          for (key in state.schema.validation.properties) {
            if (state.schema.validation.properties[key] && state.schema.validation.properties[key].value) {
              completeCount++;
            }
          }
          let left = totalprops - completeCount;
          if (left === 0) {
            state.complete = true
          }
          let res = {'left':left,'complete':completeCount,'total':totalprops}
          return res
        }

      },
      getCategoryTotals: (state)=>{
        let cats = {}
        if (state.schema.hasOwnProperty('validation')) {
          for (key in state.schema.validation.properties) {
            if (state.schema.validation.properties[key].hasOwnProperty('categories')) {
              for (var i = 0; i < state.schema.validation.properties[key]['categories'].length; i++) {
                let c = state.schema.validation.properties[key]['categories'][i]['category']
                if(!cats.hasOwnProperty(c)) {
                  Vue.set(cats,c,{})
                  Vue.set(cats[c],'Required',{'completed':0,'todo':0})
                  Vue.set(cats[c],'Recommended',{'completed':0,'todo':0})

                  switch (state.schema.validation.properties[key]['categories'][i]['subcategory']) {
                    case 'Required':
                      cats[c]['Required']['todo'] += 1
                      break;
                    case 'Recommended':
                      cats[c]['Recommended']['todo'] += 1
                      break;
                    default:
                  }

                }else{
                  switch (state.schema.validation.properties[key]['categories'][i]['subcategory']) {
                    case 'Required':
                      cats[c]['Required']['todo'] += 1
                      break;
                    case 'Recommended':
                      cats[c]['Recommended']['todo'] += 1
                      break;
                    default:
                  }
                }
              }
            }
          }
          // UPDATE TOTALS
          for (key in state.schema.validation.properties) {
            if (state.schema.validation.properties[key] && state.schema.validation.properties[key].value) {
              if (state.schema.validation.properties[key].hasOwnProperty('categories')) {
                for (var i = 0; i < state.schema.validation.properties[key]['categories'].length; i++) {

                  let c = state.schema.validation.properties[key]['categories'][i]['category']

                  switch (state.schema.validation.properties[key]['categories'][i]['subcategory']) {
                    case 'Required':
                      cats[c]['Required']['todo'] -= 1
                      cats[c]['Required']['completed'] += 1
                      break;
                    case 'Recommended':
                      cats[c]['Recommended']['todo'] -= 1
                      cats[c]['Recommended']['completed'] += 1
                      break;
                    default:
                  }
                }
              }
            }
          }
        }
        // console.log('CATS',JSON.stringify(cats,null,2))
        return cats
      },
      getPreview(state){
        return state.output
      },
      isComplete(state){
        let complete = false;
        if (state.schema && state.schema.hasOwnProperty('validation') && state.schema.validation.hasOwnProperty('required')) {
          let required = state.schema.validation['required']
          for (var i = 0; i < required.length; i++) {
            if (state.schema.validation.properties.hasOwnProperty(required[i]) && state.schema.validation.properties[required[i]].value) {
              complete = true
            }else{
              complete = false
              break;
            }
          }
        }
        return complete
      },
      getOutput(state){
        return state.output
      },
      getSelectedProps: (state)=>{
        let selected = {}

        for (var prop in state.schema.validation.properties) {
          if (state.schema.validation.properties[prop].hasOwnProperty('categories')) {
            for (var i = 0; i < state.schema.validation.properties[prop]['categories'].length; i++) {
              if (state.schema.validation.properties[prop]['categories'][i]['category'] === state.filter) {
                Vue.set(selected,prop,state.schema.validation.properties[prop])
              }
            }
          }
        }
        return selected
      },
      getFilter: (state)=>{
        return state.filter
      },
      getStartingPoint:(state)=>{
        return state.startingPoint
      },
      getSelectedPortals:(state)=>{
        return state.selectedPortals
      },
      getStep:(state)=>{
        return state.step
      },
      getSettings:(state)=>{
        return state.settings
      }
    },
    actions:{
      reset ({ commit }) {
        commit('reset')
      },
    }
  });

  Vue.component('chart', {
    data: function(){
      return{
        shouldHighlight:false,
        myChart : null
      }
    },
    props: ['name','totals','unique','maincategory'],
    methods:{
      visualize(){
        var self = this;
        let progressColor = self['totals']['todo'] === 0 ?"#28A744":'#17A2B7'
        let mainColor = self.name === "Required" ? "#9fa7aa":"#b4b7b8"
        self.myChart = new Chart(document.getElementById(self.unique), {
            type: 'pie',
            data: {
              labels: ["Done","To-Do"],
              datasets: [{
                backgroundColor: [progressColor,mainColor],
                data: [self.totals['completed'],self.totals['todo']]
              }]
            },
            options: {
              animation: false,
              responsive: true,
              title: {
                display: false,
                text:self.name
              },
              legend:{
                display:false
              },
              elements: {
                arc: {
                    borderWidth: 0
                }
              }
            }
        });
      },
      highlight(){
        var self = this;

        var payload = {};
        payload["category"] = self.maincategory;
        payload["subcategory"] = self.name;
        store.commit('highlight',payload);
      },
    },
    watch:{
      totals:function(n){
        this.visualize()
      },
      shouldHighlight:function(h){
        if (h) {
          this.highlight()
        }else {
          store.commit('unhighlight');
        }
      }
    },
    mounted: function(){
      this.visualize()
      tippy( '.fa-highlighter', {
        maxWidth:'200px',
        placement:'top',
        content: '<div class="text-muted m-0" style="border-radius:none">Highlight All</div>',
        animation: 'fade',
        theme:'light'});
    },
    computed: {

    },
    template:
    `<div>
      <div class="text-center">
        <small :class="[name === 'Required' ? 'text-danger': 'text-muted']">
          <span v-text="name"></span>
          <!--<span class="badge badge-pill pointer unselectable" @click="shouldHighlight = !shouldHighlight" :class="[!shouldHighlight? 'badge-dark text-warning' :'badge-warning text-dark']">
            <i class="fas fa-highlighter pointer unselectable" ></i>
          </span>-->
        </small>
      </div>
      <canvas :id=unique width="90"></canvas>
    </div>`
  });

  Vue.component('catcontainer', {
    data: function(){
      return{
        shouldHighlight:false,
        canRemove: true,
      }
    },
    props: ['cat','subcats','totals'],
    methods:{
      filterProps(cat){
        var payload = {};
        payload["cat"] = cat
        store.commit('filterProps',payload);
      },
      removeCat(){
        var self = this;
        Swal.fire({
          title: 'Are you sure you want to remove '+self.cat+'?',
          showCancelButton: true,
          animation:false,
          customClass:'scale-in-center',
          showCancelButton: true,
          confirmButtonColor:"{{color_main}}",
          cancelButtonColor:"{{color_sec}}",
          confirmButtonText: 'Yes'
        }).then((result) => {
          if (result.value) {
            var payload = {};
            payload["origin"] = self.cat
            store.commit('removeCategory',payload);
            self.added = false;
          }
        })
      },
    },
    watch:{

    },
    mounted: function(){
      // Update chart on mount
      // Chart.update()
      var self = this;
      let sp= store.getters.getStartingPoint
      if (sp.name == self.cat) {
        self.canRemove = false
      }
    },
    computed: {
      currentlySelected:function(){
        let f = store.getters.getFilter
        if (this.cat === f) {
          return true
        }else {
          return false
        }
      }
    },
    template:
    `<div class="m-1 text-center p-2 desc rounded" :data-tippy-info="cat" style="max-height:109px;outline:none !important;">
      <small  class="bold text-info d-block">
        <i v-if=" cat ==='Google'" class="fab fa-google googleText mr-1"></i>
        <span v-text="cat"></span>
        <i v-if="canRemove" class="fas fa-minus-square text-danger pointer desc" data-tippy-info="Remove" @click="removeCat()"></i>
      </small>
      <div class="d-flex justify-content-around">
        <template v-for="(totals,subcat) in subcats">
          <chart class="d-inline-block" :name="subcat" :unique="cat+subcat" :maincategory="cat" :totals="totals" :key="cat+subcat"></chart>
        </template>
      </div>
    </div>`
  });

  Vue.component('addcategory', {
    data: function(){
      return{
        added:false,
        loading: false,
        reqfields: [],
        specificSchema:{}
      }
    },
    props: ['item'],
    methods:{
      getCatData:function(){
        var self = this;
        if (!self.added) {
          self.loading = true;
          Swal.fire({
            title: 'Add '+self.item.name+' fields?',
            showCancelButton: true,
            animation:false,
            customClass:'scale-in-center',
            showCancelButton: true,
            confirmButtonColor:"{{color_main}}",
            cancelButtonColor:"{{color_sec}}",
            confirmButtonText: 'Yes, add them!'
          }).then((result) => {
            if (result.value) {
              axios.get('/api/registry/'+self.item.namespace+'/'+self.item.prefix+':'+self.item.name).then(res=>{
                self.loading = false;
                // console.log('CAT DATA', res.data)
                //save schema
                self.specificSchema=res.data
                var payload = {};
                payload["origin"] = self.item.name
                payload["catprops"] = res.data.validation.properties;
                if (res.data.validation.required) {
                  payload["catpropsrequired"] = res.data.validation.required;
                  self.reqfields = res.data.validation.required;
                }else{
                  payload["catpropsrequired"] = [];
                }
                store.commit('mergeCategoryProps',payload);
                self.added = true;

              }).catch(err=>{
                Swal.fire({
                  type: 'error',
                  position: 'center',
                  title: 'Failed because: ',
                  text: err.response.data.reason
                });
                self.loading = false;
                throw err;
              })

            }
          })

        }
      },
      removeCat(){
        var self = this;
        Swal.fire({
          title: 'Are you sure you want to remove '+self.item.name+' fields?',
          showCancelButton: true,
          animation:false,
          customClass:'scale-in-center',
          showCancelButton: true,
          confirmButtonColor:"{{color_main}}",
          cancelButtonColor:"{{color_sec}}",
          confirmButtonText: 'Yes, remove them!'
        }).then((result) => {
          if (result.value) {
            var payload = {};
            payload["origin"] = self.item.name
            payload["catpropsrequired"] = self.reqfields
            store.commit('removeCategory',payload);
            self.added = false;
          }
        })
      },
      formPreviewSpecific(){
        var self = this;
        store.commit('formPreview')
        // console.log(store.getters.getPreview)
        let output = store.getters.getPreview

        let previewObj = {}
        Vue.set(previewObj,'@type',self.item.name)
        Vue.set(previewObj,'@context','http://discovery.biothings.io/view/')

        // compare combined output and export only props found in this schema
        for (var key in output) {
          if (self.specificSchema.validation.properties.hasOwnProperty(key)) {
            // console.log('key match', key)
            Vue.set(previewObj,key,output[key])
          }
        }

        return previewObj

      },
      previewMetadata(){
        var self = this;
        let preview = self.formPreviewSpecific();
        // console.log('preview', preview)
        Swal.fire({
          position: 'center',
          confirmButtonColor:"{{color_main}}",
          cancelButtonColor:"{{color_sec}}",
          animation:false,
          footer:`<small><b>NOTE: </b>Some inputs may be missing as they do not match those specified by `+self.item.name+`</small>`,
          customClass:'scale-in-center',
          html: `<h6 class="text-center mainTextDark">`+self.item.name+` compliant structured metadata</h6><div class="text-left p-1 previewBox">
                  <small>
                    <pre>
                      `+JSON.stringify(preview,null,2)+`
                    </pre>
                  </small>
                </div>`
        });
      },
      exportSchema(){
        var self = this;
          let preview = self.formPreviewSpecific();

          Swal.fire({
            title: 'Name your file',
            input: 'text',
            inputAttributes: {
              autocapitalize: 'off'
            },
            showCancelButton: true,
            confirmButtonText: 'Download JSON-LD',
            allowOutsideClick: () => !Swal.isLoading()
          }).then((result) => {
            if (result.value) {
              self.download(JSON.stringify(preview,null,2), result.value+'.jsonld', 'text/plain')
            }
          })

      },
      download(content, fileName, contentType) {
        var a = document.createElement("a");
        var file = new Blob([content], {type: contentType});
        a.href = URL.createObjectURL(file);
        a.download = fileName;
        a.click();
      }
    },
    watch:{

    },
    mounted: function(){

      tippy( '#widget',{
          target:'.desc',
          content: 'Loading...',
          maxWidth:'200px',
          placement:'bottom',
          animation: 'fade',
          theme:'light',
          onShow(instance) {
            let info = instance.reference.dataset.tippyInfo;
            instance.setContent("<div class='text-muted m-0'>"+info+"</div>")
          }
        });
    },
    computed: {

    },
    template:
    `<div class="mr-2 w-25" :class="{'bg-secondary': !added, 'bg-light': added}">
      <div class="row m-0">
        <div class="col-sm-8 p-1 d-flex align-items-center justify-content-around desc" :data-tippy-info="item.description">
          <span :class="{'text-light': !added, 'text-info': added}">
            <i v-if="item.name ==='Google'" class="fab fa-google googleText mr-1"></i>
            <span v-text="item.name"></span>
          </span>
        </div>
        <div class="col-sm-4 p-1 bg-dark actions d-flex align-items-center justify-content-around">
          <span v-if="!added" class="p-1 desc" @click="getCatData" data-tippy-info="Add Fields">
            <i class="fas fa-plus-circle pointer text-muted"></i>
          </span>
          <span v-if="added" @click="removeCat" class="p-1 desc" data-tippy-info="Remove Fields">
            <i class="fas fa-minus-circle pointer text-danger"></i>
          </span>
          <span v-if="added" class="p-1 desc" @click="previewMetadata" :data-tippy-info="'Preview'">
            <i class="fas fa-code pointer text-success"></i>
          </span>
          <span v-if="added" class="p-1 desc" @click="exportSchema" :data-tippy-info="'Export '+item.name+' compliant structured metadata'">
            <i class="fas fa-file-export pointer text-warning"></i>
          </span>
        </div>
      </div>
    </div>`
  });




  Vue.component('input-box', {
    data: function(){
      return{
        constFound:false,
        constObj:{},
        licenseThirdQuestion:false,
        vocabTerm:'',
        vocab:Array,
        userLicense:{
          'text':'',
          'url':'',
          'description':''
        },
        canAcceptMultiple:false,
        vocabDetails:Object,
        vocabSuggestions:[],
        loading:false
      }
    },
    props: ['name','info'],
    methods:{
      markCompleted(propname){
        var self = this;

        var payload = {};
        payload["completed"] = {'name':propname,'value':self.userInput};
        store.commit('markCompleted',payload);
        //unselect after complete
        var payload = {};
        payload["select"] = '';
        store.commit('markSelected',payload);
        // store.commit('selectNext');
      },
      clearFieldFor:function(propname){
        var payload = {};
        payload["clear"] = propname;
        store.commit('clearValueOfProp',payload);
      },
      addKeyword(){
        let self = this;
        let value = self.$refs.keywordInput.value;

        if (value.includes(',')) {
          let arr = value.split(',');
          for (var i = 0; i < arr.length; i++) {
            let val = arr[i].trim();
            var payload = {};
            payload["item"] = val;
            payload["from"] = self.name;
            store.commit('addToArrayFrom',payload);
            self.$refs.keywordInput.value = '';
          }
        }else{
          var payload = {};
          payload["item"] = value;
          payload["from"] = self.name;
          store.commit('addToArrayFrom',payload);
          self.$refs.keywordInput.value = '';
        }

      },
      removeItem(name){
        let self = this;
        var payload = {};
        payload["item"] = name;
        payload["from"] = self.name;
        store.commit('removeArrayItemFrom',payload);
      },
      addPerson(type){
        let self = this;
        switch (type) {
          case "citation":
            self.addCitationModal(type)
            break;
          default:
            self.addPersonModal(type)
        }

      },
      addPersonModal(type){
        let self = this;
        Swal.mixin({
          input: 'text',
          confirmButtonText: 'Next &rarr;',
          showCancelButton: true,
          animation:false,
          customClass:'scale-in-center',
          confirmButtonColor:"{{color_main}}",
          cancelButtonColor:"{{color_sec}}",
          progressSteps: ['1', '2',]
        }).queue([
          {
            title: "Name*",
            text: "Enter the "+type+"'s full name",
            inputValidator: (value) => {
              if (!value) {
                return 'Name is a required field!'
              }
            }
          },
          {
            title: "URL",
            text: "Enter a URL for this "+type+"'s online profile (faculty page, GitHub page, Linkedin page, etc)",
            inputValidator: (value) => {
              return new Promise((resolve) => {
                function validURL(str) {
                  var pattern = new RegExp('^(https?:\\/\\/)?'+ // protocol
                    '((([a-z\\d]([a-z\\d-]*[a-z\\d])*)\\.)+[a-z]{2,}|'+ // domain name
                    '((\\d{1,3}\\.){3}\\d{1,3}))'+ // OR ip (v4) address
                    '(\\:\\d+)?(\\/[-a-z\\d%_.~+]*)*'+ // port and path
                    '(\\?[;&a-z\\d%_.~+=-]*)?'+ // query string
                    '(\\#[-a-z\\d_]*)?$','i'); // fragment locator
                  return !!pattern.test(str);
                }
                if (validURL(value)) {
                  resolve()
                } else {
                  resolve('Input must be a valid URL')
                }
              })
            }
          }

        ]).then((result) => {
          if (result.value) {
            let name='';
            let url ='';
            if (result.value[0]) {
              name = result.value[0]
            }
            if (result.value[1]) {
              url = result.value[1]
            }else{
              url = ''
            }
            if (name) {

              let person = {'name':name,'url':url};

              switch (type) {
                case 'publisher':
                  Vue.set(person,'@type','Organization')
                  break;
                case 'creator':
                  Vue.set(person,'@type','Person')
                  break;
                case 'contributor':
                  Vue.set(person,'@type','Person')
                  break;
                case 'funding':
                  Vue.set(person,'@type','Organization')
                  break;
                default:
                  Vue.set(person,'@type','Thing')
              }

              let self = this;
              var payload = {};
              payload["item"] = person;
              payload["from"] = self.name;
              store.commit('addToArrayFrom',payload);
            }else{
              $.notify("A "+type+"'s name is required",{ globalPosition: 'right',className:'error', showDuration: 40, });
            }


          }
        })
      },
      addCitationModal(type){
        let self = this;
        Swal.mixin({
          input: 'text',
          confirmButtonText: 'Next &rarr;',
          showCancelButton: true,
          confirmButtonColor:"{{color_main}}",
          cancelButtonColor:"{{color_sec}}",
          progressSteps: ['1', '2',]
        }).queue([
          {
            title: "Name*",
            text: "Enter the "+type+"'s title or name",
            inputValidator: (value) => {
              if (!value) {
                return 'Name is a required field!'
              }
            }
          },
          {
            title: "URL",
            text: "Enter a URL for this "+type+" (web page, GitHub page, Linkedin page, etc)",
            inputValidator: (value) => {
              return new Promise((resolve) => {
                function validURL(str) {
                  var pattern = new RegExp('^(https?:\\/\\/)?'+ // protocol
                    '((([a-z\\d]([a-z\\d-]*[a-z\\d])*)\\.)+[a-z]{2,}|'+ // domain name
                    '((\\d{1,3}\\.){3}\\d{1,3}))'+ // OR ip (v4) address
                    '(\\:\\d+)?(\\/[-a-z\\d%_.~+]*)*'+ // port and path
                    '(\\?[;&a-z\\d%_.~+=-]*)?'+ // query string
                    '(\\#[-a-z\\d_]*)?$','i'); // fragment locator
                  return !!pattern.test(str);
                }
                if (validURL(value)) {
                  resolve()
                } else {
                  resolve('Input must be a valid URL')
                }
              })
            }
          },
          {
            title: "Identifier",
            text: "Enter this "+type+"'s PubMed id here",
            inputValidator: (value) => {
              if (!value) {
                return 'You need to write something!'
              }
            }
          }

        ]).then((result) => {
          if (result.value) {
            let name='';
            let url ='';
            let ident = '';
            if (result.value[0]) {
              name = result.value[0]
            }
            if (result.value[1]) {
              url = result.value[1]
            }
            if (result.value[2]) {
              ident = result.value[2]
            }

            if (name) {
              let citation = {'name':name,'url':url,'identifier':ident};
              var payload = {};
              payload["item"] = citation;
              payload["from"] = self.name;
              store.commit('addToArrayFrom',payload);
            }else{
              $.notify("A "+type+"'s name is required",{ globalPosition: 'right',className:'error', showDuration: 40, });
            }


          }
        })
      },
      addItem(propName,propInfo){
        var self=this;
        let progressSteps =[]
        let questions =[]
        let vocabQ = ''

        let props = {}

        if (propInfo.hasOwnProperty('oneOf')) {
          for (var i = 0; i < propInfo['oneOf'].length; i++) {
            if (propInfo['oneOf'][i].hasOwnProperty('type') && propInfo['oneOf'][i]['type'] === 'object') {
              props = propInfo['oneOf'][i]['properties']
            }
            if (propInfo['oneOf'][i].hasOwnProperty('type') && propInfo['oneOf'][i]['type'] === 'array') {
              self.canAcceptMultiple = true
            }
            //  FOR VOCABULARY FROM ONTOLOGIES
            if (propInfo['oneOf'][i].hasOwnProperty('vocabulary') && propInfo['oneOf'][i]['type'] === 'string') {

              Swal.fire({
                title: propName,
                text: 'Search for an existing term here:',
                input: 'text',
                confirmButtonColor:"{{color_main}}",
                cancelButtonColor:"{{color_sec}}",
                animation:false,
                customClass:'scale-in-center',
                inputAttributes: {
                  autocapitalize: 'off'
                },
                showCancelButton: true,
                confirmButtonText: 'Look up',
                showLoaderOnConfirm: true,
                focusConfirm: false,
                preConfirm: (query) => {

                  let ontologies = propInfo['oneOf'][i]['vocabulary']['ontology'].toString()
                  let children = propInfo['oneOf'][i]['vocabulary']['children_of'].toString()
                  vocabQ = query

                  let url = `https://www.ebi.ac.uk/ols/api/search?q=${query}`
                  +"&ontology="+ontologies
                  +"&childrenOf="+children
                  +"&type=class&fieldList=id,iri,label,description,obo_id,short_form,ontology_prefix"
                  +"&queryFields=label"
                  +"&rows=100"

                  return fetch(url)
                    .then(response => {
                      if (!response.ok) {
                        throw new Error(response.statusText)
                      }
                      return response.json()
                    })
                    .catch(error => {
                      Swal.showValidationMessage(
                        `Request failed: ${error}`
                      )
                    })
                },
                allowOutsideClick: () => !Swal.isLoading()
              }).then((result) => {
                if (result.value) {
                  let html ="<div id='ontology' class='p-1 text-left'>";

                  for (var i = 0; i < result.value.response.docs.length; i++) {
                    tippy('#cb'+i,{
                      content:result.value.response.docs[i]
                    });

                    html += `<div class="form-check">
                                <input class="form-check-input" type="checkbox" value="`+result.value.response.docs[i]['iri']+`" id="cb`+i+`">
                                <label class="form-check-label" for="cb`+i+`">
                                    `+result.value.response.docs[i]['label']+`
                                    <i class="fa fa-info-circle text-info modaltip" data-tippy-info='`+JSON.stringify(result.value.response.docs[i])+`'></i>
                                </label>
                            </div>`
                  }
                  if (propInfo && !propInfo.strict) {
                    html += `<div class="alert alert-info mt-1">
                                <h6>Didn't find what you are looking for? Enter value here:</h6>
                                <input class="form-control" type="text" id="qTerm" value=${vocabQ}>
                            </div>`
                  }
                  html += "</div>";

                  Swal.fire({
                    title: propName+'(s):',
                    html: html,
                    confirmButtonColor:"{{color_main}}",
                    cancelButtonColor:"{{color_sec}}",
                    animation:false,
                    customClass:'scale-in-center',
                    preConfirm: () => {

                      let checked=[]

                        for (var i = 0; i < 100; i++) {
                          let x = document.getElementById("cb"+i)
                          if (x && x.checked) {
                            checked.push(x.value)
                          }
                        }
                        let y = document.getElementById("qTerm")
                        if (y.value) {
                          checked.push(y.value)
                        }
                        return checked
                    }
                  }).then((result) => {
                    if (result.value) {
                      // console.log('FINAL RES', result.value)
                      for (var i = 0; i < result.value.length; i++) {
                        var payload = {};
                        payload["item"] = result.value[i];
                        payload["from"] = propName;
                        store.commit('addToArrayFrom',payload);
                      }

                    }
                  })

                }
              })



            }
          }
        }else if (propInfo.hasOwnProperty('properties')){
          props = propInfo.properties
        }

        // Create questions
        for (key in props) {
          progressSteps.push(key)
          switch (key) {
            case 'size':
              questions.push({
                title: key,
                input: 'number',
                text: props[key].description,
                inputValidator: (value) => {
                  if (!value) {
                    return 'You should write something meanignful'
                  }else{
                    return new Promise((resolve) => {
                      function validInteger(str) {
                        var pattern = new RegExp('^[0-9]*$');
                        return !!pattern.test(str);
                      }
                      if (validInteger(value)) {
                        resolve()
                      } else {
                        resolve('Input must be an integer')
                      }
                    })
                  }
                }
              });
              break;
            case 'name':
              questions.push({
                title: key,
                text: props[key].description,
                inputValidator: (value) => {
                  if (!value) {
                    return 'Name is a required field'
                  }
                }
              });
              break;
            case 'url':
              questions.push({
                title: key,
                text: props[key].description,
                inputValidator: (value) => {
                  return new Promise((resolve) => {
                    function validURL(str) {
                      var pattern = new RegExp('^(https?:\\/\\/)?'+ // protocol
                        '((([a-z\\d]([a-z\\d-]*[a-z\\d])*)\\.)+[a-z]{2,}|'+ // domain name
                        '((\\d{1,3}\\.){3}\\d{1,3}))'+ // OR ip (v4) address
                        '(\\:\\d+)?(\\/[-a-z\\d%_.~+]*)*'+ // port and path
                        '(\\?[;&a-z\\d%_.~+=-]*)?'+ // query string
                        '(\\#[-a-z\\d_]*)?$','i'); // fragment locator
                      return !!pattern.test(str);
                    }
                    if (validURL(value)) {
                      resolve()
                    } else {
                      resolve('Input must be a valid URL')
                    }
                  })
                }
              })
              break;
            case 'dateModified' || 'datePublished':
              questions.push({
                title: key,
                inputAttributes: {
                  id:'hideThis'
                },
                html: '<input type="date" id="datePicked"/>',
                onOpen: ()=>{
                  document.getElementById("hideThis").classList.add('d-none');
                },
                preConfirm: () => {
                  return document.getElementById('datePicked').value
                },
              })
              break;
            default:
            questions.push({
              title: key,
              text: props[key].description,
              footer:`<small>If applicable: mutliple items must be separated by commmas</small>`,
              inputValidator: (value) => {
                if (!value) {
                  return 'You should write something meanignful'
                }
              }
            });
          }
        }

        let arr = [] //modal header steps
        for (var i = 0; i < progressSteps.length; i++) {
          arr.push(i+1)
        }

        Swal.mixin({
          input: 'text',
          confirmButtonText: 'Next &rarr;',
          showCancelButton: true,
          confirmButtonColor:"{{color_main}}",
          cancelButtonColor:"{{color_sec}}",
          animation:false,
          customClass:'scale-in-center',
          progressSteps: arr
        }).queue(questions).then((result) => {
          if (result.value) {
            let obj = {}
            switch (propName) {
              case 'creator':
                Vue.set(obj,'@type','Person')
                break;
                case 'contributor':
                  Vue.set(obj,'@type','Person')
                  break;
                  case 'publisher':
                    Vue.set(obj,'@type','Organization')
                    break;
                    case 'funding':
                      Vue.set(obj,'@type','Organization')
                      break;
              default:
            }
            for (var i = 0; i < progressSteps.length; i++) {
              if (result.value[i].includes(",")) {
                let val = result.value[i].split(',');
                Vue.set(obj,progressSteps[i],val)
              }else{
                if (props[progressSteps[i]].hasOwnProperty('type') && props[progressSteps[i]]['type']==='integer') {
                  let val = parseInt(result.value[i]);
                  Vue.set(obj,progressSteps[i],val)
                }else{
                  let val = result.value[i];
                  Vue.set(obj,progressSteps[i],val)
                }
              }
            }

            if (propInfo && propInfo['oneOf'][0].hasOwnProperty('vocabulary')){
              //if its a vocab enum field do nothing. separate modal will launch
            }else {
              var payload = {};
              payload["item"] = obj;
              payload["from"] = propName;
              store.commit('addToArrayFrom',payload);
            }

          }
        })
      },
      checkForConstantKey(obj, keyname, parentkey) {
        var self=this;
        _.mapKeys(obj, function(value, key) {
          if (key === keyname) {
            self.constFound = true;
            Vue.set(self.constObj, parentkey, value)
          }
          if (typeof value === 'object') {
            self.checkForConstantKey(value,keyname,key)
          }
        });

      },
      getLicense(specialCase){
        let self = this;
        let question1 = this.$refs.license1.value;
        let question2 = this.$refs.license2.value;

        if (specialCase) {
          switch (specialCase) {
            case 'No':
              self.userLicense.description = 'No Rights Reserved';
              self.userLicense.url = 'https://creativecommons.org/share-your-work/public-domain/cc0/';
              self.userLicense.text = 'CC0';
              break;
            case "Yes":
              self.userLicense.description = 'Attribution 4.0 International';
              self.userLicense.url = 'http://creativecommons.org/licenses/by/4.0/';
              self.userLicense.text = 'CC BY 4.0';
              break;
            default:
              self.userLicense.description = "We had trouble with your input, please try this link:";
              self.userLicense.text = '';
              self.userLicense.url = 'https://creativecommons.org/choose/';
              self.thirdQuestion = false;
              break;
          }
        }else{
          switch (question1+'|'+question2) {
            case "Yes|Yes":
              // Special Case
              self.licenseThirdQuestion = true;
              let question3 = this.$refs['license3'].value;
              self.getLicense(question3);
              break;
            case "No|Yes":
              self.userLicense.description = 'Attribution-NoDerivatives 4.0 International';
              self.userLicense.url = 'http://creativecommons.org/licenses/by-nd/4.0/';
              self.userLicense.text = 'CC BY-ND 4.0';
              self.licenseThirdQuestion = false;
              break;
            case "Yes, as long as others share alike|Yes":
              self.userLicense.description = 'Attribution-ShareAlike 4.0 International';
              self.userLicense.url = 'http://creativecommons.org/licenses/by-sa/4.0/';
              self.userLicense.text = 'CC BY-SA 4.0';
              self.licenseThirdQuestion = false;
              break;
            case "Yes|No":
              self.userLicense.description = 'Attribution-NonCommercial 4.0 International';
              self.userLicense.url = 'http://creativecommons.org/licenses/by-nc/4.0/';
              self.userLicense.text = 'CC BY-NC 4.0';
              self.licenseThirdQuestion = false;
              break;
            case "No|No":
              self.userLicense.description = 'Attribution-NonCommercial-NoDerivatives 4.0 International';
              self.userLicense.text = 'CC BY-NC-ND 4.0';
              self.userLicense.url = 'http://creativecommons.org/licenses/by-nc-nd/4.0/';
              self.licenseThirdQuestion = false;
              break;
            case "Yes, as long as others share alike|No":
              self.userLicense.description = 'Attribution-NonCommercial-ShareAlike 4.0 International';
              self.userLicense.text = 'CC BY-NC-SA 4.0';
              self.userLicense.url = 'http://creativecommons.org/licenses/by-nc-nd/4.0/';
              self.licenseThirdQuestion = false;
              break;
            default:
              self.userLicense.description = "We had trouble with your input, please try this link:";
              self.userLicense.text = '';
              self.userLicense.url = 'https://creativecommons.org/choose/';
              self.licenseThirdQuestion = false;
              break;
          }
        }
      },
      getVocabulary(){
        var self=this;
        let obj = self.info

        if (obj.hasOwnProperty('vocabulary')) {
          try {
            let query = self.vocabTerm
            let ontologies = obj['vocabulary']['ontology'].toString()
            let children = obj['vocabulary']['children_of'].toString()

            // AUTOSUGGEST

            // self.loading = true;
            //
            // axios.get("http://www.ebi.ac.uk/ols/api/suggest?q="+query+"&ontology="+ontologies+"&rows=5").then(res=>{
            //   self.vocabSuggestions = res.data.response.docs;
            //   self.loading = false;
            // }).catch(err=>{
            //   throw err;
            // });

            let url = "https://www.ebi.ac.uk/ols/api/search?q="+query
            +"&ontology="+ontologies
            +"&childrenOf="+children
            +"&type=class&fieldList=id,iri,label,description,obo_id,short_form,ontology_prefix"
            +"&queryFields=label"
            +"&rows=100"

            self.loading = true;

            axios.get(url).then(res=>{
              // console.log('result VOCAB',res.data.response)
              if (res.data.response.hasOwnProperty('docs')&& res.data.response.docs.length >= 1) {
                self.vocab= res.data.response.docs
                self.loading = false;
                // console.log('res',self.vocab.length)
              }else{
                self.vocab= []
              }

            }).catch(err=>{
              self.vocab= []
              throw err;
            });
          } catch (e) {

          }
        }
      }
    },
    watch:{
      constObj:{
        handler(obj){
          var payload = {};
          payload["completed"] = {'name':this.name,'value':obj};
          store.commit('markCompleted',payload);
        },
        deep:true
      },
      vocabTerm(term){
        this.getVocabulary()
      }
    },
    mounted: function(){
      var self = this

      self.checkForConstantKey(self.info,'const')

      try {
        var x = document.getElementsByClassName("form-control");
        x[0].focus();
      } catch (e) {
        var x = document.getElementsByClassName("btnfocus");
        x[0].focus();
      }

      // document.onkeydown = checkKey;

      // function checkKey(e) {
      //     e = e || window.event;
      //     if (e.keyCode == '39') {
      //        // right arrow
      //        self.markCompleted(self.name);
      //        store.commit('selectNext');
      //     }
      // }

      tippy( '.save', {
        placement:'top',
        maxWidth:'200px',
        content: '<div class="text-success m-0" style="border-radius:none">Done</div>',
        animation: 'fade',
        theme:'light'});

      tippy( '.required', {
        maxWidth:'200px',
        placement:'top',
        content: '<div class="text-danger m-0" style="border-radius:none">This field is required</div>',
        animation: 'fade',
        theme:'light'});

      tippy( '.delete', {
        maxWidth:'200px',
        placement:'top',
        content: '<div class="text-danger m-0" style="border-radius:none">Clear</div>',
        animation: 'fade',
        theme:'light'});

      tippy( '#masterForm', {
          target:'.inputpreview',
          content: 'Loading...',
          maxWidth:'200px',
          placement:'left',
          animation: 'fade',
          theme:'light',
          onShow(instance) {
            let info = instance.reference.dataset.tippyInfo;
            instance.setContent("<div class='text-muted m-0 text-left wraptext'><pre>"+info+"</pre></div>")
          }
        });

        tippy( '#widget', {
            target:'.info',
            content: 'Loading...',
            maxWidth:'200px',
            placement:'left',
            animation: 'fade',
            theme:'light',
            onShow(instance) {
              let info = instance.reference.dataset.tippyInfo;
              instance.setContent("<div class='text-muted m-0'>"+info+"</div>")
            }
          });

    },
    computed: {
      isRequired:function(){
        return store.getters.isRequired(this.name)
      },
      userInput: {
        get () {
          return this.$store.state.schema.validation.properties[this.name].value
        },
        set (newValue) {
          var payload = {};
          payload["completed"] = {'name':this.name,'value':newValue};
          store.commit('markCompleted',payload);
        }
      },
      datePreset:function(){
        if (this.$store.state.schema.validation.properties.hasOwnProperty('datePublished') && this.$store.state.schema.validation.properties['datePublished'].value) {
          return this.$store.state.schema.validation.properties['datePublished'].value
        }else if (this.$store.state.schema.validation.properties.hasOwnProperty('dateModified') && this.$store.state.schema.validation.properties['dateModified'].value) {
          return this.$store.state.schema.validation.properties['dateModified'].value
        }else{
          return false;
        }
      }
    },
    template:
    `<div class="m-2 inputbox fade-in" :id='name'>
      <div class="row">
        <div class="col-sm-12 text-center text-muted">
          <div class="w-75 m-auto">
            <div class="w-100 text-center">
              <h4 v-text="name" class="text-muted bold pointer mr-1 d-inline"></h4>
              <i class="fas fa-asterisk text-danger required pointer unselectable" v-if="isRequired"></i>
            </div>
            <small>
              <span v-text='info.description || "No description provided"'></span>
            </small>
          </div>
        </div>
        <div class="col-sm-2 categoryBox d-flex align-items-center justify-content-center flex-wrap" :class="[userInput ? 'alert-success':'alert-secondary']">
          <div class="text-left p-1">
            <small class="text-muted bold">Part of</small>
            <template v-if="info && info.categories" v-for="category in info.categories">
              <small v-text="category.category" class="d-block desc pointer" :data-tippy-info="[category.subcategory === 'Required' ? 'Required' : 'Recommended']" :class="[category.subcategory === 'Required' ? 'text-danger' : 'text-info']"></small>
            </template>
          </div>
        </div>
        <div class="col-sm-8 p-2 text-left d-flex align-items-center justify-content-center" :class="[userInput ? 'alert-success':'alert-secondary']">
          <div class="d-flex w-100 justify-content-center">
            <div class="w-75 p-3">
              <h6 v-show="loading" class="text-primary">Loading <i class="fas fa-spinner fa-pulse"></i></h6>
              <!-- INPUT   TYPES -->
              <template v-if="info && info.type === 'string'">
                <!--  STRING  -->
                <template v-if="info && !info.format">
                  <!--  STRING VOCABULARY -->
                  <template v-if="info && info.vocabulary">
                    <small>Input <b v-text="info.vocabulary && !info.vocabulary.strict ? 'CAN' : 'MUST' "></b> be from existing ontology terms.</small>
                    <div class="input-group">
                      <div class="input-group-prepend">
                        <div class="input-group-text bg-secondary text-light"><i class="fas fa-search"></i></div>
                      </div>
                      <input :required="isRequired" type="text" v-model="vocabTerm" class="form-control form-control-sm mousetrap" :placeholder="userInput? userInput:'Type to begin search' " id="stringInput" list="suggestionlist">
                    </div>
                    <datalist id="suggestionlist">
                      <template v-for="item in vocabSuggestions">
                        <option :value="item.autosuggest" @click="vocabTerm=item.autosuggest;vocabSuggestions=[]">
                      </template>
                    </datalist>
                    <div v-show="vocabTerm" class="alert alert-light optionBox">
                      <small><b class="text-primary" v-text="'('+vocab.length+')'"></b> Existing results related to: <i v-text='vocabTerm'></i></small>
                      <template v-if="vocab.length" v-for="(item,i) in vocab">
                        <div class="form-check">
                          <input class="form-check-input mousetrap" type="radio" name="exampleRadios" :id="i" :value="item.iri" @click='userInput=item.iri;vocabDetails=item' v-model="userInput">
                          <label class="form-check-label" :for="i">
                            <span v-text='item.label' ></span>
                            <i v-if="userInput && userInput === item.iri" class="fas fa-check text-success"></i>
                          </label>
                        </div>
                      </template>
                      <template v-if="info.vocabulary && !info.vocabulary.strict ">
                        <div class="alert alert-warning">
                          <h6>Didn't find what you are looking for?</h6>
                          <p class="text-muted">
                            Just use <b class="pointer text-success" v-text="vocabTerm" @click="userInput=vocabTerm;vocabDetails={}"></b>
                          </p>
                        </div>
                      </template>
                    </div>
                  </template>
                  <!--  STRING NORMAL -->
                  <template v-else>
                    <textarea :rows="name ==='name'?1:7" type="text" v-model="userInput" class="form-control form-control-sm mousetrap" placeholder="enter text here"></textarea>
                  </template>
                    <!--  VOCAB PREVIEW -->
                  <template v-if="vocabDetails && vocab.length && vocabDetails.ontology_prefix">
                    <div class="alert alert-info optionBox">
                      <h6>
                        <span v-text='vocabDetails.label' class="bold"></span>
                        <template v-if="vocabDetails && vocabDetails.short_form">
                          (<small v-text='vocabDetails.short_form' ></small>)
                        </template>
                      </h6>
                      <table>
                        <tbody>
                          <tr>
                            <td>
                              <div class="pillType d-block m-1">
                                <span class="mainBackDark" style="font-size:1em;">Ontology</span>
                                <span style="font-size:1em;">
                                  <a :href="vocabDetails.iri" v-text="vocabDetails.ontology_prefix" rel="nonreferrer" target="_blank"></a>
                                </span>
                              </div>
                            </td>
                          </tr>
                          <tr>
                            <td>
                              <div class="pillType d-block m-1">
                                <span class="mainBackLight" style="font-size:1em;">ID</span>
                                <span style="font-size:1em;">
                                  <a :href="vocabDetails.iri" v-text="vocabDetails.obo_id" rel="nonreferrer" target="_blank"></a>
                                </span>
                              </div>
                            </td>
                          </tr>
                          <tr v-if="vocabDetails && vocabDetails.description">
                            <td>
                              <small v-html="vocabDetails.description[0]"></small>
                            </td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                  </template>
                </template>
                <!--  URL  -->
                <template v-if="info && info.format === 'uri'">
                  <input type="url" v-model="userInput" class="form-control form-control-sm mousetrap" placeholder="enter url here">
                </template>
              </template>
              <!--  ENUM  -->
              <template v-if="info && info.enum" v-for="(item,i) in info.enum">
                <div class="form-check">
                  <input class="form-check-input mousetrap" type="radio" name="exampleRadios" :id="i" :value="item" @click='userInput=item' v-model="userInput">
                  <label class="form-check-label" :for="i" v-text='item'></label>
                </div>
              </template>
              <!--  LICENSE  -->
              <template v-if="info.type=== 'object' && name === 'license'">
                <form id="licenseForm" class="p-1" v-if="!userInput">
                  <small class="text-muted">Allow commercial uses of your work?</small>
                  <select @change="getLicense()" ref="license1" class="form-control form-control-sm" id="ControlSelect1">
                    <option selected>Choose...</option>
                    <option value="Yes">Yes</option>
                    <option value="No">No</option>
                    <option value="Yes, as long as others share alike">Yes, as long as others share alike</option>
                  </select>
                  <small class="text-muted">Allow commercial uses of your work?</small>
                  <select @change="getLicense()" ref="license2" class="form-control form-control-sm" id="ControlSelect2" required="">
                    <option selected>Choose...</option>
                    <option value="Yes">Yes</option>
                    <option value="No">No</option>
                  </select>
                  <div v-show='licenseThirdQuestion'>
                    <small class="text-muted">Impose legal requirement for attribution?</small>
                    <select @change="getLicense()" ref="license3" class="form-control form-control-sm" id="ControlSelect3" required="">
                      <option selected>Choose...</option>
                      <option value="Yes">Yes</option>
                      <option value="No">No</option>
                    </select>
                  </div>
                </form>
                <template v-if="userLicense.text && !userInput">
                  <div class="alert alert-success text-center mt-3">
                    <h6 v-text="userLicense.text"></h6>
                    <p>
                      <small v-text="userLicense.description"></small>
                    </p>
                    <small>
                      <a :href="userLicense.url" target="_blank" v-text="'Learn More About '+userLicense.text"></a>
                    </small>
                  </div>
                </template>
                <template v-if="userInput && userInput.text">
                  <div class="alert alert-success text-center mt-3">
                    <small><b>License Chosen:</b> </small>
                    <h6 v-text="userInput.text"></h6>
                    <p>
                      <small v-text="userInput.description"></small>
                    </p>
                    <small>
                      <a :href="userInput.url" target="_blank" v-text="'Learn More About '+userInput.text"></a>
                    </small>
                    <hr />
                  </div>
                </template>
                <div class="text-center p-1" v-if="userLicense.text && !userInput">
                  <button class="btn btn-success" @click="userInput=userLicense">Use This License</button>
                </div>
              </template>

              <!--   KEYWORDS  -->
              <template v-if="info.type=== 'array' && name === 'keywords'">
                <div class="form-group p-2 row">
                  <div class="col-sm-12 mb-2">
                    <form @submit.prevent="addKeyword">
                      <small class="text-muted">Enter single or multiple keywords separated by commas</small>
                      <input ref="keywordInput" autocomplete="off" type="text" class="form-control form-control-sm mousetrap" placeholder="Enter text here">
                    </form>
                  </div>
                  <div class="col-sm-12 m-auto">
                    <template v-for="text in userInput">
                      <span title="Delete"  class="badge kwbadge badge-success mr-1 pointer slit-in-vertical" title="remove">
                        <span v-html="text"></span>
                        <span style="opacity:0;" class="d-inline" @click.prevent="removeItem(text)"> <i class="fas fa-times"></i></span>
                      </span>
                    </template>
                  </div>
                  <div class="alert alert-success m-3 w-75" v-show="userInput">
                    <small><b>Saved Keywords:</b> </small>
                    <template v-for="(text,i) in userInput">
                      <small v-html="text"></small>
                      <small v-if="i !== userInput.length-1">, </small>
                    </template>
                  </div>
                </div>
              </template>

              <!--   CONSTANT DATA CATALOG  -->
              <template v-if="info.type=== 'object' && name === 'includedInDataCatalog'">
                <div class="text-center">
                  <div class="text-center bold text-info" v-if="constFound">
                    <small class="bold m-auto">Fixed Value, No Action Needed</small>
                  </div>
                  <div class='alert alert-success m-auto w-75'>
                  <p v-for="(item,index) in userInput" class="m-0">
                    <small class="bold" v-text='index'></small>:<small v-text='item'></small>
                  </p>
                  </div>
                </div>
              </template>
              <!--   OBJECT  -->
              <template v-if="info.type=== 'object' && name !== 'license' && name !== 'includedInDataCatalog' ">
                <div class="form-group p-2 row">
                  <button class="btn themeButton text-light m-auto btnfocus" @click="addItem(name,info)" v-if="info.type=== 'object' && !userInput">
                    <i class="fas fa-plus"></i> <span v-text="'Add '+name"></span>
                  </button>
                </div>
                <div class="col-sm-12 m-auto">
                  <template v-for="(person,i) in userInput">
                    <span :data-tippy-info='JSON.stringify(person,null,2)' :data-tippy-id='i'  class="badge kwbadge badge-success mr-1 pointer slit-in-vertical desc" title="remove">
                      <i class="fas fa-circle"></i>
                      <span v-text="name+' '+(i+1)"></span>
                      <span style="opacity:0;" class="d-inline" @click="removeItem(person)"> <i class="fas fa-times"></i></span>
                    </span>
                  </template>
                </div>
              </template>
              <!--   ONE OF  -->
              <template v-if="info.oneOf">
                <!--   ONE OF ANYTHING -->
                <template v-if="name !== 'datePublished' && name !== 'dateModified'">
                  <div class="form-group p-2 row">
                    <button class="btn themeButton text-light m-auto btnfocus" @click="addItem(name,info)" v-if="!userInput || canAcceptMultiple">
                      <i class="fas fa-plus"></i> <span v-text="'Add new '+name"></span>
                    </button>
                  </div>
                  <div class="col-sm-12 m-auto">
                    <template v-for="(person,i) in userInput">
                      <span :data-tippy-info='JSON.stringify(person,null,2)' :data-tippy-id='i'  class="badge kwbadge badge-success mr-1 pointer slit-in-vertical desc" title="remove">
                        <i class="fas fa-circle"></i>
                        <span v-text="name+' '+(i+1)"></span>
                        <span style="opacity:0;" class="d-inline" @click="removeItem(person)"> <i class="fas fa-times"></i></span>
                      </span>
                    </template>
                  </div>
                </template>

                <!--   ONE OF  VOCABULARY
                <template v-if="info.oneOf && info.oneOf[0].vocabulary">
                  <input-box :name="name" :info="info.oneOf[0]"></input-box>
                </template> -->

                <!--   ONE OF  DATES -->
                <template v-if="name === 'datePublished' || name === 'dateModified'">
                  <div v-if="datePreset && !userInput" class="p-2">
                    <small>Dates used:</small>
                    <small class="badge badge-info pointer m-1" v-text="'Click to use '+datePreset" @click="userInput=datePreset"></small>
                  </div>
                  <template v-for="(item,i) in info.oneOf">
                    <div>
                      <template v-if="item.format === 'date'">
                        <input type="date" v-model="userInput" class="form-control form-control-sm mousetrap" :placeholder="'enter '+item.format">
                      </template>
                      <template v-if="item.type === 'string' && !item.format">
                        <input  type="text" v-model="userInput" class="form-control form-control-sm mousetrap" :placeholder="'enter '+item.type">
                      </template>
                    </div>
                  </template>
                </template>

              </template>
            </div>
          </div>
        </div>
        <div class="col-sm-2 p-2 bg-dark actions d-flex align-items-center justify-content-around">
          <span class="fa-stack fa-1x pointer save" @click="markCompleted(name)" v-show="userInput">
            <i class="fas fa-circle text-success back fa-stack-2x"></i>
            <i class="fas fa-check fa-stack-1x text-light"></i>
          </span>
          <span class="fa-stack fa-1x pointer delete" @click="clearFieldFor(name)" v-show="info && info.value">
            <i class="fas fa-circle text-muted fa-stack-2x"></i>
            <i class="fas fa-times fa-stack-1x text-light"></i>
          </span>
        </div>
      </div>
    </div>`
  });

  Vue.component('propcontainer', {
    data: function(){
      return{
        settings: {{guide_settings}},
        allMode: Boolean
      }
    },
    props: ['type'],
    methods:{
      isRequired(propname){
        let req = store.getters.getValidation['required']
        if (req.includes(propname)) {
          return true
        }else{
          return false
        }
      },
      nextStep(){
        var self = this;
        if (self.type === "REQUIRED") {
          let payload = {}
          payload["step"] = 4;
          store.commit('changeStep',payload);
        }else{
          if (self.isComplete) {
            let payload = {}
            payload["step"] = 5;
            store.commit('changeStep',payload);
          }else{
            $.notify("Incomplete",{ globalPosition: 'right',className:'error', showDuration: 40, });
          }
        }
      },
      selectProp(propname){
        var payload = {};
        payload["select"] = propname;
        store.commit('markSelected',payload);
      },
      checkSettings(){
        var self = this;
        if (self.settings && self.settings.hasOwnProperty('form-mode')) {
          self.allMode = self.settings['form-mode']
        }else{
          self.allMode = false
        }
      },
      goToStep(s){
        var self = this;
        let payload = {}
        payload["step"] = s;
        store.commit('changeStep',payload);
      }
    },
    watch:{

    },
    mounted: function(){
      this.checkSettings();
    },
    computed: {
      validation:function(){
        return store.getters.getValidation
      },
      isComplete:function(){
        return store.getters.isComplete
      },
      categoryTotals:function(){
        let totals = store.getters.getCategoryTotals
        return totals
      },
      totals:function(){
        return store.getters.getTotals
      },
      fieldsleft:function(){
        let v = store.getters.getValidation
        let n = 0
        for (var  key in v["properties"]) {
          if (!v["properties"][key]['value']) {
            n += 1
          }
        }
        return n
      },
      step: function(){
        return store.getters.getStep
      }
    },
    template:
    `<div class="">
      <div class="row">
        <div class="col-sm-12 col-md-8">


          <div class="d-flex justify-content-around align-items-center">
            <h1 class="d-inline mr-5 bold" v-text="type" :class="type === 'REQUIRED' ?'text-danger':'text-info'"></h1>
            <div>
              <small class="text-muted">CHANGE VIEW </small> <button class="btn btn-sm themeButton text-light" v-text="!allMode ? 'ALL' : '1 BY 1'" @click="allMode = !allMode"></button>
            </div>
          </div>

          <template v-if="allMode && validation">
            <!--   ALL MODE  -->
            <div class="p-3 rounded" style="border:2px solid rgb(230, 230, 230)">
              <template v-if="type === 'REQUIRED' ">
                <template v-for="(prop,index) in validation.properties" v-if="isRequired(index)">
                  <input-box :name='index' :info="prop" :key='index'></input-box>
                </template>
              </template>
              <template v-if="type === 'RECOMMENDED' ">
                <template v-for="(prop,index) in validation.properties" v-if="!isRequired(index)">
                  <input-box :name='index' :info="prop" :key='index'></input-box>
                </template>
              </template>
            </div>
          </template>

          <template v-if="!allMode && validation">
            <!--   1 BY 1 MODE  -->
            <!--   TODO  -->
            <div class="p-1 bg-dark text-left mb-0">
              <span class="badge m-1 badge-dark text-warning">
                TO-DO <i class="fas fa-chevron-right"></i>
              </span>
              <template v-if="type === 'REQUIRED' ">
                <template v-for="(prop,index) in validation.properties" v-if="isRequired(index)">
                  <span class="badge badge-dark m-1 pointer badgeDesc font-weight-normal slit-in-vertical" @click='selectProp(index)' v-if="prop && !prop.value" :class="{'highlight': prop.highlighted}">
                    <span v-text='index'></span>
                    <i class="fas fa-asterisk text-danger required pointer unselectable" v-if="isRequired(index)"></i>
                  </span>
                </template>
              </template>
              <template v-if="type === 'RECOMMENDED' ">
                <template v-for="(prop,index) in validation.properties" v-if="!isRequired(index)">
                  <span class="badge badge-dark m-1 pointer badgeDesc font-weight-normal slit-in-vertical" @click='selectProp(index)' v-if="prop && !prop.value" :class="{'highlight': prop.highlighted}">
                    <span v-text='index'></span>
                  </span>
                </template>
              </template>
            </div>
            <!--   DONE  -->
            <div class="p-1 alert-success text-left mb-0">
              <span class="badge m-1 badge-light text-success">
                DONE <i class="fas fa-chevron-right"></i>
              </span>
              <template v-if="type === 'REQUIRED' ">
                <template v-for="(prop,index) in validation.properties" v-if="isRequired(index)">
                  <small class="m-1 text-success pointer desc" @click='selectProp(index)' v-if="prop && prop.value" :class="{'highlight': prop.highlighted}" data-tippy-info="Edit">
                    <i class="fas fa-check-circle text-success"></i> <span v-text='index'></span>
                    <i class="fas fa-asterisk text-danger required pointer unselectable" v-if="isRequired(index)"></i>
                  </small>
                </template>
              </template>
              <template v-if="type === 'RECOMMENDED' ">
                <template v-for="(prop,index) in validation.properties" v-if="!isRequired(index)">
                  <small class="m-1 text-success pointer desc" @click='selectProp(index)' v-if="prop && prop.value" :class="{'highlight': prop.highlighted}" data-tippy-info="Edit">
                    <i class="fas fa-check-circle text-success"></i> <span v-text='index'></span>
                  </small>
                </template>
              </template>
            </div>
            <div>
              <template v-if="validation.properties" v-for="(prop,index) in validation.properties">
                <input-box v-if='prop && prop.selected' :name='index' :info="prop" :key='index'></input-box>
              </template>
            </div>
          </template>

        </div>
        <div class="col-sm-12 col-md-4">
          <template v-if="categoryTotals" v-for="(subcats,cat) in categoryTotals">
            <catcontainer class="fade-in" :cat="cat" :subcats="subcats" :key="cat+subcats"></catcontainer>
          </template>
        </div>
        <div class="col-sm-12 text-right mt-2 rounded p-1" :class="{'bg-success':isComplete, 'bg-warning': !isComplete}">
          <div class="bg-light p-2 rounded">
            <template v-if="type === 'REQUIRED' && isComplete ">
              <small class="text-success bold">Ready to proceed!</small>
              <button class="btn themeButton text-light" @click="nextStep()" :class="{'heartbeat':isComplete}" :disabled="!isComplete">NEXT</button>
            </template>
            <template v-if="type === 'REQUIRED' && !isComplete ">
              <small class="text-danger bold">Complete ALL requirements to proceed!</small>
              <button class="btn themeButton text-light" @click="nextStep()" :class="{'heartbeat':isComplete, 'notallowed': !isComplete}" :disabled="!isComplete">NEXT</button>
            </template>

            <template v-if="type === 'RECOMMENDED' ">
              <small v-show="fieldsleft !== 0" class="text-info">Complete as many recommended fields as possible <b class="text-danger">ONLY <span v-text="fieldsleft"></span> LEFT!</b></small>
              <small v-show="fieldsleft === 0" class="text-success bold">Great job! Ready to proceed!</small>
              <button class="btn btn-danger text-light mr-3 ml-3" @click="goToStep(step-1)"><i class="fas fa-chevron-left"></i> BACK</button>
              <button class="btn themeButton text-light" @click="nextStep()">NEXT <i class="fas fa-chevron-right"></i></button>
            </template>
          </div>
        </div>
      </div>
    </div>`
  });




  var app = new Vue({
      el: '#guide',
      store: store,
			data: function(){
				return {
          userInfo:null,
          loading: false,
          presets:{{guide_presets}},
          portals: {{guide_portals}},
				}
			},
      computed:{
        validation:function(){
          return store.getters.getValidation
        },
        isComplete:function(){
          let res = store.getters.isComplete
          if (res) {
            $.notify.addStyle('trophy', {
              html: `<div class="bg-dark p-1 text-light">
                  <i class="fas fa-thumbs-up text-success"></i> <span data-notify-text/>
                </div>`,
                classes: {
                  base: {
                    "white-space": "nowrap",
                    "background-color": "#343a40",
                    "padding": "5px",
                    "color":'white',
                    "border-radius":"5px"
                  }
                }
            });
            // id is the id of the chart
            $("#registerReady").notify("Available Now",{style:'trophy', showDuration: 40, placement:'top'});
          }
          return res
        },
        totals:function(){
          return store.getters.getTotals
        },
        categoryTotals:function(){
          let totals = store.getters.getCategoryTotals
          return totals
        },
        selectedProps: function(){
          return store.getters.getSelectedProps
        },
        filter: function(){
          return store.getters.getFilter
        },
        startingPoint: function(){
          return store.getters.getStartingPoint
        },
        step: function(){
          return store.getters.getStep
        },
        fieldsleftRegistration:function(){
          let v = store.getters.getValidation
          let n = 0
          for (var  key in v["properties"]) {
            if (!v["properties"][key]['value']) {
              n += 1
            }
          }
          return n
        }
      },
      watch:{
        step:function(s){
          if (s === '5') {
            store.getters.getCategoryTotals
            store.getters.getTotals
          }
        }
      },
			methods:{
        checkUser(){
          let self = this;
          self.loading = true;
          $.ajax({url: "/user", success: function(result){
              self.loading = false;
             self.userInfo = result;
          },
          cache: false});
        },
        getAndLoadSchema(url){
          var self = this;
          self.loading = true;
          axios.get(url).then(res=>{
            self.loading = false;
            var payload = {};
            payload["schema"] = res.data;
            store.commit('saveSchema',payload);

          }).catch(err=>{
            self.loading = false;
            $.notify("Failed to load schema",{ globalPosition: 'right',className:'error', showDuration: 40, });
            throw err;
          })
        },
        // getStartingPointSchema(url,schemaName){
        //   let self = this;
        //   self.loading = true;
        //   axios.get("/api/view?url="+url).then(res=>{
        //
        //     var payload = {};
        //     payload["name"] = schemaName;
        //     store.commit('saveSchemaName',payload);
        //
        //     self.parseData(res.data)
        //
        //     self.loading = false;
        //   }).catch(err=>{
        //     self.loading = false;
        //     throw err;
        //   })
        // },
        getStartingPointSchema(item){
          let self = this;
          self.loading = true;
          axios.get('/api/registry/'+item.namespace+'/'+item.prefix+':'+item.name).then(res=>{
            var payload = {};
            payload["name"] = item.name;
            store.commit('saveSchemaName',payload);
            self.parseData(res.data)

            // IF ANY PORTALS AND IF ANY ARE SELECTED
            if (self.portals && self.portals.length) {
              for (var i = 0; i < self.portals.length; i++) {
                if (self.portals[i]['selected']) {
                  axios.get('/api/registry/'+self.portals[i].namespace+'/'+self.portals[i].prefix+':'+self.portals[i].name).then(result=>{

                    var payload = {};
                    payload["portal"] = result.data;
                    store.commit('addPortalSchema',payload);

                    var payload = {};
                    payload["origin"] = result.data.label
                    payload["catprops"] = result.data.validation.properties;
                    if (result.data.validation.required) {
                      payload["catpropsrequired"] = result.data.validation.required;
                      self.reqfields = result.data.validation.required;
                    }else{
                      payload["catpropsrequired"] = [];
                    }
                    store.commit('mergeCategoryProps',payload);


                  }).catch(error=>{

            				throw error;
                  });
                }
              }
            }
            self.loading = false;
    			}).catch(err=>{
            self.loading = false;
            try {
              Swal.fire({
                type: 'error',
                position: 'center',
                title: 'Failed because: ',
                text: err.response.data.reason
              });
            } catch (e) {
              console.log(e)
            } finally {

            }
    				throw err;
    			})
        },
        parseData(data){
          let self = this;
          let schemaName = store.getters.getSchemaName

          if (data.hits) {
            for (var i = 0; i < data.hits.length; i++) {
              if (data.hits[i].hasOwnProperty('name')) {
                if (data.hits[i].name.includes(schemaName)) {
                  var payload = {};
                  payload["schema"] = self.assignCategories(data.hits[i]);
                  store.commit('saveSchema',payload);
                }
              }else if (data.hits[i].hasOwnProperty('label')) {
                if (data.hits[i].label.includes(schemaName)) {
                  var payload = {};
                  payload["schema"] = self.assignCategories(data.hits[i]);
                  store.commit('saveSchema',payload);
                }
              }
            }
          }else {
            if (data.hasOwnProperty('name')) {
              if (data.name.includes(schemaName)) {
                var payload = {};
                payload["schema"] = data;
                store.commit('saveSchema',payload);
              }
            }else if (data.hasOwnProperty('label')) {
              if (data.label.includes(schemaName)) {
                var payload = {};
                payload["schema"] = data;
                store.commit('saveSchema',payload);
              }
            }
          }
        },
        assignCategories(schema){
          var self = this;

          if (schema.hasOwnProperty('validation')) {

            for (prop in schema['validation']['properties']) {
              //assign if found
              Vue.set(schema['validation']['properties'][prop],'categories',[])

              for (category in self.categories) {
                for (var subcategory in self.categories[category]) {
                  if (self.categories[category][subcategory].includes(prop)) {
                    let cat={
                      'category': category,
                      'subcategory':subcategory
                    }
                    schema['validation']['properties'][prop]['categories'].unshift(cat);
                  }
                }
              }
            }
            // console.log('WITH CATS', schema)
            return schema
          }else{
            return schema
          }
        },
        reset(){
          if (this.validation) {
            Swal.fire({
              title: 'Are you sure?',
              text: "You won't be able to revert this!",
              animation:false,
              customClass:'scale-in-center',
              showCancelButton: true,
              confirmButtonColor:"{{color_main}}",
              cancelButtonColor:"{{color_sec}}",
              confirmButtonText: 'Yes, start over'
            }).then((result) => {
              if (result.value) {
                store.dispatch('reset')
              }
            });
          }
        },
        isRequired(propname){
          let req = store.getters.getValidation['required']
          if (req.includes(propname)) {
            return true
          }else{
            return false
          }
        },
        selectProp(propname){
          var payload = {};
          payload["select"] = propname;
          store.commit('markSelected',payload);
        },
        getPreview(){
          store.commit('formPreview');
          Swal.fire({
            position: 'center',
            confirmButtonColor:"{{color_main}}",
            cancelButtonColor:"{{color_sec}}",
            animation:false,
            customClass:'scale-in-center',
            html: `<h6 class="text-center mainTextDark">Preview</h6><div class="text-left p-1 previewBox"><small><pre>`+JSON.stringify(store.getters.getPreview,null,2)+`</pre></small></div>`
          });
        },
        handleRegistration(){
          var self = this;

          if (this.isComplete) {
            store.commit('formPreview');
            let output = store.getters.getOutput
            self.loading = true;

            Swal.fire({
              title: 'Register this dataset?',
              html:"<small>Are you all done? Click <b>Register Now</b> to proceed.</small>",
              footer:`<small class='text-danger'>You will leave this page after successfully registering this dataset.</small>`,
              confirmButtonColor:"{{color_main}}",
              cancelButtonColor:"{{color_sec}}",
              animation:false,
              customClass:'scale-in-center',
              showCancelButton: true,
              confirmButtonText: 'Register Now',
              showLoaderOnConfirm: true,
              onClose:function(){
                self.loading = false;
              },
              preConfirm: (input) => {

                let schema = store.getters.getSchema

                axios.post('/api/dataset?schema='+schema['namespace']+'::'+schema['prefix']+':'+schema['label'],output).then(res=>{
                  self.loading = false;
                  if (res.data.success) {
                    let timerInterval
                    Swal.fire({
                      type:'success',
                      title: 'Registration Successful',
                      html:
                        'Taking you to your dataset page in <strong></strong> seconds.',
                      timer: 3000,
                      onBeforeOpen: () => {
                        const content = Swal.getContent()
                        const $ = content.querySelector.bind(content)
                        Swal.showLoading()
                        timerInterval = setInterval(() => {
                          Swal.getContent().querySelector('strong')
                            .textContent = (Swal.getTimerLeft() / 1000)
                              .toFixed(0)
                        }, 100)
                      },
                      onClose: () => {
                        clearInterval(timerInterval)
                        store.dispatch('reset')
                        window.location.href='/dataset/'+res.data.id
                      }
                    })
                  }else{

                    try {
                      Swal.fire({
                        type: 'error',
                        position: 'top center',
                        title: 'Registration failed because: ',
                        text: res.data.reason
                      });
                    } catch (e) {

                    } finally {

                    }
                  }
                }).catch(err=>{
                  self.loading = false;
                  throw err;
                  Swal.fire({
                    type: 'error',
                    position: 'top center',
                    title: 'Registration failed because: ',
                    text: err.response.data.reason
                  });
                })
              },
              allowOutsideClick: () => !Swal.isLoading(),

            });
            self.loading = true;
          }

        },
        downnloadSchema(){
          var self = this;
          if (this.isComplete){
            store.commit('formPreview');
            Swal.fire({
              title: 'Name your file',
              input: 'text',
              inputAttributes: {
                autocapitalize: 'off'
              },
              showCancelButton: true,
              confirmButtonText: 'Download JSON-LD',
              allowOutsideClick: () => !Swal.isLoading()
            }).then((result) => {
              if (result.value) {
                self.download(JSON.stringify(store.getters.getPreview,null,2), result.value+'.jsonld', 'text/plain')
              }
            })
          }

        },
        download(content, fileName, contentType) {
          var a = document.createElement("a");
          var file = new Blob([content], {type: contentType});
          a.href = URL.createObjectURL(file);
          a.download = fileName;
          a.click();
        },
        showHelp(){
          Swal.fire({
            title: 'Dataset Guide',
            html:`<p>
                    After selecting a starting point you will be able complete a series of fields. It's really easy and fast! Here's a quick introduction to the layout:
                  </p>
                  <small>
                    <ul class="text-left">
                      <li>
                        1. Log-in status
                      </li>
                      <li>
                        2. Start over from scratch
                      </li>
                      <li>
                        3. Preview your progress
                      </li>
                      <li>
                        4. Download your progress (Available after completing all required fields)
                      </li>
                      <li>
                        5. Register your dataset (Available after completing all required fields)
                      </li>
                      <li>
                        6. All fields available to complete (* Required)
                      </li>
                      <li>
                        7. Progress bar
                      </li>
                      <li>
                        8. Complete fields
                      </li>
                      <li>
                        9. Current field clicked
                      </li>
                      <li>
                        10. Actions: Save & Close and Clear Field
                      </li>
                    </ul>
                  </small>`,
            footer:'',
            width:'52em',
            cconfirmButtonColor:"{{color_main}}",
            cancelButtonColor:"{{color_sec}}",
            confirmButtonText:"Ready!",
            animation:false,
            customClass:'scale-in-center',
            imageUrl: '/static/img/metadata.png',
            imageAlt: 'Dataset Editor'
          })
        },
        loadData(){
          var self = this;

          Swal.fire({
            title: 'Import Dataset Metadata',
            text: "Import Metadata From:",
            showCancelButton: true,
            animation:false,
            customClass:'scale-in-center',
            confirmButtonColor:"{{color_main}}",
            cancelButtonColor:"{{color_sec}}",
            confirmButtonText: 'Raw GitHub URL',
            cancelButtonText: 'A Registered Dataset Metadata',
          }).then((result) => {
            if (result.value) {
              // URL
              Swal.fire({
                title: 'Enter the URL here',
                input: 'text',
                inputAttributes: {
                  autocapitalize: 'off'
                },
                showCancelButton: true,
                confirmButtonText: 'Go',
                allowOutsideClick: () => !Swal.isLoading()
              }).then((result) => {
                if (result.value) {
                  let url = result.value
                  axios.get(url).then(res=>{
                    let selected = res.data;
                    for(key in selected){
                      if (!['@context','@type','_id'].includes(key)) {
                        var payload = {};
                        if (typeof selected[key] === 'object') {
                          let value = [selected[key]]
                          payload["completed"] = {'name':key,'value':value};
                          store.commit('markCompleted',payload);
                        }else{
                          let value = selected[key]
                          payload["completed"] = {'name':key,'value':value};
                          store.commit('markCompleted',payload);
                        }

                      }
                    }
                  }).catch(err=>{
                    Swal.fire({
                      type: 'error',
                      title: 'Oops...',
                      text: 'Something went wrong!',
                    })
                    throw err;
                  })
                }
              })
            }else{
              self.loading = true;
              axios.get('/api/dataset?&user='+self.userInfo.login).then(publicres=>{
                // console.log("PUBLIC",res.data)
                let list = publicres.data.hits;
                self.loading = false;
                self.loading = true;
                axios.get('/api/dataset?private=true&user='+self.userInfo.login).then(privateres=>{
                  self.loading = false;
                  list =list.concat(privateres.data.hits)
                  let options = {};
                  for (var i = 0; i < list.length; i++) {
                    Vue.set(options,list[i]['name'],list[i]['name'])
                  }
                  Swal.fire({
                    title: 'Select Metadata To Import',
                    input: 'select',
                    inputOptions: options,
                    animation:false,
                    customClass:'scale-in-center',
                    inputPlaceholder: 'Select an item',
                    showCancelButton: true,
                  }).then((result) => {
                    if (result.value) {
                      for (var i = 0; i < list.length; i++) {
                        if (result.value === list[i]['name']) {
                          let selected = list[i]
                          for(key in selected){
                            if (!['@context','@type','_id'].includes(key)) {
                              var payload = {};
                              if (typeof selected[key] === 'object') {
                                let value = [selected[key]]
                                payload["completed"] = {'name':key,'value':value};
                                store.commit('markCompleted',payload);
                              }else{
                                let value = selected[key]
                                payload["completed"] = {'name':key,'value':value};
                                store.commit('markCompleted',payload);
                              }

                            }
                          }
                        }
                      }
                    }
                  })
                }).catch(err=>{
                  throw err;
                });
              }).catch(err=>{
                throw err;
              });
            }
          })
        },
        checkAutoLoad(){
          var self = this;
          // console.log('checkAutoLoad')
          let payload = {}
          if (self.presets && self.presets.length === 1) {
            payload["startingPoint"] = self.presets[0];
            store.commit('setStartingPoint',payload);
            if (self.portals && self.portals.length) {
              payload["step"] = 2;
              store.commit('changeStep',payload);
            }else{
              console.log('3')
              payload["step"] = 3;
              store.commit('changeStep',payload);
              self.getFormValues();
            }
          }else{
            payload["step"] = 1;
            store.commit('changeStep',payload);
          }
        },
        getFormValues () {
          var self = this;
          // Handle selections for startingPoint and Portals IF any
          self.getStartingPointSchema(store.getters.getStartingPoint)
          let payload = {}
          payload["step"] = 3;
          store.commit('changeStep',payload);

        },
        setStartingPoint(startingPointInfo){
          var self = this;
          let payload = {}
          payload["startingPoint"] = startingPointInfo;
          store.commit('setStartingPoint',payload);
          if (self.portals && self.portals.length) {
            // IF PORTALS AVAILABLE
            payload["step"] = 2;
            store.commit('changeStep',payload);
          }else{
            // IF NO PORTALS AVAILABLE
            self.getFormValues()
            payload["step"] = 3;
            store.commit('changeStep',payload);
          }

        },
        goToStep(s){
          var self = this;
          let payload = {}
          payload["step"] = s;
          store.commit('changeStep',payload);
        }
			},
			mounted:function(){
        this.checkUser();
        this.checkAutoLoad();

        tippy( '#guide', {
            target:'.bar',
            content: 'Loading...',
            maxWidth:'200px',
            placement:'top',
            animation: 'fade',
            theme:'light',
            onShow(instance) {
              let totals = store.getters.getTotals
              let percentage = Math.ceil((totals.complete/totals.total)*100)
              instance.setContent("<div class='text-success bold m-0'>"+percentage+"% Completed</div>")
            }
          });
        tippy( '#widget',{
            target:'.desc',
            content: 'Loading...',
            // maxWidth:'200px',
            placement:'top',
            animation: 'fade',
            interactive: true,
            theme:'light',
            onShow(instance) {
              let info = instance.reference.dataset.tippyInfo;
              instance.setContent("<div class='text-muted m-0 p-1'>"+info+"</div>")
            }
          });
			}
		});


</script>
{% include "footer.html" %}
{% endblock %}
