{% extends "main.html" %}
{% block content %}
{% include "header.html" %}
<style>
  .whitefade{
    /* Permalink - use to edit and share this gradient: https://colorzilla.com/gradient-editor/#ffffff+0,ffffff+100&1+0,0+100;White+to+Transparent */
    background: -moz-linear-gradient(top,  rgba(255,255,255,1) 0%, rgba(255,255,255,0) 100%); /* FF3.6-15 */
    background: -webkit-linear-gradient(top,  rgba(255,255,255,1) 0%,rgba(255,255,255,0) 100%); /* Chrome10-25,Safari5.1-6 */
    background: linear-gradient(to bottom,  rgba(255,255,255,1) 0%,rgba(255,255,255,0) 100%); /* W3C, IE10+, FF16+, Chrome26+, Opera12+, Safari7+ */
    filter: progid:DXImageTransform.Microsoft.gradient( startColorstr='#ffffff', endColorstr='#00ffffff',GradientType=0 ); /* IE6-9 */
  }
  .notallowed{
    cursor: not-allowed;
  }
</style>
<div id="guide" class="container pt-5">
  <div v-if=loading class="loader">
    <img src="/static/img/ripple.svg"/>
  </div>
  <div class="jumbotron bg-light text-center">
    <h1 class="logoText">DISCOVERY GUIDE</h1>
    <p class="text-muted">
      Follow best practices to make your data more findable
    </p>
  </div>
  <div >
    <ul class="nav nav-tabs">
      <li class="nav-item" v-if="userInfo && userInfo.login">
        <span class="nav-link" :class="{ disabled: userInfo }"><small>
          <i class="fas fa-user-check"></i> Logged in as <span v-text="userInfo.login"></span></small>
        </span>
      </li>
      <li class='nav-item' v-if="userInfo && !userInfo.login">
        <a class='nav-link active' href='./oauth'>
          <small><i class="fas fa-sign-in-alt"></i> Login</small>
        </a>
      </li>
      <li class='nav-item'>
        <a class='nav-link' :class="{ 'disabled text-muted notallowed': !validation, 'bg-danger text-light pointer': validation }" @click="reset()">
          <small>
            <i class="fas fa-undo"></i> Start Over
          </small>
        </a>
      </li>
      <li class='nav-item'>
        <a class='nav-link' :class="{ 'disabled notallowed': !isComplete, 'bg-success text-light': isComplete }" href='#' @click.prevent="reset()">
          <small>
            <i class="fas fa-cloud-upload-alt"></i> Save
          </small>
        </a>
      </li>
    </ul>
    <div v-if="userInfo && !userInfo.login">
      <div class="alert alert-light text-danger text-center p-5">
        <h5>You must be logged in to proceed</h5>
      </div>
    </div>
    <template v-if="userInfo && userInfo.login">
      <div v-if="!validation" class="bg-light jumbotron whitefade text-center">
        <h3 class="text-muted">Choose a metadata schema</h3>
        <div class="d-flex justify-content-center align-items-center flex-wrap">
          <template v-for="item in presets">
            <div class="p-5 m-4 bg-light text-center message text-muted">
              <h4 v-text="item.name"></h4>
              <a :href="item.url" target="_blank"><small class="mainTextDark">preview <i class="fas fa-external-link-alt"></i></small></a>
              <p>
                <small v-text="item.description"></small>
              </p>
              <buttom @click="getAndLoadSchema(item.url)" class="btn themeButton text-light">Next</buttom>
            </div>
          </template>
        </div>
      </div>
      <div v-if="validation" class="bg-light jumbotron whitefade text-center">
        <h3 class="text-muted">FORM</h3>

      </div>
    </template>
  </div>
</div>

{% endblock %}
{% block extra_scripts %}
<script src="https://unpkg.com/vuex"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.18.0/axios.min.js"></script>
<script src="/static/js/lodash.js"></script>
<script src="/static/js/notify.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@7.28.11/dist/sweetalert2.all.min.js"></script>
<script>
  const store = new Vuex.Store({
    state: {
      schema:Object,
      complete:false
    },
    strict: true,
    mutations: {
      saveSchema(state,payload){
        state.schema = payload['schema'];
        $.notify("Schema Saved",{ globalPosition: 'right',className:'success', showDuration: 40, });
        console.log(state.schema)
      },
      reset(state){
        state.schema = {};
      }
    },
    getters:{
      // exposed as store.getters.nameOfGetter
      getSchema: state => {
        return state.schema
      },
      getValidation: (state) => {
        if (state.schema && state.schema.hasOwnProperty('@graph')) {
          for (var i = 0; i < state.schema['@graph'].length; i++) {
            if (state.schema['@graph'][i].hasOwnProperty('$validation')) {
              $.notify("Validation Found",{ globalPosition: 'right',className:'success', showDuration: 40, });
              return state.schema['@graph'][i]['$validation'];
            }
          }
        }else{
          return false;
        }
      }

    },
    actions:{
      reset ({ commit }) {
        commit('reset')
      }
    }
  });


  Vue.component('comp', {
    data: function(){
      return{

      }
    },
    props: ['item'],
    methods:{

    },
    watch:{

    },
    mounted: function(){
      var self = this;
    },
    computed: {

    },
    template:
    ``
  });




  var app = new Vue({
      el: '#guide',
      store: store,
			data: function(){
				return {
          userInfo:null,
          loading: false,
          presets:[
            {
              'name':'CTSADataset',
              'url':'https://raw.githubusercontent.com/data2health/schemas/master/Dataset/CTSADataset.json',
              'description':'A schema describing Dataset from CTSA center'
            },
          ]
				}
			},
      computed:{
        validation:function(){
          return store.getters.getValidation
        },
        isComplete:function(){
          return store.state.complete
        }
      },
      watch:{
      },
			methods:{
        checkUser(){
          let self = this;
          self.loading = true;
          $.ajax({url: "/user", success: function(result){
              self.loading = false;
             self.userInfo = result;
          },
          cache: false});
        },
        getAndLoadSchema(url){
          var self = this;
          self.loading = true;
          axios.get(url).then(res=>{
            self.loading = false;
            var payload = {};
            payload["schema"] = res.data;
            store.commit('saveSchema',payload);

          }).catch(err=>{
            self.loading = false;
            $.notify("Failed to load schema",{ globalPosition: 'right',className:'error', showDuration: 40, });
            throw err;
          })
        },
        reset(){
          if (this.validation) {
            Swal.fire({
              title: 'Are you sure?',
              text: "You won't be able to revert this!",
              showCancelButton: true,
              confirmButtonColor: '#3085d6',
              cancelButtonColor: '#d33',
              confirmButtonText: 'Yes, start over'
            }).then((result) => {
              if (result.value) {
                store.dispatch('reset')
              }
            });
          }
        }
			},
			mounted:function(){
        this.checkUser();
			}
		});


</script>
{% include "footer.html" %}
{% endblock %}
